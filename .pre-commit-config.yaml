# Pre-commit hooks - AI-assisted Solo Development
# ğŸ¯ Philosophy: åªæ“‹æœƒå½±éŸ¿ Production çš„éŒ¯èª¤ï¼Œå…¶ä»–éƒ½æ˜¯æ‘©æ“¦
#
# å®‰è£:
#   pip install pre-commit
#   pre-commit install --hook-type pre-commit --hook-type pre-push
#
# Commit éšæ®µæª¢æŸ¥ (ç¸½è€—æ™‚ < 10 ç§’):
# âœ… TypeScript ç·¨è­¯ - é˜²æ­¢ runtime éŒ¯èª¤
# âœ… Import patterns - é˜²æ­¢ UnboundLocalErrorï¼ˆæœƒç‚¸ prodï¼ï¼‰
# âœ… å®‰å…¨æª¢æŸ¥ - é˜²æ­¢æ´©å¯†
# âœ… åŸºæœ¬æª”æ¡ˆæª¢æŸ¥ - é˜²æ­¢ .db/.env è¢« commit
#
# Push éšæ®µæ ¼å¼åŒ– (è‡ªå‹•ä¿®å¾©):
# ğŸ¨ Black - Python æ ¼å¼åŒ–
# ğŸ¨ Autoflake - ç§»é™¤æœªä½¿ç”¨çš„ imports
# ğŸ¨ Prettier - Frontend æ ¼å¼åŒ–
# ğŸ¨ ESLint --fix - Frontend è‡ªå‹•ä¿®å¾©

repos:
  # ==========================================
  # ğŸ”´ CRITICAL: æœƒå°è‡´ Runtime Error
  # ==========================================
  - repo: local
    hooks:
      # TypeScript ç·¨è­¯æª¢æŸ¥ï¼ˆ5-8 ç§’ï¼‰
      - id: typescript
        name: TypeScript Check
        entry: bash -c 'cd frontend && npx tsc --noEmit'
        language: system
        files: frontend/src/.*\.(ts|tsx)$
        pass_filenames: false

      # Python Import æª¢æŸ¥ï¼ˆ< 1 ç§’ï¼‰
      # é˜²æ­¢ UnboundLocalError å’Œ circular imports
      - id: check-import-patterns
        name: Check for problematic Python import patterns
        entry: python backend/hooks/check_import_patterns.py
        language: system
        types: [python]
        files: ^backend/.*\.py$
        pass_filenames: true

  # ==========================================
  # ğŸ”’ CRITICAL: å®‰å…¨æª¢æŸ¥
  # ==========================================
  - repo: local
    hooks:
      - id: check-credentials
        name: Check for hardcoded credentials
        entry: ./.github/hooks/security/check-credentials.sh
        language: script
        pass_filenames: false

      - id: check-database-urls
        name: Check for exposed database URLs
        entry: ./.github/hooks/security/check-database-urls.sh
        language: script
        pass_filenames: false

      - id: check-api-keys
        name: Check for exposed API keys
        entry: ./.github/hooks/security/check-api-keys.sh
        language: script
        pass_filenames: false

      - id: check-jwt-secrets
        name: Check for exposed JWT secrets
        entry: ./.github/hooks/security/check-jwt-secrets.sh
        language: script
        pass_filenames: false

      - id: check-env-files
        name: Prevent .env files from being committed
        entry: ./.github/hooks/security/check-env-files.sh
        language: script
        pass_filenames: false

      - id: security-audit
        name: Comprehensive security audit
        entry: ./.github/hooks/security/security-audit.sh
        language: script
        pass_filenames: false

  # ==========================================
  # âš ï¸ IMPORTANT: é˜²æ­¢å¸¸è¦‹ä½ç´šéŒ¯èª¤
  # ==========================================
  - repo: local
    hooks:
      - id: prevent-db-files
        name: Prevent database files from being committed
        entry: bash -c 'git diff --cached --name-only | grep -q "\.db$" && echo "âŒ Database files detected!" && exit 1 || exit 0'
        language: system
        pass_filenames: false
        always_run: true

      - id: check-test-file-location
        name: Check test files are in correct location
        entry: bash -c 'git diff --cached --name-only | grep -q "backend/scripts/test_.*\.py" && echo "âš ï¸ Test files should be in backend/tests/" && exit 1 || exit 0'
        language: system
        pass_filenames: false
        always_run: true

  # ==========================================
  # ğŸ“ BASIC: åŸºæœ¬æª”æ¡ˆæª¢æŸ¥ï¼ˆæ¥µå¿«ï¼‰
  # ==========================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-added-large-files
        args: ['--maxkb=5000']  # æ”¾å¯¬åˆ° 5MB
      - id: check-merge-conflict

  # ==========================================
  # ğŸ¨ æ‰‹å‹•åŸ·è¡Œæ ¼å¼åŒ–ï¼ˆä¸æ“‹ commit/pushï¼‰
  # ==========================================
  # æ ¼å¼åŒ–å·¥å…·å·²ç§»åˆ°æ‰‹å‹•åŸ·è¡Œï¼š
  #
  # å‰ç«¯æ ¼å¼åŒ–:
  #   npx prettier --write frontend/src
  #
  # å¾Œç«¯æ ¼å¼åŒ–:
  #   cd backend && black . && autoflake --in-place --recursive .
  #
  # æˆ–ä½¿ç”¨ pre-commit æ‰‹å‹•åŸ·è¡Œ:
  #   pre-commit run --all-files black autoflake prettier
