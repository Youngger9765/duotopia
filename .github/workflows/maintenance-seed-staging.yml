name: Seed Staging Database

on:
  workflow_dispatch:  # åªå…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      confirm:
        description: 'âš ï¸ ç¢ºèªè¦é‡ç½® STAGING è³‡æ–™åº«ï¼Ÿè¼¸å…¥ "RESET" ç¢ºèª'
        required: true
        type: string

jobs:
  seed-staging:
    name: ğŸŒ± Seed Staging Database
    runs-on: ubuntu-latest

    steps:
      - name: âš ï¸ Validate confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "RESET" ]]; then
            echo "âŒ ERROR: å¿…é ˆè¼¸å…¥ 'RESET' æ‰èƒ½åŸ·è¡Œè³‡æ–™åº«é‡ç½®"
            echo "ğŸ‘‰ è«‹åœ¨ workflow è§¸ç™¼æ™‚çš„ confirm æ¬„ä½è¼¸å…¥: RESET"
            exit 1
          fi
          echo "âœ… ç¢ºèªè¼¸å…¥æ­£ç¢ºï¼Œç¹¼çºŒåŸ·è¡Œ..."

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£ Python ä¾è³´..."
          pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: ğŸ” Verify database connection
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_POOLER_URL }}
        run: |
          echo "ğŸ” æ¸¬è©¦è³‡æ–™åº«é€£ç·š..."
          cd backend
          python3 -c "from database import get_engine; get_engine().connect(); print('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ')"

      - name: âš ï¸ Show warning
        run: |
          echo "âš ï¸âš ï¸âš ï¸ è­¦å‘Š âš ï¸âš ï¸âš ï¸"
          echo "å³å°‡åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š"
          echo "1. å»ºç«‹ STAGING ç’°å¢ƒçš„ Demo è³‡æ–™"
          echo "2. å»ºç«‹çµ„ç¹”ã€å­¸æ ¡ã€æ•™å¸«å¸³è™Ÿ"
          echo ""
          echo "ğŸ¯ ç›®æ¨™ç’°å¢ƒ: STAGING (Preview ç’°å¢ƒå…±ç”¨)"
          echo "ğŸ“Š å°‡å‰µå»ºçš„è³‡æ–™ï¼š"
          echo "   - çµ„ç¹”: å¼µæ©Ÿæ§‹ (21a8a0c7-a5e3-4799-8336-fbb2cf1de91a)"
          echo "   - å­¸æ ¡: å¤§å®‰åœ‹å°ã€ä¿¡ç¾©åœ‹å°"
          echo "   - æ•™å¸«: owner@duotopia.com (org_owner)"
          echo "   - æ•™å¸«: chen@duotopia.com, wang@duotopia.com, liu@duotopia.com, lee@duotopia.com"
          echo "   - æ•™æèª²ç¨‹ (Programs)"
          echo ""
          echo "åŸ·è¡Œä¸­..."

      - name: ğŸŒ± Run seed_local_org.py (prerequisite)
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_POOLER_URL }}
          SEED_DEFAULT_PASSWORD: ${{ secrets.SEED_DEFAULT_PASSWORD }}
        run: |
          echo "ğŸŒ± Creating base organization and owner account..."
          cd backend
          python3 seed_local_org.py
          echo "âœ… Base organization created!"

      - name: ğŸŒ± Run seed_demo_data.py
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_POOLER_URL }}
          SEED_DEFAULT_PASSWORD: ${{ secrets.SEED_DEFAULT_PASSWORD }}
        run: |
          echo "ğŸŒ± é–‹å§‹åŸ·è¡Œ seed_demo_data.py..."
          cd backend
          python3 seed_demo_data.py
          echo "âœ… Seed è³‡æ–™å»ºç«‹å®Œæˆï¼"

      - name: ğŸ“Š Display accounts
        run: |
          echo ""
          echo "âœ… Staging ç’°å¢ƒ Seed å®Œæˆï¼"
          echo ""
          echo "ğŸ”‘ æ¸¬è©¦å¸³è™Ÿï¼š"
          echo "   - owner@duotopia.com (æ©Ÿæ§‹æ“æœ‰è€…)"
          echo "   - chen@duotopia.com (æ©Ÿæ§‹ç®¡ç†å“¡)"
          echo "   - wang@duotopia.com (æ•™å¸«)"
          echo "   - liu@duotopia.com (æ•™å¸«)"
          echo "   - lee@duotopia.com (æ•™å¸«)"
          echo ""
          echo "ğŸ” å¯†ç¢¼: å·²è¨­å®šç‚º GitHub Secret (SEED_DEFAULT_PASSWORD)"
          echo ""
          echo "ğŸŒ æ¸¬è©¦ç’°å¢ƒ:"
          echo "   - Staging: https://staging.duotopia.com"
          echo "   - Per-Issue Preview: Check PR comments for specific URL"
