name: Fix RLS Configuration

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read

jobs:
  fix-rls:
    name: ğŸ”’ Apply RLS Fix
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Set Database URL
      id: db_url
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "DATABASE_URL=${{ secrets.PRODUCTION_DATABASE_POOLER_URL }}" >> $GITHUB_OUTPUT
          echo "ğŸš€ Targeting PRODUCTION database"
        else
          echo "DATABASE_URL=${{ secrets.STAGING_DATABASE_POOLER_URL }}" >> $GITHUB_OUTPUT
          echo "ğŸ§ª Targeting STAGING database"
        fi

    - name: Apply RLS fix
      env:
        DATABASE_URL: ${{ steps.db_url.outputs.DATABASE_URL }}
      run: |
        echo "ğŸ“ Applying RLS configuration fix..."
        psql "$DATABASE_URL" -f backend/migrations/fix_rls_missing_tables.sql
        echo "âœ… RLS configuration applied successfully"

    - name: Verify RLS status
      env:
        DATABASE_URL: ${{ steps.db_url.outputs.DATABASE_URL }}
      run: |
        echo "ğŸ” Verifying RLS status..."

        # æª¢æŸ¥æœ‰å¤šå°‘è¡¨ DISABLED RLS
        DISABLED_COUNT=$(psql "$DATABASE_URL" -t -c "
          SELECT COUNT(*)
          FROM pg_tables
          WHERE schemaname = 'public'
            AND NOT rowsecurity
            AND tablename != 'alembic_version';
        ")

        echo "ğŸ“Š Tables with RLS disabled: $DISABLED_COUNT"

        if [ "$DISABLED_COUNT" -ge 13 ]; then
          echo "âœ… RLS configuration looks correct (at least 13 business tables disabled)"
        else
          echo "âš ï¸ Warning: Only $DISABLED_COUNT tables have RLS disabled"
        fi
