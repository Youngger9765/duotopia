name: Setup Cloud Scheduler

# âš ï¸ åªåœ¨éœ€è¦æ™‚æ‰‹å‹•è§¸ç™¼ï¼Œä¸æœƒè‡ªå‹•åŸ·è¡Œ
# ä½¿ç”¨æ™‚æ©Ÿï¼š
# 1. ç¬¬ä¸€æ¬¡éƒ¨ç½² Cloud Scheduler
# 2. Cron è¦å‰‡è®Šæ›´ï¼ˆæ™‚é–“ã€URLï¼‰
# 3. ç’°å¢ƒè®Šæ•¸æ›´æ–°
on:
  workflow_dispatch:  # åªå…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PROJECT_ID: duotopia-472708
  REGION: asia-east1

jobs:
  setup-scheduler:
    name: ğŸ“… Setup Cloud Scheduler
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Set Environment Variables
      id: env_vars
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "BACKEND_URL=${{ secrets.PRODUCTION_BACKEND_URL }}" >> $GITHUB_OUTPUT
          echo "CRON_SECRET=${{ secrets.PRODUCTION_CRON_SECRET }}" >> $GITHUB_OUTPUT
          echo "ENV_SUFFIX=production" >> $GITHUB_OUTPUT
        else
          echo "BACKEND_URL=${{ secrets.STAGING_BACKEND_URL }}" >> $GITHUB_OUTPUT
          echo "CRON_SECRET=${{ secrets.STAGING_CRON_SECRET }}" >> $GITHUB_OUTPUT
          echo "ENV_SUFFIX=staging" >> $GITHUB_OUTPUT
        fi

    - name: Check existing Cloud Scheduler jobs
      run: |
        echo "ğŸ“‹ ç¾æœ‰çš„ Cloud Scheduler jobsï¼š"
        gcloud scheduler jobs list --location=${{ env.REGION }} || echo "æ²’æœ‰ç¾æœ‰çš„ jobs"

    - name: Setup Monthly Renewal Job (Production Only)
      if: github.event.inputs.environment == 'production'
      run: |
        JOB_NAME="monthly-renewal-production"

        echo "ğŸ—‘ï¸  åˆªé™¤èˆŠçš„ jobï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
        gcloud scheduler jobs delete $JOB_NAME \
          --location=${{ env.REGION }} \
          --quiet || echo "No existing job to delete"

        echo "âœ¨ å‰µå»ºæ–°çš„ monthly renewal job..."
        gcloud scheduler jobs create http $JOB_NAME \
          --location=${{ env.REGION }} \
          --schedule="0 2 1 * *" \
          --time-zone="Asia/Taipei" \
          --uri="${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/monthly-renewal" \
          --http-method=POST \
          --headers="X-Cron-Secret=${{ steps.env_vars.outputs.CRON_SECRET }},Content-Type=application/json" \
          --attempt-deadline=300s \
          --max-retry-attempts=3 \
          --description="æ¯æœˆ 1 è™Ÿå‡Œæ™¨ 2:00 (å°åŒ—æ™‚é–“) åŸ·è¡Œè‡ªå‹•çºŒè¨‚ - production only"

        echo "âœ… Monthly renewal job å‰µå»ºæˆåŠŸï¼ˆâš ï¸ æœƒçœŸå¯¦æ‰£æ¬¾ï¼‰"

    - name: Setup Renewal Reminder Job (Production Only)
      if: github.event.inputs.environment == 'production'
      run: |
        JOB_NAME="renewal-reminder-production"

        echo "ğŸ—‘ï¸  åˆªé™¤èˆŠçš„ jobï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
        gcloud scheduler jobs delete $JOB_NAME \
          --location=${{ env.REGION }} \
          --quiet || echo "No existing job to delete"

        echo "âœ¨ å‰µå»ºæ–°çš„ renewal reminder job..."
        gcloud scheduler jobs create http $JOB_NAME \
          --location=${{ env.REGION }} \
          --schedule="0 3 * * *" \
          --time-zone="Asia/Taipei" \
          --uri="${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/renewal-reminder" \
          --http-method=POST \
          --headers="X-Cron-Secret=${{ steps.env_vars.outputs.CRON_SECRET }},Content-Type=application/json" \
          --attempt-deadline=300s \
          --max-retry-attempts=3 \
          --description="æ¯å¤©å‡Œæ™¨ 3:00 (å°åŒ—æ™‚é–“) ç™¼é€åˆ°æœŸæé†’ - production only"

        echo "âœ… Renewal reminder job å‰µå»ºæˆåŠŸï¼ˆâš ï¸ æœƒç™¼é€çœŸå¯¦æé†’çµ¦ç”¨æˆ¶ï¼‰"

    - name: Setup Recording Error Report Job (Production Only)
      if: github.event.inputs.environment == 'production'
      run: |
        JOB_NAME="recording-error-report-production"

        echo "ğŸ—‘ï¸  åˆªé™¤èˆŠçš„ recording error report jobï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
        gcloud scheduler jobs delete $JOB_NAME \
          --location=${{ env.REGION }} \
          --quiet || echo "No existing job to delete"

        echo "âœ¨ å‰µå»ºéŒ„éŸ³éŒ¯èª¤å ±å‘Š job..."
        gcloud scheduler jobs create http $JOB_NAME \
          --location=${{ env.REGION }} \
          --schedule="0 */4 * * *" \
          --time-zone="Asia/Taipei" \
          --uri="${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/recording-error-report" \
          --http-method=POST \
          --headers="X-Cron-Secret=${{ steps.env_vars.outputs.CRON_SECRET }},Content-Type=application/json" \
          --attempt-deadline=300s \
          --max-retry-attempts=2 \
          --description="æ¯ 4 å°æ™‚æª¢æŸ¥ BigQuery éŒ„éŸ³éŒ¯èª¤ä¸¦ç™¼é€å ±å‘Šåˆ° myduotopia@gmail.com - production only"

        echo "âœ… Recording error report job å‰µå»ºæˆåŠŸ"
        echo ""
        echo "ğŸ“Š æ­¤ job æ¯ 4 å°æ™‚åŸ·è¡Œä¸€æ¬¡ï¼Œçµ±è¨ˆéå» 24H å’Œ 1H çš„éŒ„éŸ³éŒ¯èª¤"
        echo "ğŸ“§ å ±å‘Šæœƒç™¼é€åˆ° myduotopia@gmail.com"
        echo "ğŸ¤– åŒ…å« OpenAI AI åˆ†ææ‘˜è¦"

    - name: Setup Test Notification Job (Staging Only)
      if: github.event.inputs.environment == 'staging'
      run: |
        JOB_NAME="test-notification-staging"

        echo "ğŸ—‘ï¸  åˆªé™¤èˆŠçš„ test notification jobï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
        gcloud scheduler jobs delete $JOB_NAME \
          --location=${{ env.REGION }} \
          --quiet || echo "No existing job to delete"

        echo "âœ¨ å‰µå»ºæ¸¬è©¦é€šçŸ¥ job..."
        gcloud scheduler jobs create http $JOB_NAME \
          --location=${{ env.REGION }} \
          --schedule="0 9 * * *" \
          --time-zone="Asia/Taipei" \
          --uri="${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/test-notification" \
          --http-method=POST \
          --headers="X-Cron-Secret=${{ steps.env_vars.outputs.CRON_SECRET }},Content-Type=application/json" \
          --attempt-deadline=300s \
          --max-retry-attempts=3 \
          --description="æ¯å¤©æ—©ä¸Š 9:00 (å°åŒ—æ™‚é–“) ç™¼é€æ¸¬è©¦é€šçŸ¥åˆ° myduotopia@gmail.com - staging only"

        echo "âœ… Test notification job å‰µå»ºæˆåŠŸ"
        echo ""
        echo "ğŸ“§ æ­¤ job æ¯å¤©æ—©ä¸Š 9:00 æœƒç™¼é€æ¸¬è©¦éƒµä»¶åˆ° myduotopia@gmail.com"
        echo "ğŸ’¡ å¯ä»¥é€éé€™å€‹æ¸¬è©¦ç¢ºèª Cloud Scheduler æ˜¯å¦æ­£å¸¸é‹ä½œ"

    - name: List all Cloud Scheduler jobs
      run: |
        echo ""
        echo "ğŸ“… æ‰€æœ‰ Cloud Scheduler jobsï¼š"
        gcloud scheduler jobs list --location=${{ env.REGION }}

        echo ""
        echo "ğŸ’° æˆæœ¬ä¼°ç®—ï¼š"
        if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
          echo "- Cloud Scheduler: 1 å€‹ job Ã— USD 0.10/æœˆ = USD 0.10/æœˆ"
          echo "  - Test Notification (æ¯å¤© 1 æ¬¡ - staging only)"
          echo "- HTTP è«‹æ±‚æˆæœ¬: å…è²»ï¼ˆåœ¨ Cloud Run å…è²»é¡åº¦å…§ï¼‰"
        else
          echo "- Cloud Scheduler: 3 å€‹ jobs Ã— USD 0.10/æœˆ = USD 0.30/æœˆ"
          echo "  - Monthly Renewal (æ¯æœˆ 1 æ¬¡ - production only)"
          echo "  - Renewal Reminder (æ¯å¤© 1 æ¬¡ - production only)"
          echo "  - Recording Error Report (æ¯ 4 å°æ™‚ 1 æ¬¡ = 6Ã—30 = 180 æ¬¡/æœˆ - production only)"
          echo "- HTTP è«‹æ±‚æˆæœ¬: å…è²»ï¼ˆåœ¨ Cloud Run å…è²»é¡åº¦å…§ï¼‰"
          echo "- BigQuery æŸ¥è©¢æˆæœ¬: ~USD 0.005/æœˆï¼ˆæ¯ 4 å°æ™‚æŸ¥è©¢å…©æ¬¡ï¼Œæ¯æ¬¡ < 10 MBï¼‰"
          echo "- OpenAI API æˆæœ¬: ~USD 0.003/æœˆï¼ˆgpt-4o-mini, æ¯æ¬¡ 300 tokens, æ¯ 4 å°æ™‚ï¼‰"
        fi

    - name: Test Jobs
      run: |
        echo ""
        echo "ğŸ§ª æ¸¬è©¦æŒ‡ä»¤ï¼š"
        echo ""
        if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
          echo "1. æ¸¬è©¦é€šçŸ¥ jobï¼ˆå®‰å…¨ï¼Œåªç™¼é€æ¸¬è©¦ emailï¼‰ï¼š"
          echo "   gcloud scheduler jobs run test-notification-staging --location=${{ env.REGION }}"
          echo ""
          echo "ğŸ’¡ Staging åªæœ‰æ¸¬è©¦é€šçŸ¥ï¼Œä¸æœƒå½±éŸ¿çœŸå¯¦ç”¨æˆ¶"
        else
          echo "1. æ¸¬è©¦éŒ„éŸ³éŒ¯èª¤å ±å‘Šï¼ˆå®‰å…¨ï¼Œåªç™¼é€ emailï¼‰ï¼š"
          echo "   gcloud scheduler jobs run recording-error-report-production --location=${{ env.REGION }}"
          echo "   ğŸ’¡ æœƒæŸ¥è©¢ BigQuery ä¸¦ä½¿ç”¨ OpenAI ç”Ÿæˆåˆ†æ"
          echo ""
          echo "2. æ¸¬è©¦ renewal reminderï¼ˆâš ï¸ æœƒç™¼é€çœŸå¯¦æé†’çµ¦ç”¨æˆ¶ï¼‰ï¼š"
          echo "   gcloud scheduler jobs run renewal-reminder-production --location=${{ env.REGION }}"
          echo ""
          echo "3. æ¸¬è©¦ monthly renewalï¼ˆğŸš¨ æœƒçœŸå¯¦åŸ·è¡Œæ‰£æ¬¾é‚è¼¯ï¼ï¼‰ï¼š"
          echo "   gcloud scheduler jobs run monthly-renewal-production --location=${{ env.REGION }}"
        fi

    - name: Summary
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Cloud Scheduler è¨­å®šå®Œæˆ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
        echo "Region: ${{ env.REGION }}"
        echo ""
        if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
          echo "ğŸ“… Job 1: test-notification-staging (åƒ… staging)"
          echo "   æ’ç¨‹: æ¯å¤©æ—©ä¸Š 9:00 (å°åŒ—æ™‚é–“)"
          echo "   URL: ${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/test-notification"
          echo "   ğŸ“§ ç™¼é€æ¸¬è©¦éƒµä»¶åˆ° myduotopia@gmail.com"
          echo ""
          echo "ğŸ’¡ Staging åªæœ‰æ¸¬è©¦é€šçŸ¥ï¼Œä¸æœƒå½±éŸ¿çœŸå¯¦ç”¨æˆ¶å’Œæ‰£æ¬¾"
        else
          echo "ğŸ“… Job 1: monthly-renewal-production (åƒ… production)"
          echo "   æ’ç¨‹: æ¯æœˆ 1 è™Ÿå‡Œæ™¨ 2:00 (å°åŒ—æ™‚é–“)"
          echo "   URL: ${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/monthly-renewal"
          echo "   ğŸš¨ æœƒçœŸå¯¦åŸ·è¡Œæ‰£æ¬¾é‚è¼¯"
          echo ""
          echo "ğŸ“… Job 2: renewal-reminder-production (åƒ… production)"
          echo "   æ’ç¨‹: æ¯å¤©å‡Œæ™¨ 3:00 (å°åŒ—æ™‚é–“)"
          echo "   URL: ${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/renewal-reminder"
          echo "   âš ï¸ æœƒç™¼é€çœŸå¯¦æé†’çµ¦ç”¨æˆ¶"
          echo ""
          echo "ğŸ“… Job 3: recording-error-report-production (åƒ… production)"
          echo "   æ’ç¨‹: æ¯ 4 å°æ™‚ (å°åŒ—æ™‚é–“)"
          echo "   URL: ${{ steps.env_vars.outputs.BACKEND_URL }}/api/cron/recording-error-report"
          echo "   ğŸ“Š æŸ¥è©¢ BigQuery éŒ„éŸ³éŒ¯èª¤ï¼ˆ24H + 1Hï¼‰"
          echo "   ğŸ¤– ä½¿ç”¨ OpenAI ç”ŸæˆéŒ¯èª¤åˆ†ææ‘˜è¦"
          echo "   ğŸ“§ ç™¼é€å ±å‘Šåˆ° myduotopia@gmail.com"
        fi
        echo ""
        echo "ğŸ’¡ ä¸‹æ¬¡éœ€è¦æ›´æ–°æ™‚ï¼Œè«‹åœ¨ GitHub Actions æ‰‹å‹•è§¸ç™¼æ­¤ workflow"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
