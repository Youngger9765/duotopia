name: Cleanup Per-Issue Test Environment

on:
  issues:
    types: [closed]
  pull_request:
    types: [closed]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼æ¸…ç†
    inputs:
      issue_number:
        description: 'Issue number to cleanup (optional)'
        required: false
        type: string

env:
  PROJECT_ID: duotopia-472708
  REGION: asia-east1
  REPOSITORY: duotopia-repo

jobs:
  check-team-member:
    name: ğŸ”’ Verify Team Member
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
    - name: Check if user is team member
      run: |
        ACTOR="${{ github.actor }}"
        TEAM_MEMBERS="Youngger9765 cbtzeng kaddy-eunice"

        if ! echo "$TEAM_MEMBERS" | grep -qw "$ACTOR"; then
          echo "::error::âŒ $ACTOR is not a team member"
          echo "::error::Only team members can manually trigger cleanup"
          exit 1
        fi

        echo "âœ… $ACTOR is authorized to cleanup"

  validate-secrets:
    name: ğŸ” Validate Required Secrets
    runs-on: ubuntu-latest
    needs: check-team-member
    if: always() && (needs.check-team-member.result == 'success' || needs.check-team-member.result == 'skipped')
    steps:
    - name: Check required secrets
      run: |
        if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
          echo "::error::âŒ Missing required secret: GCP_SA_KEY"
          exit 1
        fi
        echo "âœ… Required secrets are configured"

  cleanup-per-issue-on-issue-close:
    name: ğŸ§¹ Delete Per-Issue Environment for Closed Issue
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Extract issue number from event
      id: issue
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ISSUE_NUM="${{ inputs.issue_number }}"
        elif [ "${{ github.event_name }}" = "issues" ]; then
          ISSUE_NUM="${{ github.event.issue.number }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          # å¾ PR åˆ†æ”¯åç¨±æå– issue number (e.g., fix/issue-7-description)
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oP '(?<=issue-)\d+' || echo "")
        fi

        if [ -z "$ISSUE_NUM" ]; then
          echo "âš ï¸ No issue number found, skipping cleanup"
          echo "has_issue=false" >> $GITHUB_OUTPUT
        else
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "has_issue=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Cleaning up per-issue for Issue #$ISSUE_NUM"
        fi

    - name: Delete Cloud Run backend service
      if: steps.issue.outputs.has_issue == 'true'
      continue-on-error: true  # å¦‚æœæœå‹™ä¸å­˜åœ¨ä¹Ÿä¸å ±éŒ¯
      run: |
        ISSUE_NUM="${{ steps.issue.outputs.issue_number }}"
        SERVICE_NAME="duotopia-preview-issue-${ISSUE_NUM}-backend"

        echo "ğŸ—‘ï¸ Deleting backend service: $SERVICE_NAME"

        # æª¢æŸ¥æœå‹™æ˜¯å¦å­˜åœ¨
        if gcloud run services describe $SERVICE_NAME --platform managed --region $REGION &>/dev/null; then
          gcloud run services delete $SERVICE_NAME \
            --platform managed \
            --region $REGION \
            --quiet
          echo "âœ… Backend service deleted"
        else
          echo "â„¹ï¸ Backend service not found (already deleted or never created)"
        fi

    - name: Delete Cloud Run frontend service
      if: steps.issue.outputs.has_issue == 'true'
      continue-on-error: true
      run: |
        ISSUE_NUM="${{ steps.issue.outputs.issue_number }}"
        SERVICE_NAME="duotopia-preview-issue-${ISSUE_NUM}-frontend"

        echo "ğŸ—‘ï¸ Deleting frontend service: $SERVICE_NAME"

        # æª¢æŸ¥æœå‹™æ˜¯å¦å­˜åœ¨
        if gcloud run services describe $SERVICE_NAME --platform managed --region $REGION &>/dev/null; then
          gcloud run services delete $SERVICE_NAME \
            --platform managed \
            --region $REGION \
            --quiet
          echo "âœ… Frontend service deleted"
        else
          echo "â„¹ï¸ Frontend service not found (already deleted or never created)"
        fi

    - name: Delete container images from Artifact Registry
      if: steps.issue.outputs.has_issue == 'true'
      continue-on-error: true
      run: |
        ISSUE_NUM="${{ steps.issue.outputs.issue_number }}"

        echo "ğŸ§¹ Cleaning up container images for issue #${ISSUE_NUM}..."

        # æ¸…ç† backend images
        BACKEND_SERVICE="duotopia-preview-issue-${ISSUE_NUM}-backend"
        echo "Checking for backend images: $BACKEND_SERVICE"
        BACKEND_IMAGES=$(gcloud artifacts docker images list \
          $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$BACKEND_SERVICE \
          --format="value(version)" 2>/dev/null || echo "")

        if [ ! -z "$BACKEND_IMAGES" ]; then
          echo "Deleting backend images..."
          echo "$BACKEND_IMAGES" | while read DIGEST; do
            gcloud artifacts docker images delete \
              "$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$BACKEND_SERVICE@${DIGEST}" \
              --quiet --delete-tags 2>/dev/null || echo "  Failed to delete (may be in use)"
          done
          echo "âœ… Backend images cleaned up"
        else
          echo "â„¹ï¸ No backend images found"
        fi

        # æ¸…ç† frontend images
        FRONTEND_SERVICE="duotopia-preview-issue-${ISSUE_NUM}-frontend"
        echo "Checking for frontend images: $FRONTEND_SERVICE"
        FRONTEND_IMAGES=$(gcloud artifacts docker images list \
          $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$FRONTEND_SERVICE \
          --format="value(version)" 2>/dev/null || echo "")

        if [ ! -z "$FRONTEND_IMAGES" ]; then
          echo "Deleting frontend images..."
          echo "$FRONTEND_IMAGES" | while read DIGEST; do
            gcloud artifacts docker images delete \
              "$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$FRONTEND_SERVICE@${DIGEST}" \
              --quiet --delete-tags 2>/dev/null || echo "  Failed to delete (may be in use)"
          done
          echo "âœ… Frontend images cleaned up"
        else
          echo "â„¹ï¸ No frontend images found"
        fi

    - name: Post cleanup confirmation comment to issue
      if: steps.issue.outputs.has_issue == 'true' && github.event_name == 'issues'
      uses: actions/github-script@v7
      permissions:
        issues: write
      with:
        script: |
          const issue_number = ${{ steps.issue.outputs.issue_number }};

          const body = `## ğŸ§¹ Per-Issue Environment å·²æ¸…ç†

**ğŸ“‹ Issue #${issue_number}**

Per-Issue environment å·²è‡ªå‹•æ¸…ç†ï¼š
- âœ… Backend Cloud Run service å·²åˆªé™¤
- âœ… Frontend Cloud Run service å·²åˆªé™¤
- âœ… Container images å·²æ¸…ç†

ğŸ’° è‡ªå‹•åœæ­¢è¨ˆè²»ï¼Œç¯€çœæˆæœ¬ã€‚

---
ğŸ¤– Auto-cleaned by GitHub Actions`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issue_number,
            body: body
          });

    - name: Display cleanup summary
      if: steps.issue.outputs.has_issue == 'true'
      run: |
        echo "ğŸ‰ Per-Issue Environment Cleanup Complete!"
        echo ""
        echo "ğŸ“‹ Issue #${{ steps.issue.outputs.issue_number }}"
        echo "âœ… Cloud Run services deleted"
        echo "âœ… Container images cleaned up"
        echo "ğŸ’° Cost savings: ~\$0.02-0.10/day"

  delete-stale-per-issue-environments:
    name: ğŸ—‘ï¸ Delete Per-Issue Environments Older Than 7 Days
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹å‹•è§¸ç™¼æ™‚åŸ·è¡Œ
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Find and delete stale Cloud Run services
      run: |
        echo "ğŸ” Finding per-issue services older than 7 days..."

        # å–å¾—æ‰€æœ‰ per-issue services
        SERVICES=$(gcloud run services list \
          --platform managed \
          --region $REGION \
          --filter="metadata.labels.environment=preview" \
          --format="value(metadata.name,metadata.creationTimestamp)")

        if [ -z "$SERVICES" ]; then
          echo "â„¹ï¸ No per-issue services found"
          exit 0
        fi

        # è¨ˆç®— 7 å¤©å‰çš„æ™‚é–“æˆ³
        CUTOFF_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)

        echo "Cutoff date: $CUTOFF_DATE"
        echo ""

        # æª¢æŸ¥æ¯å€‹æœå‹™çš„å»ºç«‹æ™‚é–“
        echo "$SERVICES" | while IFS=$'\t' read -r SERVICE_NAME CREATED_AT; do
          # æ¯”è¼ƒæ™‚é–“
          if [[ "$CREATED_AT" < "$CUTOFF_DATE" ]]; then
            echo "ğŸ—‘ï¸ Deleting old service: $SERVICE_NAME (created: $CREATED_AT)"
            gcloud run services delete $SERVICE_NAME \
              --platform managed \
              --region $REGION \
              --quiet
            echo "âœ… Deleted: $SERVICE_NAME"
          else
            echo "âœ“ Keeping recent service: $SERVICE_NAME (created: $CREATED_AT)"
          fi
        done

        echo ""
        echo "ğŸ‰ Old per-issue environments cleanup complete!"
