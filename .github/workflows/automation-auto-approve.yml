name: Auto Approve Detection

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  detect-approval:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null  # Only for Issues, not PRs
    steps:
      - name: Check for approval keywords
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const author = context.payload.comment.user.login;

            // Exclude bot comments
            if (author.includes('[bot]') || author === 'github-actions') {
              console.log(`Comment from ${author} - bot account excluded`);
              return;
            }

            // Only from authorized users
            const authorizedUsers = ['kaddy-eunice'];
            if (!authorizedUsers.includes(author)) {
              console.log(`Comment from ${author} - not authorized for approval`);
              return;
            }

            // Check for approval keywords (Chinese + English)
            const approvalKeywords = [
              'Ê∏¨Ë©¶ÈÄöÈÅé', 'ÊµãËØïÈÄöËøá',
              'approved', 'LGTM', 'looks good',
              'Ê≤íÂïèÈ°å', 'Ê≤°ÈóÆÈ¢ò',
              'ÂèØ‰ª•‰∫Ü', 'ÂèØ‰ª•',
              'ÁúãËµ∑‰æÜ‰∏çÈåØ', 'ÁúãËµ∑Êù•‰∏çÈîô'
            ];

            const hasApproval = approvalKeywords.some(keyword =>
              comment.toLowerCase().includes(keyword.toLowerCase())
            );

            // Check for checkmark emoji
            const hasCheckmark = comment.includes('‚úÖ') || comment.includes('üëç');

            if (hasApproval || hasCheckmark) {
              console.log(`‚úÖ Approval detected from ${author}`);

              // Add label to issue
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['‚úÖ tested-in-staging']
              });

              // Post confirmation comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ü§ñ **Auto-Approval Detected**\n\nApproval from @${author} has been recorded.\nLabel \`‚úÖ tested-in-staging\` added.\n\nThis issue is ready for Release PR.`
              });

              console.log('Label added and confirmation posted');
            } else {
              console.log('No approval keywords found');
            }
