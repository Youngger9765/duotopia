name: üßπ Cleanup Per-Issue Test Environment on Issue Close

on:
  issues:
    types: [closed]
  pull_request:
    types: [closed]

env:
  PROJECT_ID: duotopia-472708
  REGION: asia-east1

permissions:
  issues: write
  contents: write
  id-token: write

jobs:
  cleanup-on-issue-close:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract issue number
        id: extract
        run: |
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "üßπ Cleaning up Per-Issue Test Environment for Issue #${{ github.event.issue.number }}"

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cleanup Cloud Run services
        run: |
          ISSUE_NUM=${{ steps.extract.outputs.issue_number }}

          echo "üóëÔ∏è Deleting Cloud Run services for Issue #${ISSUE_NUM}..."

          # Delete frontend service
          if gcloud run services describe duotopia-preview-issue-${ISSUE_NUM}-frontend \
             --region=${{ env.REGION }} --format="value(name)" 2>/dev/null; then
            echo "Deleting frontend service..."
            gcloud run services delete duotopia-preview-issue-${ISSUE_NUM}-frontend \
              --region=${{ env.REGION }} \
              --quiet
            echo "‚úÖ Frontend service deleted"
          else
            echo "‚ÑπÔ∏è Frontend service not found (may already be deleted)"
          fi

          # Delete backend service
          if gcloud run services describe duotopia-preview-issue-${ISSUE_NUM}-backend \
             --region=${{ env.REGION }} --format="value(name)" 2>/dev/null; then
            echo "Deleting backend service..."
            gcloud run services delete duotopia-preview-issue-${ISSUE_NUM}-backend \
              --region=${{ env.REGION }} \
              --quiet
            echo "‚úÖ Backend service deleted"
          else
            echo "‚ÑπÔ∏è Backend service not found (may already be deleted)"
          fi

      - name: Cleanup container images
        run: |
          ISSUE_NUM=${{ steps.extract.outputs.issue_number }}

          echo "üóëÔ∏è Deleting container images for Issue #${ISSUE_NUM}..."

          # Delete frontend images
          gcloud artifacts docker images delete \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/duotopia-repo/duotopia-preview-issue-${ISSUE_NUM}-frontend \
            --quiet 2>/dev/null || echo "‚ÑπÔ∏è Frontend images not found"

          # Delete backend images
          gcloud artifacts docker images delete \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/duotopia-repo/duotopia-preview-issue-${ISSUE_NUM}-backend \
            --quiet 2>/dev/null || echo "‚ÑπÔ∏è Backend images not found"

          echo "‚úÖ Cleanup completed"

      - name: Cleanup all related branches
        run: |
          ISSUE_NUM=${{ steps.extract.outputs.issue_number }}

          echo "üóëÔ∏è Deleting ALL branches related to Issue #${ISSUE_NUM}..."

          # Find all branches containing issue-XX pattern
          # Match: issue-26, issue-26-, issue-26-anything
          # This catches: fix/issue-26-desc, claude/issue-26-timestamp, feature/issue-26-test
          BRANCHES=$(git ls-remote --heads origin | grep -E "issue-${ISSUE_NUM}([^0-9]|$)" | sed 's/.*refs\/heads\///' || true)
          
          if [ -z "$BRANCHES" ]; then
            echo "‚ÑπÔ∏è No branches found for Issue #${ISSUE_NUM}"
          else
            echo "Found branches to delete:"
            echo "$BRANCHES"
            
            # Delete each branch
            DELETED=0
            FAILED=0
            while IFS= read -r branch; do
              if [ -n "$branch" ]; then
                echo "Deleting branch: $branch"
                if git push origin --delete "$branch" 2>/dev/null; then
                  echo "‚úÖ Deleted: $branch"
                  ((DELETED++))
                else
                  echo "‚ö†Ô∏è Failed to delete: $branch"
                  ((FAILED++))
                fi
              fi
            done <<< "$BRANCHES"
            
            echo "üìä Summary: Deleted $DELETED branch(es), Failed $FAILED"
          fi

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              '## üßπ Per-Issue Test Environment Cleaned Up',
              '',
              '‚úÖ Cloud Run services deleted',
              '‚úÖ Container images cleaned',
              `‚úÖ All related branches deleted (Êô∫ËÉΩÊ™¢Ê∏¨ issue-${context.issue.number})`,
              'üí∞ Billing stopped',
              '',
              `**Note**: All branches containing \`issue-${context.issue.number}\` pattern have been removed.`
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  cleanup-on-pr-merge:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract issue number from PR
        id: extract
        run: |
          # Extract issue number from branch name (fix/issue-X-xxx, feature/issue-X-xxx, claude/issue-X-xxx)
          BRANCH="${{ github.event.pull_request.head.ref }}"
          if [[ "$BRANCH" =~ (fix|feature|claude)/issue-([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[2]}"
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "‚úÖ Found issue number: $ISSUE_NUM from branch: $BRANCH"
          else
            echo "‚ÑπÔ∏è No issue number found in branch name: $BRANCH"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      - uses: google-github-actions/auth@v2
        if: steps.extract.outputs.issue_number != ''
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        if: steps.extract.outputs.issue_number != ''
        uses: google-github-actions/setup-gcloud@v2

      - name: Cleanup Cloud Run services
        if: steps.extract.outputs.issue_number != ''
        run: |
          ISSUE_NUM=${{ steps.extract.outputs.issue_number }}

          echo "üóëÔ∏è Deleting Cloud Run services for Issue #${ISSUE_NUM}..."

          # Delete frontend service
          gcloud run services delete duotopia-preview-issue-${ISSUE_NUM}-frontend \
            --region=${{ env.REGION }} \
            --quiet 2>/dev/null || echo "‚ÑπÔ∏è Frontend service not found"

          # Delete backend service
          gcloud run services delete duotopia-preview-issue-${ISSUE_NUM}-backend \
            --region=${{ env.REGION }} \
            --quiet 2>/dev/null || echo "‚ÑπÔ∏è Backend service not found"

      - name: Cleanup container images
        if: steps.extract.outputs.issue_number != ''
        run: |
          ISSUE_NUM=${{ steps.extract.outputs.issue_number }}

          echo "üóëÔ∏è Deleting container images for Issue #${ISSUE_NUM}..."

          # Delete frontend images
          gcloud artifacts docker images delete \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/duotopia-repo/duotopia-preview-issue-${ISSUE_NUM}-frontend \
            --quiet 2>/dev/null || echo "‚ÑπÔ∏è Frontend images not found"

          # Delete backend images
          gcloud artifacts docker images delete \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/duotopia-repo/duotopia-preview-issue-${ISSUE_NUM}-backend \
            --quiet 2>/dev/null || echo "‚ÑπÔ∏è Backend images not found"

          echo "‚úÖ Cleanup completed for Issue #${ISSUE_NUM}"

      - name: Cleanup all related branches
        if: steps.extract.outputs.issue_number != ''
        run: |
          ISSUE_NUM=${{ steps.extract.outputs.issue_number }}

          echo "üóëÔ∏è Deleting ALL branches related to Issue #${ISSUE_NUM}..."

          # Find all branches containing issue-XX pattern
          # Match: issue-26, issue-26-, issue-26-anything
          # This catches: fix/issue-26-desc, claude/issue-26-timestamp, feature/issue-26-test
          BRANCHES=$(git ls-remote --heads origin | grep -E "issue-${ISSUE_NUM}([^0-9]|$)" | sed 's/.*refs\/heads\///' || true)
          
          if [ -z "$BRANCHES" ]; then
            echo "‚ÑπÔ∏è No branches found for Issue #${ISSUE_NUM}"
          else
            echo "Found branches to delete:"
            echo "$BRANCHES"
            
            # Delete each branch
            DELETED=0
            FAILED=0
            while IFS= read -r branch; do
              if [ -n "$branch" ]; then
                echo "Deleting branch: $branch"
                if git push origin --delete "$branch" 2>/dev/null; then
                  echo "‚úÖ Deleted: $branch"
                  ((DELETED++))
                else
                  echo "‚ö†Ô∏è Failed to delete: $branch"
                  ((FAILED++))
                fi
              fi
            done <<< "$BRANCHES"
            
            echo "üìä Summary: Deleted $DELETED branch(es), Failed $FAILED"
          fi

      - name: Comment on related issue
        if: steps.extract.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            const prNumber = ${{ github.event.pull_request.number }};
            const body = [
              '## üßπ Per-Issue Test Environment Cleaned Up',
              '',
              `PR #${prNumber} merged, cleaning up resources.`,
              '',
              '‚úÖ Cloud Run services deleted',
              '‚úÖ Container images cleaned',
              `‚úÖ All related branches deleted (Êô∫ËÉΩÊ™¢Ê∏¨ issue-${issueNumber})`,
              'üí∞ Billing stopped',
              '',
              `**Note**: All branches containing \`issue-${issueNumber}\` pattern have been removed.`
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
