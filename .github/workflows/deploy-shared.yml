name: Deploy Shared Changes

on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main, staging ]
    paths:
      # å…±ç”¨è¨­å®šæª”æ¡ˆ
      - 'docker-compose*.yml'
      - 'Makefile'
      - '.env.example'
      - '.dockerignore'
      - '.github/workflows/deploy-shared.yml'
      # æ ¹ç›®éŒ„é‡è¦æª”æ¡ˆ
      - 'pyproject.toml'
      - 'setup.py'
      - 'setup.cfg'
      # æ’é™¤ä¸éœ€è¦çš„æª”æ¡ˆ
      - '!**.md'
      - '!LICENSE'
      - '!.gitignore'
      - '!docs/**'

permissions:
  actions: write
  contents: read

jobs:
  detect-required-deployments:
    name: ğŸ” Detect Required Deployments
    runs-on: ubuntu-latest
    outputs:
      deploy-backend: ${{ steps.check.outputs.backend }}
      deploy-frontend: ${{ steps.check.outputs.frontend }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Check what needs deployment
      id: check
      run: |
        # æª¢æŸ¥è®Šæ›´çš„æª”æ¡ˆ
        # Handle manual trigger where HEAD^ may not exist
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-tree --name-only -r HEAD)
        else
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        fi
        echo "Changed files:"
        echo "$CHANGED_FILES"

        # é è¨­éƒ½éœ€è¦éƒ¨ç½²
        DEPLOY_BACKEND="true"
        DEPLOY_FRONTEND="true"

        # å¦‚æœåªæœ‰ç‰¹å®šæª”æ¡ˆè®Šæ›´ï¼Œå¯èƒ½ä¸éœ€è¦å…¨éƒ¨éƒ¨ç½²
        if echo "$CHANGED_FILES" | grep -q "^\.env\.example$"; then
          echo "ğŸ“ Environment example changed - may need manual review"
        fi

        if echo "$CHANGED_FILES" | grep -q "^Makefile$"; then
          echo "ğŸ”§ Makefile changed - checking if it affects deployment"
          # å¯ä»¥é€²ä¸€æ­¥åˆ†æ Makefile çš„è®Šæ›´å…§å®¹
        fi

        echo "backend=$DEPLOY_BACKEND" >> $GITHUB_OUTPUT
        echo "frontend=$DEPLOY_FRONTEND" >> $GITHUB_OUTPUT

  trigger-production-backend:
    name: ğŸ”„ Trigger Production Backend Deployment (Cloud Run)
    needs: detect-required-deployments
    if: github.ref == 'refs/heads/main' && needs.detect-required-deployments.outputs.deploy-backend == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Trigger Backend Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy-backend.yml',
            ref: '${{ github.ref }}'
          });
          console.log('âœ… Triggered production backend deployment (Cloud Run)');

  trigger-production-frontend:
    name: ğŸ”„ Trigger Production Frontend Deployment (Cloud Run)
    needs: detect-required-deployments
    if: github.ref == 'refs/heads/main' && needs.detect-required-deployments.outputs.deploy-frontend == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Trigger Frontend Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy-frontend.yml',
            ref: '${{ github.ref }}'
          });
          console.log('âœ… Triggered production frontend deployment (Cloud Run)');

  trigger-backend:
    name: ğŸ”„ Trigger Backend Deployment (Cloud Run)
    needs: detect-required-deployments
    if: github.ref == 'refs/heads/staging' && needs.detect-required-deployments.outputs.deploy-backend == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Trigger Backend Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy-backend.yml',
            ref: '${{ github.ref }}'
          });
          console.log('âœ… Triggered backend deployment (Cloud Run)');

  trigger-frontend:
    name: ğŸ”„ Trigger Frontend Deployment (Cloud Run)
    needs: detect-required-deployments
    if: github.ref == 'refs/heads/staging' && needs.detect-required-deployments.outputs.deploy-frontend == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Trigger Frontend Workflow
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy-frontend.yml',
            ref: '${{ github.ref }}'
          });
          console.log('âœ… Triggered frontend deployment (Cloud Run)');

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    if: always()
    continue-on-error: true
    steps:
    - uses: actions/checkout@v4

    - name: Run dependency check
      run: |
        echo "ğŸ” Checking for security vulnerabilities..."

        # Check Python dependencies
        if [ -f "requirements.txt" ]; then
          pip install safety
          safety check --json || true
        fi

        # Check Node dependencies
        if [ -f "package.json" ]; then
          npm audit --audit-level=critical || true
        fi

  notify-deployment:
    name: ğŸ“¢ Notify Deployment
    needs: [trigger-production-backend, trigger-production-frontend, trigger-backend, trigger-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Deployment Status
      run: |
        echo "ğŸš€ Shared configuration changes deployed!"
        echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
        echo "ğŸ·ï¸ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
        echo ""

        # Check which deployment path was taken
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "ğŸ¯ Deployment Target: Cloud Run (Production)"
          if [[ "${{ needs.trigger-production-backend.result }}" == "success" ]]; then
            echo "âœ… Production backend deployment triggered (Cloud Run)"
          elif [[ "${{ needs.trigger-production-backend.result }}" == "skipped" ]]; then
            echo "â­ï¸ Production backend deployment skipped"
          fi

          if [[ "${{ needs.trigger-production-frontend.result }}" == "success" ]]; then
            echo "âœ… Production frontend deployment triggered (Cloud Run)"
          elif [[ "${{ needs.trigger-production-frontend.result }}" == "skipped" ]]; then
            echo "â­ï¸ Production frontend deployment skipped"
          fi
        elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
          echo "ğŸ¯ Deployment Target: Cloud Run (Staging)"
          if [[ "${{ needs.trigger-backend.result }}" == "success" ]]; then
            echo "âœ… Backend deployment triggered (Cloud Run)"
          elif [[ "${{ needs.trigger-backend.result }}" == "skipped" ]]; then
            echo "â­ï¸ Backend deployment skipped"
          fi

          if [[ "${{ needs.trigger-frontend.result }}" == "success" ]]; then
            echo "âœ… Frontend deployment triggered (Cloud Run)"
          elif [[ "${{ needs.trigger-frontend.result }}" == "skipped" ]]; then
            echo "â­ï¸ Frontend deployment skipped"
          fi
        fi
