name: Deploy Per-Issue Environment (Simple)

on:
  push:
    branches:
      - 'fix/issue-*'
      - 'feat/issue-*'
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '!**/*.md'

env:
  PROJECT_ID: duotopia-472708
  REGION: asia-east1
  REPOSITORY: duotopia-repo

jobs:
  extract-issue-number:
    name: Extract Issue Number
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.extract.outputs.issue_number }}
    steps:
      - name: Extract issue number from branch
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          ISSUE_NUM=$(echo "$BRANCH_NAME" | grep -oE 'issue-[0-9]+' | grep -oE '[0-9]+')

          if [ -z "$ISSUE_NUM" ]; then
            echo "No issue number found in branch: $BRANCH_NAME"
            exit 1
          fi

          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Found issue number: $ISSUE_NUM"

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: extract-issue-number
    outputs:
      backend_url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build backend image
        working-directory: ./backend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/preview-issue-${{ needs.extract-issue-number.outputs.issue_number }}-backend:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          SERVICE="duotopia-preview-issue-${{ needs.extract-issue-number.outputs.issue_number }}-backend"

          gcloud run deploy "$SERVICE" \
            --image "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/preview-issue-${{ needs.extract-issue-number.outputs.issue_number }}-backend:${{ github.sha }}" \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --port 8000 \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 1 \
            --min-instances 0 \
            --set-env-vars "DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}" \
            --set-env-vars "ENVIRONMENT=preview" \
            --labels "environment=preview,issue=${{ needs.extract-issue-number.outputs.issue_number }}"

          URL=$(gcloud run services describe "$SERVICE" --platform managed --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $URL"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [extract-issue-number, deploy-backend]
    outputs:
      frontend_url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build frontend image
        working-directory: ./frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/preview-issue-${{ needs.extract-issue-number.outputs.issue_number }}-frontend:${{ github.sha }}"

          docker build \
            -f Dockerfile.staging \
            --build-arg VITE_API_URL=${{ needs.deploy-backend.outputs.backend_url }} \
            --build-arg VITE_ENVIRONMENT=preview \
            --build-arg VITE_TAPPAY_SERVER_TYPE=production \
            --build-arg VITE_TAPPAY_PRODUCTION_APP_ID=${{ secrets.TAPPAY_PRODUCTION_APP_ID }} \
            --build-arg VITE_TAPPAY_PRODUCTION_APP_KEY=${{ secrets.TAPPAY_PRODUCTION_APP_KEY }} \
            -t "$IMAGE" \
            .

          docker push "$IMAGE"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          SERVICE="duotopia-preview-issue-${{ needs.extract-issue-number.outputs.issue_number }}-frontend"

          gcloud run deploy "$SERVICE" \
            --image "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/preview-issue-${{ needs.extract-issue-number.outputs.issue_number }}-frontend:${{ github.sha }}" \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --port 80 \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 1 \
            --min-instances 0 \
            --labels "environment=preview,issue=${{ needs.extract-issue-number.outputs.issue_number }}"

          URL=$(gcloud run services describe "$SERVICE" --platform managed --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Frontend URL: $URL"

  comment-on-issue:
    name: Comment URLs
    runs-on: ubuntu-latest
    needs: [extract-issue-number, deploy-backend, deploy-frontend]
    permissions:
      issues: write
    steps:
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = ${{ needs.extract-issue-number.outputs.issue_number }};
            const frontend_url = '${{ needs.deploy-frontend.outputs.frontend_url }}';
            const backend_url = '${{ needs.deploy-backend.outputs.backend_url }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## ğŸš€ Per-Issue Test Environment å·²éƒ¨ç½²

**Preview URLs for Issue #${issue_number}:**
- Frontend: ${frontend_url}
- Backend: ${backend_url}

Branch: \`${{ github.ref_name }}\`
Commit: \`${{ github.sha }}\`

Min instances = 0ï¼Œæ²’äººè¨ªå•æ™‚ä¸æ”¶è²»ã€‚æ¸¬è©¦å®Œæˆå¾Œè«‹ç•™è¨€ã€Œæ¸¬è©¦é€šéã€ã€‚`
            });
