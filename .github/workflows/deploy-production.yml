name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: duotopia-469413
  REGION: asia-east1
  SERVICE_NAME: duotopia-backend
  FRONTEND_BUCKET: duotopia-frontend

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run backend tests
        working-directory: ./backend
        run: |
          pytest tests/ -v --cov=. --cov-report=xml
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Run frontend tests
        run: |
          npm run typecheck
          npm run lint || true
          npm run test --if-present
          npm run build

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker asia-east1-docker.pkg.dev
      
      - name: Build and push Docker image
        run: |
          docker build -f Dockerfile.backend -t asia-east1-docker.pkg.dev/$PROJECT_ID/duotopia/$SERVICE_NAME:$GITHUB_SHA .
          docker tag asia-east1-docker.pkg.dev/$PROJECT_ID/duotopia/$SERVICE_NAME:$GITHUB_SHA asia-east1-docker.pkg.dev/$PROJECT_ID/duotopia/$SERVICE_NAME:latest
          docker push asia-east1-docker.pkg.dev/$PROJECT_ID/duotopia/$SERVICE_NAME:$GITHUB_SHA
          docker push asia-east1-docker.pkg.dev/$PROJECT_ID/duotopia/$SERVICE_NAME:latest
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image asia-east1-docker.pkg.dev/$PROJECT_ID/duotopia/$SERVICE_NAME:$GITHUB_SHA \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --timeout 60 \
            --max-instances 50 \
            --min-instances 1 \
            --set-env-vars "ENVIRONMENT=production" \
            --set-env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            --set-env-vars "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
            --set-env-vars "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --set-env-vars "GCP_PROJECT_ID=$PROJECT_ID"
      
      - name: Get backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $SERVICE_NAME --region $REGION --format 'value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
      
      - name: Test deployment
        run: |
          sleep 10
          curl -f ${{ steps.backend-url.outputs.url }}/health || exit 1

  deploy-frontend:
    needs: deploy-backend
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Get backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $SERVICE_NAME --region $REGION --format 'value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          echo "VITE_API_URL=${{ steps.backend-url.outputs.url }}" > .env.production
          npm run build
      
      - name: Create bucket if not exists
        run: |
          gsutil ls -b gs://$FRONTEND_BUCKET || gsutil mb -l $REGION gs://$FRONTEND_BUCKET
      
      - name: Deploy to Cloud Storage
        working-directory: ./frontend
        run: |
          gsutil -m rsync -r -d dist/ gs://$FRONTEND_BUCKET/
          gsutil web set -m index.html -e 404.html gs://$FRONTEND_BUCKET
          gsutil iam ch allUsers:objectViewer gs://$FRONTEND_BUCKET
      
      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache duotopia-lb \
            --path="/*" \
            --global || true
      
      - name: Output URLs
        run: |
          echo "âœ… Production deployment complete!"
          echo "Backend: ${{ steps.backend-url.outputs.url }}"
          echo "Frontend: https://storage.googleapis.com/$FRONTEND_BUCKET/index.html"