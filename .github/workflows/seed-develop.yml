name: Seed Develop Database

on:
  workflow_dispatch:  # åªå…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      confirm:
        description: 'âš ï¸ ç¢ºèªè¦é‡ç½® DEVELOP è³‡æ–™åº«ï¼Ÿè¼¸å…¥ "RESET" ç¢ºèª'
        required: true
        type: string

jobs:
  seed-develop:
    name: ğŸŒ± Seed Develop Database
    runs-on: ubuntu-latest

    steps:
      - name: âš ï¸ Validate confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "RESET" ]]; then
            echo "âŒ ERROR: å¿…é ˆè¼¸å…¥ 'RESET' æ‰èƒ½åŸ·è¡Œè³‡æ–™åº«é‡ç½®"
            echo "ğŸ‘‰ è«‹åœ¨ workflow è§¸ç™¼æ™‚çš„ confirm æ¬„ä½è¼¸å…¥: RESET"
            exit 1
          fi
          echo "âœ… ç¢ºèªè¼¸å…¥æ­£ç¢ºï¼Œç¹¼çºŒåŸ·è¡Œ..."

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£ Python ä¾è³´..."
          pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: ğŸ” Verify database connection
        env:
          DATABASE_URL: ${{ secrets.DEVELOP_DATABASE_POOLER_URL }}
        run: |
          echo "ğŸ” æ¸¬è©¦è³‡æ–™åº«é€£ç·š..."
          cd backend
          python3 -c "from database import engine; engine.connect(); print('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ')"

      - name: âš ï¸ Show warning
        run: |
          echo "âš ï¸âš ï¸âš ï¸ è­¦å‘Š âš ï¸âš ï¸âš ï¸"
          echo "å³å°‡åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š"
          echo "1. DROP æ‰€æœ‰ Develop ç’°å¢ƒçš„è³‡æ–™è¡¨"
          echo "2. CREATE æ‰€æœ‰è³‡æ–™è¡¨çµæ§‹"
          echo "3. æ’å…¥ Demo è³‡æ–™ï¼ˆåŒ…å«å¥å­æ¨¡çµ„èª²ç¨‹ï¼‰"
          echo ""
          echo "ğŸ¯ ç›®æ¨™ç’°å¢ƒ: DEVELOP"
          echo "ğŸ“Š å°‡å‰µå»ºçš„è³‡æ–™ï¼š"
          echo "   - 3 å€‹æ•™å¸«å¸³è™Ÿï¼ˆdemo, expired, trialï¼‰"
          echo "   - 2 å€‹ç­ç´šï¼ˆäº”å¹´ç´šAç­ã€å…­å¹´ç´šBç­ï¼‰"
          echo "   - 30+ ä½å­¸ç”Ÿ"
          echo "   - å¤šå€‹èª²ç¨‹ï¼ˆåŒ…å«å¥å­æ¨¡çµ„æ¸¬è©¦èª²ç¨‹ï¼‰"
          echo "   - å¤šå€‹ä½œæ¥­èˆ‡é€²åº¦è³‡æ–™"
          echo ""
          echo "åŸ·è¡Œä¸­..."

      - name: ğŸŒ± Run seed_data.py
        env:
          DATABASE_URL: ${{ secrets.DEVELOP_DATABASE_POOLER_URL }}
        run: |
          echo "ğŸŒ± é–‹å§‹åŸ·è¡Œ seed_data.py..."
          cd backend
          python3 seed_data.py
          echo "âœ… Seed è³‡æ–™å»ºç«‹å®Œæˆï¼"

      - name: ğŸ“Š Verify seed results
        env:
          DATABASE_URL: ${{ secrets.DEVELOP_DATABASE_POOLER_URL }}
        run: |
          echo "ğŸ“Š é©—è­‰è³‡æ–™æ˜¯å¦æˆåŠŸå»ºç«‹..."
          cd backend
          python3 << 'PYTHON_SCRIPT'
          from database import SessionLocal
          from models import Teacher, Student, Classroom, Program, Content, ContentType

          db = SessionLocal()

          teachers = db.query(Teacher).count()
          students = db.query(Student).count()
          classrooms = db.query(Classroom).count()
          programs = db.query(Program).count()
          sentence_contents = db.query(Content).filter(Content.type == ContentType.SENTENCE_MAKING).count()

          print(f'âœ… æ•™å¸«æ•¸é‡: {teachers}')
          print(f'âœ… å­¸ç”Ÿæ•¸é‡: {students}')
          print(f'âœ… ç­ç´šæ•¸é‡: {classrooms}')
          print(f'âœ… èª²ç¨‹æ•¸é‡: {programs}')
          print(f'âœ… å¥å­æ¨¡çµ„å…§å®¹: {sentence_contents}')

          db.close()

          if sentence_contents >= 4:
              print('âœ… å¥å­æ¨¡çµ„èª²ç¨‹å»ºç«‹æˆåŠŸï¼')
          else:
              print('âš ï¸ è­¦å‘Šï¼šå¥å­æ¨¡çµ„å…§å®¹æ•¸é‡ä¸è¶³')
          PYTHON_SCRIPT
          echo ""
          echo "ğŸ‰ Seed å®Œæˆï¼å¯ä»¥ç™»å…¥ develop ç’°å¢ƒæ¸¬è©¦ï¼š"
          echo "   - æ•™å¸«: demo@duotopia.com / demo123"
          echo "   - å­¸ç”Ÿ: é¸æ“‡æ•™å¸« > é¸æ“‡ç­ç´š > é¸æ“‡å­¸ç”Ÿ"
