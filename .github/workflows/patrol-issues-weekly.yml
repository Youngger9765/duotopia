name: Weekly Issues Patrol

on:
  schedule:
    # ÊØèÈÄ±‰∏ÄÊó©‰∏ä 9:00 (UTC+8 = 01:00 UTC) Âü∑Ë°å
    - cron: '0 1 * * 1'
  workflow_dispatch:  # ÂÖÅË®±ÊâãÂãïËß∏Áôº

jobs:
  patrol:
    name: üîç Patrol Open Issues
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Patrol issues and create summary
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            sort: 'created',
            direction: 'desc'
          });

          if (issues.length === 0) {
            console.log('‚úÖ No open issues - all clear!');
            return;
          }

          // Áµ±Ë®à
          const bugs = issues.filter(i => i.labels.some(l => l.name === 'bug')).length;
          const enhancements = issues.filter(i => i.labels.some(l => l.name === 'enhancement')).length;
          const unassigned = issues.filter(i => !i.assignee).length;
          const noLabels = issues.filter(i => i.labels.length === 0).length;
          const tested = issues.filter(i => i.labels.some(l => l.name === '‚úÖ tested-in-staging')).length;
          const inProgress = issues.filter(i => i.labels.some(l => l.name === 'in progress')).length;

          // Âª∫Á´ãÊëòË¶Å
          let summary = `## üîç Weekly Issues Patrol Report

**Á∏ΩË®à**: ${issues.length} open issues

### üìä Áµ±Ë®à
- üêõ Bugs: ${bugs}
- ‚ú® Enhancements: ${enhancements}
- üë§ Unassigned: ${unassigned}
- üè∑Ô∏è No labels: ${noLabels}
- ‚úÖ Tested in staging: ${tested}
- üöß In progress: ${inProgress}

### üìã Open Issues List

`;

          // ÂàóÂá∫ÊâÄÊúâ issues
          issues.forEach(issue => {
            const labels = issue.labels.map(l => `\`${l.name}\``).join(' ');
            const assignee = issue.assignee ? `@${issue.assignee.login}` : 'Unassigned';
            const age = Math.floor((Date.now() - new Date(issue.created_at)) / (1000 * 60 * 60 * 24));

            summary += `- #${issue.number} **${issue.title}**
  - Labels: ${labels || 'None'}
  - Assignee: ${assignee}
  - Age: ${age} days
  - URL: ${issue.html_url}\n\n`;
          });

          // Ë≠¶Âëä
          if (unassigned > 0) {
            summary += `\n‚ö†Ô∏è **Warning**: ${unassigned} issues are unassigned\n`;
          }
          if (noLabels > 0) {
            summary += `‚ö†Ô∏è **Warning**: ${noLabels} issues have no labels\n`;
          }

          // Ëº∏Âá∫Âà∞ GitHub Actions summary
          await core.summary
            .addRaw(summary)
            .write();

          console.log(summary);

    - name: Check for stale preview environments
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GCP_SA_KEY }}
        script: |
          // Ê™¢Êü•ÊòØÂê¶Êúâ preview environments ÈúÄË¶ÅÊ∏ÖÁêÜ
          const { data: closedIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed',
            since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
          });

          if (closedIssues.length > 0) {
            console.log(`‚ÑπÔ∏è Found ${closedIssues.length} recently closed issues in the past 7 days`);
            console.log('Preview environments should have been auto-cleaned');
          }
