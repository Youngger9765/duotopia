name: ðŸ§¹ Cleanup Cloud Resources

on:
  # æ¯å¤©å‡Œæ™¨ 2 é»žåŸ·è¡Œï¼ˆå°ç£æ™‚é–“ï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = å°ç£æ™‚é–“ 02:00

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      keep_revisions:
        description: 'ä¿ç•™æœ€è¿‘å¹¾å€‹ revisions'
        required: false
        default: '1'  # å–®äººé–‹ç™¼ï¼Œåªä¿ç•™ 1 å€‹å°±å¤ äº†
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
      keep_images:
        description: 'ä¿ç•™æœ€è¿‘å¹¾å€‹ images'
        required: false
        default: '2'  # åªä¿ç•™ 2 å€‹ image å‚™ç”¨
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'

env:
  PROJECT_ID: duotopia-472708
  REGION: asia-east1
  REPOSITORY: duotopia-repo

jobs:
  cleanup-cloud-run:
    name: ðŸ—‘ï¸ Clean Cloud Run Revisions
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ§¹ Clean All Service Revisions
        run: |
          # è¨­å®šä¿ç•™æ•¸é‡
          KEEP_COUNT=${{ github.event.inputs.keep_revisions || '3' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent revisions per service"
          echo ""

          # æ‰€æœ‰æœå‹™åˆ—è¡¨
          services=(
            "duotopia-production-backend"
            "duotopia-production-frontend"
            "duotopia-staging-backend"
            "duotopia-staging-frontend"
          )

          total_deleted=0

          for service in "${services[@]}"; do
            echo "ðŸ“¦ Checking service: $service"

            # ç²å–æ‰€æœ‰éžæ´»èºçš„ revisions
            REVISIONS=$(gcloud run revisions list \
              --service="$service" \
              --region=${{ env.REGION }} \
              --format="value(REVISION,ACTIVE)" \
              --sort-by="~metadata.creationTimestamp" \
              2>/dev/null | grep -v "True" | awk '{print $1}' || true)

            if [ -z "$REVISIONS" ]; then
              echo "   âœ“ No inactive revisions"
              echo ""
              continue
            fi

            TOTAL=$(echo "$REVISIONS" | wc -l | tr -d ' ')
            echo "   ðŸ“Š Inactive revisions: $TOTAL"

            if [ $TOTAL -gt $KEEP_COUNT ]; then
              TO_DELETE=$(echo "$REVISIONS" | tail -n +$((KEEP_COUNT + 1)) || true)
              DELETE_COUNT=$(echo "$TO_DELETE" | wc -l | tr -d ' ')

              echo "   ðŸ—‘ï¸ Deleting $DELETE_COUNT old revisions..."

              for REVISION in $TO_DELETE; do
                if [ -n "$REVISION" ]; then
                  echo "      Deleting: $REVISION"
                  gcloud run revisions delete "$REVISION" \
                    --region=${{ env.REGION }} \
                    --quiet || echo "      âš ï¸ Failed to delete $REVISION"
                  ((total_deleted++)) || true
                fi
              done
            else
              echo "   âœ“ Within retention limit ($TOTAL revisions)"
            fi

            echo ""
          done

          echo "âœ… Cleanup complete! Deleted $total_deleted revisions across all services"

  cleanup-container-images:
    name: ðŸ³ Clean Container Images
    runs-on: ubuntu-latest
    needs: cleanup-cloud-run

    permissions:
      contents: read
      id-token: write

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ³ Clean Backend Images
        run: |
          echo "ðŸ” Checking backend container images..."

          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent images"

          # åˆ—å‡ºæ‰€æœ‰ backend images (ä½¿ç”¨æ­£ç¢ºçš„æŒ‡ä»¤)
          IMAGES=$(gcloud artifacts docker tags list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend \
            --format="value(digest)" \
            --sort-by="~timestamp" 2>/dev/null || echo "")

          if [ -z "$IMAGES" ]; then
            echo "âš ï¸ No images found or repository doesn't exist"
            exit 0
          fi

          TOTAL=$(echo "$IMAGES" | wc -l)
          echo "ðŸ“Š Total images: $TOTAL"

          if [ $TOTAL -gt $KEEP_COUNT ]; then
            TO_DELETE=$(echo "$IMAGES" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "ðŸ—‘ï¸ Deleting $DELETE_COUNT old images..."

            for DIGEST in $TO_DELETE; do
              echo "  Deleting: $DIGEST"
              IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend@sha256:$DIGEST"

              # ç›´æŽ¥åˆªé™¤æ˜ åƒï¼ˆæœƒè‡ªå‹•åˆªé™¤ç›¸é—œçš„ tagsï¼‰
              if gcloud artifacts docker images delete "${IMAGE_URI}" --delete-tags --quiet 2>&1; then
                echo "    âœ… Successfully deleted image: $DIGEST"
              else
                echo "    âš ï¸ Failed to delete image: $DIGEST"
              fi
            done

            echo "âœ… Backend images cleanup complete!"
          else
            echo "âœ… No cleanup needed. Only $TOTAL images exist."
          fi

      - name: ðŸ³ Clean Frontend Images
        run: |
          echo "ðŸ” Checking frontend container images..."

          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent images"

          # åˆ—å‡ºæ‰€æœ‰ frontend images (ä½¿ç”¨æ­£ç¢ºçš„æŒ‡ä»¤)
          IMAGES=$(gcloud artifacts docker tags list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend \
            --format="value(digest)" \
            --sort-by="~timestamp" 2>/dev/null || echo "")

          if [ -z "$IMAGES" ]; then
            echo "âš ï¸ No images found or repository doesn't exist"
            exit 0
          fi

          TOTAL=$(echo "$IMAGES" | wc -l)
          echo "ðŸ“Š Total images: $TOTAL"

          if [ $TOTAL -gt $KEEP_COUNT ]; then
            TO_DELETE=$(echo "$IMAGES" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "ðŸ—‘ï¸ Deleting $DELETE_COUNT old images..."

            for DIGEST in $TO_DELETE; do
              echo "  Deleting: $DIGEST"
              IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend@sha256:$DIGEST"

              # ç›´æŽ¥åˆªé™¤æ˜ åƒï¼ˆæœƒè‡ªå‹•åˆªé™¤ç›¸é—œçš„ tagsï¼‰
              if gcloud artifacts docker images delete "${IMAGE_URI}" --delete-tags --quiet 2>&1; then
                echo "    âœ… Successfully deleted image: $DIGEST"
              else
                echo "    âš ï¸ Failed to delete image: $DIGEST"
              fi
            done

            echo "âœ… Frontend images cleanup complete!"
          else
            echo "âœ… No cleanup needed. Only $TOTAL images exist."
          fi

  summary:
    name: ðŸ“Š Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-cloud-run, cleanup-container-images]
    if: always()

    steps:
      - name: ðŸ“ Generate Summary
        run: |
          echo "## ðŸ§¹ Cloud Resources Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Keep Revisions: ${{ github.event.inputs.keep_revisions || '3' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Keep Images: ${{ github.event.inputs.keep_images || '5' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost Savings" >> $GITHUB_STEP_SUMMARY
          echo "- Cloud Run: Reduced idle instances" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: Freed up container registry space" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Cleanup completed successfully!" >> $GITHUB_STEP_SUMMARY
