name: ðŸ§¹ Cleanup Cloud Resources

on:
  # æ¯å¤©å‡Œæ™¨ 2 é»žåŸ·è¡Œï¼ˆå°ç£æ™‚é–“ï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = å°ç£æ™‚é–“ 02:00

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      keep_revisions:
        description: 'ä¿ç•™æœ€è¿‘å¹¾å€‹ revisions'
        required: false
        default: '1'  # å–®äººé–‹ç™¼ï¼Œåªä¿ç•™ 1 å€‹å°±å¤ äº†
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
      keep_images:
        description: 'ä¿ç•™æœ€è¿‘å¹¾å€‹ images'
        required: false
        default: '2'  # åªä¿ç•™ 2 å€‹ image å‚™ç”¨
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'

env:
  PROJECT_ID: duotopia-469413
  REGION: asia-east1
  REPOSITORY: duotopia-repo

jobs:
  cleanup-cloud-run:
    name: ðŸ—‘ï¸ Clean Cloud Run Revisions
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ§¹ Clean Backend Revisions
        run: |
          echo "ðŸ” Checking backend revisions..."

          # è¨­å®šä¿ç•™æ•¸é‡
          KEEP_COUNT=${{ github.event.inputs.keep_revisions || '1' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent revisions"

          # ç²å–æ‰€æœ‰ revisionsï¼ŒæŒ‰æ™‚é–“æŽ’åº
          REVISIONS=$(gcloud run revisions list \
            --service=duotopia-staging-backend \
            --region=${{ env.REGION }} \
            --format="value(name)" \
            --sort-by="~creationTimestamp")

          # è¨ˆç®—ç¸½æ•¸
          TOTAL=$(echo "$REVISIONS" | wc -l)
          echo "ðŸ“Š Total revisions: $TOTAL"

          if [ $TOTAL -gt $KEEP_COUNT ]; then
            # è·³éŽæœ€æ–°çš„ N å€‹ï¼Œåˆªé™¤å…¶é¤˜çš„
            TO_DELETE=$(echo "$REVISIONS" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "ðŸ—‘ï¸ Deleting $DELETE_COUNT old revisions..."

            for REVISION in $TO_DELETE; do
              echo "  Deleting: $REVISION"
              gcloud run revisions delete $REVISION \
                --region=${{ env.REGION }} \
                --quiet || echo "  âš ï¸ Failed to delete $REVISION"
            done

            echo "âœ… Backend cleanup complete! Deleted $DELETE_COUNT revisions"
          else
            echo "âœ… No cleanup needed. Only $TOTAL revisions exist."
          fi

      - name: ðŸ§¹ Clean Frontend Revisions
        run: |
          echo "ðŸ” Checking frontend revisions..."

          KEEP_COUNT=${{ github.event.inputs.keep_revisions || '3' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent revisions"

          REVISIONS=$(gcloud run revisions list \
            --service=duotopia-staging-frontend \
            --region=${{ env.REGION }} \
            --format="value(name)" \
            --sort-by="~creationTimestamp")

          TOTAL=$(echo "$REVISIONS" | wc -l)
          echo "ðŸ“Š Total revisions: $TOTAL"

          if [ $TOTAL -gt $KEEP_COUNT ]; then
            TO_DELETE=$(echo "$REVISIONS" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "ðŸ—‘ï¸ Deleting $DELETE_COUNT old revisions..."

            for REVISION in $TO_DELETE; do
              echo "  Deleting: $REVISION"
              gcloud run revisions delete $REVISION \
                --region=${{ env.REGION }} \
                --quiet || echo "  âš ï¸ Failed to delete $REVISION"
            done

            echo "âœ… Frontend cleanup complete! Deleted $DELETE_COUNT revisions"
          else
            echo "âœ… No cleanup needed. Only $TOTAL revisions exist."
          fi

  cleanup-container-images:
    name: ðŸ³ Clean Container Images
    runs-on: ubuntu-latest
    needs: cleanup-cloud-run

    permissions:
      contents: read
      id-token: write

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ³ Clean Backend Images
        run: |
          echo "ðŸ” Checking backend container images..."

          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent images"

          # åˆ—å‡ºæ‰€æœ‰ backend images (ä½¿ç”¨ digest æ ¼å¼)
          IMAGES=$(gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/duotopia-staging-backend \
            --format="value(version)" \
            --sort-by="~createTime" 2>/dev/null || echo "")

          if [ -z "$IMAGES" ]; then
            echo "âš ï¸ No images found or repository doesn't exist"
            exit 0
          fi

          TOTAL=$(echo "$IMAGES" | wc -l)
          echo "ðŸ“Š Total images: $TOTAL"

          if [ $TOTAL -gt $KEEP_COUNT ]; then
            TO_DELETE=$(echo "$IMAGES" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "ðŸ—‘ï¸ Deleting $DELETE_COUNT old images..."

            for VERSION in $TO_DELETE; do
              echo "  Deleting: $VERSION"
              # æ³¨æ„ï¼šversion æ¬„ä½è¿”å›žçš„æ˜¯ sha256:xxx æ ¼å¼ï¼Œéœ€è¦ç”¨ @ ç¬¦è™Ÿ
              # å…ˆåˆªé™¤ tagsï¼Œå†åˆªé™¤ digest
              IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/duotopia-staging-backend"

              # ç²å–æ‰€æœ‰ tags - é€éŽ grep éŽæ¿¾ç‰¹å®šç‰ˆæœ¬çš„ tags
              TAGS=$(gcloud artifacts docker tags list "${IMAGE_URI}" --format="table(tag,version)" 2>/dev/null | grep "${VERSION}" | awk '{print $1}' || echo "")

              # åˆªé™¤æ‰€æœ‰ tags
              if [ -n "$TAGS" ]; then
                for TAG in $TAGS; do
                  echo "    Removing tag: $TAG"
                  gcloud artifacts docker tags delete "${IMAGE_URI}:${TAG}" --quiet || true
                done
              fi

              # åˆªé™¤ digest
              gcloud artifacts docker images delete "${IMAGE_URI}@${VERSION}" \
                --quiet || echo "  âš ï¸ Failed to delete $VERSION"
            done

            echo "âœ… Backend images cleanup complete!"
          else
            echo "âœ… No cleanup needed. Only $TOTAL images exist."
          fi

      - name: ðŸ³ Clean Frontend Images
        run: |
          echo "ðŸ” Checking frontend container images..."

          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "ðŸ“Œ Will keep $KEEP_COUNT most recent images"

          # åˆ—å‡ºæ‰€æœ‰ frontend images (ä½¿ç”¨ digest æ ¼å¼)
          IMAGES=$(gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/duotopia-staging-frontend \
            --format="value(version)" \
            --sort-by="~createTime" 2>/dev/null || echo "")

          if [ -z "$IMAGES" ]; then
            echo "âš ï¸ No images found or repository doesn't exist"
            exit 0
          fi

          TOTAL=$(echo "$IMAGES" | wc -l)
          echo "ðŸ“Š Total images: $TOTAL"

          if [ $TOTAL -gt $KEEP_COUNT ]; then
            TO_DELETE=$(echo "$IMAGES" | tail -n +$((KEEP_COUNT + 1)))
            DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

            echo "ðŸ—‘ï¸ Deleting $DELETE_COUNT old images..."

            for VERSION in $TO_DELETE; do
              echo "  Deleting: $VERSION"
              # æ³¨æ„ï¼šversion æ¬„ä½è¿”å›žçš„æ˜¯ sha256:xxx æ ¼å¼ï¼Œéœ€è¦ç”¨ @ ç®†è™Ÿ
              # å…ˆåˆªé™¤ tagsï¼Œå†åˆªé™¤ digest
              IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/duotopia-staging-frontend"

              # ç²å–æ‰€æœ‰ tags - é€éŽ grep éŽæ¿¾ç‰¹å®šç‰ˆæœ¬çš„ tags
              TAGS=$(gcloud artifacts docker tags list "${IMAGE_URI}" --format="table(tag,version)" 2>/dev/null | grep "${VERSION}" | awk '{print $1}' || echo "")

              # åˆªé™¤æ‰€æœ‰ tags
              if [ -n "$TAGS" ]; then
                for TAG in $TAGS; do
                  echo "    Removing tag: $TAG"
                  gcloud artifacts docker tags delete "${IMAGE_URI}:${TAG}" --quiet || true
                done
              fi

              # åˆªé™¤ digest
              gcloud artifacts docker images delete "${IMAGE_URI}@${VERSION}" \
                --quiet || echo "  âš ï¸ Failed to delete $VERSION"
            done

            echo "âœ… Frontend images cleanup complete!"
          else
            echo "âœ… No cleanup needed. Only $TOTAL images exist."
          fi

  summary:
    name: ðŸ“Š Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-cloud-run, cleanup-container-images]
    if: always()

    steps:
      - name: ðŸ“ Generate Summary
        run: |
          echo "## ðŸ§¹ Cloud Resources Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Keep Revisions: ${{ github.event.inputs.keep_revisions || '3' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Keep Images: ${{ github.event.inputs.keep_images || '5' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost Savings" >> $GITHUB_STEP_SUMMARY
          echo "- Cloud Run: Reduced idle instances" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: Freed up container registry space" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Cleanup completed successfully!" >> $GITHUB_STEP_SUMMARY
