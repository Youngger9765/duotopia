name: üßπ Cleanup Cloud Resources

on:
  # ÊØèÂ§©ÂáåÊô® 2 ÈªûÂü∑Ë°åÔºàÂè∞ÁÅ£ÊôÇÈñìÔºâ
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = Âè∞ÁÅ£ÊôÇÈñì 02:00

  # ÂÖÅË®±ÊâãÂãïËß∏Áôº
  workflow_dispatch:
    inputs:
      keep_revisions:
        description: '‰øùÁïôÊúÄËøëÂπæÂÄã revisions'
        required: false
        default: '1'  # ÂñÆ‰∫∫ÈñãÁôºÔºåÂè™‰øùÁïô 1 ÂÄãÂ∞±Â§†‰∫Ü
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'
      keep_images:
        description: '‰øùÁïôÊúÄËøëÂπæÂÄã images'
        required: false
        default: '2'  # Âè™‰øùÁïô 2 ÂÄã image ÂÇôÁî®
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '5'

env:
  PROJECT_ID: duotopia-472708
  REGION: asia-east1
  REPOSITORY: duotopia-repo

jobs:
  cleanup-cloud-run:
    name: üóëÔ∏è Clean Cloud Run Revisions
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üßπ Clean All Service Revisions
        run: |
          # Ë®≠ÂÆö‰øùÁïôÊï∏Èáè
          KEEP_COUNT=${{ github.event.inputs.keep_revisions || '3' }}
          echo "üìå Will keep $KEEP_COUNT most recent revisions per service"
          echo ""

          # ÊâÄÊúâÊúçÂãôÂàóË°®
          services=(
            "duotopia-production-backend"
            "duotopia-production-frontend"
            "duotopia-staging-backend"
            "duotopia-staging-frontend"
          )

          total_deleted=0

          for service in "${services[@]}"; do
            echo "üì¶ Checking service: $service"

            # Áç≤ÂèñÊâÄÊúâÈùûÊ¥ªË∫çÁöÑ revisions
            REVISIONS=$(gcloud run revisions list \
              --service="$service" \
              --region=${{ env.REGION }} \
              --format="value(REVISION,ACTIVE)" \
              --sort-by="~metadata.creationTimestamp" \
              2>/dev/null | grep -v "True" | awk '{print $1}' || true)

            if [ -z "$REVISIONS" ]; then
              echo "   ‚úì No inactive revisions"
              echo ""
              continue
            fi

            TOTAL=$(echo "$REVISIONS" | wc -l | tr -d ' ')
            echo "   üìä Inactive revisions: $TOTAL"

            if [ $TOTAL -gt $KEEP_COUNT ]; then
              TO_DELETE=$(echo "$REVISIONS" | tail -n +$((KEEP_COUNT + 1)) || true)
              DELETE_COUNT=$(echo "$TO_DELETE" | wc -l | tr -d ' ')

              echo "   üóëÔ∏è Deleting $DELETE_COUNT old revisions..."

              for REVISION in $TO_DELETE; do
                if [ -n "$REVISION" ]; then
                  echo "      Deleting: $REVISION"
                  gcloud run revisions delete "$REVISION" \
                    --region=${{ env.REGION }} \
                    --quiet || echo "      ‚ö†Ô∏è Failed to delete $REVISION"
                  ((total_deleted++)) || true
                fi
              done
            else
              echo "   ‚úì Within retention limit ($TOTAL revisions)"
            fi

            echo ""
          done

          echo "‚úÖ Cleanup complete! Deleted $total_deleted revisions across all services"

  cleanup-container-images:
    name: üê≥ Clean Container Images
    runs-on: ubuntu-latest
    needs: cleanup-cloud-run

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üê≥ Clean Production & Staging Images
        run: |
          echo "üîç Cleaning production and staging container images..."

          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "üìå Will keep $KEEP_COUNT most recent images per service"
          echo ""

          # Services to clean
          services=(
            "duotopia-production-backend"
            "duotopia-production-frontend"
            "duotopia-staging-backend"
            "duotopia-staging-frontend"
          )

          total_deleted=0

          for service in "${services[@]}"; do
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Service: $service"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            FULL_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${service}"

            # Get digests sorted by CREATE_TIME (newest first)
            DIGESTS=$(gcloud artifacts docker images list "${FULL_PATH}" \
              --sort-by="~CREATE_TIME" 2>&1 | grep "sha256:" | awk '{print $2}' || true)

            if [ -z "$DIGESTS" ]; then
              echo "   ‚ÑπÔ∏è  No images found"
              echo ""
              continue
            fi

            TOTAL=$(echo "$DIGESTS" | wc -l | tr -d ' ')
            echo "   üìä Total images: $TOTAL"

            if [ "$TOTAL" -le "$KEEP_COUNT" ]; then
              echo "   ‚úÖ Already optimal ($TOTAL <= $KEEP_COUNT)"
              echo ""
              continue
            fi

            # Keep the first KEEP_COUNT, delete the rest
            DELETE_DIGESTS=$(echo "$DIGESTS" | tail -n +"$((KEEP_COUNT + 1))")
            DELETE_COUNT=$(echo "$DELETE_DIGESTS" | wc -l | tr -d ' ')

            echo "   ‚úÖ Keeping $KEEP_COUNT newest image(s)"
            echo "   üóëÔ∏è  Deleting $DELETE_COUNT old image(s)..."

            echo "$DELETE_DIGESTS" | while read -r digest; do
              if [ -n "$digest" ]; then
                IMAGE_URI="${FULL_PATH}@${digest}"
                short_digest="${digest:7:12}"
                echo "      Deleting: ${short_digest}..."

                if gcloud artifacts docker images delete "${IMAGE_URI}" --delete-tags --quiet 2>&1; then
                  echo "         ‚úÖ Deleted"
                  total_deleted=$((total_deleted + 1))
                else
                  echo "         ‚ö†Ô∏è  Failed"
                fi
              fi
            done

            echo ""
          done

          echo "‚úÖ Production & Staging images cleanup complete!"
          echo "   Total deleted: $total_deleted images"

  cleanup-preview-images:
    name: üß™ Clean Preview-Issue Images
    runs-on: ubuntu-latest
    needs: cleanup-container-images

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üß™ Clean Preview-Issue Images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "========================================="
          echo "üß™ Preview-Issue Images Cleanup"
          echo "========================================="
          echo ""

          KEEP_COUNT=1  # Keep only the latest version for preview environments
          REGISTRY="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}"

          # Get list of open issues from GitHub
          echo "üìã Fetching open issues from GitHub..."
          OPEN_ISSUES=$(gh issue list --state open --json number --jq '.[].number' | sort -n || echo "")

          if [ -z "$OPEN_ISSUES" ]; then
            echo "‚ÑπÔ∏è  No open issues found"
            exit 0
          fi

          echo "üìå Open issues: $(echo $OPEN_ISSUES | tr '\n' ' ')"
          echo ""

          # Get all preview-issue packages
          echo "üîç Scanning all preview-issue images..."
          ALL_PACKAGES=$(gcloud artifacts docker images list \
            ${REGISTRY} \
            --include-tags \
            --format="value(package)" 2>&1 | \
            grep "preview-issue" | \
            sort -u || true)

          if [ -z "$ALL_PACKAGES" ]; then
            echo "‚ÑπÔ∏è  No preview-issue images found"
            exit 0
          fi

          total_deleted=0
          total_kept=0

          # Extract issue numbers from packages and process
          for package in $ALL_PACKAGES; do
            # Extract issue number from package name (e.g., duotopia-preview-issue-26-backend)
            issue_num=$(echo "$package" | sed -n 's/.*preview-issue-\([0-9]\+\)-.*/\1/p')

            if [ -z "$issue_num" ]; then
              continue
            fi

            # Check if issue is still open
            if echo "$OPEN_ISSUES" | grep -q "^${issue_num}$"; then
              # Issue is open - keep latest KEEP_COUNT versions
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üì¶ Issue #${issue_num} (OPEN) - $(basename $package)"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

              # Get digests sorted by CREATE_TIME (newest first)
              DIGESTS=$(gcloud artifacts docker images list "${package}" \
                --sort-by="~CREATE_TIME" 2>&1 | grep "sha256:" | awk '{print $2}' || true)

              if [ -z "$DIGESTS" ]; then
                echo "   ‚ÑπÔ∏è  No images found"
                echo ""
                continue
              fi

              TOTAL=$(echo "$DIGESTS" | wc -l | tr -d ' ')
              echo "   üìä Total images: $TOTAL"

              if [ "$TOTAL" -le "$KEEP_COUNT" ]; then
                echo "   ‚úÖ Already optimal ($TOTAL <= $KEEP_COUNT)"
                total_kept=$((total_kept + TOTAL))
                echo ""
                continue
              fi

              # Keep the first KEEP_COUNT, delete the rest
              DELETE_DIGESTS=$(echo "$DIGESTS" | tail -n +"$((KEEP_COUNT + 1))")
              DELETE_COUNT=$(echo "$DELETE_DIGESTS" | wc -l | tr -d ' ')

              echo "   ‚úÖ Keeping $KEEP_COUNT newest image(s)"
              echo "   üóëÔ∏è  Deleting $DELETE_COUNT old image(s)..."

              total_kept=$((total_kept + KEEP_COUNT))

              echo "$DELETE_DIGESTS" | while read -r digest; do
                if [ -n "$digest" ]; then
                  IMAGE_URI="${package}@${digest}"
                  short_digest="${digest:7:12}"
                  echo "      Deleting: ${short_digest}..."

                  if gcloud artifacts docker images delete "${IMAGE_URI}" --delete-tags --quiet 2>&1; then
                    echo "         ‚úÖ Deleted"
                    total_deleted=$((total_deleted + 1))
                  else
                    echo "         ‚ö†Ô∏è  Failed"
                  fi
                fi
              done

              echo ""
            else
              # Issue is closed - delete ALL versions
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "üóëÔ∏è  Issue #${issue_num} (CLOSED) - $(basename $package)"
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

              # Get all digests
              DIGESTS=$(gcloud artifacts docker images list "${package}" \
                --sort-by="~CREATE_TIME" 2>&1 | grep "sha256:" | awk '{print $2}' || true)

              if [ -z "$DIGESTS" ]; then
                echo "   ‚ÑπÔ∏è  No images found"
                echo ""
                continue
              fi

              TOTAL=$(echo "$DIGESTS" | wc -l | tr -d ' ')
              echo "   üìä Total images: $TOTAL"
              echo "   üóëÔ∏è  Deleting all $TOTAL image(s)..."

              echo "$DIGESTS" | while read -r digest; do
                if [ -n "$digest" ]; then
                  IMAGE_URI="${package}@${digest}"
                  short_digest="${digest:7:12}"
                  echo "      Deleting: ${short_digest}..."

                  if gcloud artifacts docker images delete "${IMAGE_URI}" --delete-tags --quiet 2>&1; then
                    echo "         ‚úÖ Deleted"
                    total_deleted=$((total_deleted + 1))
                  else
                    echo "         ‚ö†Ô∏è  Failed"
                  fi
                fi
              done

              echo ""
            fi
          done

          echo "========================================="
          echo "‚úÖ Preview-Issue Images Cleanup Complete!"
          echo "========================================="
          echo "üìä Summary:"
          echo "   - Total deleted: $total_deleted images"
          echo "   - Total kept: $total_kept images"
          echo ""

  summary:
    name: üìä Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-cloud-run, cleanup-container-images, cleanup-preview-images]
    if: always()

    steps:
      - name: üìù Generate Summary
        run: |
          echo "## üßπ Cloud Resources Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÖ Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Keep Revisions: ${{ github.event.inputs.keep_revisions || '3' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Keep Images: ${{ github.event.inputs.keep_images || '5' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí∞ Cost Savings" >> $GITHUB_STEP_SUMMARY
          echo "- Cloud Run: Reduced idle instances" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: Freed up container registry space" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Cleanup completed successfully!" >> $GITHUB_STEP_SUMMARY
