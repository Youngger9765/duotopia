name: Issue Approval Automation

on:
  issue_comment:
    types: [created]

jobs:
  handle-approval:
    # åªåœ¨ open issues ä¸”æœ‰ç‰¹å®š label æ™‚è§¸ç™¼
    if: |
      github.event.issue.state == 'open' &&
      (contains(github.event.comment.body, 'æ¸¬è©¦é€šé') ||
       contains(github.event.comment.body, 'approved') ||
       contains(github.event.comment.body, 'âœ…') ||
       contains(github.event.comment.body, 'LGTM'))

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if commenter is case owner
        id: check-owner
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æª¢æŸ¥ç•™è¨€è€…æ˜¯å¦ç‚º kaddy-eunice æˆ–å…¶ä»– case owner
          COMMENTER="${{ github.event.comment.user.login }}"

          # å¯ä»¥æ“´å±•åˆ°å¾ issue assignee åˆ¤æ–·
          if [[ "$COMMENTER" == "kaddy-eunice" ]] || \
             [[ "$COMMENTER" == "Youngger9765" ]]; then
            echo "is_owner=true" >> $GITHUB_OUTPUT
            echo "âœ… Commenter $COMMENTER is a case owner"
          else
            echo "is_owner=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Commenter $COMMENTER is not a case owner"
          fi

      - name: Add approval label
        if: steps.check-owner.outputs.is_owner == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # åŠ ä¸Š "âœ… tested-in-staging" label
          gh issue edit $ISSUE_NUMBER --add-label "âœ… tested-in-staging"

          echo "âœ… Added 'tested-in-staging' label to Issue #${ISSUE_NUMBER}"

      - name: Find associated Release PR
        if: steps.check-owner.outputs.is_owner == 'true'
        id: find-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"

          # æŸ¥æ‰¾åŒ…å«æ­¤ issue çš„ Draft PR (staging â†’ main)
          PR_NUMBER=$(gh pr list \
            --state open \
            --draft \
            --base main \
            --head staging \
            --json number,body \
            --jq ".[] | select(.body | contains(\"#${ISSUE_NUMBER}\")) | .number" | head -1)

          if [ -n "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            echo "âœ… Found Release PR #${PR_NUMBER}"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No Release PR found for Issue #${ISSUE_NUMBER}"
          fi

      - name: Check if all issues are approved
        if: |
          steps.check-owner.outputs.is_owner == 'true' &&
          steps.find-pr.outputs.found == 'true'
        id: check-all-approved
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find-pr.outputs.pr_number }}"

          # å¾ PR body æŠ½å–æ‰€æœ‰ issue numbers
          ISSUES=$(gh pr view $PR_NUMBER --json body --jq '.body' | grep -oE '#[0-9]+' | sed 's/#//' | sort -u)

          echo "ğŸ“‹ Issues in PR #${PR_NUMBER}:"
          echo "$ISSUES"

          ALL_APPROVED=true
          for ISSUE in $ISSUES; do
            # æª¢æŸ¥æ¯å€‹ issue æ˜¯å¦æœ‰ "tested-in-staging" label
            HAS_LABEL=$(gh issue view $ISSUE --json labels --jq '.labels[].name' | grep -c "âœ… tested-in-staging" || true)

            if [ "$HAS_LABEL" -eq 0 ]; then
              echo "âŒ Issue #${ISSUE} not yet approved"
              ALL_APPROVED=false
            else
              echo "âœ… Issue #${ISSUE} approved"
            fi
          done

          if [ "$ALL_APPROVED" = true ]; then
            echo "all_approved=true" >> $GITHUB_OUTPUT
            echo "âœ… All issues in PR #${PR_NUMBER} are approved!"
          else
            echo "all_approved=false" >> $GITHUB_OUTPUT
            echo "â³ Some issues still need approval"
          fi

      - name: Mark Release PR as ready
        if: |
          steps.check-owner.outputs.is_owner == 'true' &&
          steps.find-pr.outputs.found == 'true' &&
          steps.check-all-approved.outputs.all_approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find-pr.outputs.pr_number }}"

          # æ¨™è¨˜ PR ç‚º Ready for review
          gh pr ready $PR_NUMBER

          # åŠ ä¸Šè©•è«–
          gh pr comment $PR_NUMBER --body "ğŸ‰ æ‰€æœ‰ issues å·²åœ¨ staging æ¸¬è©¦é€šéï¼æ­¤ PR å·²æ¨™è¨˜ç‚º Ready for reviewã€‚

**ä¸‹ä¸€æ­¥**ï¼šè«‹ review ä»£ç¢¼å¾Œ merge åˆ° main é€²è¡Œç”Ÿç”¢éƒ¨ç½²ã€‚"

          echo "âœ… PR #${PR_NUMBER} marked as ready for review!"

      - name: Add approval comment to issue
        if: steps.check-owner.outputs.is_owner == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          COMMENTER="${{ github.event.comment.user.login }}"

          gh issue comment $ISSUE_NUMBER --body "âœ… **@${COMMENTER} å·²æ‰¹å‡†æ­¤ä¿®å¾©**

- âœ… Staging æ¸¬è©¦é€šé
- ğŸ·ï¸ å·²åŠ ä¸Š \`tested-in-staging\` label
- ğŸ“¦ ç­‰å¾… Release PR å®Œæˆå…¶ä»– issues æ¸¬è©¦å¾Œéƒ¨ç½²åˆ° production

æ„Ÿè¬æ¸¬è©¦ï¼ğŸ™"

          echo "âœ… Added approval comment to Issue #${ISSUE_NUMBER}"
