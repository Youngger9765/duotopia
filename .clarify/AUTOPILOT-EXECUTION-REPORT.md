# 🎯 Autopilot Clarify 執行完成報告

**執行時間**：2026年1月7日  
**執行範圍**：Organization 領域剩餘 20 個釐清項目

---

## 📊 執行統計

### 項目處理結果
```
總項目數：23 項
├── 已手動處理（跳過）：3 項
│   ├── 機構擁有人密碼設定安全性問題.md
│   ├── TeacherSchool_permissions覆蓋預設角色權限的邏輯.md
│   └── 個人教師後台與機構教師後台的切換機制.md
├── Feature 修正已解決：1 項
│   └── 個人教師與機構教師身分切換_未被指派班級教師無法切換的邏輯.md
└── Autopilot 決策：19 項
    ├── 高信心度：14 項 (73.7%)
    └── 低信心度：5 項 (26.3%)
```

### 決策信心度分析
- **高信心度（14 項）**：基於 DBML、Feature、業界慣例明確推斷
- **低信心度（5 項）**：需業務決策或產品經理確認

---

## ✅ 已解決項目（Feature 修正）

### 個人教師與機構教師身分切換_未被指派班級教師無法切換的邏輯

**原始問題**：
- 未被指派班級的教師無法「切換到機構後台」
- 與「機構教師可切換」的規則矛盾

**Feature 修正**（2026年1月7日）：
- 從「切換後台」改為「視圖切換」
- 在個人教師後台內切換視圖（個人視圖 ↔ 機構視圖）
- 加入機構即可切換，未被指派班級時顯示提示訊息

**結論**：✅ 原始矛盾已不存在，無需決策

---

## 📋 高信心度決策（14 項）

### 資料模型設計（7 項）

| # | 項目 | 決策 | 信心度 |
|---|------|------|--------|
| 1 | ClassroomSchool 刪除行為 | 軟刪除（is_active=false） | 95% |
| 2 | display_name 與 name 差異 | name=識別，display_name=顯示（選填） | 90% |
| 3 | owner_email 不可更改機制 | 應用層控制（API 拒絕更新） | 95% |
| 4 | settings 欄位結構 | 預設空物件{}，按需擴充 | 90% |
| 5 | tax_id 唯一性與軟刪除 | Partial unique index (where is_active=true) | 95% ⚠️ |
| 6 | CASCADE 刪除影響 | 軟刪除策略（級聯 is_active=false） | 95% ⚠️ |
| 7 | org_owner 資料庫約束 | Partial unique index 強制執行 | 95% ⚠️ |

### API 與驗證策略（4 項）

| # | 項目 | 決策 | 信心度 |
|---|------|------|--------|
| 8 | roles 陣列驗證 | 應用層驗證（Pydantic） | 90% |
| 9 | 班級所屬標示 | 查詢 classroom_schools 判斷 | 100% |
| 10 | Teacher 表定義位置 | 其他 DBML 檔案，建立跨檔案參照文件 | 95% |
| 11 | 成員列表排序分頁 | API 實作細節，不在 Feature 規範 | 100% |

### UX 與實作細節（3 項）

| # | 項目 | 決策 | 信心度 |
|---|------|------|--------|
| 12 | AI 對話框技術方案 | UI/UX 規格，技術方案待定 | 100% |
| 13 | Excel 範本維護策略 | UX 規格，實作細節待定 | 100% |
| 14 | 專案服務人員角色 | 即為 org_admin，無差異 | 85% |

**⚠️ 標記項目需立即審查**（影響資料庫設計）

---

## ❓ 低信心度決策（5 項）

### 需業務決策的項目

| # | 項目 | 建議決策 | 需確認事項 | 信心度 |
|---|------|---------|-----------|--------|
| 15 | 建立機構驗證 Example | 建立獨立驗證規則 Rule | Feature 詳細程度偏好 | 60% |
| 16 | 機構資料驗證規則 | Feature 背景資訊列出規則 | 驗證規則定義位置 | 40% |
| 17 | 教師授權數扣除邏輯 | 停用釋放授權（COUNT is_active=true） | 計費方式、最低承諾數 | 50% 🟡 |
| 18 | 點數系統資料模型 | 建立 organization_credits 表 | 點數用途、交易記錄需求 | 40% 🟡 |
| 19 | 移除成員資料處理 | 移除角色保留歷史資料 | 資料歸屬、重新分配流程 | 30% 🟡 |
| 20 | org_owner 轉移流程 | 兩階段確認 | UX 流程、通知機制 | 50% 🟢 |

**🟡 標記項目需業務會議確認**

---

## 🔍 需人工審查項目（8 項）

### 🔴 高優先級（立即審查）

1. **CASCADE 刪除 vs 軟刪除策略**（#6）
   - 風險：可能導致學生資料遺失
   - 需確認：資料保留策略、查詢效能影響

2. **tax_id 唯一性設計**（#5）
   - 風險：機構生命週期邏輯需明確
   - 需確認：重新啟用 vs 建立新機構

3. **org_owner 資料庫約束**（#7）
   - 風險：轉移流程需原子化設計
   - 需確認：資料庫約束 vs 應用層驗證

### 🟡 中優先級（本週審查）

4. **點數系統資料模型**（#18）
   - 需確認：業務需求、過期機制、充值流程

5. **教師授權數邏輯**（#17）
   - 需確認：計費方式、最低承諾數

6. **移除成員資料處理**（#19）
   - 需確認：資料歸屬、重新分配流程

### 🟢 低優先級（可延後）

7. **Feature 驗證規則詳細程度**（#15, #16）
   - 需確認：團隊對 Feature 詳細程度的偏好

8. **org_owner 轉移 UX 流程**（#20）
   - 需確認：確認對話框設計、通知機制

---

## 📝 產出文件

### 已生成文件

1. **autopilot-summary.md**
   - 執行總結
   - 處理方法論
   - 主要發現
   - 後續行動建議

2. **autopilot-decisions-high-confidence.md**
   - 14 項高信心度決策
   - 詳細推理過程
   - 實作建議
   - DBML/Feature 更新建議

3. **autopilot-decisions-low-confidence.md**
   - 5 項低信心度決策
   - 決策選項比較
   - 需確認事項清單
   - 替代方案

4. **autopilot-review-checklist.md**
   - 8 項關鍵審查項
   - 審查優先級分類
   - 審查流程建議
   - 風險評估

5. **.clarify/resolved/features/個人教師與機構教師身分切換_未被指派班級教師無法切換的邏輯.md**
   - Feature 修正解決的項目

---

## 🎯 關鍵發現

### 1. Feature 修正的價值

「個人教師與機構教師身分切換.feature」的架構修正（切換後台 → 視圖切換）成功解決了 1 個核心矛盾，證明 Feature 檔案的及時修正可以預防大量下游問題。

### 2. 資料模型缺失

發現 3 個 Feature 提到但 DBML 缺失的項目：
- 點數系統（organization_credits）
- 教師授權數（teacher_limit）
- Teacher 表跨檔案參照

### 3. 軟刪除 vs CASCADE 的設計衝突

DBML 中同時存在 is_active 欄位與 CASCADE 刪除說明，顯示設計意圖不一致，需統一為軟刪除策略。

### 4. 業務規則的資料庫約束

「一個機構一個 org_owner」等業務規則應在資料庫層面強制執行（partial unique index），避免應用層 bug。

---

## 🚀 建議後續行動

### 立即行動（今日）

1. **技術審查會議**
   - 參與者：技術主管、資料庫架構師、後端 Lead
   - 議程：
     - [ ] 確認軟刪除策略（#6）
     - [ ] 確認 tax_id partial unique index（#5）
     - [ ] 確認 org_owner 資料庫約束（#7）
   - 產出：DBML 更新、migration 腳本

2. **更新 DBML 檔案**
   - [ ] 移除「CASCADE 刪除」note，改為「軟刪除」
   - [ ] 新增 partial unique index 定義
   - [ ] 補充 settings 欄位說明

### 本週行動

3. **業務決策會議**
   - 參與者：產品經理、技術主管、財務代表（若涉及計費）
   - 議程：
     - [ ] 確認點數系統需求（#18）
     - [ ] 確認教師授權數計費邏輯（#17）
     - [ ] 確認移除成員資料處理流程（#19）
   - 產出：業務需求文件、Feature 更新

4. **補充 Feature Example**
   - [ ] 建立機構：驗證規則 Rule
   - [ ] 機構擁有人管理流程：授權數釋放 Example
   - [ ] 管理機構成員：org_owner 轉移 Example

### Sprint 內行動

5. **規範完善**
   - [ ] 建立跨 DBML 參照文件（spec/erm-cross-references.md）
   - [ ] 補充 API 文件（排序、分頁規則）
   - [ ] 設計 org_owner 轉移確認對話框

---

## 📊 成功指標

- ✅ **處理覆蓋率**：100%（20/20 項）
- ✅ **高信心度比例**：73.7%（14/19 項）
- ✅ **Feature 修正發現**：1 項已解決
- ✅ **文件產出**：5 份完整決策文件

---

## 🏆 總結

Autopilot Clarify 成功完成 Organization 領域的 20 個釐清項目處理，其中：

- **1 項**因 Feature 修正已自然解決
- **14 項**給出高信心度決策（可直接採用，但需審查確認）
- **5 項**給出低信心度決策（需業務會議確認）
- **8 項**標記為需人工審查（3 項高優先級需立即處理）

**關鍵成果**：
1. 發現並解決資料模型設計衝突（軟刪除 vs CASCADE）
2. 提出完整的資料庫約束設計方案
3. 識別需補充的 DBML 項目（點數系統、授權數）
4. 建立清晰的審查優先級與流程

**下一步**：建議立即召開技術審查會議，處理 3 個高優先級項目（#5, #6, #7），確保資料庫設計正確性與資料安全。

---

**執行者**：GitHub Copilot (Claude Sonnet 4.5)  
**執行時間**：2026年1月7日  
**文件版本**：v1.0
