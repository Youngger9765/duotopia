# Autopilot 審查檢查清單

**目的**：列出需要技術主管或架構師審查的關鍵決策項目

---

## 審查優先級分類

### 🔴 高優先級（立即審查）- 3 項
影響系統核心設計、資料安全、業務邏輯

### 🟡 中優先級（本週審查）- 3 項
影響資料模型設計、API 設計

### 🟢 低優先級（可延後）- 2 項
主要為規範完整性，不阻礙開發

---

## 🔴 高優先級審查項

### 1. CASCADE 刪除 vs 軟刪除策略 ⚠️

**項目編號**：#6 (School_CASCADE刪除對班級學生的影響)

**Autopilot 決策**：選項 C - 軟刪除策略（設定 is_active=false）

**決策理由**：
- DBML 所有表都設計了 is_active 欄位
- 保留學生學習歷史資料
- 符合教育系統業界標準

**需要審查的問題**：
- [ ] 確認軟刪除策略是否符合系統設計原則？
- [ ] DBML 中的「CASCADE 刪除」note 是否應修正為「級聯軟刪除」？
- [ ] 是否需要保留硬刪除功能（資料清理用）？
- [ ] 軟刪除的查詢效能影響（is_active 過濾）？

**風險評估**：
- 🔴 **高風險**：若採用硬刪除，可能導致學生學習資料永久遺失
- 影響範圍：organizations → schools → classroom_schools → classrooms → students

**替代方案**：
1. 完整軟刪除（Autopilot 建議）
2. 分階段刪除（先軟刪除，X天後硬刪除）
3. 完整 CASCADE 刪除（不建議）

**建議審查時間**：立即（阻礙資料庫設計）

---

### 2. tax_id 唯一性與軟刪除設計 ⚠️

**項目編號**：#5 (Organization_tax_id唯一性跨所有機構或軟刪除後可重用)

**Autopilot 決策**：選項 B - 使用 partial unique index (where is_active=true)

**決策理由**：
- 支援機構重新啟用流程
- 符合軟刪除系統最佳實踐
- 避免統編被永久鎖住

**需要審查的問題**：
- [ ] 確認機構重新啟用的業務需求？
- [ ] partial unique index 的效能影響？
- [ ] 是否需要「機構重新啟用」vs「建立新機構」的明確流程？
- [ ] 歷史資料查詢的處理方式？

**實作影響**：
```sql
-- 移除原本的 unique 約束
ALTER TABLE organizations DROP CONSTRAINT IF EXISTS organizations_tax_id_key;

-- 建立部分唯一索引
CREATE UNIQUE INDEX uq_organizations_tax_id_active 
ON organizations (tax_id) 
WHERE is_active = true;
```

**風險評估**：
- 🟡 **中風險**：機構重新啟用邏輯需仔細設計
- 需明確定義：停用機構是否可重新啟用 vs 建立新機構

**替代方案**：
1. Partial unique index（Autopilot 建議）
2. 永久唯一（不可重用）
3. 時間限制（停用 X 天後可重用）

**建議審查時間**：立即（阻礙資料庫設計）

---

### 3. org_owner 數量約束的資料庫實作 ⚠️

**項目編號**：#7 (TeacherOrganization_一個機構一個org_owner的資料庫約束)

**Autopilot 決策**：選項 B - 使用資料庫 partial unique index 強制執行

**決策理由**：
- 在資料庫層面保證資料完整性
- 支援 org_owner 轉移流程
- 保留歷史記錄

**需要審查的問題**：
- [ ] 確認資料庫約束 vs 應用層驗證的選擇？
- [ ] org_owner 轉移流程是否需要原子化交易？
- [ ] 是否需要記錄 org_owner 變更歷史？
- [ ] 若約束違反，錯誤訊息是否友善？

**實作影響**：
```sql
CREATE UNIQUE INDEX uq_teacher_org_owner 
ON teacher_organizations (organization_id) 
WHERE role = 'org_owner' AND is_active = true;
```

**風險評估**：
- 🟡 **中風險**：轉移流程需仔細設計，避免暫時性約束違反
- 需明確定義：轉移流程的步驟與回滾機制

**關聯項目**：項目 #20（org_owner 轉移流程）

**建議審查時間**：立即（阻礙資料庫設計）

---

## 🟡 中優先級審查項

### 4. 點數系統資料模型設計

**項目編號**：#18 (機構擁有人管理流程_點數系統的資料模型定義)

**Autopilot 決策**：選項 B - 建立 organization_credits 表（餘額 + 交易記錄）

**決策理由**：
- 計費系統需要完整交易記錄
- 支援審計與對帳
- 支援查詢歷史

**需要審查的問題**：
- [ ] 點數系統的業務需求明確了嗎？
- [ ] 是否需要過期機制？
- [ ] 是否需要分級定價（不同點數包）？
- [ ] 充值與消費的流程設計？

**實作影響**：
- 新增 2 個表：organization_credits, credit_transactions
- 影響計費模組設計

**風險評估**：
- 🟡 **中風險**：過早設計可能需要大幅修改
- 建議：先與產品經理確認點數系統的完整需求

**替代方案**：
1. 完整交易系統（Autopilot 建議）
2. 僅 balance 欄位（簡化版）
3. 延後實作（Feature 標記為 TODO）

**建議審查時間**：本週（需確認業務需求）

---

### 5. 教師授權數扣除與釋放邏輯

**項目編號**：#17 (機構擁有人管理流程_教師授權數扣除與釋放邏輯)

**Autopilot 決策**：選項 A - 停用教師釋放授權（COUNT is_active=true）

**決策理由**：
- 符合 SaaS 計費邏輯
- 保留歷史資料
- 機構可彈性管理成本

**需要審查的問題**：
- [ ] 計費方式：按啟用教師數 vs 按最高峰值？
- [ ] 是否有「最低承諾教師數」限制？
- [ ] 停用教師是否可重新啟用？
- [ ] 授權數欄位是否儲存 vs 即時計算？

**實作影響**：
- organizations 表可能需新增 teacher_limit 欄位
- 授權數計算邏輯

**風險評估**：
- 🟡 **中風險**：計費邏輯影響營收模式
- 建議：與產品經理、財務部門確認

**關聯項目**：項目 #18（點數系統）

**建議審查時間**：本週（需確認計費策略）

---

### 6. 移除機構成員後的資料處理

**項目編號**：#19 (管理機構成員_移除成員後資料如何處理)

**Autopilot 決策**：選項 C - 移除角色但保留歷史資料

**決策理由**：
- 班級/教材為機構資產
- 學生學習記錄需保留
- 移除成員 ≠ 刪除資料

**需要審查的問題**：
- [ ] 班級/教材是否為機構資產？（重要）
- [ ] 移除成員時是否允許有班級存在？
- [ ] 是否需要重新分配功能？
- [ ] 「已離職教師建立」的資料如何標記與管理？

**實作影響**：
- 移除成員的業務邏輯
- 可能需要資料重新分配功能
- 前端顯示邏輯（已離職教師標記）

**風險評估**：
- 🟡 **中風險**：資料歸屬邏輯影響使用者體驗
- 建議：與產品經理確認資料處理流程

**替代方案**：
1. 保留資料（Autopilot 建議）
2. 強制重新分配（操作複雜）
3. 移除成員前檢查（防止遺失）

**建議審查時間**：本週（需確認業務邏輯）

---

## 🟢 低優先級審查項

### 7. Feature 驗證規則的詳細程度

**項目編號**：#15 & #16 (建立機構_缺少驗證規則與 Example)

**Autopilot 決策**：
- #15: 選項 C - 建立獨立的驗證規則 Rule
- #16: 選項 A - 在 Feature 背景資訊中明確列出驗證規則

**決策理由**：
- 符合 Discovery.md 的 B3 規範（例子覆蓋度）
- 驗證規則與業務邏輯分離
- 提高 Feature 可讀性

**需要審查的問題**：
- [ ] 團隊對 Feature 詳細程度的偏好？
- [ ] 是否接受 Scenario Outline 模式？
- [ ] 格式驗證（Email, phone, tax_id）的具體規則？
- [ ] Feature vs 單元測試的職責分界？

**實作影響**：
- Feature 檔案長度增加
- API 驗證邏輯需與 Feature 同步

**風險評估**：
- 🟢 **低風險**：主要影響規範完整性，不阻礙開發
- 可先實作核心功能，後續補充邊界條件

**建議審查時間**：可延後（不阻礙開發）

---

### 8. org_owner 轉移流程設計

**項目編號**：#20 (管理機構成員_編輯角色範例缺少驗證規則)

**Autopilot 決策**：選項 C - 兩階段確認

**決策理由**：
- 平衡安全性與使用體驗
- 防止誤操作
- 符合重要操作的 UX 慣例

**需要審查的問題**：
- [ ] 是否需要原 org_owner 的 Email 確認？
- [ ] 轉移後是否發送通知？
- [ ] 是否記錄操作日誌？
- [ ] 是否支援撤銷轉移？

**實作影響**：
- 前端確認對話框
- 通知系統
- 操作日誌

**風險評估**：
- 🟢 **低風險**：主要為 UX 設計，不影響核心邏輯
- 可先實作基本轉移，後續優化 UX

**關聯項目**：項目 #7（org_owner 資料庫約束）

**建議審查時間**：可延後（與 UX 設計協調）

---

## 審查流程建議

### 階段一：立即審查（高優先級）
**時間**：本日完成  
**參與者**：技術主管、資料庫架構師、後端 Lead

**審查項目**：
1. CASCADE 刪除 vs 軟刪除策略（#6）
2. tax_id 唯一性設計（#5）
3. org_owner 資料庫約束（#7）

**產出**：
- 確認資料庫設計方案
- 更新 DBML 檔案
- 建立 migration 腳本

---

### 階段二：業務決策（中優先級）
**時間**：本週內完成  
**參與者**：產品經理、技術主管、財務代表（若涉及計費）

**審查項目**：
1. 點數系統資料模型（#18）
2. 教師授權數邏輯（#17）
3. 移除成員資料處理（#19）

**產出**：
- 確認業務需求與規則
- 更新 Feature 檔案
- 補充 DBML 設計

---

### 階段三：規範完善（低優先級）
**時間**：Sprint 內完成  
**參與者**：QA、開發團隊、UX 設計師

**審查項目**：
1. Feature 驗證規則詳細程度（#15, #16）
2. org_owner 轉移 UX 流程（#20）

**產出**：
- 補充 Feature Example
- 設計確認對話框
- 建立驗證規則文件

---

## 審查檢查表模板

```markdown
## 項目審查記錄

### 項目 #X: [項目名稱]

**審查日期**：____年__月__日  
**審查者**：________________

**Autopilot 建議**：
- [ ] 已閱讀並理解

**決策**：
- [ ] 採用 Autopilot 建議
- [ ] 採用替代方案：___________
- [ ] 需要更多資訊

**修改建議**：
_______________________________

**後續行動**：
- [ ] 更新 DBML
- [ ] 更新 Feature
- [ ] 更新 API 文件
- [ ] 建立 migration

**簽核**：________________
```

---

## 總結

**需審查項目**：8 項
- 🔴 高優先級：3 項（立即審查）
- 🟡 中優先級：3 項（本週審查）
- 🟢 低優先級：2 項（可延後）

**關鍵風險**：
1. CASCADE 刪除可能導致資料遺失
2. 計費邏輯影響營收模式
3. 資料歸屬邏輯影響使用者體驗

**建議行動**：
1. 立即召開技術審查會議（高優先級項目）
2. 安排業務決策會議（中優先級項目）
3. 規劃 Sprint 內完善規範（低優先級項目）
