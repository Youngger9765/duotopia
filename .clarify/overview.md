# 釐清項目總覽

## Organization 領域 - Discovery 掃描完成

**掃描時間**：2026年1月7日  
**掃描範圍**：Organization 領域（6 個 Feature 檔案 + 1 個 DBML 檔案）

---

## 釐清項目統計

### 本次掃描（Organization 領域）
- **資料模型相關（.clarify/data/）**：9 項
- **功能模型相關（.clarify/features/）**：14 項
- **總計**：23 項

### 全域統計（包含已完成項目）
- **已完成**：18 項（.clarify/resolved/）
- **待釐清**：23 項（本次新增）
- **總計**：41 項

---

## 優先級分佈（本次新增項目）

- **High**：13 項（56.5%）
- **Medium**：7 項（30.4%）
- **Low**：3 項（13.1%）

---

## 建議釐清順序

### 【階段一：核心資料模型】High 優先級（資料模型）

**原則**：先釐清核心實體與約束，奠定資料基礎

1. **Organization_tax_id唯一性跨所有機構或軟刪除後可重用** (High)
   - 影響索引設計與機構生命週期
   - 阻礙資料庫設計

2. **TeacherOrganization_一個機構一個org_owner的資料庫約束** (High)
   - 核心業務規則，需明確資料庫約束
   - 依賴項：無

3. **TeacherSchool_permissions覆蓋預設角色權限的邏輯** (High)
   - 影響權限系統核心設計
   - 依賴項：無

4. **School_CASCADE刪除對班級學生的影響** (High)
   - 影響資料完整性與刪除策略
   - 依賴項：Organization_tax_id（刪除策略一致性）

### 【階段二：核心功能規則】High 優先級（功能模型）

**原則**：釐清主要業務流程的規則與 Example

5. **建立機構_缺少成功與失敗的完整邊界條件Example** (High)
   - 例子覆蓋度（必須做到）
   - 依賴項：建立機構_缺少機構資料完整性驗證規則

6. **建立機構_缺少機構資料完整性驗證規則** (High)
   - 驗證規則為前置條件
   - 依賴項：無

7. **管理機構成員_編輯角色範例缺少驗證規則** (High)
   - 與「一個機構一個 org_owner」規則衝突
   - 依賴項：TeacherOrganization_一個機構一個org_owner的資料庫約束

8. **管理機構成員_移除成員後資料如何處理** (High)
   - 影響資料完整性
   - 依賴項：School_CASCADE刪除對班級學生的影響（刪除策略一致性）

9. **個人教師與機構教師身分切換_未被指派班級教師無法切換的邏輯** (High)
   - 核心功能邏輯矛盾
   - 依賴項：無

10. **機構設定與擁有人註冊_預設密碼格式的安全性** (High)
    - 安全性問題
    - 依賴項：無

11. **機構擁有人管理流程_教師授權數扣除與釋放邏輯** (High)
    - 影響資料模型設計（需新增欄位）
    - 依賴項：無

12. **機構擁有人管理流程_點數系統的資料模型定義** (High)
    - Feature 提到但 DBML 缺失
    - 依賴項：無

### 【階段三：邊界條件與跨模型關聯】Medium 優先級

**原則**：補足邊界案例與實作細節

13. **Organization_owner_email不可更改的實作機制** (Medium)
    - 影響 API 設計
    - 依賴項：無

14. **Organization_settings欄位的結構定義** (Medium)
    - 影響 API 設計與前端
    - 依賴項：無

15. **TeacherSchool_roles陣列的有效值與驗證** (Medium)
    - 影響資料驗證策略
    - 依賴項：無

16. **建立機構_系統管理員定義與Teacher_is_admin關係** (Medium)
    - 影響規格一致性
    - 依賴項：無

17. **個人教師與機構教師身分切換_班級標示所屬的實作方式** (Medium)
    - 影響查詢邏輯
    - 依賴項：無

18. **機構設定與擁有人註冊_專案服務人員與org_admin角色的關係** (Medium)
    - 影響角色體系
    - 依賴項：無

### 【階段四：細節與優化】Low 優先級

**原則**：完善規格細節，不阻礙核心開發

19. **Organization_display_name與name的用途差異** (Low)
    - 文件清晰度
    - 依賴項：無

20. **管理機構成員_查看成員列表的排序與分頁規則** (Low)
    - API 設計細節
    - 依賴項：無

21. **AI輔助新增機構資料_AI對話框的技術實作方案** (Low)
    - UX 增強功能
    - 依賴項：無

22. **AI輔助新增機構資料_Excel範本的標準化與維護策略** (Low)
    - UX 增強功能
    - 依賴項：AI輔助新增機構資料_AI對話框的技術實作方案

---

## 覆蓋度摘要

### A. 領域與資料模型檢查（DBML）

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| **A1. 實體完整性** | **Partial** | 核心實體已定義（organizations, schools, teacher_organizations, teacher_schools, classroom_schools），但缺少授權數與點數系統建模（2 個釐清項目） |
| **A2. 屬性定義** | **Partial** | 大部分屬性有明確型別與說明，但 settings (jsonb) 缺少結構定義，owner_email 的「無法更改」缺少技術約束（2 個釐清項目） |
| **A3. 屬性值邊界條件** | **Missing** | 缺少屬性長度限制、格式驗證的明確規則，如 tax_id 格式、email 格式、phone 格式等（1 個釐清項目） |
| **A4. 跨屬性不變條件** | **Partial** | 「一個機構僅能有一個 org_owner」有說明但缺少資料庫約束定義（1 個釐清項目） |
| **A5. 關係與唯一性** | **Partial** | 關聯關係完整，但 tax_id 的 unique 約束在軟刪除情境下的行為未定義（1 個釐清項目） |
| **A6. 生命週期與狀態** | **Partial** | is_active 欄位已定義，但 CASCADE 刪除的完整鏈路與影響未明確（2 個釐清項目） |

### B. 功能模型檢查（Feature）

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| **B1. 功能識別** | **Clear** | 6 個 Feature 功能清晰，涵蓋機構建立、成員管理、身份切換、擁有人註冊、管理流程、AI 輔助（0 個釐清項目） |
| **B2. 規則完整性** | **Partial** | 規則大多已原子化，但部分規則缺少前置條件或後置條件的完整說明（3 個釐清項目） |
| **B3. 例子覆蓋度** | **Partial** | **關鍵問題：部分 Rule 缺少 Example，尤其是邊界條件**（4 個釐清項目） |
| **B4. 邊界條件覆蓋** | **Partial** | 缺少驗證失敗、欄位格式錯誤、權限衝突等邊界情況（3 個釐清項目） |
| **B5. 錯誤與異常處理** | **Partial** | 部分錯誤情境有 Example，但缺少完整的異常處理說明（2 個釐清項目） |

### C. 術語與一致性檢查

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| **C1. 詞彙表** | **Clear** | 核心術語清晰（org_owner, org_admin, school_principal, school_admin, teacher）（0 個釐清項目） |
| **C2. 術語衝突** | **Clear** | 無明顯同義詞混用或同名異義問題（0 個釐清項目） |

### D. 跨檔案一致性檢查

| 檢查項 | 狀態 | 說明 |
|--------|------|------|
| **D1. Feature 與 DBML 實體對應** | **Partial** | Feature 提到的「教師授權數」「點數系統」「Teacher.is_admin」在 DBML 中缺失（3 個釐清項目） |
| **D2. 跨 Feature 檔案的一致性** | **Partial** | 「個人教師與機構教師身份切換」中的邏輯與其他 Feature 有部分矛盾（1 個釐清項目） |

---

## 主要風險提示

### 資料模型風險
1. **授權數與點數系統未建模**：Feature 多次提到但 DBML 缺失，需儘快補充
2. **CASCADE 刪除鏈路不明確**：可能導致意外資料遺失
3. **約束缺失**：「一個機構一個 org_owner」無資料庫約束，僅依賴應用層

### 功能模型風險
1. **Example 覆蓋度不足**：多個 Rule 缺少邊界條件 Example（B3 檢查項為必須做到）
2. **邏輯矛盾**：「個人教師與機構教師身分切換」中的切換條件有衝突
3. **安全性問題**：預設密碼格式可預測（統編為公開資訊）

### 建議後續行動
1. **優先進入 Autopilot Clarify 階段**：High 優先級項目（13 項）需儘快釐清
2. **人工介入項目**：
   - 機構設定與擁有人註冊_預設密碼格式的安全性（安全性風險）
   - TeacherSchool_permissions覆蓋預設角色權限的邏輯（影響核心權限系統）
   - 個人教師與機構教師身分切換_未被指派班級教師無法切換的邏輯（業務邏輯矛盾）

---

## 已完成項目（18 項，存放於 .clarify/resolved/）

### 資料模型相關（17 項 - 全部完成）

1. ✅ **User\_角色的資料結構設計方式.md**
   - 答案：B+E 混合（Teacher/Student 分離 + 關聯表）

2. ✅ **Permission\_權限控制策略模式.md**
   - 答案：C 混合模式（個人教師後台 D - 所有權 + 機構後台 A - RBAC）

3. ✅ **Role\_權限繼承原則.md**
   - 答案：A - 機構後台 RBAC 體系中上層角色自動繼承下層權限

4. ✅ **User\_多角色行為邏輯.md**
   - 答案：C - 依據操作情境自動選擇最合適的角色

5. ✅ **Student\_跨機構跨班級歸屬規則.md**
   - 答案：A - 可跨機構但資料隔離（需切換情境）

6. ✅ **Student\_帳號唯一性規則.md**
   - 答案：D - 混合模式（Student ID + optional Email + combo uniqueness）

7. ✅ **Organization\_資料隔離規則.md**
   - 答案：A - 完全隔離（同一用戶可在多個機構註冊，需切換情境）

8. ✅ **PlatformOwner\_具體權限定義.md**
   - 答案：6 大類權限（機構管理、用戶管理、訂閱財務、平台分析、系統維護、開發測試）

9. ✅ **OrganizationOwner\_具體權限定義.md**
   - 答案：4 大類權限（機構層級管理、教師權限管理、分校管理、機構資訊管理）

10. ✅ **OrganizationAdmin\_與負責人權限差異.md**
    - 答案：A - 無法查看/管理訂閱方案，其他功能相同

11. ✅ **OrganizationAdmin\_管理範圍.md**
    - 答案：A - 整個機構（與 org_owner 相同）

12. ✅ **SchoolPrincipal\_具體權限定義.md**
    - 答案：school_admin - 4 項權限（manage_teachers, manage_students, manage_classrooms, view_school_analytics）

13. ✅ **SchoolAdmin\_與校長權限差異.md**
    - 答案：school_director 與 school_admin 權限完全相同，僅語義不同

14. ✅ **Organization\_建立機構權限要求.md**
15. ✅ **Organization\_org_owner數量限制.md**
16. ✅ **Organization\_org_admin新增org_owner權限.md**
17. ✅ **Organization\_org_admin移除成員權限.md**

### 功能模型相關（1 項 - 已完成）

18. ✅ **Organization\_角色變更權限控制.md**
