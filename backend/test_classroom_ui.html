<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>教室詳細功能測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4338CA;
        }
        .student-list, .course-list {
            margin: 10px 0;
        }
        .item {
            padding: 10px;
            border: 1px solid #eee;
            margin: 5px 0;
            border-radius: 4px;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .tab-button.active {
            border-color: #4F46E5;
            color: #4F46E5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>個體戶教室詳細功能測試</h1>
    
    <div class="section">
        <h2>1. 登入</h2>
        <button onclick="login()">登入 (teacher@individual.com)</button>
        <div id="loginStatus"></div>
    </div>
    
    <div class="section">
        <h2>2. 選擇教室</h2>
        <div id="classroomList"></div>
    </div>
    
    <div class="section" id="classroomDetail" style="display:none;">
        <h2>3. 教室詳情: <span id="classroomName"></span></h2>
        
        <div class="tab-buttons">
            <div class="tab-button active" onclick="showTab('students')">學生管理</div>
            <div class="tab-button" onclick="showTab('courses')">課程管理</div>
        </div>
        
        <div class="tab-content active" id="students-tab">
            <h3>學生列表 (<span id="studentCount"></span>)</h3>
            <button onclick="showAddStudentModal()">新增學生</button>
            <div id="studentList" class="student-list"></div>
        </div>
        
        <div class="tab-content" id="courses-tab">
            <h3>課程列表</h3>
            <button onclick="showPublicCourses()">從公版複製</button>
            <button onclick="createNewCourse()">建立新課程</button>
            <div id="courseList" class="course-list"></div>
        </div>
    </div>
    
    <!-- 公版課程選擇 Modal -->
    <div id="publicCoursesModal" class="modal">
        <div class="modal-content">
            <h3>選擇公版課程</h3>
            <div id="publicCoursesList"></div>
            <button onclick="closeModal()">關閉</button>
        </div>
    </div>

    <script>
        let token = null;
        let currentClassroom = null;
        
        async function login() {
            try {
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'username=teacher@individual.com&password=test123'
                });
                
                const data = await response.json();
                token = data.access_token;
                document.getElementById('loginStatus').innerHTML = '✅ 登入成功';
                loadClassrooms();
            } catch (error) {
                console.error('Login error:', error);
            }
        }
        
        async function loadClassrooms() {
            const response = await fetch('http://localhost:8000/api/individual/classrooms', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const classrooms = await response.json();
            const html = classrooms.map(c => `
                <div class="item">
                    <h4>${c.name}</h4>
                    <p>學生: ${c.student_count}/${c.max_students} | 價格: $${c.pricing}/堂</p>
                    <button onclick="selectClassroom('${c.id}', '${c.name}')">進入教室</button>
                </div>
            `).join('');
            
            document.getElementById('classroomList').innerHTML = html;
        }
        
        async function selectClassroom(id, name) {
            currentClassroom = id;
            document.getElementById('classroomName').textContent = name;
            document.getElementById('classroomDetail').style.display = 'block';
            
            loadStudents();
            loadCourses();
        }
        
        async function loadStudents() {
            const response = await fetch(`http://localhost:8000/api/individual/classrooms/${currentClassroom}/students`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const students = await response.json();
            document.getElementById('studentCount').textContent = `${students.length}人`;
            
            const html = students.map(s => `
                <div class="item">
                    <strong>${s.full_name}</strong> - ${s.email}
                    <span style="float:right">
                        ${s.payment_status === 'paid' ? '✅已付款' : 
                          s.payment_status === 'overdue' ? '❌逾期' : '⏳待付款'}
                        <button onclick="removeStudent('${s.enrollment_id}')">移除</button>
                    </span>
                </div>
            `).join('');
            
            document.getElementById('studentList').innerHTML = html;
        }
        
        async function loadCourses() {
            const response = await fetch(`http://localhost:8000/api/individual/classrooms/${currentClassroom}/courses`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const courses = await response.json();
            const html = courses.map(c => `
                <div class="item">
                    <strong>${c.title}</strong>
                    <p>${c.description || '無描述'}</p>
                    <p>課時數: ${c.lesson_count}</p>
                    ${c.copied_from_title ? `<p style="color:#666">複製自: ${c.copied_from_title}</p>` : ''}
                </div>
            `).join('');
            
            document.getElementById('courseList').innerHTML = html || '<p>尚無課程</p>';
        }
        
        async function showPublicCourses() {
            const response = await fetch('http://localhost:8000/api/individual/courses/public', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const courses = await response.json();
            const html = courses.map(c => `
                <div class="item">
                    <strong>${c.title}</strong> - $${c.pricing_per_lesson}/堂
                    <p>${c.description || '無描述'}</p>
                    <button onclick="copyCourse('${c.id}')">複製此課程</button>
                </div>
            `).join('');
            
            document.getElementById('publicCoursesList').innerHTML = html;
            document.getElementById('publicCoursesModal').classList.add('show');
        }
        
        async function copyCourse(courseId) {
            const response = await fetch(`http://localhost:8000/api/individual/classrooms/${currentClassroom}/courses/copy`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ source_course_id: courseId })
            });
            
            if (response.ok) {
                alert('課程複製成功！');
                closeModal();
                loadCourses();
            }
        }
        
        async function removeStudent(enrollmentId) {
            if (!confirm('確定要移除這個學生嗎？')) return;
            
            const response = await fetch(`http://localhost:8000/api/individual/enrollments/${enrollmentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                loadStudents();
            }
        }
        
        function showTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            if (tab === 'students') loadStudents();
            if (tab === 'courses') loadCourses();
        }
        
        function closeModal() {
            document.getElementById('publicCoursesModal').classList.remove('show');
        }
        
        function showAddStudentModal() {
            alert('新增學生功能（需要實作學生選擇器）');
        }
        
        function createNewCourse() {
            alert('建立新課程功能（需要實作課程編輯器）');
        }
    </script>
</body>
</html>