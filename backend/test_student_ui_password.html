<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>學生密碼修改測試</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        input, button { padding: 10px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>學生密碼修改測試</h1>
    
    <div class="section">
        <h2>1. 學生登入</h2>
        <button onclick="studentLogin()">使用測試學生登入</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="section">
        <h2>2. 修改密碼</h2>
        <div>
            <label>當前密碼: <input type="password" id="currentPassword" value="20150920"></label><br>
            <label>新密碼: <input type="password" id="newPassword" value="test1234"></label><br>
            <label>確認密碼: <input type="password" id="confirmPassword" value="test1234"></label><br>
            <button onclick="changePassword()">修改密碼</button>
        </div>
        <div id="changeResult"></div>
    </div>
    
    <div class="section">
        <h2>3. 學生資訊</h2>
        <div id="studentInfo"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let studentData = null;
        let token = null;

        async function studentLogin() {
            try {
                // 1. 搜尋老師
                const teacherResp = await fetch(`${API_BASE}/api/student-login/teachers/search?email=teacher@individual.com`);
                const teacher = await teacherResp.json();
                
                // 2. 獲取教室
                const classroomsResp = await fetch(`${API_BASE}/api/student-login/teachers/${teacher.id}/classrooms`);
                const classrooms = await classroomsResp.json();
                
                // 3. 獲取學生
                const studentsResp = await fetch(`${API_BASE}/api/student-login/classrooms/${classrooms[0].id}/students`);
                const students = await studentsResp.json();
                const student = students[0];
                
                // 4. 登入
                const loginResp = await fetch(`${API_BASE}/api/student-login/verify-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: student.id,
                        password: '20150920'
                    })
                });
                
                if (loginResp.ok) {
                    const loginData = await loginResp.json();
                    token = loginData.access_token;
                    studentData = loginData.student;
                    
                    document.getElementById('loginResult').innerHTML = 
                        `<div class="success">登入成功！</div>
                         <div class="info">
                            學生: ${studentData.name}<br>
                            Email: ${studentData.email || '未設定'}<br>
                            Teacher ID: ${studentData.teacher_id}<br>
                            使用預設密碼: ${studentData.is_default_password}
                         </div>`;
                    
                    updateStudentInfo();
                } else {
                    const error = await loginResp.json();
                    document.getElementById('loginResult').innerHTML = 
                        `<div class="error">登入失敗: ${error.detail}</div>`;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<div class="error">錯誤: ${error.message}</div>`;
            }
        }

        async function changePassword() {
            if (!token || !studentData) {
                alert('請先登入');
                return;
            }
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                document.getElementById('changeResult').innerHTML = 
                    '<div class="error">新密碼與確認密碼不相符</div>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/student-login/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        student_id: studentData.id,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('changeResult').innerHTML = 
                        `<div class="success">密碼修改成功！</div>
                         <div class="info">請使用新密碼重新登入</div>`;
                    
                    // 更新學生資訊
                    studentData.is_default_password = false;
                    updateStudentInfo();
                } else {
                    document.getElementById('changeResult').innerHTML = 
                        `<div class="error">修改失敗: ${result.detail}</div>`;
                }
            } catch (error) {
                document.getElementById('changeResult').innerHTML = 
                    `<div class="error">錯誤: ${error.message}</div>`;
            }
        }
        
        function updateStudentInfo() {
            if (studentData) {
                document.getElementById('studentInfo').innerHTML = 
                    `<div class="info">
                        <strong>當前學生資訊:</strong><br>
                        ID: ${studentData.id}<br>
                        姓名: ${studentData.name}<br>
                        Email: ${studentData.email || '未設定'}<br>
                        Teacher ID: ${studentData.teacher_id}<br>
                        使用預設密碼: ${studentData.is_default_password ? '是' : '否'}
                    </div>`;
            }
        }
    </script>
</body>
</html>