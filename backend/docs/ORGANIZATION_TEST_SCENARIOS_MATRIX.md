# 機構完整測試場景矩陣

## 📋 目的

驗證多租戶機構階層系統在各種真實使用情境下的正確性。

**涵蓋範圍**：
- 🏢 機構類型：補習班、個體戶
- 🏫 學校配置：單校、多校、無校
- 👥 師生關係：多角色、跨校、課程分享
- 📚 課程作業：自創課程、公版課程、課程分享、作業分配

---

## 🎯 測試場景矩陣

### 場景 1: 補習班 - 單一分校 (Basic Cram School)

**機構配置**：
- 組織：快樂補習班
- 學校：台北總校
- 角色：
  - 張老師 (org_owner): 機構擁有人兼校長
  - 李老師 (teacher): 普通教師

**師生配置**：
- 台北總校：
  - 五年級A班 (張老師): 5 位學生
  - 六年級B班 (李老師): 8 位學生

**課程作業**：
- 張老師：自創課程「英文基礎」→ 作業「第一週測驗」(5位學生)
- 李老師：使用公版課程「國小英文入門」→ 作業「單字練習」(8位學生)

**測試重點**：
- ✅ org_owner 可以看到所有班級
- ✅ teacher 只能看到自己的班級
- ✅ 作業分配正確（不會跨班）
- ✅ 公版課程可以正常使用

---

### 場景 2: 補習班 - 多分校 (Multi-Branch Cram School)

**機構配置**：
- 組織：台灣英語補習班
- 學校：台北分校、台中分校、高雄分校
- 角色：
  - 王老師 (org_owner): 機構擁有人
  - 陳老師 (org_admin): 機構管理員兼台北校長
  - 林老師 (school_admin @ 台中): 台中校長
  - 黃老師 (teacher @ 高雄): 高雄教師

**師生配置**：
- 台北分校：
  - 初級班 (陳老師): 10 位學生
  - 中級班 (陳老師): 8 位學生
- 台中分校：
  - 進階班 (林老師): 6 位學生
- 高雄分校：
  - 幼兒班 (黃老師): 12 位學生

**課程作業**：
- 陳老師：課程「多益入門」→ 分享給林老師
- 林老師：使用陳老師分享的課程 → 作業「TOEIC Practice」(6位學生)
- 黃老師：自創課程「幼兒英文」→ 作業「ABC練習」(12位學生)

**測試重點**：
- ✅ org_owner 可以訪問所有分校
- ✅ org_admin 可以訪問所有分校
- ✅ school_admin 只能訪問自己的分校
- ✅ 課程分享功能正常（陳 → 林）
- ✅ 作業隔離（不會跨校混亂）
- ✅ 權限繼承正確

---

### 場景 3: 補習班 - 教師多角色 (Multi-Role Teacher)

**機構配置**：
- 組織：精英補習班
- 學校：總校
- 角色：
  - 周老師 (org_owner): 機構擁有人
  - 吳老師 (school_admin + teacher): 校長兼任教師

**師生配置**：
- 總校：
  - 高一數學班 (吳老師): 15 位學生
  - 高二數學班 (吳老師): 12 位學生
  - 高三物理班 (周老師): 10 位學生

**課程作業**：
- 吳老師：
  - 課程「高中數學」→ 作業「三角函數」(高一班15人)
  - 課程「進階數學」→ 作業「微積分」(高二班12人)
- 周老師：課程「高中物理」→ 作業「力學」(10人)

**測試重點**：
- ✅ 多角色教師可以同時管理學校和教課
- ✅ 作業分配不會混亂（高一 vs 高二）
- ✅ 權限正確（school_admin 可以看到周老師的班級）

---

### 場景 4: 個體戶 - 獨立教師 (Independent Teacher)

**機構配置**：
- 組織：NONE（無機構）
- 學校：NONE（無學校）
- 角色：
  - 劉老師 (independent): 獨立教師

**師生配置**：
- 家教班A (劉老師): 3 位學生
- 家教班B (劉老師): 2 位學生

**課程作業**：
- 劉老師：
  - 課程「一對一英文」→ 作業「口語練習」(家教班A, 3人)
  - 使用公版課程「國小英文」→ 作業「單字測驗」(家教班B, 2人)

**測試重點**：
- ✅ 無機構也能正常使用所有核心功能
- ✅ 班級、學生、課程、作業功能完整
- ✅ 公版課程可以使用
- ✅ GET /api/organizations 回傳空陣列
- ✅ GET /api/schools 回傳空陣列

---

### 場景 5: 補習班 - 課程分享鏈 (Course Sharing Chain)

**機構配置**：
- 組織：知識共享補習班
- 學校：A分校、B分校、C分校
- 角色：
  - 鄭老師 (org_owner): 機構擁有人
  - 謝老師 (teacher @ A分校): A分校教師（課程創建者）
  - 蔡老師 (teacher @ B分校): B分校教師（第一層分享）
  - 楊老師 (teacher @ C分校): C分校教師（第二層分享）

**師生配置**：
- A分校：初級班 (謝老師, 10人)
- B分校：中級班 (蔡老師, 8人)
- C分校：高級班 (楊老師, 6人)

**課程作業**：
- 謝老師：創建「英文文法大全」→ 分享給蔡老師
- 蔡老師：使用「英文文法大全」→ 分享給楊老師 → 作業「文法練習」(8人)
- 楊老師：使用「英文文法大全」→ 作業「高級文法」(6人)

**測試重點**：
- ✅ 課程可以多層分享（謝 → 蔡 → 楊）
- ✅ 每個老師的作業獨立（不會混亂）
- ✅ 原創者可以看到分享記錄
- ✅ 課程修改權限正確（只有原創者可以修改）

---

### 場景 6: 混合情境 - 跨機構隔離 (Cross-Organization Isolation)

**機構配置**：
- 組織A：快樂補習班
  - 王老師 (org_owner)
  - 學校：台北校
  - 班級：五年級A班 (5人)
- 組織B：美語天地
  - 李老師 (org_owner)
  - 學校：新竹校
  - 班級：六年級B班 (8人)
- 獨立教師：
  - 陳老師 (independent)
  - 班級：家教班C (3人)

**課程作業**：
- 王老師：課程「快樂英文」→ 作業「測驗1」(5人)
- 李老師：課程「美語會話」→ 作業「測驗2」(8人)
- 陳老師：課程「家教課程」→ 作業「測驗3」(3人)

**測試重點**：
- ✅ 王老師看不到李老師的機構/學校/班級
- ✅ 李老師看不到王老師的機構/學校/班級
- ✅ 陳老師看不到任何機構（GET /api/organizations 回傳 []）
- ✅ 作業完全隔離（不會跨機構）
- ✅ 課程分享只能在同一機構內

---

### 場景 7: 補習班 - 軟刪除與重啟 (Soft Delete & Reactivation)

**機構配置**：
- 組織：永續補習班
- 學校：主校、舊校 (is_active=False)
- 角色：
  - 張老師 (org_owner)
  - 李老師 (teacher @ 主校)
  - 王老師 (teacher @ 舊校，但舊校已關閉)

**師生配置**：
- 主校：五年級班 (李老師, 10人)
- 舊校：六年級班 (王老師, 0人，學校已關閉)

**課程作業**：
- 李老師：課程「現行課程」→ 作業「當前作業」(10人)
- 王老師：課程「歷史課程」→ 無作業（學校已關閉）

**測試重點**：
- ✅ GET /api/schools 只回傳主校（不含舊校）
- ✅ 舊校的資料還在資料庫（soft delete）
- ✅ 王老師無法訪問舊校（403 Forbidden）
- ✅ 重啟舊校（is_active=True）後，王老師可以重新訪問

---

### 場景 8: 補習班 - 權限邊界測試 (Permission Boundary)

**機構配置**：
- 組織：邊界測試補習班
- 學校：北校、南校
- 角色：
  - 總監 (org_owner): 機構擁有人
  - 北校長 (school_admin @ 北校): 北校管理員
  - 南校長 (school_admin @ 南校): 南校管理員
  - 北老師 (teacher @ 北校): 北校教師
  - 南老師 (teacher @ 南校): 南校教師

**師生配置**：
- 北校：A班 (北老師, 10人)
- 南校：B班 (南老師, 8人)

**課程作業**：
- 北老師：課程「北校課程」→ 作業「北校作業」(10人)
- 南老師：課程「南校課程」→ 作業「南校作業」(8人)

**測試重點**：
- ✅ 總監可以訪問北校和南校
- ✅ 北校長只能訪問北校（訪問南校 → 403）
- ✅ 南校長只能訪問南校（訪問北校 → 403）
- ✅ 北老師只能看到A班（看不到B班）
- ✅ 南老師只能看到B班（看不到A班）
- ✅ 北老師無法訪問南校課程
- ✅ 課程分享權限正確（同校可分享，跨校不可）

---

### 場景 9: 補習班 - 作業批改與學生提交 (Assignment Grading)

**機構配置**：
- 組織：作業測試補習班
- 學校：測試校
- 角色：
  - 老師A (teacher): 教師

**師生配置**：
- 測試校：五年級班 (老師A, 5人)
  - 學生1, 學生2, 學生3, 學生4, 學生5

**課程作業**：
- 老師A：課程「測試課程」→ 作業「綜合練習」
  - 學生1: 已提交 → 已批改 (90分)
  - 學生2: 已提交 → 未批改
  - 學生3: 已提交 → 退回訂正
  - 學生4: 未提交
  - 學生5: 已提交 → 重新提交

**測試重點**：
- ✅ 老師可以看到所有學生的提交狀態
- ✅ 批改後學生可以看到分數
- ✅ 退回訂正功能正常
- ✅ 重新提交覆蓋舊提交
- ✅ 統計數據正確（已提交/未提交/已批改）

---

### 場景 10: 補習班 - Casbin 同步測試 (Casbin Sync)

**機構配置**：
- 組織：同步測試補習班
- 學校：A校
- 角色：
  - 張老師 (org_owner)
  - 李老師 (teacher @ A校)

**動態操作**：
1. 建立組織 → 檢查 Casbin role
2. 加入李老師到學校 → 檢查 Casbin role
3. 升級李老師為 school_admin → 檢查 Casbin role 更新
4. 移除李老師 (is_active=False) → 檢查 Casbin role 移除
5. 重新啟用李老師 → 檢查 Casbin role 恢復

**測試重點**：
- ✅ 資料庫變更後 Casbin 自動同步
- ✅ 權限變更立即生效
- ✅ 軟刪除移除 Casbin 權限
- ✅ 重新啟用恢復 Casbin 權限

---

## 📊 場景覆蓋率矩陣

| 場景 | 機構 | 多校 | 多角色 | 課程分享 | 作業 | 公版課程 | 軟刪除 | Casbin | 隔離 |
|------|------|------|--------|----------|------|----------|--------|--------|------|
| 1. 單一分校 | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ✅ | ❌ |
| 2. 多分校 | ✅ | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 3. 多角色 | ✅ | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 4. 個體戶 | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ |
| 5. 分享鏈 | ✅ | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 6. 跨機構 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 7. 軟刪除 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ | ✅ | ✅ | ❌ |
| 8. 權限邊界 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ✅ | ✅ |
| 9. 作業批改 | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 10. Casbin同步 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ | ❌ |

---

## 🧪 測試執行計劃

### Phase 1: 資料準備
1. 建立 10 個場景的 seed data
2. 確保資料完整性（外鍵、CASCADE）

### Phase 2: API 測試
1. 為每個場景撰寫整合測試
2. 驗證 API 回應正確性
3. 驗證權限控制

### Phase 3: E2E 測試
1. 使用真實 HTTP 請求測試
2. 模擬用戶操作流程
3. 驗證前後端整合

### Phase 4: 負面測試
1. 測試未授權訪問（403）
2. 測試跨機構訪問（403）
3. 測試軟刪除過濾

---

## ✅ 成功標準

每個場景必須通過：
- [ ] 資料建立成功（無 Foreign Key 錯誤）
- [ ] API 回應正確（200/403/404）
- [ ] 權限控制正確（Casbin）
- [ ] 資料隔離正確（不會看到其他機構/學校）
- [ ] 作業分配正確（不會跨班/跨校）
- [ ] 課程分享功能正確

---

*Last Updated*: 2025-11-27
*Purpose*: 完整驗證多租戶機構系統的所有排列組合場景
