# language: zh-TW
功能: 專案人員開立機構訂閱
  作為 Duotopia 專案人員
  我希望能夠為機構開立訂閱
  以便機構能夠開始使用系統

  背景:
    假設 我是 Duotopia 專案人員，角色為 "service_staff"
    而且 機構 "ABC 教育集團" 已註冊且通過審核
    而且 機構統編為 "12345678"
    而且 機構已完成線下簽約與付款流程
    而且 我被指派為該機構的專案服務人員

  規則: 開立訂閱 - 基本資訊填寫
    
    場景: 開立一年約訂閱
      假設 機構簽署的合約為 "一年約"
      而且 合約起始日期為 "2024-01-15"
      而且 合約結束日期為 "2025-01-14"
      而且 購買教師數為 "7" 位
      而且 贈送教師數為 "3" 位
      # total = 7 + 3 = 10
      而且 初始點數為 "117000" 點
      當 我開立機構訂閱
      那麼 訂閱應成功建立
      而且 訂閱開始日期應為 "2024-01-15"
      而且 訂閱結束日期應為 "2025-01-14"
      而且 購買教師數應為 "7"
      而且 贈送教師數應為 "3"
      而且 教師授權總數應為 "10"
      而且 初始點數應為 "117000"
      而且 總點數應為 "117000"
      而且 剩餘點數應為 "117000"
      而且 訂閱狀態應為 "生效中"
      而且 專案服務人員應為我本人
    
    場景: 開立兩年約訂閱
      假設 機構簽署的合約為 "兩年約"
      而且 合約起始日期為 "2024-01-15"
      而且 合約結束日期為 "2026-01-14"
      而且 購買教師數為 "5" 位
      而且 贈送教師數為 "5" 位
      # total = 5 + 5 = 10
      而且 初始點數為 "234000" 點
      # 兩年總點數: 117,000 × 2 = 234,000
      當 我開立機構訂閱
      那麼 訂閱應成功建立
      而且 購買教師數應為 "5"
      而且 贈送教師數應為 "5"
      而且 教師授權總數應為 "10"
      而且 初始點數應為 "234000"
  
  規則: 驗證授權數計算
    
    場景: 系統自動計算總授權數
      假設 我填寫購買教師數為 "8"
      而且 我填寫贈送教師數為 "4"
      當 我開立機構訂閱
      那麼 教師授權總數應為 "12"
      # 8 + 4 = 12
    
    場景大綱: 授權數驗證 - 合法案例
      假設 購買教師數為 "<purchased>"
      而且 贈送教師數為 "<bonus>"
      當 我開立機構訂閱
      那麼 教師授權總數應為 "<total>"
      
      範例:
        | purchased | bonus | total |
        | 10        | 0     | 10    |
        | 7         | 3     | 10    |
        | 5         | 5     | 10    |
        | 20        | 10    | 30    |
    
    場景: 授權數驗證 - 負數檢查
      假設 購買教師數為 "-1"
      當 我開立機構訂閱
      那麼 應顯示錯誤訊息 "購買教師數必須大於 0"
      而且 訂閱不應建立
  
  規則: 上傳合約檔案
    
    場景: 開立訂閱時上傳合約 PDF
      假設 我準備開立機構訂閱
      而且 我上傳合約檔案 "ABC教育集團-2024年度合約.pdf"
      而且 檔案大小為 "2.5 MB"
      而且 合約編號為 "ABC-2024-001"
      而且 合約類型為 "一年約"
      而且 合約起始日期為 "2024-01-15"
      而且 合約結束日期為 "2025-01-14"
      當 我開立機構訂閱
      那麼 訂閱應成功建立
      而且 合約檔案應成功上傳
      而且 合約檔案名稱應為 "ABC教育集團-2024年度合約.pdf"
      而且 合約檔案應關聯到此訂閱
      而且 合約編號應為 "ABC-2024-001"
    
    場景: 補充上傳續約合約（同一訂閱多份合約）
      假設 機構已有一個生效中的訂閱
      而且 訂閱已關聯一份 "ABC-2024-001" 合約檔案
      而且 機構辦理續約，簽署新合約 "ABC-2025-001"
      當 我上傳續約合約 PDF 檔案
      而且 關聯到同一訂閱
      那麼 合約檔案應成功上傳
      而且 訂閱應關聯 "2" 份合約檔案
      而且 合約檔案清單應包含 "ABC-2024-001" 與 "ABC-2025-001"
  
  規則: 記錄付款資訊
    
    場景: 記錄銀行轉帳付款
      假設 機構已完成線下銀行轉帳付款
      而且 付款日期為 "2024-01-10"
      而且 付款金額為 "50000" 元
      而且 付款方式為 "銀行轉帳"
      而且 付款編號為 "PAY-2024-001"
      而且 備註為 "發票號碼: INV-2024-001"
      當 我開立機構訂閱並記錄付款資訊
      那麼 訂閱應成功建立
      而且 付款記錄應成功建立
      而且 付款編號應為 "PAY-2024-001"
      而且 付款日期應為 "2024-01-10"
      而且 付款方式應為 "銀行轉帳"
      而且 付款金額應為 "50000"
      而且 付款幣別應為 "TWD"
      而且 付款記錄應關聯到此訂閱
      而且 記錄者應為我本人
    
    場景: 記錄 AFTEE 分期付款
      假設 機構使用 AFTEE 分期付款
      而且 付款日期為 "2024-01-10"
      而且 付款金額為 "50000" 元
      而且 分期期數為 "12" 期
      而且 分期提供方為 "aftee"
      當 我開立機構訂閱並記錄付款資訊
      那麼 付款記錄應成功建立
      而且 付款方式應為 "aftee_installment"
      而且 分期期數應為 "12"
      而且 分期提供方應為 "aftee"
    
    場景: 記錄信用卡分期付款
      假設 機構使用玉山銀行信用卡分期付款
      而且 付款日期為 "2024-01-10"
      而且 付款金額為 "50000" 元
      而且 分期期數為 "6" 期
      而且 分期提供方為 "玉山銀行"
      當 我開立機構訂閱並記錄付款資訊
      那麼 付款記錄應成功建立
      而且 付款方式應為 "credit_card_installment"
      而且 分期期數應為 "6"
      而且 分期提供方應為 "yushan_bank"
  
  規則: 發放初始點數
    
    場景: 訂閱開通後自動發放初始點數
      假設 我開立機構訂閱
      而且 初始點數為 "117000" 點
      當 訂閱成功建立
      那麼 應建立點數交易記錄
      而且 交易類型應為 "initial_grant"
      而且 點數變動量應為 "+117000"
      而且 交易前餘額應為 "0"
      而且 交易後餘額應為 "117000"
      而且 訂閱總點數應為 "117000"
      而且 訂閱剩餘點數應為 "117000"
      而且 交易備註應為 "訂閱開通初始點數發放"
  
  規則: 訂閱狀態管理
    
    場景: 新建訂閱預設為生效中
      假設 訂閱起始日期為今天或過去日期
      當 我開立機構訂閱
      那麼 訂閱狀態應為 "生效中"
      而且 訂閱生效時間應為建立時間
    
    場景: 未來日期的訂閱可手動設定為生效中
      假設 訂閱起始日期為 "2025-01-15"（未來日期）
      而且 我勾選 "立即生效"
      當 我開立機構訂閱
      那麼 訂閱狀態應為 "生效中"
      而且 訂閱生效時間應為建立時間
  
  規則: 權限檢查
    
    場景: 僅專案人員可開立訂閱
      假設 我的角色為 "org_admin"（機構管理員）
      當 我嘗試開立機構訂閱
      那麼 應顯示錯誤訊息 "您沒有權限執行此操作"
      而且 訂閱不應建立
    
    場景: 專案人員只能為指派的機構開立訂閱
      假設 我是專案人員 A
      而且 我被指派為機構 ABC 的服務人員
      而且 機構 XYZ 的服務人員是專案人員 B
      當 我嘗試為機構 XYZ 開立訂閱
      那麼 應顯示錯誤訊息 "您未被指派為該機構的服務人員"
      而且 訂閱不應建立
  
  規則: 通知機構管理員
    
    場景: 訂閱開通後通知機構管理員
      假設 機構管理員 Email 為 "admin@abc.edu.tw"
      當 訂閱成功建立
      那麼 應發送 Email 通知到 "admin@abc.edu.tw"
      而且 Email 主旨應為 "您的 Duotopia 訂閱已開通"
      而且 Email 內容應包含訂閱起始與結束日期
      而且 Email 內容應包含教師授權數與初始點數
      而且 Email 內容應包含登入連結與使用指南
