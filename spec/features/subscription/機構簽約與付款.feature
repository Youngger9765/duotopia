# language: zh-TW
功能: 機構簽約與付款
  作為 Duotopia 專案擁有人
  我希望能夠為機構建立合約並處理付款
  以便機構能夠開始使用系統

  背景:
    假設 我是 Duotopia 專案擁有人
    而且 機構 "ABC 教育集團" 已完成詢價與報價
    而且 機構統編為 "12345678"
    而且 機構擁有人為 "王小明"
    而且 機構擁有人 Email 為 "wang@abc.edu.tw"
    而且 機構擁有人手機為 "0912345678"
    # 所有教師授權數均以 total_teacher_licenses 為基準，等於 purchased_teachers + 贈送教師數量

  規則: 建立機構合約
    
    場景: 建立一年約合約
      假設 機構選擇 "一年約"
      而且 機構有 "10" 位英文老師
      而且 機構有 "50" 位學生
      而且 每位學生每週練習 "3" 次
      而且 每次練習 "15" 句
      而且 預估年度點數為 "117000" 點
      當 我為機構建立合約
      那麼 合約應成功建立
      而且 合約編號應自動生成
      而且 合約類型應為 "一年約"
      而且 合約開始日期應為簽約日期
      而且 合約結束日期應為簽約日期加 "1" 年
      而且 購買教師數應為 "7" 位
      # 10 - 3 (贈額) = 7
      而且 贈送教師數應為 "3" 位
      而且 教師授權總數應為 "10" 位
      而且 購買點數應為 "117000" 點
      而且 合約狀態應為 "待付款"
    
    場景: 建立兩年約合約
      假設 機構選擇 "兩年約"
      而且 機構有 "10" 位英文老師
      而且 機構有 "50" 位學生
      而且 每位學生每週練習 "3" 次
      而且 每次練習 "15" 句
      而且 預估年度點數為 "234000" 點
      # 兩年總點數: 117,000 × 2 = 234,000
      當 我為機構建立合約
      那麼 合約應成功建立
      而且 合約類型應為 "兩年約"
      而且 合約結束日期應為簽約日期加 "2" 年
      而且 購買教師數應為 "5" 位
      # 10 - 5 (贈額) = 5
      而且 贈送教師數應為 "5" 位
      而且 教師授權總數應為 "10" 位
  
  規則: 處理付款 - AFTEE 分期
    
    場景: 一年約使用 AFTEE 分 12 期
      假設 機構有一個 "一年約" 合約
      而且 合約總價為 "50000" 元
      而且 機構選擇 "AFTEE 分期" 付款
      而且 機構選擇分 "12" 期
      當 我處理機構付款
      那麼 付款記錄應成功建立
      而且 付款方式應為 "AFTEE 分期"
      而且 分期期數應為 "12" 期
      而且 分期提供方應為 "aftee"
      而且 付款狀態應為 "待處理"
    
    場景: 兩年約使用 AFTEE 分 24 期
      假設 機構有一個 "兩年約" 合約
      而且 合約總價為 "100000" 元
      而且 機構選擇 "AFTEE 分期" 付款
      而且 機構選擇分 "24" 期
      當 我處理機構付款
      那麼 付款記錄應成功建立
      而且 付款方式應為 "AFTEE 分期"
      而且 分期期數應為 "24" 期
  
  規則: 處理付款 - 轉帳付清
    
    場景: 一次轉帳付清
      假設 機構有一個 "一年約" 合約
      而且 合約總價為 "50000" 元
      而且 機構選擇 "轉帳付清" 付款
      當 我處理機構付款
      那麼 付款記錄應成功建立
      而且 付款方式應為 "轉帳"
      而且 分期期數應為空
      而且 付款狀態應為 "待處理"
  
  規則: 處理付款 - 刷卡付清
    
    場景: 一次刷卡付清
      假設 機構有一個 "一年約" 合約
      而且 合約總價為 "50000" 元
      而且 機構選擇 "刷卡付清" 付款
      當 我處理機構付款
      那麼 付款記錄應成功建立
      而且 付款方式應為 "刷卡"
      而且 分期期數應為空
  
  規則: 處理付款 - 信用卡分期
    
    場景: 使用玉山銀行信用卡分期
      假設 機構有一個 "一年約" 合約
      而且 合約總價為 "50000" 元
      而且 機構選擇 "信用卡分期" 付款
      而且 機構使用 "玉山銀行" 信用卡
      而且 機構選擇分 "6" 期
      當 我處理機構付款
      那麼 付款記錄應成功建立
      而且 付款方式應為 "信用卡分期"
      而且 分期提供方應為 "玉山銀行"
      而且 分期期數應為 "6" 期
    
    場景: 使用中信銀行信用卡分期
      假設 機構有一個 "兩年約" 合約
      而且 合約總價為 "100000" 元
      而且 機構選擇 "信用卡分期" 付款
      而且 機構使用 "中信銀行" 信用卡
      而且 機構選擇分 "12" 期
      當 我處理機構付款
      那麼 付款記錄應成功建立
      而且 付款方式應為 "信用卡分期"
      而且 分期提供方應為 "中信銀行"
      而且 分期期數應為 "12" 期
  
  規則: 付款完成後開通訂閱
    
    場景: 付款完成後自動開通訂閱
      假設 機構有一個 "一年約" 合約
      而且 合約有一筆付款記錄
      當 付款狀態變更為 "已完成"
      那麼 合約狀態應變更為 "生效中"
      而且 應自動建立機構訂閱
      而且 訂閱開始日期應為付款完成日期
      而且 訂閱結束日期應與合約結束日期相同
      而且 訂閱教師授權總數應與合約教師授權總數相同
      而且 訂閱總點數應與合約購買點數相同
      而且 訂閱狀態應為 "生效中"
    
    場景: 付款完成後發放初始點數
      假設 機構訂閱已開通
      而且 合約購買點數為 "117000" 點
      當 付款狀態變更為 "已完成"
      那麼 應建立點數交易記錄
      而且 交易類型應為 "發放"
      而且 點數變動量應為 "117000" 點
      而且 交易前餘額應為 "0" 點
      而且 交易後餘額應為 "117000" 點
      而且 訂閱剩餘點數應為 "117000" 點

  規則: 付款失敗處理
    Example: 業務人員手動重開付款
      Given 機構已簽立合約
      When 付款失敗
      Then 業務人員手動重新開立付款方式
      And 系統記錄新付款資訊
