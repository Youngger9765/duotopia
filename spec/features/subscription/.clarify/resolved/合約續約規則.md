# 合約續約規則

## 決策日期

2026-01-09

## 背景說明

機構訂閱採用合約制，合約到期後可續約。需要明確定義續約時的點數、教師授權等資源如何處理。

## 核心規則

### 情境 1：正常續約（無重疊期）

```
合約 #1: 2024-01-15 ~ 2025-01-14
- 教師授權：10 位（7 購買 + 3 贈送）
- 初始點數：117,000
- 期末剩餘：25,000 點
- 已邀請教師：10 位

合約 #2: 2025-01-15 ~ 2026-01-14（緊接著）
- 教師授權：15 位（10 購買 + 5 贈送）
- 初始點數：234,000
```

#### 規則 1：點數累加

**決策**：舊合約剩餘點數 + 新合約初始點數

**範例**：

- 2025-01-15 當天總點數 = 25,000（舊剩餘）+ 234,000（新合約）= 259,000

**理由**：

- 點數是機構已付費購買的資源
- 未使用完的點數應保留給機構繼續使用
- 符合商業公平原則

---

#### 規則 2：教師授權重置

**決策**：合約切換時，**所有教師帳號停用**，需重新邀請

**執行流程**：

1. 2025-01-14 23:59:59 - 合約 #1 到期
2. 2025-01-15 00:00:00 - 合約 #2 生效
3. 系統自動：
   - 停用所有已邀請的教師帳號（10 位）
   - 更新授權上限為 15 位
4. 機構管理員可以：
   - 重新邀請舊教師（從停用清單中啟用）
   - 邀請新教師
   - 總數不超過 15 位

**理由**：

- 新合約可能有不同的授權數量與定價
- 明確的重置時間點便於管理
- 給機構機會重新調整教師名單

---

#### 規則 3：降級續約處理

**情境**：

```
合約 #1: 10 位教師授權（已邀請 10 位）
合約 #2: 8 位教師授權（降級）
```

**決策**：全部停用，機構可重新啟用舊教師或邀請新教師，總數不超過新授權數

**執行流程**：

1. 2025-01-15 - 合約 #2 生效
2. 系統自動：
   - 停用所有 10 位教師帳號
   - 更新授權上限為 8 位
3. 機構管理員可以：
   - 從 10 位舊教師中選擇 8 位重新啟用
   - 或邀請新教師（總數 ≤ 8）

**理由**：

- 與升級續約保持一致的處理邏輯
- 由機構自行決定保留哪些教師
- 避免系統自動停用特定教師造成爭議

---

## 待釐清問題

### 情境 2：提前續約（有重疊期）

```
合約 #1: 2024-01-15 ~ 2025-01-14（仍生效中）
- 期間剩餘點數：30,000

合約 #2: 2024-12-01 簽署，生效期 2025-01-15 ~ 2026-01-14
- 初始點數：234,000
```

#### 規則 4：提前續約點數發放

**決策**：簽約時立即發放，可提前使用

**執行流程**：

1. 2024-12-01 - 專案人員開立合約 #2
2. 系統自動：
   - 立即發放 234,000 點數
   - 總點數 = 30,000（合約 #1 剩餘）+ 234,000（合約 #2）= 264,000
3. 2024-12-01 ~ 2025-01-14 期間：
   - 機構可使用總計 264,000 點數
   - 教師授權仍為合約 #1 的數量（例如：10 位）
4. 2025-01-15 - 合約 #1 到期，合約 #2 生效：
   - 教師授權切換為合約 #2 的數量（例如：15 位）
   - 所有教師停用，需重新邀請

**理由**：

- 機構已完成付款，點數應立即可用
- 提前續約是機構的權利，不應限制資源使用
- 點數與教師授權分開管理，互不影響

### 情境 3：合約到期未續約

```
合約 #1: 2024-01-15 ~ 2025-01-14（到期）
- 期末剩餘點數：50,000 點
- 已邀請教師：10 位

（機構未續約，3 個月後才簽約）

合約 #2: 2025-04-15 ~ 2026-04-14
- 初始點數：234,000
```

#### 規則 5：空窗期教師狀態

**決策**：可登入查看，但功能受限（無法使用）

**執行流程**：

1. 2025-01-15 00:00:00 - 合約 #1 到期
2. 系統自動：
   - 訂閱狀態變更為 'expired'（已到期）
   - 教師帳號保持啟用，但標記為「受限模式」
3. 空窗期（2025-01-15 ~ 2025-04-14）：
   - 教師可登入系統
   - 教師可查看過往資料
   - 教師**無法**：
     - 建立新的練習任務
     - 批改學生作業
     - 使用任何消耗點數的功能

**理由**：

- 避免立即切斷服務造成用戶體驗不佳
- 保留歷史資料查閱權限
- 明確限制付費功能的使用

---

#### 規則 6：空窗期點數處理

**決策**：合約到期隔天清零舊點數

**執行流程**：

1. 2025-01-14 23:59:59 - 合約 #1 最後一天
   - 剩餘點數：50,000（仍可使用）
2. 2025-01-15 00:00:00 - 合約到期隔天
3. 系統自動：
   - 剩餘點數 50,000 清零
   - 記錄點數清零交易（transaction_type: 'expiration'）
   - 訂閱狀態變更為 'expired'
4. 2025-04-15 - 合約 #2 生效
5. 系統自動：
   - 發放新合約初始點數：234,000
   - 總點數從 234,000 開始（不累加舊點數）

**理由**：

- 合約最後一天仍可使用剩餘點數
- 到期隔天才清零，給機構使用完整的合約期間
- 簡化空窗期的點數管理邏輯
- 鼓勵機構及時續約

**特殊情境**：如果是**正常續約**（無空窗期），點數累加規則仍適用（規則 1）

---

## 影響範圍

### 資料表設計

**需要決定**：

- Contract_files 是否應包含業務欄位（purchased_teachers, bonus_teachers, initial_points）
- Subscriptions 表的角色：
  - 選項 A：聚合視圖（從所有合約計算）
  - 選項 B：快照實體（每次新增合約時更新）
  - 選項 C：移除 Subscriptions 表，所有邏輯基於 Contract_files

### 功能影響

- 專案人員開立訂閱功能
- 合約到期提醒與續約流程
- 教師帳號管理（停用/重新啟用）
- 點數交易記錄（續約時的點數累加）

---

## 信心評分

**High**

理由：

- ✅ 點數累加規則明確（正常續約）
- ✅ 教師授權重置規則明確（合約切換時全部停用）
- ✅ 降級處理規則明確（同樣重置）
- ✅ 提前續約點數發放規則明確（立即發放）
- ✅ 空窗期教師狀態明確（可登入但受限）
- ✅ 空窗期點數處理明確（清零）

所有核心續約情境已完整定義。
