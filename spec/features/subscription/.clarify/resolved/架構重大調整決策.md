# 架構重大調整決策記錄

## 決策日期

2026-01-09

## 背景說明

經與專案擁有人澄清，機構訂閱的實際業務流程為：

1. 線下簽約（紙本合約）
2. 線下付款（銀行轉帳/分期等）
3. 專案人員在後台手動開立機構訂閱
4. 合約電子檔上傳至系統供查閱

這與原先設計的「線上簽約付款」流程完全不同，需要重大架構調整。

## 核心決策

### 決策 #5-8：資料模型重構

#### 1. contracts 表 → contract_files 表

**決策**：

- 移除 `contracts` 表（含所有合約條款欄位）
- 新增 `contract_files` 表，僅儲存電子檔資訊

**contract_files 表結構**：

```dbml
Table contract_files {
  id uuid [pk]
  organization_id uuid [not null, ref: > organizations.id]

  // 檔案資訊
  file_name varchar(255) [not null, note: "原始檔名"]
  file_path varchar(500) [not null, note: "檔案儲存路徑"]
  file_size bigint [not null, note: "檔案大小（bytes）"]
  mime_type varchar(100) [not null, note: "檔案類型"]

  // 合約基本資訊（選填，方便搜尋）
  contract_number varchar(50) [null, note: "合約編號（如有）"]
  contract_type varchar(20) [null, note: "合約類型：yearly/two_years"]

  // 上傳資訊
  uploaded_by int [not null, ref: > users.id, note: "上傳者（專案人員）"]
  uploaded_at timestamp [not null, default: `now()`]

  // 備註
  notes text [null, note: "備註說明"]
}
```

**理由**：

- 合約是線下文件，系統只需儲存電子檔
- 一個機構可以有多份合約（續約）
- 合約條款內容在 PDF 中，不需要重複儲存在資料庫

#### 2. payments 表調整

**決策**：保留 payments 表，但簡化為線下付款記錄

**保留欄位**：

- 基本資訊：`payment_number`, `amount`, `currency`, `payment_method`
- 分期資訊：`installment_periods`, `installment_provider`（記錄線下分期）
- 時間資訊：`payment_date`（實際付款日期）
- 備註：`notes`

**移除欄位**：

- 線上付款專用：`transaction_id`, `payment_gateway`, `gateway_response`
- 狀態管理：`status`（線下付款無需狀態追蹤）

**調整後結構**：

```dbml
Table payments {
  id uuid [pk]
  organization_id uuid [not null, ref: > organizations.id]

  // 付款資訊
  payment_number varchar(50) [unique, not null, note: "付款編號"]
  payment_date date [not null, note: "實際付款日期"]
  amount decimal(12,2) [not null, note: "付款金額"]
  currency varchar(3) [not null, default: 'TWD', note: "幣別"]

  // 付款方式
  payment_method varchar(50) [not null, note: "付款方式：bank_transfer, aftee_installment, credit_card_installment"]
  installment_periods int [null, note: "分期期數（如適用）"]
  installment_provider varchar(50) [null, note: "分期提供方：aftee, yushan_bank, ctbc"]

  // 記錄資訊
  recorded_by int [not null, ref: > users.id, note: "記錄者（專案人員）"]
  notes text [null, note: "備註說明"]

  // 時間戳記
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [null]
}
```

#### 3. subscriptions 表擴充

**決策**：新增欄位以儲存合約條款快照

**新增欄位**：

```dbml
// 合約條款快照（專案人員填寫）
purchased_teachers int [not null, note: "購買教師數"]
bonus_teachers int [not null, note: "贈送教師數"]
initial_points bigint [not null, note: "初始點數"]

// 驗證約束
CHECK (total_teacher_licenses = purchased_teachers + bonus_teachers)
```

**欄位關係**：

- `total_teacher_licenses = purchased_teachers + bonus_teachers`（驗證用）
- `available_teacher_licenses = total_teacher_licenses - used_teacher_licenses`（計算）
- `total_points = initial_points + 後續加購`（累加）
- `remaining_points = total_points - used_points`（計算）

#### 4. subscriptions 與 contract_files 關聯

**決策**：多對多關聯（一個訂閱可關聯多份合約）

**實作方式**：

- 選項 A：在 `contract_files` 加入 `subscription_id` 欄位
- 選項 B：新增中間表 `subscription_contracts`

**建議**：選項 A（較簡單）

```dbml
Table contract_files {
  // ... 其他欄位
  subscription_id uuid [null, ref: > subscriptions.id, note: "關聯的訂閱（續約時同一訂閱有多份合約）"]
}
```

## 功能調整

### 3. 機構報價計算功能

**決策**：保留作為線上自助工具

**用途**：

- 機構用戶自行使用作參考
- 不涉及實際簽約流程
- 提供報價試算功能

**Feature 保持原樣**，僅調整說明：

```gherkin
功能: 機構報價計算
  作為 機構詢價者
  我希望能使用線上報價計算機
  以便了解不同方案的費用
```

### 4. 機構簽約與付款 → 專案人員開立機構訂閱

**決策**：重寫 Feature 為後台管理功能

**新 Feature 名稱**：「專案人員開立機構訂閱」

**核心流程**：

1. 專案人員建立機構（organization）
2. 上傳合約電子檔（contract_files）
3. 記錄付款資訊（payments）
4. 開立訂閱（subscriptions）- 填寫條款快照
5. 發放初始點數（points_transactions）

### 5. subscriptions 與 contract_files 關聯

**決策**：一個訂閱可關聯多份合約

**情境**：

- 初次簽約：1 個訂閱 → 1 份合約
- 續約：同一訂閱 → 新增一份合約（新的起訖日期）
- 合約變更：同一訂閱 → 新增補充合約

## 影響範圍

### 需要移除的檔案/內容

- `contracts` 表定義 - ✅ 已移除
- 「機構簽約與付款.feature」的付款流程部分 - ⏳ 保留原檔案供參考，已建立新檔案

### 需要新增的檔案/內容

- `contract_files` 表定義 - ✅ 已新增至 erm-subscription.dbml
- 「專案人員開立機構訂閱.feature」 - ✅ 已建立

### 需要修改的檔案/內容

- `subscriptions` 表（新增欄位） - ✅ 已完成
  - ✅ 新增 purchased_teachers, bonus_teachers, initial_points
  - ✅ 移除 contract_id
  - ✅ 更新 Note 說明
- `payments` 表（簡化欄位） - ✅ 已完成
  - ✅ 保留基本資訊與分期記錄
  - ✅ 移除線上付款專用欄位
  - ✅ 新增 recorded_by
  - ✅ 更新 Note 說明
- 「機構報價計算.feature」（調整說明） - ✅ 已保留為線上工具

## 相關釐清項目歸檔

以下釐清項目因架構調整而解決：

- Contract\_合約狀態轉換規則（無需狀態管理）
- Payment\_付款狀態轉換規則（無需狀態管理）
- Contract\_與訂閱的關聯關係（改為 contract_files）
- 機構簽約與付款\_付款失敗重試流程（無線上付款）
- 機構簽約與付款\_合約編號生成規則（改為上傳檔案）
- 機構簽約與付款\_AFTEE 分期期數選項（改為手動記錄）
- Payment\_付款方式枚舉值（簡化為線下方式）
- Payment\_分期提供方枚舉值（簡化為記錄欄位）

## 信心評分

**High**

理由：

- 基於專案擁有人的明確說明
- 符合實際業務流程
- 大幅簡化系統複雜度
- 更符合 B2B 人工介入的特性
