# Discovery 執行摘要 - 訂閱功能

## 執行資訊

- 執行日期：2026-01-07
- 掃描領域：subscription（訂閱與計費系統）
- 掃描範圍：
  - 資料模型：`spec/erm-subscription.dbml`
  - 功能模型：
    - `spec/features/subscription/機構報價計算.feature`
    - `spec/features/subscription/機構簽約與付款.feature`
    - `spec/features/subscription/點數加購.feature`

## 釐清項目統計

### 按分類統計

**資料模型相關**：12 項

    - contracts 表：2 項

- payments 表：3 項
- subscriptions 表：3 項
- points_transactions 表：2 項

- **功能模型相關**：10 項

  - 機構報價計算：3 項
  - 機構簽約與付款：4 項
  - 點數加購：3 項

- **跨檔案一致性**：3 項

**總計**：23 項

### 按優先級統計

**High**：8 項

- **Medium**：11 項
- **Low**：4 項

## 覆蓋度摘要

### A. 資料模型檢查（A1-A6）

| 檢查項             | 狀態    | 釐清項目數 | 說明                           |
| ------------------ | ------- | ---------- | ------------------------------ |
| A1. 實體完整性     | Clear   | 0          | 核心實體已定義完整             |
| A2. 屬性定義       | Partial | 0          | 屬性已定義，但部分枚舉值需釐清 |
| A3. 屬性值邊界條件 | Partial | 3          | 範圍限制需要釐清               |
| A4. 跨屬性不變條件 | Partial | 4          | 計算公式與關係需要確認         |
| A5. 關係與唯一性   | Partial | 1          | 合約與訂閱關係需釐清           |
| A6. 生命週期與狀態 | Missing | 5          | 狀態轉換規則未完整定義         |

### B. 功能模型檢查（B1-B5）

| 檢查項             | 狀態    | 釐清項目數 | 說明                 |
| ------------------ | ------- | ---------- | -------------------- |
| B1. 功能識別       | Clear   | 0          | 三個核心功能已識別   |
| B2. 規則完整性     | Partial | 4          | 部分邊界條件未涵蓋   |
| B3. 例子覆蓋度     | Clear   | 0          | 每個規則都有範例     |
| B4. 邊界條件覆蓋   | Partial | 3          | 輸入範圍與限制需釐清 |
| B5. 錯誤與異常處理 | Missing | 3          | 失敗場景未完整涵蓋   |

### C. 術語與一致性檢查（C1-C2）

| 檢查項       | 狀態    | 釐清項目數 | 說明           |
| ------------ | ------- | ---------- | -------------- |
| C1. 詞彙表   | Partial | 1          | 部分術語不一致 |
| C2. 術語衝突 | Partial | 1          | 發現同義詞混用 |

### D. 跨檔案一致性檢查（D1-D2）

| 檢查項                     | 狀態    | 釐清項目數 | 說明                          |
| -------------------------- | ------- | ---------- | ----------------------------- |
| D1. 跨 Feature 一致性      | Partial | 2          | 兩個 Feature 間計算邏輯不一致 |
| D2. Feature 與 DBML 一致性 | Clear   | 0          | 基本一致                      |

## 建議釐清順序

依照「由核心至延伸、平衡資料與功能分佈」原則，建議按以下順序處理釐清項目：

### 第一階段：核心資料模型與業務邏輯（High 優先級）

**目標**：解決影響最大的核心計算邏輯與資料一致性問題

（已釐清）

（已釐清）

3. **跨檔案一致性\_機構老師數與合約總教師數** (High) - 跨檔案

   - 原因：與前兩項相關，解決 Feature 間的計算邏輯矛盾
   - 依賴：前兩項釐清後再處理

（已釐清）

5. **術語一致性\_教師授權 vs 教師名額** (High) - 術語
   - 原因：統一術語後可減少後續混淆

### 第二階段：狀態管理與流程控制（High 優先級）

**目標**：定義完整的狀態轉換規則，確保業務流程清晰

6. **Contract\_合約狀態轉換規則** (High) - 資料

   - 原因：影響簽約與訂閱開通流程

7. **Payment\_付款狀態轉換規則** (High) - 資料

   - 原因：影響付款處理與重試邏輯

8. **Subscription\_訂閱狀態轉換規則** (High) - 資料

   - 原因：影響訂閱管理功能

9. **機構簽約與付款\_付款失敗重試流程** (High) - 功能

   - 原因：與付款狀態轉換緊密相關

10. **點數加購\_付款失敗處理邏輯** (High) - 功能
    - 原因：加購失敗處理的業務規則

### 第三階段：資料一致性維護（High 優先級）

**目標**：確保衍生欄位的計算與同步機制

11. **Subscription\_剩餘點數自動計算規則** (High) - 資料

    - 原因：點數餘額是核心業務資料，需確保一致性

12. **PointsTransaction\_首次發放前餘額** (High) - 資料
    - 原因：與點數餘額計算緊密相關

### 第四階段：細節與約束條件（Medium 優先級）

**目標**：補足邊界條件與枚舉值定義

13. **Payment\_付款方式枚舉值** (Medium) - 資料

    - 原因：影響付款選項與驗證邏輯

14. **Payment\_分期提供方枚舉值** (Medium) - 資料

    - 原因：影響分期選項

15. **機構簽約與付款\_AFTEE 分期期數選項** (Medium) - 功能

    - 原因：與分期提供方相關

16. **PointsTransaction\_交易類型完整枚舉** (Medium) - 資料

    - 原因：影響點數交易的分類

17. **Contract\_教師月費定價規則** (Medium) - 資料

    - 原因：確認定價是否固定

18. **Subscription\_授權數自動計算規則** (Medium) - 資料

    - 原因：與剩餘點數計算規則類似

19. **機構報價計算\_每週練習次數範圍限制** (Medium) - 功能

    - 原因：輸入驗證

20. **機構報價計算\_每次練習句數範圍限制** (Medium) - 功能

    - 原因：輸入驗證

21. **機構報價計算\_合約總價是否含稅** (Medium) - 功能

    - 原因：影響最終金額計算

22. **Contract\_與訂閱的關聯關係** (Medium) - 資料

    - 原因：影響續約流程設計

23. **訂閱到期\_剩餘點數處理** (Medium) - 功能

    - 原因：影響客戶滿意度

24. **合約管理\_提前終止規則** (Medium) - 功能

    - 原因：影響合約管理功能

25. **點數加購\_是否支援批量購買** (Medium) - 功能

    - 原因：影響資料模型設計

26. **PointsTransaction\_使用記錄時機** (Medium) - 資料
    - 原因：影響效能設計

### 第五階段：優化與擴充（Low 優先級）

**目標**：非核心功能的細節優化

27. **Contract\_點數單價是否可變** (Low) - 資料

    - 原因：目前固定值即可，未來可擴充

28. **點數加購\_加購頻率限制** (Low) - 功能

    - 原因：非必要限制

29. **機構簽約與付款\_合約編號生成規則** (Low) - 功能

    - 原因：實作細節

30. **機構報價計算\_報價結果是否儲存** (Low) - 功能
    - 原因：可後續擴充

## 釐清策略說明

### 平衡原則

### 依賴關係

以下釐清項目存在前置依賴：

（已釐清）

- 依賴：Contract*贈送教師數計算公式、Contract*購買教師數與總教師數關係

- **機構簽約與付款\_AFTEE 分期期數選項**

  - 依賴：Payment\_分期提供方枚舉值

- **PointsTransaction\_首次發放前餘額**
  - 依賴：Subscription\_剩餘點數自動計算規則

### 組合釐清

以下項目可一併處理：

**組合 1：贈送教師名額計算**

- Contract\_贈送教師數計算公式
- Contract\_購買教師數與總教師數關係
- 跨檔案一致性\_機構老師數與合約總教師數

**組合 2：付款方式定義**

- Payment\_付款方式枚舉值
- Payment\_分期提供方枚舉值
- 機構簽約與付款\_AFTEE 分期期數選項

**組合 3：狀態轉換規則**

- Contract\_合約狀態轉換規則
- Payment\_付款狀態轉換規則
- Subscription\_訂閱狀態轉換規則

**組合 4：點數計算與記錄**

- Subscription\_剩餘點數自動計算規則
- PointsTransaction\_首次發放前餘額
- PointsTransaction\_使用記錄時機

**組合 5：報價計算輸入驗證**

- 機構報價計算\_每週練習次數範圍限制
- 機構報價計算\_每次練習句數範圍限制

## 後續行動

1. **立即執行**：使用 `formulation.md` 或 `clarify-and-translation.md` 流程，按建議順序逐項釐清
2. **優先處理**：第一階段的 5 個 High 優先級項目（核心計算邏輯）
3. **批次處理**：考慮使用「組合釐清」方式，提高效率
4. **監控進度**：釐清完成後歸檔至 `.clarify/resolved/`，避免重複提問

## 釐清項目檔案清單

### 資料模型相關（.clarify/data/）

2. Contract\_購買教師數與總教師數關係.md (High)
3. Contract\_教師月費定價規則.md (Medium)
4. Contract\_點數單價是否可變.md (Low)
5. Contract\_合約狀態轉換規則.md (High)
6. Contract\_預估點數與購買點數關係.md (High)
7. Contract\_與訂閱的關聯關係.md (Medium)
8. Payment\_分期提供方枚舉值.md (Medium)
9. Payment\_付款方式枚舉值.md (Medium)
10. Payment\_付款狀態轉換規則.md (High)
11. Subscription\_授權數自動計算規則.md (Medium)
12. Subscription\_剩餘點數自動計算規則.md (High)
13. Subscription\_訂閱狀態轉換規則.md (High)
14. PointsTransaction\_交易類型完整枚舉.md (Medium)
15. PointsTransaction\_首次發放前餘額.md (High)
16. PointsTransaction\_使用記錄時機.md (Medium)

### 功能模型相關（.clarify/features/）

17. 機構報價計算\_每週練習次數範圍限制.md (Medium)
18. 機構報價計算\_每次練習句數範圍限制.md (Medium)
19. 機構報價計算\_合約總價是否含稅.md (Medium)
20. 機構報價計算\_報價結果是否儲存.md (Low)
21. 機構簽約與付款\_付款失敗重試流程.md (High)
22. 機構簽約與付款\_合約編號生成規則.md (Low)
23. 機構簽約與付款\_AFTEE 分期期數選項.md (Medium)
24. 點數加購\_付款失敗處理邏輯.md (High)
25. 點數加購\_加購頻率限制.md (Low)
26. 點數加購\_是否支援批量購買.md (Medium)
27. 術語一致性\_教師授權 vs 教師名額.md (High)
28. 跨檔案一致性\_機構老師數與合約總教師數.md (High)
29. 訂閱到期\_剩餘點數處理.md (Medium)
30. 合約管理\_提前終止規則.md (Medium)

---

**Discovery 階段完成**。可執行 Autopilot 的 Clarify 階段，或使用 `clarify-and-translation.md` 進行互動式釐清。
