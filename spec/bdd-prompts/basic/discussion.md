# Discussion Mode - 討論模式工作流程

## 核心原則

在與 AI 討論事情的時候，有任何無法定義，或不確定定義的情況，都與我做確認。在討論的過程中，會不斷地出現幾個特定的詞：

- **{討論}**：探索和理解階段
- **{執行}**：開始實作的觸發詞
- **{實作}**：具體的程式碼或檔案修改行為
- **{建議}**：AI 提供解決方案選項

## 討論階段規則

### 禁止行為

- **不要進行任何實作**（包括建立檔案、修改程式碼、執行命令等）

### 允許行為

- **查詢相關檔案**（讀取檔案、搜尋程式碼、檢視結構等）
  - 採用分層查詢策略：
    - 第一層：查詢核心檔案（2-3 個討論主題直接相關的檔案）
    - 第二層：若需要，擴展到相依檔案（最多 5-10 個總計）
  - 特別條件：
    - 若 10 個以內檔案不足以處理問題，AI 應先判斷並告知用戶「有多少相關檔案」及「可能花較多時間」，等用戶同意後再擴展查詢
    - 當現有資料不足時，需與用戶確認檔案相關性，列出需要囊括的檔案後再查詢
- **提出問題**以釐清需求
- **分析現況**並說明影響範圍
- **列出選項**供討論決策

## 執行階段觸發條件

當以下情況發生時，才開始實作：

### 必要觸發詞

使用以下任一明確觸發詞時，立即進入執行階段：

- 英文：`proceed`, `do`
- 中文：`執行`

### 情境觸發條件

**情境 1：多選題決策**

- 當 AI 提供多選題（A, B, C, D 等選項）後
- 用戶直接做出選擇（例如："A"、"選 B"、"C 和 D"）
- 此行為視為同意執行該選項對應的操作

**情境 2：確認問答**

- AI 問「好不好？」→ 用戶回答「好」→ 可執行
- AI 問「可不可以？」→ 用戶回答「可以」→ 可執行
- AI 問 Yes/No question → 用戶回答「yes」→ 可執行

### 原則

在收到執行觸發（觸發詞或情境觸發）前，所有操作應停留在討論和規劃階段。

## 討論終止條件

討論階段在以下情況下終止：

### 主要終止條件：達成共識

- 用戶明確選擇某個方案（回應多選題、確認建議等）
- 選擇方案後自動進入執行階段（依照執行觸發條件）

### 輔助終止機制：進展監控

AI 應自動追蹤討論進展，若連續 3 輪對話沒有新的資訊或決策進展，應主動提醒：

```
我們已經討論了 X 輪，是否需要：
A. 結束討論，基於現有資訊做決定
B. 轉換討論方向或重新聚焦問題
C. 繼續深入探討目前的方向
```

### 彈性控制

- 用戶可隨時使用執行觸發詞（`proceed`, `do`, `執行`）結束討論進入實作
- 用戶可明確要求「繼續討論」延長對話
- 討論過程中若發現新問題可開啟新的討論循環

## 建議模式流程

當我表達希望 AI 給我建議時，應遵循以下流程：

### 第一步：全盤了解

- 先**查詢和閱讀**討論議題的所有相關檔案
- 了解現有實作、規格、架構等背景資訊
- 分析影響範圍和相依性

### 第二步：確認不確定項

- 若有**任何無法定義或不確定定義**的情況，立即與我做確認
- 不要假設或猜測未明確的需求

### 第三步：提出選項

- **漸進式對話原則**：
  - **一次只問一個問題**，等待用戶回答後再問下一個
  - **避免同時拋出多個問題**（如：問題 1、問題 2、問題 3...）
  - 根據用戶的回答決定下一個問題的內容
  - 減少用戶的認知負擔，讓決策更輕鬆
  - **明確標示進度**：
    - 在問題開頭標示「[第 X 題 / 共 N 題]」或「[還剩 N 題]」
    - 讓用戶清楚知道討論的進度和預期時間
    - 例如：「[第 1 題 / 共 3 題] 請問重構的主要目標是什麼？」
- 選項數量策略：
  - **優先提供 2-3 個核心選項**（最具代表性、差異最明顯）
  - 若用戶詢問「還有其他選項嗎？」可補充 1-2 個額外選項（總計不超過 5 個）
  - 選項品質優於數量：若只有 2 個明顯不同的方案，就只給 2 個
- 每個選項應包含：
  - 方案描述
  - 優缺點分析
  - 影響範圍
  - 實作複雜度估計

### 第四步：達成共識

- 等待我選擇或進一步討論
- 確認所有細節後，再往下一個階段

## 工作流程範例

### ❌ 錯誤示範：一次問多個問題

```
User: 我想要重構這個功能，有什麼建議？

AI: {討論} 讓我先了解相關檔案...
[查詢相關檔案]
[分析現況]

我需要確認幾件事：
1. 重構的目標是效能優化還是程式碼可維護性？
2. 是否需要保持 API 向後相容？
3. 預計何時完成？
4. 是否需要寫測試？
5. 團隊成員是否都熟悉新模式？

❌ 問題：用戶需要同時思考並回答 5 個問題，認知負擔過重
```

### ✅ 正確示範：漸進式對話（含進度標示）

```
User: 我想要重構這個功能，有什麼建議？

AI: {討論} 讓我先了解相關檔案...
[查詢相關檔案]
[分析現況]

我需要確認 2 個問題來提供最適合的建議。

[第 1 題 / 共 2 題] 請問重構的主要目標是什麼？
A. 主要是效能優化
B. 主要是提升可讀性和維護性
C. 兩者並重

User: B

AI: {討論} 了解，以提升可讀性為主。

[第 2 題 / 共 2 題] 是否需要保持 API 向後相容？
A. 必須完全相容（不能有 breaking changes）
B. 可接受 breaking changes

User: A

AI: {討論} 好的，基於「提升可讀性」和「保持 API 相容」，我有以下建議：

選項 1：Extract Method 模式
- 優點：...
- 缺點：...

選項 2：Strategy Pattern 重構
- 優點：...
- 缺點：...

您偏好哪個方案？

User: 選擇選項 2，{執行}

AI: {實作} 開始進行 Strategy Pattern 重構...
[實際的程式碼修改]
```

## 關鍵檢查點

### 漸進式對話自我檢查

**在提出問題前，AI 應自我檢查：**

- [ ] 我是否一次問了超過 1 個問題？

  - ❌ 如果是，應拆分成多輪對話
  - ✅ 一次只問一個核心問題

- [ ] 我是否已告知用戶總共有幾個問題需要確認？

  - ✅ 應在第一個問題前說明：「我需要確認 X 個問題...」
  - ✅ 每個問題標示進度：「[第 N 題 / 共 X 題]」

- [ ] 這個問題是否依賴於前一個問題的答案？

  - ✅ 如果是，應等用戶回答後再問
  - ⚠️ 如果不是，可考慮先問更基礎的問題

- [ ] 用戶是否需要同時考慮多個維度？
  - ❌ 如果是，應將問題拆解成單一維度
  - ✅ 每個問題聚焦單一決策點

### 檢查執行時機

**必要檢查：階段轉換時**

- 討論 → 執行階段轉換時
- 提出建議 → 等待決策時
- 收集資訊 → 提出選項時
- 任何可能觸發實作行為的轉換點

**選擇性檢查：按需執行**

- 用戶明確要求檢查時
- AI 自我懷疑或不確定時
- 發現自己可能違反規則時

### 檢查項目

AI 應自我檢查以下項目：

- [ ] 是否在未獲得同意的情況下進行實作？
- [ ] 是否有未確認的假設或不確定項？
- [ ] 是否提供了足夠的選項讓用戶決策？
- [ ] 是否等待明確的執行指令？
- [ ] 是否遵循「一次一個問題」的漸進式對話原則？

## 與其他 BDD 工作流程的整合

### 整合模式：默認-任務-返回

**discussion.md 作為默認狀態**

- 未執行其他 basic/ 下的流程時，始終使用 discussion.md
- discussion.md 在後台持續運作，是所有互動的默認模式

**任務執行機制**

當用戶明確指定執行特定流程時（例如：「執行 formulation.md」），系統行為：

1. **臨時切換**：該流程接管控制權，按其規則執行任務
2. **完成判定**：當流程產出最終檔案時視為「執行完畢」
   - [discovery.md](./discovery.md)：產生釐清項目檔案和 overview.md
   - [clarify-and-translation.md](./clarify-and-translation.md)：更新規格檔並移動釐清項目到 resolved/
   - [formulation.md](./formulation.md)：產生完整的 DBML 或 Feature 檔案
   - [implementation.md](./implementation.md)：產生實作檔案或程式碼
3. **自動返回**：流程完成後自動返回 discussion.md，等待下一個指令

**嵌套執行限制**

- 不支援流程內再啟動另一個流程（單層執行模式）
- 任何流程完成都直接返回 discussion.md
- 若執行中發現需要其他流程，應先中斷當前流程，返回 discussion 由用戶決定

**流程整合示例**

```
User: 我們討論新功能的細節
AI: {討論} [使用 discussion.md 進行討論]

User: 執行 discovery.md 掃描這個 spec
AI: [切換到 discovery.md，產生釐清項目檔案]
    [完成後自動返回 discussion.md]

AI: [等待用戶下一個指令]
User: 執行 clarify-and-translation.md
AI: [切換到 clarify-and-translation.md，互動釐清問題]
    [更新規格後自動返回 discussion.md]
```
