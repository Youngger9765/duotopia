# 💳 金流測試指南 - Staging 環境

## 🎯 目標
讓案主可以在 Staging 環境完整測試金流，並在 TapPay 後台驗證交易記錄。

---

## 📋 測試前準備

### 1. **確認測試環境**
- **Staging Frontend**: https://duotopia-staging-frontend-b2ovkkgl6a-de.a.run.app
- **Staging Backend**: https://duotopia-staging-backend-b2ovkkgl6a-de.a.run.app
- **TapPay 環境**: Sandbox（沙盒測試環境）
- **TapPay Merchant ID**: `tppf_duotopia_GP_POS_3`

### 2. **TapPay 後台登入**
- **後台網址**: https://portal.tappaysdk.com/
- **登入帳號**: （請使用案主的 TapPay 帳號）
- **切換到**: Sandbox 環境（右上角下拉選單）

---

## 🧪 完整測試流程

### Step 1: 用戶註冊 & 登入

1. 前往 Staging 環境：https://duotopia-staging-frontend-b2ovkkgl6a-de.a.run.app
2. 註冊新教師帳號（或使用測試帳號）
3. 驗證 Email 並登入

---

### Step 2: 模擬訂閱到期

#### 情境 A: 新用戶（試用期）
- 新註冊用戶有 30 天免費試用
- 可以跳到 Step 3 直接測試續訂

#### 情境 B: 已過期用戶
- 如需測試「訂閱已過期」流程
- 請聯繫開發團隊手動將測試帳號設為過期狀態

---

### Step 3: 進入訂閱頁面

1. 登入後，前往「訂閱管理」或「方案選擇」頁面
2. 應該會看到：
   - ✅ 當前訂閱狀態（試用中/已過期）
   - ✅ 剩餘天數
   - ✅ 續訂按鈕

---

### Step 4: 選擇訂閱方案

**測試方案選項**：
- 📅 **月繳**: NT$ 399/月
- 📅 **季繳**: NT$ 1,097/季（8 折）
- 📅 **年繳**: NT$ 3,588/年（75 折）

點擊「立即訂閱」

---

### Step 5: 填寫付款資訊

#### 🔹 TapPay 測試卡號（Sandbox 環境）

**信用卡資訊**：
```
卡號：4242 4242 4242 4242
到期日：12/25（任何未來日期）
CVV：123（任意 3 碼）
持卡人姓名：Test User
```

#### 🔹 其他測試卡號

| 測試情境 | 卡號 | 結果 |
|---------|------|------|
| 成功交易 | `4242 4242 4242 4242` | ✅ 交易成功 |
| 餘額不足 | `4000 0000 0000 0002` | ❌ 餘額不足 |
| 卡片過期 | `4000 0000 0000 0069` | ❌ 卡片過期 |
| CVV 錯誤 | `4000 0000 0000 0127` | ❌ CVV 錯誤 |

---

### Step 6: 確認交易

1. 點擊「確認付款」
2. 應該會看到：
   - ⏳ 處理中畫面
   - ✅ 付款成功訊息
   - ✅ 訂閱啟用通知

3. **檢查前端狀態**：
   - 訂閱狀態更新為「啟用中」
   - 到期日期正確顯示
   - 可以正常使用所有功能

---

### Step 7: TapPay 後台驗證

#### 🔹 登入 TapPay Portal

1. 前往：https://portal.tappaysdk.com/
2. 登入案主的 TapPay 帳號
3. **切換到 Sandbox 環境**（右上角下拉選單）

#### 🔹 查看交易記錄

1. 進入「交易管理」→「交易紀錄」
2. 應該能看到剛剛的測試交易：
   ```
   交易時間：[剛剛的時間]
   商店代號：tppf_duotopia_GP_POS_3
   金額：NT$ [訂閱金額]
   狀態：成功
   ```

#### 🔹 檢查交易詳情

點擊交易記錄，確認以下資訊：
- ✅ **交易金額**正確
- ✅ **訂單編號**（可追蹤到 Duotopia 系統）
- ✅ **交易狀態**為「成功」
- ✅ **卡號末四碼**為 `4242`
- ✅ **交易時間**正確

---

## 🧪 測試案例清單

### ✅ 必測項目

- [ ] **1. 成功付款**
  - 使用 `4242 4242 4242 4242` 完成付款
  - 前端顯示訂閱成功
  - TapPay 後台有交易記錄

- [ ] **2. 訂閱狀態更新**
  - 付款後訂閱狀態立即更新
  - 到期日期正確計算
  - 功能權限正常開通

- [ ] **3. TapPay 後台對帳**
  - 交易金額正確
  - 商店代號正確
  - 訂單編號可追蹤

- [ ] **4. 付款失敗處理**
  - 使用 `4000 0000 0000 0002` 測試餘額不足
  - 應顯示錯誤訊息
  - 訂閱狀態不應改變

- [ ] **5. 多次訂閱測試**
  - 測試連續訂閱（續約）
  - 確認到期日累加正確

---

## 🔍 驗證重點

### 前端檢查
1. ✅ 付款流程順暢（無卡頓）
2. ✅ 錯誤訊息清楚易懂
3. ✅ 成功/失敗狀態明確
4. ✅ 訂閱資訊即時更新

### 後端檢查（TapPay Portal）
1. ✅ 交易記錄完整
2. ✅ 金額計算正確
3. ✅ 時間戳記準確
4. ✅ 狀態同步正確

### 業務邏輯檢查
1. ✅ 訂閱到期日計算正確
   - 月繳：+30 天
   - 季繳：+90 天
   - 年繳：+365 天
2. ✅ 權限控制正確
3. ✅ 重複訂閱處理正確

---

## 🚨 常見問題

### Q1: 測試卡號在 Sandbox 不扣款嗎？
**A**: 對，Sandbox 環境不會產生真實扣款，所有交易都是模擬的。

### Q2: TapPay 後台看不到交易記錄？
**A**: 請確認：
1. 已切換到 **Sandbox 環境**（不是 Production）
2. 使用正確的 TapPay 帳號登入
3. 查看時間範圍是否包含測試時間

### Q3: 付款失敗怎麼辦？
**A**: 請檢查：
1. 是否使用正確的測試卡號
2. 瀏覽器 Console 是否有錯誤訊息
3. 聯繫開發團隊提供錯誤日誌

### Q4: 訂閱狀態沒有更新？
**A**: 請：
1. 重新整理頁面
2. 檢查 TapPay 後台交易是否成功
3. 聯繫開發團隊檢查 webhook

---

## 📞 技術支援

遇到問題請聯繫開發團隊：

**提供以下資訊**：
1. 測試時間（精確到秒）
2. 使用的測試帳號 Email
3. 選擇的訂閱方案
4. 錯誤訊息截圖
5. TapPay 後台截圖（如有）

---

## 📊 測試報告範本

```markdown
## 金流測試報告

**測試環境**: Staging
**測試日期**: 2025-XX-XX
**測試人員**: [姓名]

### 測試結果

| 測試項目 | 結果 | 備註 |
|---------|------|------|
| 成功付款 | ✅ | 交易流暢 |
| TapPay 對帳 | ✅ | 記錄完整 |
| 訂閱狀態更新 | ✅ | 即時生效 |
| 付款失敗處理 | ✅ | 錯誤訊息清楚 |

### 問題與建議
1. [如有問題或建議，請列於此處]
```

---

## 💡 取消訂閱 & 退款政策決策

### 🎯 案主需要決定的事項

目前系統**已實作付款功能**，但**尚未實作取消訂閱和退款功能**。

請案主參考以下業界做法，決定 Duotopia 的政策：

---

### 📋 選項 A: 立即取消 + 比例退款

**運作方式**：
- 用戶取消後立即失去服務權限
- 按剩餘天數比例退款

**範例**：Spotify

**優點**：
- ✅ 對用戶公平
- ✅ 降低取消心理門檻

**缺點**：
- ❌ 需計算比例退款（技術複雜）
- ❌ 客服成本高

---

### 📋 選項 B: 期末取消（最常見）

**運作方式**：
- 用戶取消後，服務繼續到當期結束
- 不退款（用戶已付費可用完）
- 到期後自動停止續訂

**範例**：Netflix, GitHub, Notion, Slack

**優點**：
- ✅ 用戶體驗好
- ✅ 不需處理退款
- ✅ 技術實作簡單
- ✅ 業界標準做法

**缺點**：
- ❌ 無

**前端顯示範例**：
```
您的訂閱將在 2025/12/31 到期後停止續訂。
在此之前，您仍可繼續使用所有功能。
```

---

### 📋 選項 C: 混合模式（推薦）

**運作方式**：
- **前 7 天內取消**：全額退款 + 立即停止服務
- **7 天後取消**：不退款 + 服務到期末

**範例**：Apple App Store, Google Play

**優點**：
- ✅ 符合消保法 7 天鑑賞期
- ✅ 降低購買風險
- ✅ 建立品牌信任
- ✅ 減少退款爭議

**缺點**：
- ⚠️ 需判斷是否在鑑賞期內（技術複雜度中等）

---

### 🏛️ 台灣消保法說明

**7 天鑑賞期規定**：
- 網路購物需提供 7 天無條件退款
- **但**數位內容若用戶已使用，可不適用

**Duotopia 的立場**：
- 法律上：可不提供鑑賞期（已使用的數位服務）
- 建議：**仍提供 7 天退款**（建立信任、減少爭議）

---

### 📊 方案比較

| 項目 | A 立即取消 | B 期末取消 | C 混合模式 |
|------|-----------|-----------|-----------|
| 用戶體驗 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 技術複雜度 | 🔴 高 | 🟢 低 | 🟡 中 |
| 客服成本 | 🔴 高 | 🟢 低 | 🟡 中 |
| 品牌形象 | 🟡 普通 | 🟡 普通 | 🟢 良好 |
| 業界標準 | ❌ 少見 | ✅ 最常見 | ✅ 常見 |

---

### ✅ 案主決策清單

**請勾選您的決定**：

#### 1. 採用哪種取消政策？
- [ ] 選項 A：立即取消 + 比例退款
- [ ] 選項 B：期末取消（最常見）
- [ ] 選項 C：混合模式（7天鑑賞期 + 期末取消）⭐ 推薦

#### 2. 如選擇選項 C，鑑賞期天數？
- [ ] 7 天（符合消保法）⭐ 推薦
- [ ] 14 天
- [ ] 30 天

#### 3. 退款處理時間
- [ ] 立即退款（TapPay API 自動處理）⭐ 推薦
- [ ] 3-5 個工作天（手動處理）
- [ ] 7-14 個工作天

#### 4. 取消時是否詢問原因？
- [ ] 是（可了解改進方向）
- [ ] 否（降低取消摩擦）⭐ 推薦

#### 5. 是否提供「暫停訂閱」功能？
- [ ] 是（技術複雜，不建議）
- [ ] 否 ⭐ 推薦

---

### 🛠️ 如採用選項 C，需要實作的功能

**資料庫欄位**：
```python
cancel_at_period_end: bool  # 期末取消標記
cancelled_at: datetime      # 取消時間
refund_eligible_until: datetime  # 可退款截止日
```

**API 端點**：
```
POST /api/subscription/cancel  # 取消訂閱
POST /api/subscription/refund  # 申請退款（7天內）
GET  /api/subscription/cancellation-policy  # 查詢取消政策
```

**前端 UI**：
- 訂閱管理頁面顯示「取消訂閱」按鈕
- 取消前顯示政策說明（依剩餘天數）
- 確認後執行取消或退款

**開發時間估計**：
- 資料庫修改：0.5 天
- 後端 API：1 天
- 前端 UI：1 天
- 測試：0.5 天
- **總計：3 天**

---

### 📝 決策記錄

**決策日期**: ________________

**採用方案**: [ ] A / [ ] B / [ ] C

**政策說明**:
- 鑑賞期：_____ 天（如選 C）
- 退款方式：___________________
- 取消原因調查：[ ] 是 / [ ] 否
- 暫停訂閱：[ ] 是 / [ ] 否

**備註**:
_________________________________
_________________________________

---

**✅ 完成以上測試與決策後，開發團隊將根據決定實作相應功能！**
