<!DOCTYPE html>
<html>
<head>
    <title>æ¸¬è©¦æ¨™ç±¤åŠŸèƒ½</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f4f4f4; padding: 10px; }
    </style>
</head>
<body>
    <h1>æ¨™ç±¤åŠŸèƒ½å‰ç«¯æ¸¬è©¦</h1>

    <div class="test">
        <h2>1. ç™»å…¥æ¸¬è©¦</h2>
        <button onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
        <div id="loginResult"></div>
    </div>

    <div class="test">
        <h2>2. å»ºç«‹å¸¶æ¨™ç±¤çš„èª²ç¨‹</h2>
        <button onclick="testCreateWithTags()">æ¸¬è©¦å»ºç«‹</button>
        <div id="createResult"></div>
    </div>

    <div class="test">
        <h2>3. æŸ¥è©¢èª²ç¨‹æª¢æŸ¥æ¨™ç±¤</h2>
        <button onclick="testQueryPrograms()">æŸ¥è©¢èª²ç¨‹</button>
        <div id="queryResult"></div>
    </div>

    <script>
        let token = '';
        let classroomId = 0;

        async function testLogin() {
            const result = document.getElementById('loginResult');
            try {
                const response = await fetch('http://localhost:8000/api/auth/teacher/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@duotopia.com',
                        password: 'demo123'
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    token = data.access_token;
                    result.innerHTML = '<div class="success">âœ… ç™»å…¥æˆåŠŸï¼Token å·²å„²å­˜</div>';

                    // å–å¾—ç­ç´š
                    const classroomsResponse = await fetch('http://localhost:8000/api/teachers/classrooms', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const classrooms = await classroomsResponse.json();
                    if (classrooms.length > 0) {
                        classroomId = classrooms[0].id;
                        result.innerHTML += `<div>ç­ç´š ID: ${classroomId}</div>`;
                    }
                } else {
                    result.innerHTML = `<div class="error">âŒ ç™»å…¥å¤±æ•—: ${JSON.stringify(data)}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ éŒ¯èª¤: ${error}</div>`;
            }
        }

        async function testCreateWithTags() {
            if (!token) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            const result = document.getElementById('createResult');
            const programData = {
                name: 'å‰ç«¯æ¸¬è©¦æ¨™ç±¤èª²ç¨‹ ' + new Date().getTime(),
                description: 'æ¸¬è©¦æ¨™ç±¤æ˜¯å¦èƒ½å„²å­˜',
                level: 'B1',
                estimated_hours: 20,
                tags: ['å‰ç«¯æ¸¬è©¦', 'æ¨™ç±¤åŠŸèƒ½', 'JavaScript', 'æ¸¬è©¦ä¸­']
            };

            try {
                result.innerHTML = '<div>é€å‡ºè³‡æ–™:</div><pre>' + JSON.stringify(programData, null, 2) + '</pre>';

                const response = await fetch(`http://localhost:8000/api/programs/create-custom?classroom_id=${classroomId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(programData)
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML += '<div class="success">âœ… å»ºç«‹æˆåŠŸï¼</div>';
                    result.innerHTML += '<div>å›æ‡‰è³‡æ–™:</div><pre>' + JSON.stringify(data, null, 2) + '</pre>';

                    // æª¢æŸ¥æ¨™ç±¤
                    if (data.tags) {
                        const tagsMatch = JSON.stringify(data.tags) === JSON.stringify(programData.tags);
                        if (tagsMatch) {
                            result.innerHTML += '<div class="success">âœ… æ¨™ç±¤æ­£ç¢ºå„²å­˜ï¼</div>';
                        } else {
                            result.innerHTML += '<div class="error">âŒ æ¨™ç±¤ä¸ç¬¦åˆ</div>';
                        }
                    } else {
                        result.innerHTML += '<div class="error">âŒ å›æ‡‰ä¸­æ²’æœ‰ tags æ¬„ä½</div>';
                    }
                } else {
                    result.innerHTML += `<div class="error">âŒ å»ºç«‹å¤±æ•—: ${response.status}</div>`;
                    result.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                result.innerHTML += `<div class="error">âŒ éŒ¯èª¤: ${error}</div>`;
            }
        }

        async function testQueryPrograms() {
            if (!token) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            const result = document.getElementById('queryResult');

            try {
                const response = await fetch('http://localhost:8000/api/teachers/programs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const programs = await response.json();

                if (response.ok) {
                    result.innerHTML = `<div class="success">âœ… å–å¾— ${programs.length} å€‹èª²ç¨‹</div>`;

                    // æ‰¾å‡ºæœ‰æ¨™ç±¤çš„èª²ç¨‹
                    const programsWithTags = programs.filter(p => p.tags && p.tags.length > 0);
                    result.innerHTML += `<div>æœ‰æ¨™ç±¤çš„èª²ç¨‹: ${programsWithTags.length} å€‹</div>`;

                    // é¡¯ç¤ºå‰3å€‹æœ‰æ¨™ç±¤çš„èª²ç¨‹
                    programsWithTags.slice(0, 3).forEach(p => {
                        result.innerHTML += `<div>ğŸ“š ${p.name}: ${JSON.stringify(p.tags)}</div>`;
                    });

                    // é¡¯ç¤ºå®Œæ•´è³‡æ–™
                    if (programsWithTags.length > 0) {
                        result.innerHTML += '<div>ç¬¬ä¸€å€‹æœ‰æ¨™ç±¤çš„èª²ç¨‹è©³ç´°è³‡æ–™:</div>';
                        result.innerHTML += '<pre>' + JSON.stringify(programsWithTags[0], null, 2) + '</pre>';
                    }
                } else {
                    result.innerHTML = `<div class="error">âŒ æŸ¥è©¢å¤±æ•—: ${response.status}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">âŒ éŒ¯èª¤: ${error}</div>`;
            }
        }
    </script>
</body>
</html>
