# Migration 策略分析

## 🎯 兩個選擇

### 選擇1：一次性整理 Alembic + 重新 TDD ⭐ **推薦**

#### 優勢 ✅
- **乾淨的開始**：沒有歷史包袱，migration 歷史簡潔
- **一次到位**：所有新表格結構一次設計好
- **完整測試**：重新建立 TDD，確保所有功能正確
- **無風險**：還沒上線，不會影響生產資料
- **易於維護**：未來的 migration 歷史更清晰

#### 劣勢 ❌
- **工作量大**：需要重新建立所有 migration
- **一次性風險**：需要確保一次就做對

#### 實施步驟
1. 備份現有資料庫
2. 重置 Alembic 歷史
3. 建立全新的 initial migration（包含新表格）
4. 重新建立完整的 TDD 測試套件
5. 一次性驗證所有功能

---

### 選擇2：漸進式遷移

#### 優勢 ✅
- **風險低**：逐步驗證每個步驟
- **保留歷史**：現有 migration 歷史完整保留
- **可回滾**：每步都可以回滾

#### 劣勢 ❌
- **複雜**：migration 歷史會很複雜
- **歷史包袱**：舊的設計決策會保留在歷史中
- **維護困難**：未來要理解為什麼有這些 migration

## 🏆 **建議：選擇1 - 一次性整理**

### 為什麼選擇1更好？

#### 🎯 **你的情況特殊**
- ✅ **還沒上線** - 沒有生產資料風險
- ✅ **開發階段** - 可以大膽重構
- ✅ **架構變更大** - 從 JSONB 改為關聯式設計
- ✅ **團隊小** - 協調成本低

#### 📊 **長期收益**
- **維護成本低** - 乾淨的 migration 歷史
- **新人友善** - 容易理解系統架構
- **未來擴展** - 良好的基礎架構

## 🚀 **具體實施計畫**

### **Phase 1: 準備工作** (1天)

1. **備份當前狀態**
   ```bash
   # 匯出當前資料庫結構
   pg_dump duotopia > backup_before_redesign.sql

   # 建立 Git 分支
   git checkout -b feature/clean-migration-redesign
   ```

2. **分析現有結構**
   ```bash
   # 檢查當前有哪些表格
   psql duotopia -c "\\dt"

   # 匯出現有資料
   python scripts/export_current_data.py
   ```

### **Phase 2: 重置 Migration** (0.5天)

1. **清理 Alembic 歷史**
   ```bash
   # 刪除舊的 migration 檔案
   rm alembic/versions/20250902_*.py
   rm alembic/versions/20250905_*.py
   rm alembic/versions/20250906_*.py
   rm alembic/versions/20250907_*.py
   rm alembic/versions/20250910_*.py
   rm alembic/versions/20250917_*.py

   # 重置 alembic_version 表
   alembic stamp head
   ```

2. **建立全新 Initial Migration**
   ```bash
   alembic revision --autogenerate -m "initial_schema_with_content_items"
   ```

### **Phase 3: 重新設計 TDD** (2天)

1. **建立新的測試契約**
   - 學生錄音上傳流程
   - 老師檢視學生進度
   - AI 評分儲存
   - 課程內容管理

2. **完整的測試覆蓋**
   - Unit tests: 新模型關係
   - Integration tests: API 端點
   - E2E tests: 完整使用者流程

### **Phase 4: 一次性實施** (2天)

1. **執行新 Migration**
2. **更新所有程式碼**
3. **執行完整測試**
4. **手動驗證功能**

### **Phase 5: 驗證** (1天)

1. **效能測試**
2. **資料完整性檢查**
3. **使用者介面測試**

## 📊 **風險評估**

### **高風險** 🔴
- 一次性變更大，如果出錯影響面廣

### **緩解措施** 🛡️
- ✅ 完整備份
- ✅ 完整 TDD 測試
- ✅ 階段性驗證
- ✅ 可以回滾到備份

## 🎯 **成功標準**

### **技術指標**
- [ ] 所有新測試 100% 通過
- [ ] API 回應時間 < 200ms
- [ ] 資料庫查詢效能提升 > 3x
- [ ] 零資料遺失

### **功能指標**
- [ ] 學生可以正常使用所有功能
- [ ] 老師可以檢視詳細的學生進度
- [ ] AI 評分正確對應題目
- [ ] 不再有陣列同步錯誤

## 💡 **決定因素**

關鍵問題：**你希望 6 個月後的自己看到什麼樣的程式碼？**

- **選擇1**: 乾淨、易懂、好維護的程式碼
- **選擇2**: 有歷史包袱、需要解釋的程式碼

## 🚀 **我的強烈建議**

**選擇1 - 一次性整理**，因為：

1. **現在是最佳時機** - 還沒上線
2. **長期收益大** - 乾淨的架構
3. **風險可控** - 有完整備份和測試
4. **學習價值高** - 正確的重構經驗

**你覺得如何？要不要直接開始執行選擇1的計畫？**
