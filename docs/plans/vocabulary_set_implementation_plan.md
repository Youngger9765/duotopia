# å–®å­—é›† (VOCABULARY_SET) å¯¦ä½œè¨ˆåŠƒ

> âš ï¸ **æ³¨æ„**ï¼šæ­¤åŠŸèƒ½ç›®å‰ç‚º **Phase 2**ï¼Œå°šæœªå¯¦ä½œã€‚
>
> æ­¤æ–‡ä»¶ä¿ç•™å®Œæ•´å¯¦ä½œè¨ˆåŠƒä¾›æœªä¾†é–‹ç™¼åƒè€ƒã€‚

---

## æ¦‚è¿°

| é …ç›® | èªªæ˜ |
|------|------|
| ContentType | `VOCABULARY_SET` |
| ä¸­æ–‡åç¨± | å–®å­—é›† |
| èˆŠåç¨± | SENTENCE_MAKINGï¼ˆå·²æ£„ç”¨ï¼‰ |
| ç›®å‰ç‹€æ…‹ | â¸ï¸ Phase 2 - å°šæœªå¯¦ä½œ |

---

## ğŸ“‹ ç›®éŒ„

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [âš ï¸ å‘å¾Œå…¼å®¹æ€§è€ƒé‡](#å‘å¾Œå…¼å®¹æ€§è€ƒé‡)
3. [è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ](#è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ)
4. [å¾Œç«¯ API è¨­è¨ˆ](#å¾Œç«¯-api-è¨­è¨ˆ)
5. [å‰ç«¯çµ„ä»¶è¨­è¨ˆ](#å‰ç«¯çµ„ä»¶è¨­è¨ˆ)
6. [è‰¾è³“æµ©æ–¯è¨˜æ†¶æ›²ç·šæ¼”ç®—æ³•](#è‰¾è³“æµ©æ–¯è¨˜æ†¶æ›²ç·šæ¼”ç®—æ³•)
7. [å¯¦ä½œå„ªå…ˆé †åº](#å¯¦ä½œå„ªå…ˆé †åº)
8. [æ¸¬è©¦è¨ˆåŠƒ](#æ¸¬è©¦è¨ˆåŠƒ)

---

## åŠŸèƒ½æ¦‚è¿°

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

**é€ å¥ç·´ç¿’**æ˜¯ä¸€å€‹çµåˆè‰¾è³“æµ©æ–¯è¨˜æ†¶æ›²ç·šçš„è‹±æ–‡å­¸ç¿’ç³»çµ±ï¼Œæ”¯æ´å…©ç¨®ç­”é¡Œæ¨¡å¼ï¼š

1. **è½åŠ›æ¨¡å¼ä½œç­”**
   - æ’­æ”¾å–®å­—éŸ³æª”
   - å­¸ç”Ÿè½éŸ³æª”å¾Œé¸æ“‡å–®å­—çµ„æˆå¥å­
   - é©åˆè½åŠ›è¨“ç·´å’ŒèªéŸ³è¨˜æ†¶

2. **å¯«ä½œæ¨¡å¼ä½œç­”**
   - ä¸æ’­æ”¾éŸ³æª”
   - å­¸ç”Ÿç´”ç²¹çœ‹é¡Œç›®é¸æ“‡å–®å­—çµ„æˆå¥å­
   - é©åˆé–±è®€ç†è§£å’Œæ–‡å­—è¨˜æ†¶

### ğŸ§  è‰¾è³“æµ©æ–¯è¨˜æ†¶æ›²ç·šæ•´åˆ

- ç³»çµ±æ ¹æ“šå­¸ç”Ÿçš„è¨˜æ†¶å¼·åº¦æ™ºèƒ½é¸æ“‡ç·´ç¿’å–®å­—
- æ¯æ¬¡ç­”é¡Œå¾Œæ›´æ–°è¨˜æ†¶å¼·åº¦å’Œä¸‹æ¬¡è¤‡ç¿’æ™‚é–“
- å„ªå…ˆç·´ç¿’å³å°‡éºå¿˜çš„å–®å­—
- é”åˆ°ç›®æ¨™ç†Ÿæ‚‰åº¦å¾Œå®Œæˆä½œæ¥­

---

## âš ï¸ å‘å¾Œå…¼å®¹æ€§è€ƒé‡

### ğŸ¯ æ ¸å¿ƒåŸå‰‡

**çµ•å°ä¸èƒ½å½±éŸ¿ç¾æœ‰çš„æœ—è®€è©•æ¸¬åŠŸèƒ½ï¼**

é€ å¥ç·´ç¿’æ˜¯ä¸€å€‹**æ–°å¢åŠŸèƒ½**ï¼Œè€Œéä¿®æ”¹åŠŸèƒ½ã€‚æ‰€æœ‰æ–°å¢çš„ä»£ç¢¼ã€è³‡æ–™åº«æ¬„ä½ã€API éƒ½å¿…é ˆç¢ºä¿ï¼š
1. ä¸ç ´å£ç¾æœ‰æœ—è®€è©•æ¸¬ä½œæ¥­çš„å‰µå»º
2. ä¸ç ´å£ç¾æœ‰æœ—è®€è©•æ¸¬ä½œæ¥­çš„é¡¯ç¤º
3. ä¸ç ´å£ç¾æœ‰æœ—è®€è©•æ¸¬ä½œæ¥­çš„ç­”é¡Œæµç¨‹
4. ä¸ç ´å£ç¾æœ‰å­¸ç”Ÿä½œæ¥­æ•¸æ“š

---

### ğŸ”’ é—œéµæª¢æŸ¥é»

#### 1. è³‡æ–™åº«å±¤é¢

**âœ… æ­£ç¢ºåšæ³•**ï¼š
```sql
-- âœ… æ·»åŠ æ¬„ä½æ™‚å¿…é ˆè¨­ç½®é è¨­å€¼ï¼Œç¢ºä¿ç¾æœ‰è³‡æ–™ä¸å—å½±éŸ¿
ALTER TABLE assignments ADD COLUMN IF NOT EXISTS
  answer_mode VARCHAR(20) DEFAULT 'writing' CHECK (answer_mode IN ('listening', 'writing'));
```

**âŒ éŒ¯èª¤åšæ³•**ï¼š
```sql
-- âŒ ä¸è¨­ç½®é è¨­å€¼æœƒå°è‡´ç¾æœ‰è¨˜éŒ„å‡ºç¾ NULL
ALTER TABLE assignments ADD COLUMN answer_mode VARCHAR(20) NOT NULL;
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] `answer_mode` æ¬„ä½æœ‰é è¨­å€¼ `'writing'`
- [ ] ç¾æœ‰çš„æœ—è®€è©•æ¸¬ä½œæ¥­è‡ªå‹•è¨­ç‚º `'writing'` æ¨¡å¼ï¼ˆé›–ç„¶ä¸ä½¿ç”¨ï¼‰
- [ ] æ–°å¢çš„è¡¨ (`user_word_progress`, `practice_sessions`, `practice_answers`) ä¸å½±éŸ¿ç¾æœ‰è¡¨
- [ ] æ‰€æœ‰ Foreign Key ä½¿ç”¨ `ON DELETE CASCADE` é¿å…å­¤å…’è¨˜éŒ„

#### 2. å¾Œç«¯ API å±¤é¢

**âœ… æ­£ç¢ºåšæ³•**ï¼š
```python
class AssignmentCreate(BaseModel):
    title: str
    description: Optional[str] = None
    classroom_id: int
    content_ids: List[int]
    student_ids: List[int] = []
    due_date: Optional[datetime] = None
    answer_mode: str = "writing"  # âœ… æœ‰é è¨­å€¼ï¼ŒèˆŠç‰ˆå‰ç«¯ä¸å‚³æ­¤åƒæ•¸ä¹Ÿèƒ½æ­£å¸¸é‹ä½œ
```

**âŒ éŒ¯èª¤åšæ³•**ï¼š
```python
class AssignmentCreate(BaseModel):
    title: str
    answer_mode: str  # âŒ å¿…å¡«æ¬„ä½æœƒå°è‡´èˆŠç‰ˆå‰ç«¯ç„¡æ³•å‰µå»ºä½œæ¥­
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] `answer_mode` åƒæ•¸ç‚ºé¸å¡«ï¼Œæœ‰é è¨­å€¼
- [ ] å‰µå»ºä½œæ¥­ API åœ¨æ²’æœ‰ `answer_mode` æ™‚é è¨­ç‚º `'writing'`
- [ ] å›å‚³çš„ä½œæ¥­è³‡æ–™åŒ…å« `answer_mode`ï¼Œä½†èˆŠç‰ˆå‰ç«¯å¯å¿½ç•¥æ­¤æ¬„ä½
- [ ] ä¸ä¿®æ”¹ä»»ä½•ç¾æœ‰ API çš„å¿…å¡«åƒæ•¸

#### 3. å‰ç«¯è·¯ç”±å±¤é¢

**âœ… æ­£ç¢ºåšæ³•**ï¼š
```typescript
// StudentActivityPageContent.tsx
const renderActivity = () => {
  const contentType = assignment.content?.type;

  if (contentType === "reading_assessment") {
    // âœ… æœ—è®€è©•æ¸¬èµ°åŸæœ¬çš„ ReadingAssessmentTemplate
    return <ReadingAssessmentTemplate {...props} />;
  }

  if (contentType === "sentence_making") {
    // âœ… é€ å¥ç·´ç¿’èµ°æ–°çš„ SentenceMakingActivity
    return <SentenceMakingActivity {...props} />;
  }

  // âœ… æœªä¾†çš„æ–°é¡å‹...
  return <DefaultTemplate />;
};
```

**âŒ éŒ¯èª¤åšæ³•**ï¼š
```typescript
// âŒ ä¸è¦æ ¹æ“š answer_mode è·¯ç”±ï¼Œé€™æœƒå½±éŸ¿æœ—è®€è©•æ¸¬
if (assignment.answer_mode === "listening") {
  return <ListeningModeTemplate />;  // âŒ éŒ¯èª¤ï¼æœ—è®€è©•æ¸¬ä¹Ÿå¯èƒ½æœ‰ answer_mode
}
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] è·¯ç”±é‚è¼¯åªæ ¹æ“š `content.type` åˆ¤æ–·ï¼Œä¸çœ‹ `answer_mode`
- [ ] `answer_mode` åªåœ¨ `sentence_making` é¡å‹å…§éƒ¨ä½¿ç”¨
- [ ] æœ—è®€è©•æ¸¬çš„çµ„ä»¶å®Œå…¨ä¸å— `answer_mode` å½±éŸ¿
- [ ] é è¨­æƒ…æ³ä¸‹å›é€€åˆ°æœ—è®€è©•æ¸¬ï¼ˆå‘å¾Œå…¼å®¹ï¼‰

#### 4. å­¸ç”Ÿä½œæ¥­å¯¦ä¾‹å±¤é¢

**âœ… æ­£ç¢ºåšæ³•**ï¼š
```python
# å‰µå»ºå­¸ç”Ÿä½œæ¥­æ™‚ï¼Œæ ¹æ“š content.type æ±ºå®šè™•ç†æ–¹å¼
if content.type == ContentType.READING_ASSESSMENT:
    # âœ… æœ—è®€è©•æ¸¬ä½¿ç”¨åŸæœ¬çš„é‚è¼¯
    student_content_progress = StudentContentProgress(
        student_assignment_id=student_assignment.id,
        content_id=content.id,
        status=AssignmentStatusEnum.NOT_STARTED
        # ä¸å‰µå»º user_word_progressï¼Œä¸å½±éŸ¿ç¾æœ‰æµç¨‹
    )
elif content.type == ContentType.SENTENCE_MAKING:
    # âœ… é€ å¥ç·´ç¿’æ‰ä½¿ç”¨æ–°çš„è¨˜æ†¶æ›²ç·šç³»çµ±
    student_content_progress = StudentContentProgress(
        student_assignment_id=student_assignment.id,
        content_id=content.id,
        status=AssignmentStatusEnum.NOT_STARTED
    )
    # åªæœ‰é€ å¥ç·´ç¿’æ‰åˆå§‹åŒ– user_word_progress
```

**âŒ éŒ¯èª¤åšæ³•**ï¼š
```python
# âŒ ä¸è¦å°æ‰€æœ‰ä½œæ¥­éƒ½å‰µå»º user_word_progress
for content in contents:
    # ç‚ºæ‰€æœ‰å…§å®¹å‰µå»ºè¨˜æ†¶é€²åº¦ï¼ˆåŒ…æ‹¬æœ—è®€è©•æ¸¬ï¼‰âŒ
    user_word_progress = UserWordProgress(...)
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] `user_word_progress` åªç‚º `sentence_making` é¡å‹å‰µå»º
- [ ] æœ—è®€è©•æ¸¬ä½œæ¥­å®Œå…¨ä¸ä½¿ç”¨è¨˜æ†¶æ›²ç·šç³»çµ±
- [ ] å­¸ç”Ÿä½œæ¥­ç‹€æ…‹æ›´æ–°é‚è¼¯æ ¹æ“šé¡å‹åˆ†æµ
- [ ] åˆ†æ•¸è¨ˆç®—é‚è¼¯æ ¹æ“šé¡å‹åˆ†æµ

#### 5. å‰ç«¯çµ„ä»¶å±¤é¢

**âœ… æ­£ç¢ºåšæ³•**ï¼š
```typescript
// AssignmentDialog.tsx
{getSelectedContentType() === "sentence_making" && (
  <div className="mt-2 pt-2 border-t border-blue-200">
    {/* âœ… åªåœ¨é€ å¥ç·´ç¿’æ™‚é¡¯ç¤ºç­”é¡Œæ¨¡å¼é¸æ“‡å™¨ */}
    <div className="text-xs font-medium text-blue-900 mb-2">
      ç­”é¡Œæ¨¡å¼ï¼š
    </div>
    <RadioGroup value={formData.answer_mode} ...>
      {/* Radio é¸é … */}
    </RadioGroup>
  </div>
)}
```

**âŒ éŒ¯èª¤åšæ³•**ï¼š
```typescript
// âŒ ä¸è¦å°æ‰€æœ‰ä½œæ¥­é¡å‹éƒ½é¡¯ç¤ºç­”é¡Œæ¨¡å¼
<RadioGroup value={formData.answer_mode}>
  {/* é€™æœƒåœ¨æœ—è®€è©•æ¸¬æ™‚ä¹Ÿé¡¯ç¤ºï¼Œé€ æˆå›°æƒ‘ */}
</RadioGroup>
```

**æª¢æŸ¥æ¸…å–®**ï¼š
- [ ] ç­”é¡Œæ¨¡å¼é¸æ“‡å™¨åªåœ¨ `sentence_making` é¡å‹é¡¯ç¤º
- [ ] æœ—è®€è©•æ¸¬çš„è¡¨å–®ä¸åŒ…å« `answer_mode` é¸é …
- [ ] UI æ–‡æ¡ˆæ˜ç¢ºå€åˆ†æœ—è®€è©•æ¸¬å’Œé€ å¥ç·´ç¿’
- [ ] ä½œæ¥­å¡ç‰‡é¡¯ç¤ºæ­£ç¢ºçš„é¡å‹æ¨™ç±¤

---

### ğŸ§ª å‘å¾Œå…¼å®¹æ€§æ¸¬è©¦å ´æ™¯

#### Scenario 1: ç¾æœ‰æœ—è®€è©•æ¸¬ä½œæ¥­ä¸å—å½±éŸ¿

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
1. ä½¿ç”¨æ–°ç‰ˆä»£ç¢¼å•Ÿå‹•ç³»çµ±
2. æŸ¥è©¢è³‡æ–™åº«ä¸­ç¾æœ‰çš„æœ—è®€è©•æ¸¬ä½œæ¥­
3. ç¢ºèª `answer_mode` æ¬„ä½è‡ªå‹•å¡«å……ç‚º `'writing'`
4. å­¸ç”Ÿæ‰“é–‹ç¾æœ‰çš„æœ—è®€è©•æ¸¬ä½œæ¥­
5. ç¢ºèªé¡¯ç¤ºåŸæœ¬çš„æœ—è®€è©•æ¸¬ä»‹é¢ï¼ˆä¸æ˜¯é€ å¥ç·´ç¿’ä»‹é¢ï¼‰
6. å­¸ç”Ÿå®Œæˆä½œæ¥­ä¸¦æäº¤
7. ç¢ºèªè©•åˆ†å’Œè¨˜éŒ„æ­£å¸¸

**é æœŸçµæœ**ï¼š
- âœ… æ‰€æœ‰ç¾æœ‰ä½œæ¥­æ­£å¸¸é‹ä½œ
- âœ… å­¸ç”Ÿçœ‹ä¸åˆ°ä»»ä½•è®ŠåŒ–
- âœ… è€å¸«çœ‹ä¸åˆ°ä»»ä½•è®ŠåŒ–
- âœ… è³‡æ–™åº«è¨˜éŒ„æ­£å¸¸

#### Scenario 2: å‰µå»ºæ–°çš„æœ—è®€è©•æ¸¬ä½œæ¥­

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
1. è€å¸«å‰µå»ºæ–°çš„æœ—è®€è©•æ¸¬ä½œæ¥­
2. é¸æ“‡ `content.type = "reading_assessment"`
3. ç¢ºèªä½œæ¥­æ‘˜è¦ä¸­**ä¸é¡¯ç¤º**ç­”é¡Œæ¨¡å¼é¸æ“‡å™¨
4. æäº¤ä½œæ¥­
5. å­¸ç”Ÿæ‰“é–‹ä½œæ¥­
6. ç¢ºèªé¡¯ç¤ºæœ—è®€è©•æ¸¬ä»‹é¢

**é æœŸçµæœ**ï¼š
- âœ… æœ—è®€è©•æ¸¬ä½œæ¥­å‰µå»ºæµç¨‹ä¸è®Š
- âœ… ä¸æœƒå‡ºç¾ç­”é¡Œæ¨¡å¼é¸æ“‡å™¨
- âœ… å­¸ç”Ÿç«¯æ­£å¸¸é¡¯ç¤ºæœ—è®€è©•æ¸¬

#### Scenario 3: å‰µå»ºæ–°çš„é€ å¥ç·´ç¿’ä½œæ¥­

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
1. è€å¸«å‰µå»ºæ–°çš„é€ å¥ç·´ç¿’ä½œæ¥­
2. é¸æ“‡ `content.type = "sentence_making"`
3. ç¢ºèªä½œæ¥­æ‘˜è¦ä¸­**é¡¯ç¤º**ç­”é¡Œæ¨¡å¼é¸æ“‡å™¨
4. é¸æ“‡ã€Œå¯«ä½œæ¨¡å¼ã€æˆ–ã€Œè½åŠ›æ¨¡å¼ã€
5. æäº¤ä½œæ¥­
6. å­¸ç”Ÿæ‰“é–‹ä½œæ¥­
7. ç¢ºèªé¡¯ç¤ºå°æ‡‰çš„é€ å¥ç·´ç¿’ä»‹é¢

**é æœŸçµæœ**ï¼š
- âœ… æ–°åŠŸèƒ½æ­£å¸¸é‹ä½œ
- âœ… ä¸å½±éŸ¿æœ—è®€è©•æ¸¬

#### Scenario 4: æ··åˆä½œæ¥­ï¼ˆåŒ…å«æœ—è®€è©•æ¸¬å’Œé€ å¥ç·´ç¿’ï¼‰

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
1. è€å¸«åœ¨åŒä¸€å€‹ä½œæ¥­ä¸­é¸æ“‡ï¼š
   - 2 å€‹æœ—è®€è©•æ¸¬å…§å®¹
   - 2 å€‹é€ å¥ç·´ç¿’å…§å®¹
2. ç”±æ–¼é¡å‹é™åˆ¶ï¼Œæ‡‰è©²**ç„¡æ³•åŒæ™‚é¸æ“‡**
3. ç¢ºèª UI æ­£ç¢ºç¦ç”¨ä¸åŒé¡å‹çš„å…§å®¹

**é æœŸçµæœ**ï¼š
- âœ… é¡å‹é™åˆ¶æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- âœ… ä¸æœƒå‰µå»ºæ··åˆé¡å‹ä½œæ¥­
- âœ… é¿å…äº†è¤‡é›œçš„ç›¸å®¹æ€§å•é¡Œ

#### Scenario 5: API å‘å¾Œå…¼å®¹æ€§

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
1. ä½¿ç”¨èˆŠç‰ˆå‰ç«¯ï¼ˆæ²’æœ‰ `answer_mode` åƒæ•¸ï¼‰
2. èª¿ç”¨ `/api/teachers/assignments/create` API
3. Request Body ä¸åŒ…å« `answer_mode`
4. ç¢ºèªä½œæ¥­æˆåŠŸå‰µå»º
5. ç¢ºèª `answer_mode` è‡ªå‹•è¨­ç‚º `'writing'`

**é æœŸçµæœ**ï¼š
- âœ… èˆŠç‰ˆå‰ç«¯ç¹¼çºŒæ­£å¸¸é‹ä½œ
- âœ… ä¸æœƒå‡ºç¾é©—è­‰éŒ¯èª¤
- âœ… é è¨­å€¼æ­£ç¢º

---

### ğŸ“ Migration å®‰å…¨æ€§æª¢æŸ¥

åœ¨åŸ·è¡Œè³‡æ–™åº« Migration å‰ï¼Œå¿…é ˆç¢ºèªï¼š

```bash
# 1. å‚™ä»½è³‡æ–™åº«
pg_dump duotopia_production > backup_before_sentence_making_$(date +%Y%m%d).sql

# 2. åœ¨æ¸¬è©¦ç’°å¢ƒå…ˆåŸ·è¡Œ
alembic upgrade head --sql > migration.sql
# æª¢æŸ¥ SQL æ˜¯å¦åŒ…å« DROPã€TRUNCATE ç­‰å±éšªæŒ‡ä»¤

# 3. ç¢ºèªé è¨­å€¼
grep "DEFAULT" migration.sql
# æ‡‰è©²çœ‹åˆ°ï¼šanswer_mode VARCHAR(20) DEFAULT 'writing'

# 4. åœ¨æ¸¬è©¦ç’°å¢ƒåŸ·è¡Œä¸¦é©—è­‰
alembic upgrade head
# æª¢æŸ¥ç¾æœ‰è³‡æ–™æ˜¯å¦æ­£å¸¸

# 5. åŸ·è¡Œå‘å¾Œå…¼å®¹æ€§æ¸¬è©¦ï¼ˆä¸Šè¿° 5 å€‹ Scenariosï¼‰

# 6. æ­£å¼ç’°å¢ƒåŸ·è¡Œï¼ˆç¶­è­·çª—å£ï¼‰
alembic upgrade head
```

---

### ğŸš¨ ç´…ç·šè¦å‰‡ï¼ˆçµ•å°ç¦æ­¢ï¼‰

1. âŒ **çµ•å°ä¸è¦**ä¿®æ”¹ç¾æœ‰çš„ `reading_assessment` ç›¸é—œä»£ç¢¼é‚è¼¯
2. âŒ **çµ•å°ä¸è¦**åœ¨æœ—è®€è©•æ¸¬æµç¨‹ä¸­èª¿ç”¨è¨˜æ†¶æ›²ç·šç›¸é—œå‡½æ•¸
3. âŒ **çµ•å°ä¸è¦**è®“ `answer_mode` æˆç‚ºå¿…å¡«æ¬„ä½
4. âŒ **çµ•å°ä¸è¦**æ ¹æ“š `answer_mode` è·¯ç”±æ‰€æœ‰ä½œæ¥­é¡å‹
5. âŒ **çµ•å°ä¸è¦**åœ¨æ²’æœ‰å‚™ä»½çš„æƒ…æ³ä¸‹åŸ·è¡Œ Migration
6. âŒ **çµ•å°ä¸è¦**åˆªé™¤æˆ–é‡å‘½åç¾æœ‰çš„è³‡æ–™åº«æ¬„ä½
7. âŒ **çµ•å°ä¸è¦**ä¿®æ”¹ç¾æœ‰ API çš„å›å‚³æ ¼å¼ï¼ˆåªèƒ½æ–°å¢æ¬„ä½ï¼‰

---

### âœ… å®‰å…¨å¯¦ä½œæª¢æŸ¥æ¸…å–®

**åœ¨é–‹å§‹ Phase 1 ä¹‹å‰**ï¼š
- [ ] å·²é–±è®€ä¸¦ç†è§£æ‰€æœ‰å‘å¾Œå…¼å®¹æ€§è¦æ±‚
- [ ] å·²è¦åŠƒ Migration å›æ»¾ç­–ç•¥
- [ ] å·²æº–å‚™æ¸¬è©¦ç’°å¢ƒå’Œè³‡æ–™

**Phase 1 å®Œæˆå¾Œ**ï¼š
- [ ] è³‡æ–™åº«æ¬„ä½æœ‰æ­£ç¢ºçš„é è¨­å€¼
- [ ] ç¾æœ‰è³‡æ–™çš„ `answer_mode` å·²è‡ªå‹•å¡«å……
- [ ] Migration å¯ä»¥å®‰å…¨å›æ»¾

**Phase 2 å®Œæˆå¾Œ**ï¼š
- [ ] API åƒæ•¸éƒ½æ˜¯é¸å¡«
- [ ] èˆŠç‰ˆå‰ç«¯æ¸¬è©¦é€šé
- [ ] æœ—è®€è©•æ¸¬ä½œæ¥­å‰µå»ºæ¸¬è©¦é€šé

**Phase 3 å®Œæˆå¾Œ**ï¼š
- [ ] è·¯ç”±é‚è¼¯åªæ ¹æ“š `content.type`
- [ ] æœ—è®€è©•æ¸¬ä»‹é¢å®Œå…¨ä¸è®Š
- [ ] UI æ¢ä»¶æ¸²æŸ“æ­£ç¢º

**ä¸Šç·šå‰**ï¼š
- [ ] æ‰€æœ‰ 5 å€‹å‘å¾Œå…¼å®¹æ€§æ¸¬è©¦å ´æ™¯é€šé
- [ ] è³‡æ–™åº«å·²å‚™ä»½
- [ ] å›æ»¾è¨ˆåŠƒå·²æº–å‚™
- [ ] ç›£æ§å‘Šè­¦å·²è¨­ç½®

---

## è³‡æ–™åº«æ¶æ§‹è¨­è¨ˆ

### ğŸ“Š Schema æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   assignments   â”‚  ä½œæ¥­ä¸»è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ student_        â”‚ â”‚
â”‚ assignments     â”‚ â”‚  å­¸ç”Ÿä½œæ¥­å¯¦ä¾‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ user_word_progress       â”‚  è¨˜æ†¶å¼·åº¦è¿½è¹¤ï¼ˆæ ¸å¿ƒï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ practice_       â”‚  ç·´ç¿’è¨˜éŒ„
â”‚ sessions        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ practice_       â”‚  ç­”é¡Œè©³ç´°è¨˜éŒ„
â”‚ answers         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. assignments è¡¨ï¼ˆä½œæ¥­ä¸»è¡¨ï¼‰- éœ€è¦æ–°å¢æ¬„ä½

```sql
ALTER TABLE assignments ADD COLUMN IF NOT EXISTS
  answer_mode VARCHAR(20) DEFAULT 'writing' CHECK (answer_mode IN ('listening', 'writing'));

-- ç­”é¡Œæ¨¡å¼ï¼š'listening' è½åŠ›æ¨¡å¼ï¼Œ'writing' å¯«ä½œæ¨¡å¼
-- é è¨­ç‚º 'writing'
```

**èªªæ˜**ï¼š
- ä½œæ¥­å‰µå»ºæ™‚ç”±è€å¸«é¸æ“‡ç­”é¡Œæ¨¡å¼
- åŒä¸€å€‹ä½œæ¥­çš„æ‰€æœ‰å­¸ç”Ÿä½¿ç”¨ç›¸åŒçš„ç­”é¡Œæ¨¡å¼

### 2. user_word_progress è¡¨ï¼ˆå­¸ç”Ÿå–®å­—è¨˜æ†¶é€²åº¦ï¼‰- æ–°å¢

```sql
CREATE TABLE IF NOT EXISTS user_word_progress (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  student_assignment_id INTEGER NOT NULL REFERENCES student_assignments(id) ON DELETE CASCADE,
  content_item_id INTEGER NOT NULL REFERENCES content_items(id) ON DELETE CASCADE,

  -- è‰¾è³“æµ©æ–¯è¨˜æ†¶æ›²ç·šç›¸é—œæ¬„ä½
  memory_strength DECIMAL(5,4) DEFAULT 0 CHECK (memory_strength >= 0 AND memory_strength <= 1),
  -- è¨˜æ†¶å¼·åº¦ (0-1)ï¼Œ0 è¡¨ç¤ºå®Œå…¨ä¸è¨˜å¾—ï¼Œ1 è¡¨ç¤ºå®Œå…¨è¨˜ä½

  repetition_count INTEGER DEFAULT 0,
  -- é€£çºŒç­”å°æ¬¡æ•¸ï¼ˆSuperMemo-2 æ¼”ç®—æ³•ç”¨ï¼‰

  correct_count INTEGER DEFAULT 0,
  -- ç´¯è¨ˆç­”å°æ¬¡æ•¸

  incorrect_count INTEGER DEFAULT 0,
  -- ç´¯è¨ˆç­”éŒ¯æ¬¡æ•¸

  last_review_at TIMESTAMPTZ,
  -- æœ€å¾Œè¤‡ç¿’æ™‚é–“

  next_review_at TIMESTAMPTZ,
  -- ä¸‹æ¬¡å»ºè­°è¤‡ç¿’æ™‚é–“ï¼ˆæ ¹æ“šéºå¿˜æ›²ç·šè¨ˆç®—ï¼‰

  easiness_factor DECIMAL(3,2) DEFAULT 2.5 CHECK (easiness_factor >= 1.3),
  -- é›£æ˜“åº¦å› å­ï¼ˆSM-2 æ¼”ç®—æ³•ï¼‰ï¼Œ1.3-2.5ï¼Œæ•¸å­—è¶Šå¤§è¡¨ç¤ºè¶Šå®¹æ˜“è¨˜ä½

  interval_days DECIMAL(10,2) DEFAULT 1,
  -- ç›®å‰è¤‡ç¿’é–“éš”å¤©æ•¸

  -- çµ±è¨ˆè³‡æ–™
  total_attempts INTEGER DEFAULT 0,
  -- ç¸½å˜—è©¦æ¬¡æ•¸

  accuracy_rate DECIMAL(5,4) DEFAULT 0,
  -- æ­£ç¢ºç‡ = correct_count / total_attempts

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(student_assignment_id, content_item_id)
  -- ç¢ºä¿æ¯å€‹å­¸ç”Ÿä½œæ¥­ä¸­çš„æ¯å€‹ content_item åªæœ‰ä¸€æ¢è¨˜éŒ„
);

-- ç´¢å¼•å„ªåŒ–
CREATE INDEX idx_user_word_progress_student ON user_word_progress(student_id, student_assignment_id);
CREATE INDEX idx_user_word_progress_next_review ON user_word_progress(student_assignment_id, next_review_at);
CREATE INDEX idx_user_word_progress_memory ON user_word_progress(memory_strength);
```

### 3. practice_sessions è¡¨ï¼ˆç·´ç¿’è¨˜éŒ„ï¼‰- æ–°å¢

```sql
CREATE TABLE IF NOT EXISTS practice_sessions (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  student_assignment_id INTEGER NOT NULL REFERENCES student_assignments(id) ON DELETE CASCADE,

  -- ç·´ç¿’æ¨¡å¼
  practice_mode VARCHAR(20) NOT NULL CHECK (practice_mode IN ('listening', 'writing')),

  -- æœ¬æ¬¡ç·´ç¿’çµ±è¨ˆ
  words_practiced INTEGER NOT NULL DEFAULT 0,
  -- æœ¬æ¬¡ç·´ç¿’çš„å–®å­—æ•¸ï¼ˆé€šå¸¸æ˜¯ 10 å€‹ï¼‰

  correct_count INTEGER DEFAULT 0,
  -- æœ¬æ¬¡ç·´ç¿’ç­”å°é¡Œæ•¸

  total_time_seconds INTEGER DEFAULT 0,
  -- ç¸½èŠ±è²»æ™‚é–“ï¼ˆç§’ï¼‰

  -- æ™‚é–“æˆ³è¨˜
  started_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_practice_sessions_student ON practice_sessions(student_id, student_assignment_id);
CREATE INDEX idx_practice_sessions_started ON practice_sessions(started_at);
```

### 4. practice_answers è¡¨ï¼ˆç­”é¡Œè©³ç´°è¨˜éŒ„ï¼‰- æ–°å¢

```sql
CREATE TABLE IF NOT EXISTS practice_answers (
  id SERIAL PRIMARY KEY,
  practice_session_id INTEGER NOT NULL REFERENCES practice_sessions(id) ON DELETE CASCADE,
  content_item_id INTEGER NOT NULL REFERENCES content_items(id),

  -- ç­”é¡Œçµæœ
  is_correct BOOLEAN NOT NULL,
  time_spent_seconds INTEGER DEFAULT 0,

  -- å­¸ç”Ÿç­”æ¡ˆï¼ˆJSON æ ¼å¼å„²å­˜ï¼‰
  answer_data JSONB,
  -- ä¾‹å¦‚: {"selected_words": ["How", "are", "you"], "attempts": 3}

  -- æ™‚é–“æˆ³è¨˜
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_practice_answers_session ON practice_answers(practice_session_id);
CREATE INDEX idx_practice_answers_item ON practice_answers(content_item_id);
```

### 5. content_items è¡¨ï¼ˆå…§å®¹é …ç›®ï¼‰- å·²å­˜åœ¨ï¼Œéœ€ç¢ºèªæ¬„ä½

```sql
-- ç¢ºèª content_items è¡¨æœ‰ä»¥ä¸‹æ¬„ä½ï¼š
-- - id
-- - content_id
-- - text (å–®å­—)
-- - translation (ä¸­æ–‡ç¿»è­¯)
-- - example_sentence (ä¾‹å¥)
-- - example_sentence_translation (ä¾‹å¥ä¸­æ–‡ç¿»è­¯)
-- - audio_url (éŸ³æª” URL)
-- - order_index (æ’åº)
```

---

## å¾Œç«¯ API è¨­è¨ˆ

### ğŸ”Œ API ç«¯é»åˆ—è¡¨

#### 1. å‰µå»ºä½œæ¥­ï¼ˆå·²å­˜åœ¨ï¼Œéœ€ä¿®æ”¹ï¼‰

**ç«¯é»**: `POST /api/teachers/assignments/create`

**Request Body**:
```json
{
  "title": "Week 1 Vocabulary",
  "description": "Practice common words",
  "classroom_id": 1,
  "content_ids": [1, 2, 3],
  "student_ids": [10, 11, 12],
  "due_date": "2025-12-01T00:00:00Z",
  "answer_mode": "listening"  // âœ¨ æ–°å¢æ¬„ä½
}
```

**ä¿®æ”¹ä½ç½®**: `/backend/routers/teachers.py`

```python
class AssignmentCreate(BaseModel):
    title: str
    description: Optional[str] = None
    classroom_id: int
    content_ids: List[int]
    student_ids: List[int] = []
    due_date: Optional[datetime] = None
    answer_mode: str = "writing"  # âœ¨ æ–°å¢ï¼šç­”é¡Œæ¨¡å¼ï¼Œé è¨­å¯«ä½œæ¨¡å¼
```

#### 2. ç²å–ç·´ç¿’é¡Œç›®ï¼ˆæ–°å¢ï¼‰

**ç«¯é»**: `GET /api/students/assignments/{assignment_id}/practice-words`

**åŠŸèƒ½**: æ ¹æ“šè‰¾è³“æµ©æ–¯æ›²ç·šé¸æ“‡ 10 å€‹éœ€è¦ç·´ç¿’çš„å–®å­—

**Response**:
```json
{
  "session_id": 123,
  "answer_mode": "listening",
  "words": [
    {
      "content_item_id": 45,
      "text": "apple",
      "translation": "è˜‹æœ",
      "example_sentence": "I eat an apple every day.",
      "example_sentence_translation": "æˆ‘æ¯å¤©åƒä¸€å€‹è˜‹æœã€‚",
      "audio_url": "https://storage.../apple.mp3",
      "memory_strength": 0.3,
      "priority_score": 75
    }
    // ... 9 more words
  ]
}
```

**å¯¦ä½œé‚è¼¯**:
```python
@router.get("/assignments/{assignment_id}/practice-words")
async def get_practice_words(
    assignment_id: int,
    current_student: Student = Depends(get_current_student),
    db: Session = Depends(get_db)
):
    # 1. å–å¾—å­¸ç”Ÿä½œæ¥­å¯¦ä¾‹
    student_assignment = db.query(StudentAssignment).filter(
        StudentAssignment.assignment_id == assignment_id,
        StudentAssignment.student_number == current_student.student_number
    ).first()

    if not student_assignment:
        raise HTTPException(404, "ä½œæ¥­ä¸å­˜åœ¨")

    # 2. å‰µå»ºæ–°çš„ç·´ç¿’ session
    practice_session = PracticeSession(
        student_id=current_student.id,
        student_assignment_id=student_assignment.id,
        practice_mode=student_assignment.assignment.answer_mode
    )
    db.add(practice_session)
    db.commit()

    # 3. ä½¿ç”¨ SQL function é¸æ“‡ 10 å€‹å–®å­—
    words = db.execute(
        text("""
            SELECT * FROM get_words_for_practice(
                :student_assignment_id,
                :limit_count
            )
        """),
        {
            "student_assignment_id": student_assignment.id,
            "limit_count": 10
        }
    ).fetchall()

    return {
        "session_id": practice_session.id,
        "answer_mode": practice_session.practice_mode,
        "words": [dict(word) for word in words]
    }
```

#### 3. æäº¤ç­”æ¡ˆï¼ˆæ–°å¢ï¼‰

**ç«¯é»**: `POST /api/students/practice-sessions/{session_id}/submit-answer`

**Request Body**:
```json
{
  "content_item_id": 45,
  "is_correct": true,
  "time_spent_seconds": 12,
  "answer_data": {
    "selected_words": ["I", "eat", "an", "apple", "every", "day"],
    "attempts": 2
  }
}
```

**Response**:
```json
{
  "success": true,
  "new_memory_strength": 0.65,
  "next_review_at": "2025-12-03T10:30:00Z"
}
```

**å¯¦ä½œé‚è¼¯**:
```python
@router.post("/practice-sessions/{session_id}/submit-answer")
async def submit_answer(
    session_id: int,
    answer: PracticeAnswerSubmit,
    current_student: Student = Depends(get_current_student),
    db: Session = Depends(get_db)
):
    # 1. é©—è­‰ session å±¬æ–¼ç•¶å‰å­¸ç”Ÿ
    session = db.query(PracticeSession).filter(
        PracticeSession.id == session_id,
        PracticeSession.student_id == current_student.id
    ).first()

    if not session:
        raise HTTPException(404, "ç·´ç¿’ session ä¸å­˜åœ¨")

    # 2. è¨˜éŒ„ç­”æ¡ˆ
    practice_answer = PracticeAnswer(
        practice_session_id=session_id,
        content_item_id=answer.content_item_id,
        is_correct=answer.is_correct,
        time_spent_seconds=answer.time_spent_seconds,
        answer_data=answer.answer_data
    )
    db.add(practice_answer)

    # 3. æ›´æ–°è¨˜æ†¶å¼·åº¦ï¼ˆä½¿ç”¨ PostgreSQL functionï¼‰
    result = db.execute(
        text("""
            SELECT * FROM update_memory_strength(
                :student_assignment_id,
                :content_item_id,
                :is_correct
            )
        """),
        {
            "student_assignment_id": session.student_assignment_id,
            "content_item_id": answer.content_item_id,
            "is_correct": answer.is_correct
        }
    ).fetchone()

    db.commit()

    return {
        "success": True,
        "new_memory_strength": result.memory_strength,
        "next_review_at": result.next_review_at
    }
```

#### 4. æª¢æŸ¥ä½œæ¥­å®Œæˆåº¦ï¼ˆæ–°å¢ï¼‰

**ç«¯é»**: `GET /api/students/assignments/{assignment_id}/mastery-status`

**Response**:
```json
{
  "current_mastery": 0.87,
  "target_mastery": 0.90,
  "achieved": false,
  "words_mastered": 23,
  "total_words": 30,
  "weak_words": [
    {
      "text": "difficult",
      "memory_strength": 0.45,
      "last_review_at": "2025-11-20T10:00:00Z"
    }
  ]
}
```

---

## å‰ç«¯çµ„ä»¶è¨­è¨ˆ

### ğŸ¨ çµ„ä»¶çµæ§‹

```
StudentActivityPageContent (å·²å­˜åœ¨)
  â””â”€ SentenceMakingActivity (æ–°å¢)
       â”œâ”€ ListeningModeTemplate (æ–°å¢)
       â”‚    â”œâ”€ AudioPlayer
       â”‚    â”œâ”€ WordChoicePanel
       â”‚    â””â”€ ProgressIndicator
       â”‚
       â””â”€ WritingModeTemplate (æ–°å¢)
            â”œâ”€ QuestionDisplay
            â”œâ”€ WordChoicePanel
            â””â”€ ProgressIndicator
```

### ğŸ“¦ çµ„ä»¶è©³ç´°è¨­è¨ˆ

#### 1. SentenceMakingActivity (ä¸»çµ„ä»¶)

**ä½ç½®**: `/frontend/src/components/activities/SentenceMakingActivity.tsx`

**åŠŸèƒ½**:
- ç²å–ç·´ç¿’é¡Œç›®
- æ ¹æ“š answer_mode æ±ºå®šä½¿ç”¨ ListeningModeTemplate æˆ– WritingModeTemplate
- ç®¡ç†ç­”é¡Œç‹€æ…‹å’Œé€²åº¦

**State ç®¡ç†**:
```typescript
interface SentenceMakingState {
  sessionId: number | null;
  answerMode: "listening" | "writing";
  words: PracticeWord[];
  currentIndex: number;
  answers: AnswerRecord[];
  loading: boolean;
  masteryStatus: MasteryStatus | null;
}

interface PracticeWord {
  content_item_id: number;
  text: string;
  translation: string;
  example_sentence: string;
  example_sentence_translation: string;
  audio_url?: string;
  memory_strength: number;
  priority_score: number;
}

interface AnswerRecord {
  content_item_id: number;
  is_correct: boolean;
  time_spent_seconds: number;
  answer_data: {
    selected_words: string[];
    attempts: number;
  };
}
```

**æ ¸å¿ƒé‚è¼¯**:
```typescript
const SentenceMakingActivity: React.FC<Props> = ({ assignmentId }) => {
  const [state, setState] = useState<SentenceMakingState>({
    sessionId: null,
    answerMode: "writing",
    words: [],
    currentIndex: 0,
    answers: [],
    loading: true,
    masteryStatus: null,
  });

  // åˆå§‹åŒ–ï¼šç²å–ç·´ç¿’é¡Œç›®
  useEffect(() => {
    loadPracticeWords();
  }, [assignmentId]);

  const loadPracticeWords = async () => {
    try {
      const response = await apiClient.get(
        `/api/students/assignments/${assignmentId}/practice-words`
      );

      setState((prev) => ({
        ...prev,
        sessionId: response.session_id,
        answerMode: response.answer_mode,
        words: response.words,
        loading: false,
      }));
    } catch (error) {
      console.error("Failed to load practice words:", error);
      toast.error("ç„¡æ³•è¼‰å…¥ç·´ç¿’é¡Œç›®");
    }
  };

  // æäº¤ç­”æ¡ˆ
  const submitAnswer = async (answer: AnswerRecord) => {
    try {
      await apiClient.post(
        `/api/students/practice-sessions/${state.sessionId}/submit-answer`,
        answer
      );

      // è¨˜éŒ„ç­”æ¡ˆ
      setState((prev) => ({
        ...prev,
        answers: [...prev.answers, answer],
      }));

      // ç§»å‹•åˆ°ä¸‹ä¸€é¡Œ
      if (state.currentIndex < state.words.length - 1) {
        setState((prev) => ({ ...prev, currentIndex: prev.currentIndex + 1 }));
      } else {
        // å®Œæˆæœ¬è¼ªç·´ç¿’ï¼Œæª¢æŸ¥é”æ¨™ç‹€æ…‹
        checkMasteryStatus();
      }
    } catch (error) {
      console.error("Failed to submit answer:", error);
      toast.error("æäº¤ç­”æ¡ˆå¤±æ•—");
    }
  };

  // æª¢æŸ¥é”æ¨™ç‹€æ…‹
  const checkMasteryStatus = async () => {
    const status = await apiClient.get(
      `/api/students/assignments/${assignmentId}/mastery-status`
    );

    setState((prev) => ({ ...prev, masteryStatus: status }));

    if (status.achieved) {
      toast.success("æ­å–œï¼æ‚¨å·²é”æˆç›®æ¨™ç†Ÿæ‚‰åº¦ï¼");
      // è·³è½‰åˆ°å®Œæˆé é¢æˆ–è¿”å›ä½œæ¥­åˆ—è¡¨
    } else {
      toast.info(
        `ç•¶å‰ç†Ÿæ‚‰åº¦ï¼š${(status.current_mastery * 100).toFixed(0)}%ï¼Œç¹¼çºŒç·´ç¿’ï¼`
      );
      // é‡æ–°è¼‰å…¥ä¸‹ä¸€è¼ªé¡Œç›®
      loadPracticeWords();
    }
  };

  if (state.loading) {
    return <LoadingSpinner />;
  }

  const currentWord = state.words[state.currentIndex];

  return (
    <div className="sentence-making-activity">
      {state.answerMode === "listening" ? (
        <ListeningModeTemplate
          word={currentWord}
          onSubmit={submitAnswer}
          progress={{
            current: state.currentIndex + 1,
            total: state.words.length,
          }}
        />
      ) : (
        <WritingModeTemplate
          word={currentWord}
          onSubmit={submitAnswer}
          progress={{
            current: state.currentIndex + 1,
            total: state.words.length,
          }}
        />
      )}
    </div>
  );
};
```

#### 2. ListeningModeTemplate (è½åŠ›æ¨¡å¼çµ„ä»¶)

**ä½ç½®**: `/frontend/src/components/activities/ListeningModeTemplate.tsx`

**åŠŸèƒ½**:
- è‡ªå‹•æ’­æ”¾éŸ³æª”
- é¡¯ç¤ºä¾‹å¥çš„æ‰“äº‚å–®å­—é¸é …
- è™•ç†å–®å­—é»æ“Šå’Œç­”é¡Œé‚è¼¯

**UI è¨­è¨ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€²åº¦ï¼šç¬¬ 3 é¡Œ / å…± 10 é¡Œ              [80%] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚   ğŸ”Š [Playing Audio...]                     â”‚
â”‚                                             â”‚
â”‚   æ­£åœ¨æ’­æ”¾ä¾‹å¥éŸ³æª”ï¼Œè«‹ä»”ç´°è†è½...            â”‚
â”‚                                             â”‚
â”‚   [â–¶ é‡æ’­éŸ³æª”]                              â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç­”æ¡ˆå€ï¼š                                     â”‚
â”‚ â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”              â”‚
â”‚ â”‚ I â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚              â”‚
â”‚ â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¸æ“‡å–®å­—ï¼š                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ apple â”‚ every â”‚  eat  â”‚  an   â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚ â”‚  day  â”‚   .   â”‚                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒé‚è¼¯**:
```typescript
interface Props {
  word: PracticeWord;
  onSubmit: (answer: AnswerRecord) => void;
  progress: { current: number; total: number };
}

const ListeningModeTemplate: React.FC<Props> = ({ word, onSubmit, progress }) => {
  const [selectedWords, setSelectedWords] = useState<string[]>([]);
  const [availableWords, setAvailableWords] = useState<string[]>([]);
  const [attempts, setAttempts] = useState(0);
  const [startTime, setStartTime] = useState(Date.now());
  const [audioPlayed, setAudioPlayed] = useState(false);

  // åˆå§‹åŒ–ï¼šæ‰“äº‚ä¾‹å¥å–®å­—
  useEffect(() => {
    const words = word.example_sentence
      .replace(/[,!?]/g, "") // ç§»é™¤æ¨™é»
      .split(" ")
      .filter((w) => w.length > 0);

    // éš¨æ©Ÿæ‰“äº‚
    const shuffled = [...words].sort(() => Math.random() - 0.5);
    setAvailableWords(shuffled);
    setSelectedWords([]);
    setAttempts(0);
    setStartTime(Date.now());
  }, [word]);

  // è‡ªå‹•æ’­æ”¾éŸ³æª”
  useEffect(() => {
    if (word.audio_url && !audioPlayed) {
      playAudio();
    }
  }, [word.audio_url]);

  const playAudio = () => {
    const audio = new Audio(word.audio_url);
    audio.play();
    setAudioPlayed(true);
  };

  const handleWordClick = (word: string) => {
    setAttempts((prev) => prev + 1);

    // æ­£ç¢ºç­”æ¡ˆæ˜¯åŸå§‹ä¾‹å¥çš„å–®å­—åºåˆ—
    const correctWords = word.example_sentence
      .replace(/[,!?]/g, "")
      .split(" ")
      .filter((w) => w.length > 0);

    const nextIndex = selectedWords.length;
    const isCorrect = word === correctWords[nextIndex];

    if (isCorrect) {
      // æ­£ç¢ºï¼šæ·»åŠ åˆ°ç­”æ¡ˆå€
      setSelectedWords((prev) => [...prev, word]);
      setAvailableWords((prev) => prev.filter((w) => w !== word));

      // æª¢æŸ¥æ˜¯å¦å®Œæˆ
      if (nextIndex + 1 === correctWords.length) {
        // å…¨éƒ¨ç­”å°ï¼Œæäº¤ç­”æ¡ˆ
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);
        onSubmit({
          content_item_id: word.content_item_id,
          is_correct: true,
          time_spent_seconds: timeSpent,
          answer_data: {
            selected_words: [...selectedWords, word],
            attempts,
          },
        });
      }
    } else {
      // éŒ¯èª¤ï¼šæ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
      playErrorSound();
      toast.error("é¸éŒ¯äº†ï¼Œå†è©¦è©¦çœ‹ï¼");
    }
  };

  return (
    <div className="listening-mode p-6">
      {/* é€²åº¦æ¢ */}
      <ProgressBar current={progress.current} total={progress.total} />

      {/* éŸ³æª”æ’­æ”¾å€ */}
      <div className="audio-section mt-6 mb-8 text-center">
        {!audioPlayed && (
          <div className="text-gray-600 mb-4">
            <Loader2 className="animate-spin inline-block mr-2" />
            æ­£åœ¨æ’­æ”¾ä¾‹å¥éŸ³æª”...
          </div>
        )}
        <Button onClick={playAudio} variant="outline">
          <Volume2 className="mr-2" />
          é‡æ’­éŸ³æª”
        </Button>
      </div>

      {/* ç­”æ¡ˆå€ */}
      <div className="answer-area mb-6">
        <div className="text-sm font-medium mb-2">ç­”æ¡ˆå€ï¼š</div>
        <div className="flex gap-2">
          {selectedWords.map((w, idx) => (
            <div key={idx} className="px-4 py-2 bg-blue-100 border border-blue-300 rounded">
              {w}
            </div>
          ))}
          {/* ç©ºç™½æ¡† */}
          {Array.from({ length: correctWords.length - selectedWords.length }).map((_, idx) => (
            <div key={`empty-${idx}`} className="px-4 py-2 border-2 border-dashed border-gray-300 rounded w-20" />
          ))}
        </div>
      </div>

      {/* å–®å­—é¸æ“‡å€ */}
      <div className="word-choices">
        <div className="text-sm font-medium mb-2">é¸æ“‡å–®å­—ï¼š</div>
        <div className="grid grid-cols-4 gap-3">
          {availableWords.map((w, idx) => (
            <button
              key={idx}
              onClick={() => handleWordClick(w)}
              className="px-4 py-3 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 hover:border-blue-400 transition-colors"
            >
              {w}
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};
```

#### 3. WritingModeTemplate (å¯«ä½œæ¨¡å¼çµ„ä»¶)

**ä½ç½®**: `/frontend/src/components/activities/WritingModeTemplate.tsx`

**åŠŸèƒ½**: èˆ‡ ListeningModeTemplate å¹¾ä¹ç›¸åŒï¼Œä½†ï¼š
- ä¸è‡ªå‹•æ’­æ”¾éŸ³æª”
- é¡¯ç¤ºä¾‹å¥åŸæ–‡å’Œä¸­æ–‡ç¿»è­¯ä½œç‚ºæç¤º
- å…¶ä»–é‚è¼¯å®Œå…¨ç›¸åŒ

**UI è¨­è¨ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€²åº¦ï¼šç¬¬ 3 é¡Œ / å…± 10 é¡Œ              [80%] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¡Œç›®ï¼š                                       â”‚
â”‚   I eat an apple every day.                 â”‚
â”‚   æˆ‘æ¯å¤©åƒä¸€å€‹è˜‹æœã€‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç­”æ¡ˆå€ï¼šï¼ˆåŒä¸Šï¼‰                             â”‚
â”‚ é¸æ“‡å–®å­—ï¼šï¼ˆåŒä¸Šï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è‰¾è³“æµ©æ–¯è¨˜æ†¶æ›²ç·šæ¼”ç®—æ³•

### ğŸ§® æ ¸å¿ƒæ¼”ç®—æ³•ï¼šSuperMemo-2 (SM-2)

**PostgreSQL Function å¯¦ä½œ**:

```sql
-- æ›´æ–°è¨˜æ†¶å¼·åº¦çš„æ ¸å¿ƒå‡½æ•¸
CREATE OR REPLACE FUNCTION update_memory_strength(
  p_student_assignment_id INTEGER,
  p_content_item_id INTEGER,
  p_is_correct BOOLEAN
) RETURNS TABLE (
  memory_strength DECIMAL,
  next_review_at TIMESTAMPTZ,
  easiness_factor DECIMAL
) AS $
DECLARE
  v_progress user_word_progress%ROWTYPE;
  v_time_since_last_review INTERVAL;
  v_new_strength DECIMAL;
  v_new_easiness DECIMAL;
  v_new_interval DECIMAL;
BEGIN
  -- å–å¾—æˆ–å‰µå»ºé€²åº¦è¨˜éŒ„
  SELECT * INTO v_progress
  FROM user_word_progress
  WHERE student_assignment_id = p_student_assignment_id
    AND content_item_id = p_content_item_id;

  -- å¦‚æœä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°è¨˜éŒ„
  IF NOT FOUND THEN
    INSERT INTO user_word_progress (
      student_assignment_id,
      content_item_id,
      memory_strength,
      last_review_at,
      next_review_at,
      total_attempts
    ) VALUES (
      p_student_assignment_id,
      p_content_item_id,
      CASE WHEN p_is_correct THEN 0.5 ELSE 0.2 END,
      NOW(),
      NOW() + INTERVAL '1 day',
      1
    )
    RETURNING * INTO v_progress;

    RETURN QUERY SELECT
      v_progress.memory_strength,
      v_progress.next_review_at,
      v_progress.easiness_factor;
    RETURN;
  END IF;

  -- è¨ˆç®—è·é›¢ä¸Šæ¬¡è¤‡ç¿’çš„æ™‚é–“
  v_time_since_last_review := NOW() - v_progress.last_review_at;

  -- è‰¾è³“æµ©æ–¯éºå¿˜å…¬å¼ï¼šR = e^(-t/S)
  -- R: è¨˜æ†¶ä¿æŒç‡, t: ç¶“éæ™‚é–“ï¼ˆç§’ï¼‰, S: è¨˜æ†¶å¼·åº¦å¸¸æ•¸ï¼ˆèˆ‡é›£æ˜“åº¦æˆæ­£æ¯”ï¼‰
  v_new_strength := v_progress.memory_strength *
    EXP(
      -EXTRACT(EPOCH FROM v_time_since_last_review) /
      (86400.0 * v_progress.easiness_factor)
    );

  IF p_is_correct THEN
    -- ===== ç­”å°è™•ç† =====

    -- æå‡è¨˜æ†¶å¼·åº¦ï¼ˆæœ€é«˜ 1.0ï¼‰
    v_new_strength := LEAST(1.0, v_new_strength + 0.3);

    -- æ›´æ–°é›£æ˜“åº¦å› å­ï¼ˆSM-2 æ¼”ç®—æ³•ï¼‰
    -- EF' = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))
    -- å…¶ä¸­ q = 4 (ç­”å°çš„å“è³ªè©•åˆ†)
    v_new_easiness := v_progress.easiness_factor +
      (0.1 - (5 - 4) * (0.08 + (5 - 4) * 0.02));
    v_new_easiness := GREATEST(1.3, v_new_easiness); -- æœ€å°å€¼ 1.3

    -- è¨ˆç®—ä¸‹æ¬¡è¤‡ç¿’é–“éš”ï¼ˆSM-2 æ¼”ç®—æ³•ï¼‰
    IF v_progress.repetition_count = 0 THEN
      v_new_interval := 1;  -- ç¬¬ä¸€æ¬¡ç­”å°ï¼š1 å¤©å¾Œè¤‡ç¿’
    ELSIF v_progress.repetition_count = 1 THEN
      v_new_interval := 6;  -- ç¬¬äºŒæ¬¡ç­”å°ï¼š6 å¤©å¾Œè¤‡ç¿’
    ELSE
      v_new_interval := v_progress.interval_days * v_new_easiness;
    END IF;

    -- æ›´æ–°è¨˜éŒ„
    UPDATE user_word_progress SET
      memory_strength = v_new_strength,
      repetition_count = repetition_count + 1,
      correct_count = correct_count + 1,
      total_attempts = total_attempts + 1,
      easiness_factor = v_new_easiness,
      interval_days = v_new_interval,
      last_review_at = NOW(),
      next_review_at = NOW() + (v_new_interval || ' days')::INTERVAL,
      accuracy_rate = (correct_count + 1)::DECIMAL / (total_attempts + 1),
      updated_at = NOW()
    WHERE id = v_progress.id
    RETURNING * INTO v_progress;

  ELSE
    -- ===== ç­”éŒ¯è™•ç† =====

    -- é™ä½è¨˜æ†¶å¼·åº¦
    v_new_strength := GREATEST(0.1, v_new_strength * 0.5);

    -- é™ä½é›£æ˜“åº¦å› å­ï¼ˆè®Šé›£è¨˜ï¼‰
    v_new_easiness := GREATEST(1.3, v_progress.easiness_factor - 0.2);

    -- é‡ç½®é–“éš”ç‚º 1 å¤©
    v_new_interval := 1;

    UPDATE user_word_progress SET
      memory_strength = v_new_strength,
      repetition_count = 0,  -- é‡ç½®é€£çºŒç­”å°æ¬¡æ•¸
      incorrect_count = incorrect_count + 1,
      total_attempts = total_attempts + 1,
      easiness_factor = v_new_easiness,
      interval_days = v_new_interval,
      last_review_at = NOW(),
      next_review_at = NOW() + INTERVAL '1 day',
      accuracy_rate = correct_count::DECIMAL / (total_attempts + 1),
      updated_at = NOW()
    WHERE id = v_progress.id
    RETURNING * INTO v_progress;
  END IF;

  RETURN QUERY SELECT
    v_progress.memory_strength,
    v_progress.next_review_at,
    v_progress.easiness_factor;
END;
$ LANGUAGE plpgsql;
```

### ğŸ“Š é¸é¡Œæ¼”ç®—æ³•

```sql
-- é¸æ“‡éœ€è¦è¤‡ç¿’çš„å–®å­—
CREATE OR REPLACE FUNCTION get_words_for_practice(
  p_student_assignment_id INTEGER,
  p_limit_count INTEGER DEFAULT 10
) RETURNS TABLE (
  content_item_id INTEGER,
  text VARCHAR,
  translation VARCHAR,
  example_sentence TEXT,
  example_sentence_translation TEXT,
  audio_url TEXT,
  memory_strength DECIMAL,
  priority_score DECIMAL
) AS $
BEGIN
  RETURN QUERY
  WITH assignment_contents AS (
    -- å–å¾—æ­¤ä½œæ¥­åŒ…å«çš„æ‰€æœ‰ content_items
    SELECT DISTINCT ci.id as content_item_id
    FROM student_assignments sa
    JOIN student_content_progress scp ON scp.student_assignment_id = sa.id
    JOIN content_items ci ON ci.content_id = scp.content_id
    WHERE sa.id = p_student_assignment_id
  )
  SELECT
    ci.id,
    ci.text,
    ci.translation,
    ci.example_sentence,
    ci.example_sentence_translation,
    ci.audio_url,
    COALESCE(uwp.memory_strength, 0) as memory_strength,
    -- å„ªå…ˆé †åºè¨ˆç®—ï¼š
    -- 1. å¾æœªç·´ç¿’éçš„å–®å­—ï¼ˆpriority = 100ï¼‰
    -- 2. è©²è¤‡ç¿’æ™‚é–“åˆ°äº† + è¨˜æ†¶å¼·åº¦ä½ï¼ˆpriority = 50-100ï¼‰
    -- 3. æ™‚é–“æœªåˆ°ä½†è¨˜æ†¶å¼·åº¦ä½ï¼ˆpriority = 0-30ï¼‰
    CASE
      WHEN uwp.id IS NULL THEN 100  -- å¾æœªç·´ç¿’é
      WHEN uwp.next_review_at IS NULL THEN 100
      WHEN uwp.next_review_at <= NOW() THEN
        50 + (1 - uwp.memory_strength) * 50
      ELSE
        (1 - uwp.memory_strength) * 30
    END as priority_score
  FROM assignment_contents ac
  JOIN content_items ci ON ci.id = ac.content_item_id
  LEFT JOIN user_word_progress uwp ON
    uwp.student_assignment_id = p_student_assignment_id AND
    uwp.content_item_id = ci.id
  ORDER BY priority_score DESC, RANDOM()
  LIMIT p_limit_count;
END;
$ LANGUAGE plpgsql;
```

### ğŸ¯ é”æ¨™æª¢æŸ¥

```sql
-- è¨ˆç®—ä½œæ¥­æ•´é«”ç†Ÿæ‚‰åº¦
CREATE OR REPLACE FUNCTION calculate_assignment_mastery(
  p_student_assignment_id INTEGER
) RETURNS TABLE (
  current_mastery DECIMAL,
  target_mastery DECIMAL,
  achieved BOOLEAN,
  words_mastered INTEGER,
  total_words INTEGER
) AS $
DECLARE
  v_total_words INTEGER;
  v_avg_strength DECIMAL;
  v_target DECIMAL := 0.90;  -- ç›®æ¨™ 90% ç†Ÿæ‚‰åº¦
BEGIN
  -- å–å¾—ä½œæ¥­ç¸½å–®å­—æ•¸
  SELECT COUNT(DISTINCT ci.id) INTO v_total_words
  FROM student_assignments sa
  JOIN student_content_progress scp ON scp.student_assignment_id = sa.id
  JOIN content_items ci ON ci.content_id = scp.content_id
  WHERE sa.id = p_student_assignment_id;

  -- è¨ˆç®—å¹³å‡è¨˜æ†¶å¼·åº¦
  SELECT
    COALESCE(AVG(uwp.memory_strength), 0)
  INTO v_avg_strength
  FROM user_word_progress uwp
  WHERE uwp.student_assignment_id = p_student_assignment_id;

  -- å¦‚æœæœ‰æœªç·´ç¿’çš„å–®å­—ï¼Œå°‡å…¶è¦–ç‚º 0 å¼·åº¦
  IF v_total_words > 0 THEN
    SELECT COUNT(*) INTO v_practiced_words
    FROM user_word_progress
    WHERE student_assignment_id = p_student_assignment_id;

    v_avg_strength := (v_avg_strength * v_practiced_words) / v_total_words;
  END IF;

  -- è¨ˆç®—å·²æŒæ¡çš„å–®å­—æ•¸ï¼ˆè¨˜æ†¶å¼·åº¦ >= 0.8ï¼‰
  SELECT COUNT(*) INTO v_words_mastered
  FROM user_word_progress
  WHERE student_assignment_id = p_student_assignment_id
    AND memory_strength >= 0.8;

  RETURN QUERY SELECT
    v_avg_strength,
    v_target,
    v_avg_strength >= v_target,
    v_words_mastered,
    v_total_words;
END;
$ LANGUAGE plpgsql;
```

---

## å¯¦ä½œå„ªå…ˆé †åº

### Phase 1: åŸºç¤è¨­æ–½ï¼ˆå¿…é ˆå…ˆå®Œæˆï¼‰

**å„ªå…ˆç´š**: â­â­â­â­â­

1. **è³‡æ–™åº« Schema å»ºç«‹**
   - [ ] ä¿®æ”¹ `assignments` è¡¨ï¼Œæ·»åŠ  `answer_mode` æ¬„ä½
   - [ ] å‰µå»º `user_word_progress` è¡¨
   - [ ] å‰µå»º `practice_sessions` è¡¨
   - [ ] å‰µå»º `practice_answers` è¡¨
   - [ ] å‰µå»ºæ‰€æœ‰ç´¢å¼•

2. **PostgreSQL Functions**
   - [ ] `update_memory_strength()`
   - [ ] `get_words_for_practice()`
   - [ ] `calculate_assignment_mastery()`

3. **Alembic Migration**
   - [ ] å‰µå»º migration æª”æ¡ˆ
   - [ ] åŸ·è¡Œ migration

**é ä¼°æ™‚é–“**: 4-6 å°æ™‚

---

### Phase 2: å¾Œç«¯ API é–‹ç™¼

**å„ªå…ˆç´š**: â­â­â­â­

4. **ä¿®æ”¹ç¾æœ‰ API**
   - [ ] æ›´æ–° `/api/teachers/assignments/create` æ¥æ”¶ `answer_mode`
   - [ ] æ›´æ–° Assignment model å’Œ schema

5. **æ–°å¢ API ç«¯é»**
   - [ ] `GET /api/students/assignments/{id}/practice-words`
   - [ ] `POST /api/students/practice-sessions/{id}/submit-answer`
   - [ ] `GET /api/students/assignments/{id}/mastery-status`

6. **æ¸¬è©¦ API**
   - [ ] å–®å…ƒæ¸¬è©¦
   - [ ] æ•´åˆæ¸¬è©¦

**é ä¼°æ™‚é–“**: 6-8 å°æ™‚

---

### Phase 3: å‰ç«¯çµ„ä»¶é–‹ç™¼

**å„ªå…ˆç´š**: â­â­â­â­

7. **æ ¸å¿ƒçµ„ä»¶**
   - [ ] `SentenceMakingActivity.tsx`ï¼ˆä¸»çµ„ä»¶ï¼‰
   - [ ] `ListeningModeTemplate.tsx`
   - [ ] `WritingModeTemplate.tsx`
   - [ ] `WordChoicePanel.tsx`ï¼ˆå…±ç”¨çµ„ä»¶ï¼‰
   - [ ] `ProgressIndicator.tsx`ï¼ˆå…±ç”¨çµ„ä»¶ï¼‰

8. **è·¯ç”±æ•´åˆ**
   - [ ] åœ¨ `StudentActivityPageContent.tsx` ä¸­æ•´åˆæ–°çµ„ä»¶
   - [ ] æ ¹æ“š content type è·¯ç”±åˆ°æ­£ç¢ºçš„çµ„ä»¶

**é ä¼°æ™‚é–“**: 8-10 å°æ™‚

---

### Phase 4: éŸ³æª”æª¢æŸ¥èˆ‡é©—è­‰

**å„ªå…ˆç´š**: â­â­â­

9. **éŸ³æª”æª¢æŸ¥é‚è¼¯**
   - [ ] å¯¦ä½œå‰ç«¯éŸ³æª”æª¢æŸ¥ï¼ˆé¸æ“‡è½åŠ›æ¨¡å¼æ™‚ï¼‰
   - [ ] API ç«¯é»æª¢æŸ¥å…§å®¹æ˜¯å¦æœ‰éŸ³æª”
   - [ ] æç¤ºè¨Šæ¯ UI

10. **éŒ¯èª¤è™•ç†**
    - [ ] éŸ³æª”è¼‰å…¥å¤±æ•—è™•ç†
    - [ ] ç¶²è·¯éŒ¯èª¤è™•ç†
    - [ ] ç”¨æˆ¶é«”é©—å„ªåŒ–

**é ä¼°æ™‚é–“**: 3-4 å°æ™‚

---

### Phase 5: æ¸¬è©¦èˆ‡å„ªåŒ–

**å„ªå…ˆç´š**: â­â­â­

11. **E2E æ¸¬è©¦**
    - [ ] è€å¸«å‰µå»ºé€ å¥ç·´ç¿’ä½œæ¥­
    - [ ] å­¸ç”Ÿå®Œæˆè½åŠ›æ¨¡å¼ä½œæ¥­
    - [ ] å­¸ç”Ÿå®Œæˆå¯«ä½œæ¨¡å¼ä½œæ¥­
    - [ ] è‰¾è³“æµ©æ–¯æ›²ç·šé©—è­‰

12. **æ€§èƒ½å„ªåŒ–**
    - [ ] SQL æŸ¥è©¢å„ªåŒ–
    - [ ] å‰ç«¯åŠ è¼‰å„ªåŒ–
    - [ ] å¿«å–ç­–ç•¥

**é ä¼°æ™‚é–“**: 4-6 å°æ™‚

---

## æ¸¬è©¦è¨ˆåŠƒ

### ğŸ§ª å–®å…ƒæ¸¬è©¦

#### å¾Œç«¯æ¸¬è©¦

```python
# tests/test_memory_strength.py

def test_update_memory_strength_first_time_correct():
    """ç¬¬ä¸€æ¬¡ç­”å°æ‡‰è©²è¨­ç½®è¨˜æ†¶å¼·åº¦ç‚º 0.5"""
    result = update_memory_strength(
        student_assignment_id=1,
        content_item_id=10,
        is_correct=True
    )
    assert result.memory_strength == 0.5
    assert result.easiness_factor == 2.5

def test_update_memory_strength_consecutive_correct():
    """é€£çºŒç­”å°æ‡‰è©²æå‡è¨˜æ†¶å¼·åº¦å’Œé–“éš”"""
    # ç¬¬ä¸€æ¬¡
    update_memory_strength(1, 10, True)
    # ç¬¬äºŒæ¬¡
    result = update_memory_strength(1, 10, True)
    assert result.memory_strength > 0.5
    assert result.interval_days == 6

def test_update_memory_strength_incorrect():
    """ç­”éŒ¯æ‡‰è©²é™ä½è¨˜æ†¶å¼·åº¦ä¸¦é‡ç½®é–“éš”"""
    # å…ˆç­”å°å…©æ¬¡
    update_memory_strength(1, 10, True)
    update_memory_strength(1, 10, True)
    # ç­”éŒ¯
    result = update_memory_strength(1, 10, False)
    assert result.repetition_count == 0
    assert result.interval_days == 1

def test_get_words_for_practice_prioritizes_weak_words():
    """é¸é¡Œæ‡‰è©²å„ªå…ˆé¸æ“‡è¨˜æ†¶å¼·åº¦ä½çš„å–®å­—"""
    words = get_words_for_practice(
        student_assignment_id=1,
        limit_count=10
    )
    # æª¢æŸ¥å‰å¹¾å€‹å–®å­—çš„å„ªå…ˆç´šè¼ƒé«˜
    assert words[0].priority_score > words[-1].priority_score
```

#### å‰ç«¯æ¸¬è©¦

```typescript
// tests/components/SentenceMakingActivity.test.tsx

describe('SentenceMakingActivity', () => {
  it('should load practice words on mount', async () => {
    const mockWords = [
      { content_item_id: 1, text: 'apple', example_sentence: 'I eat an apple.' }
    ];

    apiClient.get = jest.fn().mockResolvedValue({
      session_id: 123,
      answer_mode: 'writing',
      words: mockWords
    });

    render(<SentenceMakingActivity assignmentId={1} />);

    await waitFor(() => {
      expect(screen.getByText('apple')).toBeInTheDocument();
    });
  });

  it('should switch to listening mode when answer_mode is listening', async () => {
    apiClient.get = jest.fn().mockResolvedValue({
      answer_mode: 'listening',
      words: []
    });

    render(<SentenceMakingActivity assignmentId={1} />);

    await waitFor(() => {
      expect(screen.getByText('é‡æ’­éŸ³æª”')).toBeInTheDocument();
    });
  });
});
```

### ğŸ”¬ æ•´åˆæ¸¬è©¦

```python
# tests/integration/test_sentence_making_flow.py

def test_complete_practice_flow():
    """æ¸¬è©¦å®Œæ•´çš„ç·´ç¿’æµç¨‹"""
    # 1. å‰µå»ºä½œæ¥­
    assignment = create_assignment(
        title="Vocabulary Practice",
        content_ids=[1],
        answer_mode="writing"
    )

    # 2. å­¸ç”Ÿç²å–ç·´ç¿’é¡Œç›®
    response = client.get(
        f"/api/students/assignments/{assignment.id}/practice-words"
    )
    assert response.status_code == 200
    assert len(response.json()['words']) == 10

    # 3. æäº¤ç­”æ¡ˆ
    session_id = response.json()['session_id']
    word = response.json()['words'][0]

    submit_response = client.post(
        f"/api/students/practice-sessions/{session_id}/submit-answer",
        json={
            "content_item_id": word['content_item_id'],
            "is_correct": True,
            "time_spent_seconds": 10,
            "answer_data": {"selected_words": ["I", "eat"], "attempts": 1}
        }
    )
    assert submit_response.status_code == 200

    # 4. æª¢æŸ¥è¨˜æ†¶å¼·åº¦æœ‰æ›´æ–°
    progress = db.query(UserWordProgress).filter_by(
        content_item_id=word['content_item_id']
    ).first()
    assert progress.memory_strength > 0
```

---

## ç¸½çµ

### ğŸ“ˆ é ä¼°é–‹ç™¼æ™‚é–“

| Phase | å…§å®¹ | æ™‚é–“ |
|-------|------|------|
| Phase 1 | è³‡æ–™åº« Schema + Functions | 4-6 å°æ™‚ |
| Phase 2 | å¾Œç«¯ API é–‹ç™¼ | 6-8 å°æ™‚ |
| Phase 3 | å‰ç«¯çµ„ä»¶é–‹ç™¼ | 8-10 å°æ™‚ |
| Phase 4 | éŸ³æª”æª¢æŸ¥èˆ‡é©—è­‰ | 3-4 å°æ™‚ |
| Phase 5 | æ¸¬è©¦èˆ‡å„ªåŒ– | 4-6 å°æ™‚ |
| **ç¸½è¨ˆ** | | **25-34 å°æ™‚** |

### âœ… æˆåŠŸæ¨™æº–

1. âœ… è€å¸«å¯ä»¥å‰µå»ºé€ å¥ç·´ç¿’ä½œæ¥­ä¸¦é¸æ“‡ç­”é¡Œæ¨¡å¼
2. âœ… å­¸ç”Ÿé€²å…¥ä½œæ¥­æ™‚æ ¹æ“šæ¨¡å¼çœ‹åˆ°ä¸åŒçš„ UI
3. âœ… è½åŠ›æ¨¡å¼æœƒè‡ªå‹•æ’­æ”¾éŸ³æª”
4. âœ… å¯«ä½œæ¨¡å¼ä¸æ’­æ”¾éŸ³æª”ä½†é¡¯ç¤ºä¾‹å¥æ–‡å­—
5. âœ… ç­”é¡Œæ­£ç¢ºæ€§åˆ¤æ–·æº–ç¢º
6. âœ… è¨˜æ†¶å¼·åº¦æ­£ç¢ºæ›´æ–°
7. âœ… é”åˆ° 90% ç†Ÿæ‚‰åº¦å¾Œä½œæ¥­å®Œæˆ
8. âœ… æ‰€æœ‰æ¸¬è©¦é€šé

### ğŸš€ å¾ŒçºŒæ“´å±•

1. **çµ±è¨ˆåˆ†æ**
   - å­¸ç”Ÿå­¸ç¿’æ›²ç·šåœ–è¡¨
   - å¼±é …å–®å­—åˆ†æ
   - å­¸ç¿’æ™‚é–“çµ±è¨ˆ

2. **é€²éšåŠŸèƒ½**
   - è‡ªå®šç¾©ç›®æ¨™ç†Ÿæ‚‰åº¦
   - ä¸åŒé›£åº¦ç´šåˆ¥
   - å¤šè¼ªè¤‡ç¿’æ©Ÿåˆ¶

3. **éŠæˆ²åŒ–**
   - é€£çºŒç­”å°çå‹µ
   - æˆå°±ç³»çµ±
   - æ’è¡Œæ¦œ

---

## é™„éŒ„

### A. è³‡æ–™åº« Migration æª”æ¡ˆç¯„æœ¬

```python
# alembic/versions/xxx_add_sentence_making_features.py

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

revision = 'xxx'
down_revision = 'yyy'

def upgrade():
    # 1. ä¿®æ”¹ assignments è¡¨
    op.add_column('assignments',
        sa.Column('answer_mode', sa.String(20), server_default='writing'))
    op.create_check_constraint(
        'assignments_answer_mode_check',
        'assignments',
        "answer_mode IN ('listening', 'writing')"
    )

    # 2. å‰µå»º user_word_progress è¡¨
    op.create_table(
        'user_word_progress',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('student_id', sa.Integer(), sa.ForeignKey('students.id', ondelete='CASCADE')),
        sa.Column('student_assignment_id', sa.Integer(), sa.ForeignKey('student_assignments.id', ondelete='CASCADE')),
        sa.Column('content_item_id', sa.Integer(), sa.ForeignKey('content_items.id', ondelete='CASCADE')),
        sa.Column('memory_strength', sa.Numeric(5, 4), server_default='0'),
        sa.Column('repetition_count', sa.Integer(), server_default='0'),
        sa.Column('correct_count', sa.Integer(), server_default='0'),
        sa.Column('incorrect_count', sa.Integer(), server_default='0'),
        sa.Column('last_review_at', sa.DateTime(timezone=True)),
        sa.Column('next_review_at', sa.DateTime(timezone=True)),
        sa.Column('easiness_factor', sa.Numeric(3, 2), server_default='2.5'),
        sa.Column('interval_days', sa.Numeric(10, 2), server_default='1'),
        sa.Column('total_attempts', sa.Integer(), server_default='0'),
        sa.Column('accuracy_rate', sa.Numeric(5, 4), server_default='0'),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.func.now()),
        sa.UniqueConstraint('student_assignment_id', 'content_item_id')
    )

    # ç´¢å¼•
    op.create_index('idx_uwp_student', 'user_word_progress', ['student_id', 'student_assignment_id'])
    op.create_index('idx_uwp_next_review', 'user_word_progress', ['student_assignment_id', 'next_review_at'])

    # 3-4. å…¶ä»–è¡¨é¡ä¼¼...

    # 5. å‰µå»º PostgreSQL functions
    op.execute("""
        CREATE OR REPLACE FUNCTION update_memory_strength(...)
        -- å®Œæ•´å‡½æ•¸å®šç¾©
    """)

def downgrade():
    op.drop_table('practice_answers')
    op.drop_table('practice_sessions')
    op.drop_table('user_word_progress')
    op.drop_column('assignments', 'answer_mode')
    op.execute("DROP FUNCTION IF EXISTS update_memory_strength")
```

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.0
**å‰µå»ºæ—¥æœŸ**: 2025-11-11
**æœ€å¾Œæ›´æ–°**: 2025-11-11
**ä½œè€…**: Claude Code
**å¯©æ ¸ç‹€æ…‹**: å¾…å¯©æ ¸
