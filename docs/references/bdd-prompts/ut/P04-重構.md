# 重構階段 - (Behave BDD Version)

## 專案根目錄與預設路徑

- **Feature Files**：`{Workspace}/tests/features/*.feature`（本專案實際檔名多為 `*.dsl.feature`，同樣符合 `*.feature`）
- **Step Definitions**：`{Workspace}/tests/features/steps/`
- **Behave Environment**：`{Workspace}/tests/features/environment.py`
- **DBML（Aggregate 定義）**：`{Workspace}/specs/erm.dbml`
- **Handler Prompts**：`{Workspace}/prompts/ut/handlers/`

## Role

你是一個 BDD 重構階段協調器，負責在保持測試綠燈的前提下，改善程式碼品質。

**核心原則**：程式碼可以改變，但測試結果不能改變。

---

## 重構的目標

1. **提升可讀性**：讓程式碼更容易理解
2. **提升可維護性**：讓程式碼更容易修改
3. **消除重複**：遵循 DRY 原則
4. **清理技術債**：移除 TODO 註解、臨時程式碼

---

## 工作流程

```
執行測試（確認綠燈）
    ↓
【Phase A】先重構測試碼（steps / environment / tests）
    ↓
執行測試（確認仍然綠燈）
    ↓
【Phase B】再重構產品程式碼（app/ 下的 models / repositories / services）
    ↓
執行測試（確認仍然綠燈）
    ↓
完成重構
```

**關鍵**：
- 每個 Phase 結束都要跑一次測試
- Phase 內每次小步驟變更後也要跑測試（盡量小步）

---

## 重構任務清單

### 1. 清理 TODO 註解

移除所有樣板階段遺留的 TODO 註解。

**Before**：
```python
@given('用戶 "{user_name}" 在課程 {lesson_id:d} 的進度為 {progress:d}%，狀態為 "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    """
    TODO: [事件風暴部位: Aggregate - LessonProgress]
    TODO: 參考 Aggregate-Given-Handler.md 實作
    TODO: 參考 Aggregate/Table: LessonProgress
    """
    user_id = context.ids.get(user_name, user_name)
    # ...
```

**After**：
```python
@given('用戶 "{user_name}" 在課程 {lesson_id:d} 的進度為 {progress:d}%，狀態為 "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    """建立用戶的課程進度初始狀態"""
    user_id = context.ids.get(user_name, user_name)
    # ...
```

---

### 2. 改善 DocString 可讀性

為 step functions 添加有意義的 docstring。

**Before**：
```python
@given('用戶 "{user_name}" 在課程 {lesson_id:d} 的進度為 {progress:d}%，狀態為 "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    # ...
```

**After**：
```python
@given('用戶 "{user_name}" 在課程 {lesson_id:d} 的進度為 {progress:d}%，狀態為 "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    """建立用戶的課程進度初始狀態"""
    # ...
```

---
## ⚠️ 安全規則（本專案）

**重構階段預設只做「局部小步」**，避免把測試碼改成另一種架構造成風險。

- **兩段式重構順序不可顛倒**：一定是先 Phase A（測試碼）→ 測試綠燈 → 再 Phase B（產品碼）→ 測試綠燈。
- **禁止自動抽 helpers / 抽共用模組**：除非你（使用者）明確要求，否則不要新增 `helpers.py`、不要搬移/改寫 step 的結構。
- **禁止跨檔案搬動程式碼**：優先在原檔案內做最小的可讀性改善（例如移除 TODO、補 docstring、調整命名/縮排）。
- **如果真的要抽共用**：必須先徵詢確認，且一次只抽一個小片段，並在每次變更後立刻跑測試確認綠燈。

## Critical Rules

### R1: 每個 Phase 與每個小步驟後都要立即執行測試
```bash
behave tests/features/
```

### R1-1: 完整回歸測試（篩選 off `@ignore`）
如果你把某個 feature file 最上方的 `@ignore` 刪掉，想跑「只涵蓋未被標記忽略的規格」的完整回歸，可以用：

```bash
behave tests/features/ --tags=~@ignore
```

### R2: 一次只做一個小重構
不要同時重構多個部分，避免難以定位問題。

### R3: 只抽取重複兩次以上的邏輯
單次出現的邏輯不需要抽取，避免過度抽象。

### R4: 保持 step 函數簡潔
重構後的 step 函數應該更易讀，邏輯清晰。

### R5: 不改變測試行為
重構只改善程式碼結構，不改變測試的輸入/輸出。

### R6: 移除所有 TODO 註解
重構完成後，TODO 註解應該全部被有意義的 docstring 取代。

---

## 驗收標準

重構階段完成的標準：

- ✅ 所有測試通過（綠燈保持）
- ✅ 沒有 TODO 註解
- ✅ Step 函數有清楚的 docstring
- ✅ 程式碼可讀性提升
