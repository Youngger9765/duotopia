# ç´…ç‡ˆéšæ®µ - Coordinator (Behave BDD Version)

## å°ˆæ¡ˆæ ¹ç›®éŒ„èˆ‡é è¨­è·¯å¾‘
- **Feature Files**ï¼š`{Workspace}/tests/features/*.feature`ï¼ˆæœ¬å°ˆæ¡ˆå¯¦éš›æª”åå¤šç‚º `*.dsl.feature`ï¼ŒåŒæ¨£ç¬¦åˆ `*.feature`ï¼‰
- **Step Definitions**ï¼š`{Workspace}/tests/features/steps/`
- **Behave Environment**ï¼š`{Workspace}/tests/features/environment.py`
- **DBMLï¼ˆAggregate å®šç¾©ï¼‰**ï¼š`{Workspace}/specs/erm.dbml`
- **Handler Prompts**ï¼š`{Workspace}/prompts/ut/handlers/`

## âš ï¸ ç´…ç‡ˆéšæ®µçš„æ ¸å¿ƒåŸå‰‡

**ç´…ç‡ˆéšæ®µåªå»ºç«‹éª¨æ¶ï¼Œä¸å¯¦ä½œæ¥­å‹™é‚è¼¯**ï¼š

### âœ… å¯ä»¥åšçš„äº‹
- å¯¦ä½œ Step Definition æ–¹æ³•ï¼ˆAggregate Given/Thenã€Commandã€Queryï¼‰
- å»ºç«‹ Aggregate é¡åˆ¥å®šç¾©ï¼ˆå±¬æ€§ã€`__init__`ï¼‰
- å»ºç«‹ Repository é¡åˆ¥å®šç¾©ï¼ˆæ–¹æ³•ç°½åï¼Œå…§éƒ¨æ‹‹å‡º `NotImplementedError`ï¼‰
- å»ºç«‹ Service é¡åˆ¥å®šç¾©ï¼ˆæ–¹æ³•ç°½åï¼Œå…§éƒ¨æ‹‹å‡º `NotImplementedError`ï¼‰
- åœ¨ `tests/features/environment.py` è¨­å®š context åˆå§‹åŒ–

### âŒ ä¸å¯ä»¥åšçš„äº‹
- **ä¸å¯¦ä½œ Repository çš„æ–¹æ³•é«”**ï¼ˆåªå®šç¾©ç°½åï¼‰
- **ä¸å¯¦ä½œ Service çš„æ¥­å‹™é‚è¼¯**ï¼ˆåªå®šç¾©ç°½åï¼‰
- **ä¸è®“æ¸¬è©¦é€šé**ï¼ˆæ¸¬è©¦æ‡‰è©²å¤±æ•—ï¼‰

### ç‚ºä»€éº¼ï¼Ÿ
- ç´…ç‡ˆéšæ®µçš„ç›®çš„æ˜¯è®“æ¸¬è©¦**å¤±æ•—**
- Step Definition æœƒå‘¼å« Service â†’ æ‹‹å‡º `NotImplementedError`
- é€™æ­£æ˜¯ TDD çš„ç´…ç‡ˆï¼šæ¸¬è©¦é‹è¡Œä½†å¤±æ•—
- ç¶ ç‡ˆéšæ®µæ‰å¯¦ä½œ Repository å’Œ Serviceï¼Œè®“æ¸¬è©¦é€šé

---

## æ ¸å¿ƒå¥‘ç´„ï¼ˆBehave Contextï¼‰

### å¥‘ç´„ 1ï¼šå…±ç”¨ç‹€æ…‹

**æ‰€æœ‰ scenario ç‹€æ…‹åªèƒ½æ”¾åœ¨ context çš„ä»¥ä¸‹å±¬æ€§**ï¼š

```python
# tests/features/environment.py - before_scenario

context.last_error = None      # Exception | Noneï¼ˆWhen å¯«å…¥ã€Then åªè®€ï¼‰
context.query_result = None    # Any | Noneï¼ˆWhen(Query) å¯«å…¥ã€Then(ReadModel) åªè®€ï¼‰
context.ids = {}              # dictï¼šåç¨± â†’ ID æ˜ å°„ï¼ˆå¦‚ "Alice" -> user_idï¼‰
context.memo = {}             # dictï¼šå…¶ä»–è‡¨æ™‚å…±äº«ç‹€æ…‹
```

**è¦å‰‡**ï¼š
- **When è² è²¬å¯«å…¥**ï¼šCommand/Query åŸ·è¡Œå¾Œå¯«å…¥ `context.last_error` æˆ– `context.query_result`
- **Then è² è²¬è®€å–**ï¼šé©—è­‰æ­¥é©Ÿåªè®€é€™äº›ç‹€æ…‹ï¼Œä¸é‡æ–°åŸ·è¡Œ When
- **ç¦æ­¢è·¨ scenario å…±ç”¨**ï¼šæ¯å€‹ scenario å‰å¿…é ˆé‡æ–°åˆå§‹åŒ–

### å¥‘ç´„ 2ï¼šä¾è³´æ³¨å…¥ï¼ˆç´” Behave ç‰ˆï¼‰

**æ‰€æœ‰ä¾è³´åªèƒ½æ”¾åœ¨ context çš„ä»¥ä¸‹å‘½åç©ºé–“**ï¼š

```python
# tests/features/environment.py - before_scenario

from types import SimpleNamespace

context.repos = SimpleNamespace()      # æ‰€æœ‰ Repositories
context.services = SimpleNamespace()   # æ‰€æœ‰ Services

# ç¯„ä¾‹ï¼šåˆå§‹åŒ– repositoriesï¼ˆFakeï¼Œdict-basedï¼‰
context.repos.lesson_progress = LessonProgressRepository()
context.repos.user = UserRepository()

# ç¯„ä¾‹ï¼šåˆå§‹åŒ– servicesï¼ˆæ³¨å…¥ reposï¼‰
context.services.lesson = LessonService(
    lesson_progress_repository=context.repos.lesson_progress
)
```

**è¦å‰‡**ï¼š
- **steps åªèƒ½å¾ `context.repos.*` / `context.services.*` å–ä¾è³´**
- **ç¦æ­¢åœ¨ step å…§ new repo/service**
- **ç¦æ­¢ module/global è®Šæ•¸è·¨ scenario**
- **æ¯å€‹ scenario å‰éƒ½é‡æ–°åˆå§‹åŒ–ï¼ˆbefore_scenarioï¼‰**

### å¥‘ç´„ 3ï¼šAAA è²¬ä»»åˆ‡åˆ†

- **Given = Arrange**ï¼šåªå»ºå‰ç½®è³‡æ–™ï¼Œä¸é©—è­‰æ¥­å‹™è¦å‰‡
- **When = Act**ï¼šåŸ·è¡Œä¸€æ¬¡å—æ¸¬è¡Œç‚ºï¼Œæ•ç²éŒ¯èª¤åˆ° `context.last_error`
- **Then = Assert**ï¼šåªé©—è­‰çµæœï¼Œä¸é‡åš When

### å¥‘ç´„ 4ï¼šStep å‡½æ•¸ç°½åè¦å‰‡

```python
# âœ… æ­£ç¢ºï¼šåªæœ‰ context + å¾ pattern è§£æçš„åƒæ•¸
@given('ç”¨æˆ¶ "{user_name}" åœ¨èª²ç¨‹ {lesson_id:d} çš„é€²åº¦ç‚º {progress:d}%')
def step_impl(context, user_name, lesson_id, progress):
    # å¾ context å–å¾—ä¾è³´
    repo = context.repos.lesson_progress
    # ...

# âŒ éŒ¯èª¤ï¼šä¸èƒ½æœ‰ fixture åƒæ•¸ï¼ˆé‚£æ˜¯ pytest-bdd çš„æ±è¥¿ï¼‰
@given('...')
def step_impl(context, user_name, lesson_progress_repository):
    # behave ä¸æ”¯æ´é€™ç¨®æ³¨å…¥
```

---

## Role

ä½ æ˜¯ä¸€å€‹ BDD æ¸¬è©¦å”èª¿å™¨ï¼Œè² è²¬ï¼š
1. æ‰¾åˆ°å°šæœªå¯¦ä½œçš„ Step Definition æ¨£æ¿
2. è®€å–æ¨£æ¿ä¸­çš„ TODO è¨»è§£ï¼ˆä½œç‚ºè·¯ç‰Œï¼‰
3. æ ¹æ“šè·¯ç‰ŒæŒ‡ç¤ºï¼Œèª¿ç”¨å°æ‡‰çš„ Handler Prompt ä¾†å¯¦ä½œ

**ä½ ä¸éœ€è¦è‡ªå·±å¯¦ä½œé‚è¼¯ï¼Œåªéœ€è¦æŒ‰ç…§è¨»è§£è·¯ç‰ŒæŒ‡ç¤ºï¼Œæ‰¾åˆ°æ­£ç¢ºçš„ Handler Prompt é–±è®€ä»–ã€åŸ·è¡Œä»–çš„è¦æ±‚ã€‚**

---

## æ¨£æ¿ç¯„ä¾‹

é€™æ˜¯ç”± `P01-Feature-to-Step-Definition-æ¨£æ¿.md` ç”Ÿæˆçš„æ¨£æ¿ï¼ŒåŒ…å«äº†ä½ éœ€è¦çš„æ‰€æœ‰è·¯ç‰Œè³‡è¨Šï¼š

```python
# tests/features/steps/aggregate_given.py

from behave import given

@given('ç”¨æˆ¶ "{user_name}" åœ¨èª²ç¨‹ {lesson_id:d} çš„é€²åº¦ç‚º {progress:d}%ï¼Œç‹€æ…‹ç‚º "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    """
    TODO: [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    TODO: åƒè€ƒ Aggregate-Given-Handler.md å¯¦ä½œ
    TODO: åƒè€ƒ Aggregate/Table: LessonProgress
    """
    pass
```

**è·¯ç‰Œè§£è®€**ï¼š
- ğŸ“ **Handler Prompt**: `Aggregate-Given-Handler.md`ï¼ˆåœ¨ `prompts/ut/handlers/` ç›®éŒ„ä¸‹ï¼‰
- ğŸ“‹ **åƒè€ƒ Spec**: `erm.dbml` ä¸­çš„ LessonProgress Table å®šç¾©
- ğŸ¯ **äº‹ä»¶é¢¨æš´éƒ¨ä½**: Aggregate - LessonProgress

---

## å·¥ä½œæµç¨‹

### æ­¥é©Ÿ 1: è­˜åˆ¥æœªå¯¦ä½œçš„æ¨£æ¿

æƒæ `tests/features/steps/` ç›®éŒ„ï¼Œæ‰¾åˆ°åŒ…å« TODO è¨»è§£çš„ Step Definition æ–¹æ³•ã€‚

**æª¢æŸ¥æ¨¡å¼**ï¼š
```python
"""
TODO: åƒè€ƒ XXX-Handler.md å¯¦ä½œ
"""
pass  # è¡¨ç¤ºå°šæœªå¯¦ä½œ
```

### æ­¥é©Ÿ 2: è®€å–è·¯ç‰Œè³‡è¨Š

å¾ TODO è¨»è§£ä¸­æå–ï¼š
1. **Handler Prompt æª”å**ï¼šå¦‚ `Aggregate-Given-Handler.md`
2. **åƒè€ƒçš„ Spec**ï¼šå¾ `erm.dbml` æ‰¾å°æ‡‰çš„ Table å®šç¾©

### æ­¥é©Ÿ 3: èª¿ç”¨å°æ‡‰çš„ Handler Prompt

**å‚³å…¥è³‡è¨Š**ï¼š
1. **æ¨£æ¿ä»£ç¢¼**ï¼šåŒ…å«æ–¹æ³•ç°½åã€åƒæ•¸
2. **DBML å®šç¾©**ï¼ˆå¦‚æœéœ€è¦ï¼‰

**Handler Prompt ä½ç½®**ï¼š`{Workspace}/prompts/ut/handlers/{Handleråç¨±}.md`

### æ­¥é©Ÿ 4: å¯¦ä½œ Step Definition

Handler Prompt æœƒæ ¹æ“šæ¨£æ¿å’Œ Specï¼Œç”Ÿæˆä»¥ä¸‹å…§å®¹ï¼š

#### âœ… ç´…ç‡ˆéšæ®µæœƒå»ºç«‹çš„å…§å®¹
- **Step Definition æ–¹æ³•çš„å®Œæ•´å¯¦ä½œ**
- **Aggregate é¡åˆ¥**ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰
  - å±¬æ€§å®šç¾©
  - `__init__` æ–¹æ³•
- **Repository é¡åˆ¥**ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰
  - æ–¹æ³•**ç°½å**ï¼ˆå¦‚ `def save(self, entity):`ï¼‰
  - **å…§éƒ¨æ‹‹å‡º `NotImplementedError`**
- **Service é¡åˆ¥**ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰
  - æ–¹æ³•**ç°½å**
  - **å…§éƒ¨æ‹‹å‡º `NotImplementedError`**
- **`tests/features/environment.py`**ï¼ˆhooks å®šç¾©ï¼‰

#### âŒ ç´…ç‡ˆéšæ®µä¸æœƒå»ºç«‹çš„å…§å®¹
- **Repository çš„å¯¦ä½œé‚è¼¯** - å®Œå…¨ä¸å»ºç«‹
- **Service çš„æ¥­å‹™é‚è¼¯** - å®Œå…¨ä¸å»ºç«‹

### æ­¥é©Ÿ 5: è¨­å®š tests/features/environment.py

**å¿…é ˆå»ºç«‹æ­¤æª”æ¡ˆä¾†åˆå§‹åŒ– context**ï¼š

```python
# tests/features/environment.py

from types import SimpleNamespace

def before_scenario(context, scenario):
    """æ¯å€‹ scenario åŸ·è¡Œå‰åˆå§‹åŒ–"""
    # åˆå§‹åŒ–ç‹€æ…‹
    context.last_error = None
    context.query_result = None
    context.ids = {}
    context.memo = {}
    
    # åˆå§‹åŒ–ä¾è³´
    context.repos = SimpleNamespace()
    context.services = SimpleNamespace()
    
    # TODO: æ ¹æ“šéœ€è¦çš„ repos/services åˆå§‹åŒ–
    # ç¯„ä¾‹ï¼š
    # from app.repositories.lesson_progress_repository import LessonProgressRepository
    # from app.services.lesson_service import LessonService
    # 
    # context.repos.lesson_progress = LessonProgressRepository()
    # context.services.lesson = LessonService(
    #     lesson_progress_repository=context.repos.lesson_progress
    # )

def after_scenario(context, scenario):
    """æ¯å€‹ scenario åŸ·è¡Œå¾Œæ¸…ç†"""
    context.last_error = None
    context.query_result = None
    context.ids.clear()
    context.memo.clear()
```

### æ­¥é©Ÿ 6: åŸ·è¡Œæ¸¬è©¦ç¢ºèªç´…ç‡ˆ

**âš ï¸ é‡è¦ï¼šç´…ç‡ˆéšæ®µå®Œæˆå¾Œï¼Œå¿…é ˆåŸ·è¡Œæ¸¬è©¦ç¢ºèªç´…ç‡ˆç‹€æ…‹ï¼**

åŸ·è¡Œæ¸¬è©¦å‘½ä»¤ï¼š
```bash
behave tests/features/{feature_file}
```

æˆ–åŸ·è¡Œæ•´å€‹ featureï¼š
```bash
behave tests/features/03-äº¤ä»˜èª²ç¨‹.dsl.feature
```

**é æœŸçµæœ**ï¼šæ¸¬è©¦å¤±æ•—ï¼ˆç´…ç‡ˆï¼‰

**å¤±æ•—åŸå› **ï¼š
- Service/Repository æ–¹æ³•æ‹‹å‡º `NotImplementedError`
- æ¸¬è©¦é‹è¡Œä½†å¤±æ•— âœ…

**æª¢æŸ¥è¦é»**ï¼š
1. âœ… Step Definitions æ˜¯å¦æ­£ç¢ºè¼‰å…¥ï¼ˆæ²’æœ‰ "undefined step" éŒ¯èª¤ï¼‰
2. âœ… æ¸¬è©¦æ˜¯å¦åŸ·è¡Œï¼ˆä¸æ˜¯èªæ³•éŒ¯èª¤ï¼‰
3. âœ… æ¸¬è©¦æ˜¯å¦å¤±æ•—ï¼ˆå› ç‚º `NotImplementedError`ï¼‰
4. âœ… éŒ¯èª¤è¨Šæ¯æ˜¯å¦ç‚º "ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ"

**ç¯„ä¾‹è¼¸å‡º**ï¼š
```
Feature: èª²ç¨‹å¹³å° - å¢åŠ å½±ç‰‡é€²åº¦

  Scenario: æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦
    Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%ï¼Œç‹€æ…‹ç‚º "é€²è¡Œä¸­"  # passes
    When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„å½±ç‰‡é€²åº¦ç‚º 80%              # fails
      NotImplementedError: ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ

Failing scenarios:
  tests/features/03-å¢åŠ å½±ç‰‡é€²åº¦.dsl.feature:6  æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦

0 features passed, 1 failed, 0 skipped
0 scenarios passed, 1 failed, 0 skipped
```

**å¦‚æœæ¸¬è©¦æ²’æœ‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥**ï¼š
- Step Definition æ˜¯å¦æ­£ç¢ºå¯¦ä½œ
- Service æ–¹æ³•æ˜¯å¦æ‹‹å‡º `NotImplementedError`
- `__init__.py` æ˜¯å¦æ­£ç¢ºå°å…¥æ‰€æœ‰ step definition æ¨¡çµ„

---

### æ­¥é©Ÿ 7: ç§»é™¤è©² Feature File æœ€ä¸Šæ–¹çš„ `@ignore` tag

ç•¶ä½ å®Œæˆé€™å€‹ feature çš„ç´…ç‡ˆéª¨æ¶å¾Œï¼Œè«‹æŠŠè©² feature file ç¬¬ä¸€è¡Œçš„ `@ignore` åˆªæ‰ï¼Œè®“å®ƒå¾ŒçºŒå¯ä»¥è¢«ã€Œæ’é™¤ `@ignore` çš„å›æ­¸æ¸¬è©¦ã€æ¶µè“‹åˆ°ã€‚

## Input è³‡è¨Š

| é …ç›® | è·¯å¾‘ |
|------|------|
| **Workspace** | å°ˆæ¡ˆç›®éŒ„ |
| **Step Definition** | `{Workspace}/tests/features/steps/` |
| **Source Code** | `{Workspace}/app/` |
| **Handler Prompts** | `{Workspace}/prompts/ut/handlers/` |
| **DBML** | `{Workspace}/specs/erm.dbml` |
| **Environment** | `{Workspace}/tests/features/environment.py` |

---

## è·¯ç‰Œå°ç…§è¡¨

| TODO è¨»è§£ä¸­çš„ Handler | Handler Prompt æª”æ¡ˆ | éœ€è¦çš„ Spec |
|---------------------|-------------------|-----------|
| `Aggregate-Given-Handler.md` | Aggregate-Given-Handler.md | erm.dbml (Table å®šç¾©) |
| `Aggregate-Then-Handler.md` | Aggregate-Then-Handler.md | erm.dbml (Table å®šç¾©) |
| `Command-Handler.md` | Command-Handler.md | erm.dbml (Table å®šç¾©) |
| `Query-Handler.md` | Query-Handler.md | erm.dbml (Table å®šç¾©) |
| `ReadModel-Then-Handler.md` | ReadModel-Then-Handler.md | - |
| `Success-Failure-Handler.md` | Success-Failure-Handler.md | - |

---

## Complete Example

### Inputï¼ˆStep Definition æ¨£æ¿ï¼‰

```python
@given('ç”¨æˆ¶ "{user_name}" åœ¨èª²ç¨‹ {lesson_id:d} çš„é€²åº¦ç‚º {progress:d}%ï¼Œç‹€æ…‹ç‚º "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    """
    TODO: [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    TODO: åƒè€ƒ Aggregate-Given-Handler.md å¯¦ä½œ
    TODO: åƒè€ƒ Aggregate/Table: LessonProgress
    """
    pass

@when('ç”¨æˆ¶ "{user_name}" æ›´æ–°èª²ç¨‹ {lesson_id:d} çš„å½±ç‰‡é€²åº¦ç‚º {progress:d}%')
def step_impl(context, user_name, lesson_id, progress):
    """
    TODO: [äº‹ä»¶é¢¨æš´éƒ¨ä½: Command - update_video_progress]
    TODO: åƒè€ƒ Command-Handler.md å¯¦ä½œ
    """
    pass

@then('ç”¨æˆ¶ "{user_name}" åœ¨èª²ç¨‹ {lesson_id:d} çš„é€²åº¦æ‡‰ç‚º {progress:d}%')
def step_impl(context, user_name, lesson_id, progress):
    """
    TODO: [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    TODO: åƒè€ƒ Aggregate-Then-Handler.md å¯¦ä½œ
    """
    pass
```

### Output 1ï¼ˆStep Definition å¯¦ä½œ - tests/features/steps/ï¼‰

```python
# tests/features/steps/aggregate_given.py

from behave import given
from app.models.lesson_progress import LessonProgress

@given('ç”¨æˆ¶ "{user_name}" åœ¨èª²ç¨‹ {lesson_id:d} çš„é€²åº¦ç‚º {progress:d}%ï¼Œç‹€æ…‹ç‚º "{status}"')
def step_impl(context, user_name, lesson_id, progress, status):
    # å–å¾—ç”¨æˆ¶ IDï¼ˆå¾ context.ids æˆ–å»ºç«‹æ–°çš„ï¼‰
    if user_name not in context.ids:
        # ç°¡åŒ–ï¼šç›´æ¥ç”¨ user_name ç•¶ ID
        context.ids[user_name] = user_name
    
    user_id = context.ids[user_name]
    
    # ç‹€æ…‹æ˜ å°„ï¼šä¸­æ–‡ â†’ è‹±æ–‡ enum
    status_map = {
        "é€²è¡Œä¸­": "IN_PROGRESS",
        "å·²å®Œæˆ": "COMPLETED",
        "æœªé–‹å§‹": "NOT_STARTED",
    }
    
    # å»ºç«‹ Aggregate
    lesson_progress = LessonProgress(
        user_id=user_id,
        lesson_id=lesson_id,
        progress=progress,
        status=status_map.get(status, status)
    )
    
    # å„²å­˜åˆ° Repositoryï¼ˆå¾ context å–å¾—ï¼‰
    context.repos.lesson_progress.save(lesson_progress)
```

```python
# tests/features/steps/commands.py

from behave import when

@when('ç”¨æˆ¶ "{user_name}" æ›´æ–°èª²ç¨‹ {lesson_id:d} çš„å½±ç‰‡é€²åº¦ç‚º {progress:d}%')
def step_impl(context, user_name, lesson_id, progress):
    # å–å¾—ç”¨æˆ¶ ID
    user_id = context.ids.get(user_name, user_name)
    
    try:
        # å‘¼å« Serviceï¼ˆå¾ context å–å¾—ï¼‰
        context.services.lesson.update_video_progress(
            user_id=user_id,
            lesson_id=lesson_id,
            progress=progress
        )
        context.last_error = None
    except Exception as e:
        context.last_error = e
```

```python
# tests/features/steps/aggregate_then.py

from behave import then

@then('ç”¨æˆ¶ "{user_name}" åœ¨èª²ç¨‹ {lesson_id:d} çš„é€²åº¦æ‡‰ç‚º {progress:d}%')
def step_impl(context, user_name, lesson_id, progress):
    # å–å¾—ç”¨æˆ¶ ID
    user_id = context.ids.get(user_name, user_name)
    
    # å¾ Repository æŸ¥è©¢ï¼ˆå¾ context å–å¾—ï¼‰
    lesson_progress = context.repos.lesson_progress.find(
        user_id=user_id,
        lesson_id=lesson_id
    )
    
    # é©—è­‰
    assert lesson_progress is not None, \
        f"æ‰¾ä¸åˆ°ç”¨æˆ¶ {user_name} åœ¨èª²ç¨‹ {lesson_id} çš„é€²åº¦"
    assert lesson_progress.progress == progress, \
        f"é æœŸé€²åº¦ {progress}%ï¼Œå¯¦éš›ç‚º {lesson_progress.progress}%"
```

### Output 2ï¼ˆAggregate å®šç¾© - app/models/lesson_progress.pyï¼‰

```python
class LessonProgress:
    """èª²ç¨‹é€²åº¦ Aggregate"""
    
    def __init__(self, user_id: str, lesson_id: int, progress: int, status: str):
        self.user_id = user_id
        self.lesson_id = lesson_id
        self.progress = progress
        self.status = status
```

### Output 3ï¼ˆRepository å®šç¾© - app/repositories/lesson_progress_repository.pyï¼‰

```python
from typing import Optional
from app.models.lesson_progress import LessonProgress

class LessonProgressRepository:
    """èª²ç¨‹é€²åº¦ Repository - åƒ…å®šç¾©ä»‹é¢ï¼Œä¸å¯¦ä½œ"""
    
    def save(self, lesson_progress: LessonProgress) -> None:
        """ä¿å­˜èª²ç¨‹é€²åº¦ - ç´…ç‡ˆéšæ®µï¼šç©ºå¯¦ä½œ"""
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")
    
    def find(self, user_id: str, lesson_id: int) -> Optional[LessonProgress]:
        """æŸ¥è©¢èª²ç¨‹é€²åº¦ - ç´…ç‡ˆéšæ®µï¼šç©ºå¯¦ä½œ"""
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")
```

### Output 4ï¼ˆService å®šç¾© - app/services/lesson_service.pyï¼‰

```python
from app.repositories.lesson_progress_repository import LessonProgressRepository

class LessonService:
    """èª²ç¨‹æœå‹™ - åƒ…å®šç¾©ä»‹é¢ï¼Œä¸å¯¦ä½œ"""
    
    def __init__(self, lesson_progress_repository: LessonProgressRepository):
        self.lesson_progress_repository = lesson_progress_repository
    
    def update_video_progress(self, user_id: str, lesson_id: int, progress: int) -> None:
        """æ›´æ–°å½±ç‰‡é€²åº¦ - ç´…ç‡ˆéšæ®µï¼šç©ºå¯¦ä½œ"""
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")
```

### Output 5ï¼ˆEnvironment å®šç¾© - tests/features/environment.pyï¼‰

```python
# tests/features/environment.py

from types import SimpleNamespace
from app.repositories.lesson_progress_repository import LessonProgressRepository
from app.services.lesson_service import LessonService

def before_scenario(context, scenario):
    """æ¯å€‹ scenario åŸ·è¡Œå‰åˆå§‹åŒ–"""
    # åˆå§‹åŒ–ç‹€æ…‹
    context.last_error = None
    context.query_result = None
    context.ids = {}
    context.memo = {}
    
    # åˆå§‹åŒ–ä¾è³´
    context.repos = SimpleNamespace()
    context.services = SimpleNamespace()
    
    # åˆå§‹åŒ– repositories
    context.repos.lesson_progress = LessonProgressRepository()
    
    # åˆå§‹åŒ– servicesï¼ˆæ³¨å…¥ reposï¼‰
    context.services.lesson = LessonService(
        lesson_progress_repository=context.repos.lesson_progress
    )

def after_scenario(context, scenario):
    """æ¯å€‹ scenario åŸ·è¡Œå¾Œæ¸…ç†"""
    context.last_error = None
    context.query_result = None
    context.ids.clear()
    context.memo.clear()
```

### é æœŸçµæœï¼šæ¸¬è©¦åŸ·è¡Œæœƒå¤±æ•—ï¼ˆç´…ç‡ˆï¼‰ğŸ”´

```bash
$ behave tests/features/

Feature: èª²ç¨‹å¹³å° - å¢åŠ å½±ç‰‡é€²åº¦

  Scenario: æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦
    Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%ï¼Œç‹€æ…‹ç‚º "é€²è¡Œä¸­"  # passes
    When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„å½±ç‰‡é€²åº¦ç‚º 80%              # fails
      NotImplementedError: ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ

Failing scenarios:
  tests/features/03-å¢åŠ å½±ç‰‡é€²åº¦.dsl.feature:6  æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦

0 features passed, 1 failed, 0 skipped
0 scenarios passed, 1 failed, 0 skipped
```

**é€™å°±æ˜¯ç´…ç‡ˆ**ï¼š
- âœ… Step Definition å®Œæ•´å¯¦ä½œ
- âœ… ä»‹é¢å®šç¾©å®Œæ•´ï¼ˆé¡åˆ¥ã€æ–¹æ³•ã€åƒæ•¸ï¼‰
- âœ… environment.py å®šç¾©å®Œæ•´ï¼ˆcontext åˆå§‹åŒ–ï¼‰
- âœ… æ¥­å‹™é‚è¼¯æœªå¯¦ä½œï¼ˆæ‹‹å‡º NotImplementedErrorï¼‰
- âœ… æ¸¬è©¦åŸ·è¡Œæœƒå¤±æ•—

---

## Behave ç›®éŒ„çµæ§‹

```
app/
â”œâ”€â”€ models/                    # Aggregates
â”œâ”€â”€ repositories/              # Repositoriesï¼ˆç´…ç‡ˆéšæ®µï¼šåªæœ‰ç°½åï¼‰
â””â”€â”€ services/                  # Servicesï¼ˆç´…ç‡ˆéšæ®µï¼šåªæœ‰ç°½åï¼‰

specs/
â””â”€â”€ erm.dbml                   # DBML è¦æ ¼

tests/
â””â”€â”€ features/
    â”œâ”€â”€ environment.py          # hooksï¼šåˆå§‹åŒ– context
    â”œâ”€â”€ steps/                  # Step Definitions
    â””â”€â”€ *.feature               # Feature filesï¼ˆåŒ…å« *.dsl.featureï¼‰
```

---

## Critical Rules

### R1: Step Definition å¿…é ˆå®Œæ•´
Step Definition é‚è¼¯å¿…é ˆå®Œæ•´å¯¦ä½œï¼Œä¸èƒ½åªæœ‰ `pass`ã€‚

### R2: ä»‹é¢å®šç¾©å¿…é ˆå®Œæ•´ï¼Œä½†ä¸å¯¦ä½œ
é¡åˆ¥å’Œæ–¹æ³•ç°½åå®Œæ•´ï¼Œä½†å…§éƒ¨ä¸å¯¦ä½œæ¥­å‹™é‚è¼¯ã€‚

```python
# âœ… æ­£ç¢ºï¼šå®šç¾©å®Œæ•´ï¼Œä¸å¯¦ä½œ
class LessonService:
    def update_video_progress(self, user_id: str, lesson_id: int, progress: int) -> None:
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")

# âŒ éŒ¯èª¤ï¼šå¯¦ä½œäº†æ¥­å‹™é‚è¼¯
class LessonService:
    def update_video_progress(self, user_id: str, lesson_id: int, progress: int) -> None:
        current = self.repository.find(user_id, lesson_id)
        current.progress = progress
        self.repository.save(current)
```

### R3: environment.py å¿…é ˆæ­£ç¢ºå®šç¾©
æ‰€æœ‰ Step Definition éœ€è¦çš„ repos/services éƒ½å¿…é ˆåœ¨ `environment.py` ä¸­åˆå§‹åŒ–ã€‚

### R4: æª”æ¡ˆçµæ§‹æ­£ç¢º
```
âœ… æ­£ç¢ºçµæ§‹ï¼š
app/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ lesson_progress.py        # Aggregate
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ lesson_progress_repository.py  # Repository
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ lesson_service.py         # Service
â””â”€â”€ exceptions.py
specs/
â””â”€â”€ erm.dbml                       # DBML è¦æ ¼
tests/
â””â”€â”€ features/
    â”œâ”€â”€ environment.py            # Context åˆå§‹åŒ–
    â”œâ”€â”€ steps/                    # Step Definitions
    â””â”€â”€ *.feature                 # Feature æª”æ¡ˆï¼ˆåŒ…å« *.dsl.featureï¼‰
```

### R5: æ¸¬è©¦æœƒå¤±æ•—ï¼ˆç´…ç‡ˆï¼‰
ç´…ç‡ˆéšæ®µçš„æ¸¬è©¦åŸ·è¡Œå¾Œæ‡‰è©²å¤±æ•—ï¼Œé€™æ˜¯é æœŸçš„çµæœã€‚

### R6: ä¾è³´é€é context å–å¾—
æ‰€æœ‰ä¾è³´éƒ½å¾ `context.repos.*` / `context.services.*` å–å¾—ï¼Œä¸ä½¿ç”¨å…¨åŸŸè®Šæ•¸ã€‚

### R7: ç‹€æ…‹é€é context å…±äº«
`last_error` å’Œ `query_result` ç›´æ¥ä½œç‚º context å±¬æ€§ï¼Œä¸ä½¿ç”¨ dictã€‚

```python
# âœ… æ­£ç¢ºï¼šç›´æ¥ä½¿ç”¨ context å±¬æ€§
context.last_error = e
context.query_result = result

# âŒ éŒ¯èª¤ï¼šä½¿ç”¨ dictï¼ˆé‚£æ˜¯ pytest-bdd çš„åšæ³•ï¼‰
last_error["error"] = e
```

---

## Next Step

å®Œæˆç´…ç‡ˆéšæ®µå¾Œï¼Œé€²å…¥**ç¶ ç‡ˆéšæ®µ**ï¼ˆ`P03-ç¶ ç‡ˆ.md`ï¼‰ï¼š
- å¯¦ä½œ Fake Repository
- å¯¦ä½œ Service æ¥­å‹™é‚è¼¯
- è®“æ¸¬è©¦é€šéï¼ˆç¶ ç‡ˆï¼‰

---

**æ–‡ä»¶å»ºç«‹æ—¥æœŸ**ï¼š2025-12-28
**æ–‡ä»¶ç‰ˆæœ¬**ï¼šBehave BDD Unit Test Version 2.0
**é©ç”¨æ¡†æ¶**ï¼šPython + Behave
