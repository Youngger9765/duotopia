# 新增班級和班級學生

## 適用後台

- **機構後台**：在分校下建立班級、新增學生（需組織/分校管理權限）
- **教師個人後台**：建立自己的班級、新增自己的學生

## 角色限制

### 機構後台

- `org_owner`（機構擁有者）
- `org_admin`（機構管理員）
- `school_admin`（分校管理員）

### 教師個人後台

- 所有教師（建立個人班級和學生）

> 通用規則見 [common-rules.md](./common-rules.md)

## 對話流程

### Step 0：確認組織與分校（僅機構後台）

確認組織和分校，邏輯與新增教師相同：

| 用戶所在頁面 | URL 範例 | 已知資訊 | AI 行為 |
|-------------|---------|---------|--------|
| 某分校班級頁面 | `/organization/schools/5/classrooms` | 組織 + 分校 | 直接確認：「您目前在 {組織名} / {分校名}，要在此分校操作嗎？」 |
| 某組織頁面 | `/organization/3` | 組織 | 列出組織下的分校讓用戶選擇 |
| 其他頁面 | `/organization/dashboard` | 無 | 列出組織 → 選組織 → 列出分校 → 選分校 |

- 只有一個組織 → 直接帶入
- 只有一個分校 → 直接帶入
- 教師個人後台跳過此步驟，直接進入 Step 1

### Step 1：選擇操作

AI 提示：

```
請問您要？
  [建立新班級] [對現有班級加學生]
```

- **建立新班級** → 進入 Step 2a
- **對現有班級加學生** → 進入 Step 2b

### Step 2a：建立新班級

AI 依序收集班級資料：

**1. 班級名稱**（必填）：

> 請輸入班級名稱。

**2. 語言等級**（必填）：

> 請選擇語言等級：
> [PREA] [A1] [A2] [B1] [B2] [C1] [C2]

**3. 負責教師**（僅機構後台，選填）：

> 是否指定負責教師？
> [王小明] [李大華] [陳美玲] [邀請新教師] [先不指派]

- 列出該分校現有教師
- **邀請新教師** → 切換到「新增機構教師」流程（見 [add-teacher.md](./add-teacher.md)），完成後回到班級流程繼續
- **先不指派** → 跳過，之後在班級設定頁指定

教師個人後台不問此步驟，自動帶入當前教師。

**班級確認**：

```
即將建立班級：

班級名稱：高級英文班
語言等級：B1
負責教師：王小明（或「未指定」）

確認建立嗎？
```

用戶確認後建立班級，接著進入 Step 3。

### Step 2b：選擇現有班級

#### 機構後台

列出該分校的班級：

```
請選擇班級：
  [高級英文班 (B1)] [初級英文班 (A1)] [兒童班 (PREA)]
```

#### 教師個人後台

列出教師自己的班級：

```
請選擇班級：
  [高級英文班 (B1)] [初級英文班 (A1)]
```

選擇後進入 Step 3。

### Step 3：收集學生資料（自由輸入）

AI 提示：

> 請提供學生的**姓名**和**生日**。
> 也可以附上學號、Email、電話（選填）。
> 可一次提供多位，例如：
> ```
> 林小明 2015-03-21
> 張美玲 2014-08-15 A001
> 王大偉 2015-01-10 B002 wang@gmail.com
> ```

**LLM 解析規則**：

- 必須解析出：姓名、生日
- 可選解析：學號、email、電話
- 生日格式支援：`YYYY-MM-DD`、`YYYY/MM/DD`、`YYYYMMDD`、`MM/DD/YYYY`
- 如果缺少姓名或生日 → 回報哪些資料不完整，請用戶補充
- 如果同一個姓名+生日出現多次 → 提醒用戶並去重
- 學號格式驗證：僅允許英文、數字、底線、連字號

### Step 4：AI 整理 + 用戶確認

AI 將解析結果以表格呈現：

```
即將在【高級英文班】新增以下學生：

| # | 姓名   | 生日       | 學號 | Email          | 狀態 |
|---|--------|-----------|------|----------------|------|
| 1 | 林小明 | 2015-03-21 | -    | -              | ✓   |
| 2 | 張美玲 | 2014-08-15 | A001 | -              | ✓   |
| 3 | 王大偉 | 2015-01-10 | B002 | wang@gmail.com | ✓   |

請確認，或告訴我需要修改的地方。
```

**生日格式驗證**：

如果有生日格式無法辨識，在表格中標註：

```
| # | 姓名   | 生日       | 學號 | 狀態               |
|---|--------|-----------|------|--------------------|
| 1 | 林小明 | abc       | -    | ⚠️ 生日格式不正確   |
| 2 | 張美玲 | 2014-08-15 | A001 | ✓                  |

⚠️ 第 1 筆生日格式有誤，請修正後才能執行。
```

- 有任何一筆格式不正確 → 不允許確認，必須修正

**學號重複檢查**（僅機構後台）：

如果學號在該分校已存在，標註警告。

**用戶可執行的修改**：
- 修改資料：「林小明的生日改成 2015-04-21」
- 刪除某位：「把王大偉移除」
- 新增更多：「再加一個 趙小華 2015-06-01」
- 新增欄位：「張美玲的 email 是 zhang@gmail.com」

修改後重新顯示表格，直到所有驗證通過且用戶確認。

### Step 5：批次執行 + 完成摘要

用戶確認後，批次建立所有學生：

```
正在新增學生...

✅ 新增完成！

成功：3 位
  - 林小明 (2015-03-21)
  - 張美玲 (2014-08-15) 學號：A001
  - 王大偉 (2015-01-10) 學號：B002

學生登入資訊：
  帳號：使用 Email 或教師提供的登入連結
  預設密碼：學生的生日（YYYYMMDD 格式）
```

**錯誤處理**：
- 學號已存在於該分校 → 顯示「⚠️ 學號 A001 已存在，張美玲已略過」，繼續其他學生
- API 失敗 → 顯示「❌ 新增失敗：{錯誤原因}」，繼續其他學生

**部分成功時的摘要**：

```
新增完成！

✅ 成功：2 位
  - 林小明 (2015-03-21)
  - 王大偉 (2015-01-10) 學號：B002

⚠️ 略過：1 位
  - 張美玲 (2014-08-15) → 學號 A001 已存在於該分校
```

## 資料欄位定義

### 班級

| 欄位 | 型別 | 必填 | 預設值 | 驗證規則 |
|------|------|------|--------|---------|
| name | string | 必填 | - | 1-100 字元 |
| level | string | 必填 | `A1` | `PREA` \| `A1` \| `A2` \| `B1` \| `B2` \| `C1` \| `C2` |
| description | string | 選填 | - | 文字 |
| teacher_id | integer | 選填 | - | 必須是分校內的有效教師 |

### 學生

| 欄位 | 型別 | 必填 | 預設值 | 驗證規則 |
|------|------|------|--------|---------|
| name | string | 必填 | - | 1-100 字元 |
| birthdate | string | 必填 | - | YYYY-MM-DD 格式 |
| email | string | 選填 | - | 合法 email 格式，max 255 字元，可為空 |
| student_number | string | 選填 | - | 1-50 字元，僅英數底線連字號 |
| phone | string | 選填 | - | max 20 字元 |

## API 對應

### 建立班級

#### 個人班級（教師後台）

```
POST /api/teachers/classrooms

Request Body:
{
  "name": "高級英文班",
  "level": "B1",
  "description": ""
}

Success Response (200):
{
  "id": 1,
  "name": "高級英文班",
  "program_level": "B1",
  "teacher_id": 42,
  "is_active": true
}
```

#### 分校班級（機構後台）

```
POST /api/schools/{school_id}/classrooms

Request Body:
{
  "name": "高級英文班",
  "level": "B1",
  "teacher_id": 42  // 選填
}

Success Response (200):
{
  "id": 1,
  "name": "高級英文班",
  "program_level": "B1",
  "teacher_name": "王小明",
  "student_count": 0
}
```

### 新增學生

#### 個人學生（教師後台）

```
POST /api/teachers/students

Request Body:
{
  "name": "林小明",
  "birthdate": "2015-03-21",
  "email": null,
  "student_number": null,
  "classroom_id": 1  // 指定班級
}

Success Response (200):
{
  "id": 1,
  "name": "林小明",
  "birthdate": "2015-03-21",
  "default_password": "20150321",
  "classroom_id": 1
}
```

#### 分校學生（機構後台）

```
POST /api/schools/{school_id}/students

Request Body:
{
  "name": "林小明",
  "birthdate": "2015-03-21",
  "email": null,
  "student_number": "A001"
}

Success Response (200):
{
  "id": 1,
  "name": "林小明",
  "birthdate": "2015-03-21",
  "default_password": "20150321",
  "student_number": "A001"
}

Error Cases:
- 409: 學號已存在於該分校
- 403: 無權限
```

### 查詢現有班級

#### 教師班級

```
GET /api/teachers/classrooms

Response: ClassroomInfo[]
```

#### 分校班級

```
GET /api/schools/{school_id}/classrooms

Response: ClassroomInfo[]
```

### 查詢分校教師（機構後台指派教師用）

```
GET /api/schools/{school_id}/teachers

Response: TeacherInfo[]
```

## 上下文資料來源

| 資料 | 來源 |
|------|------|
| 用戶可管理的組織列表 | `GET /api/organizations` |
| 組織下的分校列表 | `GET /api/organizations/{org_id}/schools` |
| 分校下的班級列表 | `GET /api/schools/{school_id}/classrooms` |
| 分校下的教師列表 | `GET /api/schools/{school_id}/teachers` |
| 教師自己的班級列表 | `GET /api/teachers/classrooms` |
| 當前頁面的組織/分校 | 前端 URL 路由參數 |
