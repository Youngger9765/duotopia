# 🔒 Payment System Security Checklist

## 📋 業界標準金流安全檢查清單

### 1. **PCI DSS 合規性檢查** ⚠️ 最重要
- [ ] **不存儲完整卡號** - 只存後 4 碼
- [ ] **不存儲 CVV/CVC** - 絕對禁止
- [ ] **不存儲 PIN** - 絕對禁止
- [ ] **加密傳輸** - 必須使用 HTTPS/TLS
- [ ] **存取控制** - 限制誰能看到交易資料
- [ ] **定期安全掃描** - 每季至少一次
- [ ] **網路隔離** - 支付系統與其他系統隔離

### 2. **防止重複扣款（Idempotency）** 🔄
```python
# 必須實作的機制
- [ ] Idempotency Key - 每筆交易唯一識別碼
- [ ] 交易鎖定機制 - 防止並發處理同一筆交易
- [ ] 重試邏輯 - 區分新交易與重試
- [ ] 狀態檢查 - 處理前檢查是否已處理
```

#### 實作範例：
```sql
-- 加入唯一約束防止重複
ALTER TABLE teacher_subscription_transactions 
ADD COLUMN idempotency_key VARCHAR(255);

CREATE UNIQUE INDEX idx_idempotency_key 
ON teacher_subscription_transactions(idempotency_key) 
WHERE idempotency_key IS NOT NULL;
```

### 3. **交易狀態管理** 📊
- [ ] **明確的狀態流程**
  ```
  PENDING → PROCESSING → SUCCESS/FAILED
         ↓
      CANCELLED → REFUNDED
  ```
- [ ] **狀態不可逆** - SUCCESS 不能變回 PENDING
- [ ] **原子性操作** - 使用資料庫 Transaction
- [ ] **超時處理** - PENDING 超過 X 分鐘自動失敗

### 4. **稽核記錄（Audit Trail）** 📝
- [ ] **Who** - 誰發起交易（user_id, email）
- [ ] **What** - 做了什麼（金額、方案、動作）
- [ ] **When** - 時間戳記（精確到毫秒）
- [ ] **Where** - IP 位址、裝置資訊
- [ ] **Why** - 交易原因（購買/退款/調整）
- [ ] **Result** - 結果（成功/失敗/錯誤碼）

### 5. **資料驗證** ✅
- [ ] **金額驗證**
  - 不能為負數
  - 不超過上限（如 999,999）
  - 正確的小數位數（TWD 沒有小數）
- [ ] **幣別驗證** - 只接受支援的幣別
- [ ] **用戶身份驗證** - 確認是本人
- [ ] **方案驗證** - 確認方案存在且有效

### 6. **錯誤處理** ❌
- [ ] **不洩漏敏感資訊** - 錯誤訊息不含卡號
- [ ] **分類錯誤類型**
  - 可重試（網路錯誤）
  - 不可重試（卡號錯誤）
- [ ] **錯誤記錄** - 記錄所有錯誤但不含敏感資料
- [ ] **用戶友善訊息** - 提供清楚的錯誤說明

### 7. **退款機制** 💰
- [ ] **退款政策** - 明確的退款規則
- [ ] **部分退款支援** - 能退部分金額
- [ ] **退款追蹤** - 記錄退款原因和批准者
- [ ] **防止超額退款** - 不能退超過原始金額

### 8. **監控與告警** 🚨
- [ ] **即時監控**
  - 成功率低於 95% 告警
  - 平均處理時間超過 3 秒告警
- [ ] **異常偵測**
  - 短時間大量失敗
  - 異常大額交易
  - 重複失敗的卡號
- [ ] **每日報表**
  - 交易總額
  - 成功/失敗比例
  - 各支付方式統計

### 9. **資料備份與恢復** 💾
- [ ] **定期備份** - 每日備份交易記錄
- [ ] **異地備援** - 備份存在不同地點
- [ ] **恢復測試** - 定期測試恢復流程
- [ ] **資料保留政策** - 依法規保留 X 年

### 10. **第三方整合** 🔌
- [ ] **API 金鑰管理**
  - 使用環境變數
  - 定期輪換
  - 不同環境不同金鑰
- [ ] **Webhook 驗證** - 驗證來源真實性
- [ ] **重試機制** - API 失敗時的處理
- [ ] **版本管理** - 追蹤 API 版本變更

### 11. **法規遵循** ⚖️
- [ ] **個資法遵循** - GDPR/台灣個資法
- [ ] **金流法規** - 電子支付法規
- [ ] **稅務合規** - 發票開立
- [ ] **洗錢防制** - KYC/AML 檢查

### 12. **測試環境** 🧪
- [ ] **沙盒環境** - 獨立測試環境
- [ ] **測試卡號** - 專用測試資料
- [ ] **模擬各種情境**
  - 成功交易
  - 卡片被拒
  - 網路逾時
  - 部分退款

## 🔴 紅線規則（絕對禁止）

1. **絕不在 log 中印出**
   - 完整卡號
   - CVV
   - 密碼
   - API 金鑰

2. **絕不在前端存儲**
   - 任何卡片資訊
   - 交易密鑰

3. **絕不使用 GET 請求**
   - 處理支付
   - 傳遞敏感資料

4. **絕不信任前端資料**
   - 金額必須後端驗證
   - 用戶身份必須後端確認

## 📊 實作優先順序

### Phase 1: 基礎安全（第一週）
1. HTTPS 設定
2. 基本驗證
3. 錯誤處理
4. 基礎 logging

### Phase 2: 核心功能（第二週）
1. Idempotency 實作
2. 狀態管理
3. 基本監控
4. 退款流程

### Phase 3: 進階功能（第三週）
1. 完整稽核
2. 異常偵測
3. 自動化測試
4. 效能優化

### Phase 4: 合規性（第四週）
1. PCI DSS 評估
2. 法規檢查
3. 安全掃描
4. 文件完善

## 🎯 關鍵指標（KPI）

```python
# 必須監控的指標
PAYMENT_KPI = {
    'success_rate': '>= 97%',        # 成功率
    'avg_response_time': '< 2s',     # 平均回應時間
    'duplicate_rate': '< 0.1%',      # 重複扣款率
    'refund_rate': '< 5%',           # 退款率
    'fraud_rate': '< 0.1%',          # 詐欺率
    'uptime': '>= 99.9%'             # 可用性
}
```

## 💡 最佳實踐建議

1. **使用成熟的支付服務商** - TapPay, Stripe, PayPal
2. **不要自己處理卡號** - 用 tokenization
3. **做好文件記錄** - 每個決策都要有理由
4. **定期安全審計** - 至少每季一次
5. **保持更新** - 關注最新的安全威脅

## 🚨 緊急應變計劃

### 發生資安事件時：
1. **立即停止服務** - 防止損害擴大
2. **通知相關人員** - 技術、法務、公關
3. **保存證據** - 不要刪除 log
4. **評估影響範圍** - 多少用戶受影響
5. **通知用戶** - 依法規時限內通知
6. **事後檢討** - 防止再次發生

---

*最後更新: 2024-10-04*
*參考標準: PCI DSS v4.0.1, OWASP Top 10 2021*