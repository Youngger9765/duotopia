# Duotopia 11æœˆäº¤ä»˜åŠŸèƒ½ PRD (Product Requirements Document)

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-11-17
**ç‹€æ…‹**: âœ… Final ç‰ˆæœ¬

---

## ä¸€ã€äº¤ä»˜æ¦‚è¿°

### 1.1 äº¤ä»˜æ™‚ç¨‹
- **é–‹ç™¼æœˆä»½**: 2025å¹´11æœˆ
- **äº¤ä»˜æ—¥æœŸ**: 2025å¹´11æœˆ30æ—¥
- **éšæ®µ**: Phase 1.5 - è¨‚é–±èˆ‡ç®¡ç†åŠŸèƒ½å¢å¼·

### 1.2 äº¤ä»˜ç›®æ¨™
æœ¬æ¬¡äº¤ä»˜å°ˆæ³¨æ–¼å®Œå–„è¨‚é–±ç®¡ç†ç³»çµ±ã€å¾Œå°ç®¡ç†åŠŸèƒ½ã€ä»¥åŠå…¨ç«™åœ‹éš›åŒ–æ”¯æ´ï¼Œç‚ºå¹³å°å•†æ¥­åŒ–é‹ç‡Ÿå¥ å®šåŸºç¤ã€‚

---

## äºŒã€æ ¸å¿ƒåŠŸèƒ½äº¤ä»˜æ¸…å–®

### 2.1 å¾Œå°ç®¡ç†é¸å–®ï¼ˆè§’è‰²åˆ‡æ›ï¼‰

#### åŠŸèƒ½æè¿°
å¯¦ä½œå¤šè§’è‰²å¾Œå°ç®¡ç†ç³»çµ±ï¼Œæ”¯æ´ä¸åŒè¨‚é–±å±¤ç´šçš„ä½¿ç”¨è€…æª¢è¦–èˆ‡ç®¡ç†åŠŸèƒ½ã€‚

#### æ”¯æ´è§’è‰²
1. **è©¦ç”¨è€… (Trial)**
   - 30å¤©å…è²»è©¦ç”¨æœŸ
   - åŸºç¤åŠŸèƒ½å­˜å–
   - é¡¯ç¤ºè©¦ç”¨å‰©é¤˜å¤©æ•¸
   - å‡ç´šè¨‚é–±æç¤º

2. **è¨‚é–±è€… - Tutor**
   - NT$330/æœˆ
   - 10,000é»é…é¡
   - å®Œæ•´æ•™å¸«åŠŸèƒ½
   - åŸºç¤çµ±è¨ˆåˆ†æ

3. **è¨‚é–±è€… - School**
   - NT$660/æœˆ
   - 25,000é»é…é¡
   - å®Œæ•´æ•™å¸«åŠŸèƒ½
   - é€²éšçµ±è¨ˆåˆ†æ
   - å­¸æ ¡ç®¡ç†åŠŸèƒ½ï¼ˆPhase 2ï¼‰

#### æŠ€è¡“å¯¦ä½œ
- **è³‡æ–™æ¨¡å‹**: `Teacher.subscription_tier` (trial/tutor/school)
- **æ¬Šé™ç®¡ç†**: Role-Based Access Control (RBAC)
- **å‰ç«¯å…ƒä»¶**:
  - `RoleSwitcher.tsx` - è§’è‰²åˆ‡æ›é¸å–®
  - `SubscriptionBadge.tsx` - è¨‚é–±å±¤ç´šå¾½ç« 
  - `UpgradePrompt.tsx` - å‡ç´šæç¤ºå…ƒä»¶

#### é©—æ”¶æ¨™æº–
- [ ] ä½¿ç”¨è€…ç™»å…¥å¾Œæ­£ç¢ºé¡¯ç¤ºå°æ‡‰è§’è‰²
- [ ] ä¸åŒè§’è‰²çœ‹åˆ°å°æ‡‰çš„åŠŸèƒ½é¸å–®
- [ ] å‡ç´š/é™ç´šè¨‚é–±å¾Œè§’è‰²å³æ™‚æ›´æ–°
- [ ] è©¦ç”¨æœŸåˆ°æœŸå¾Œè‡ªå‹•é–å®šé€²éšåŠŸèƒ½
- [ ] è§’è‰²æ¬Šé™æ­£ç¢ºé™åˆ¶ API å­˜å–

---

### 2.2 é€€æ¬¾æ©Ÿåˆ¶ï¼ˆå…¬å¸ç®¡ç†è€…å¾Œå°ï¼‰

#### åŠŸèƒ½æè¿°
ç‚ºå…¬å¸ç®¡ç†è€…æä¾›å®Œæ•´çš„é€€æ¬¾ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æ´å…¨é¡é€€æ¬¾æ“ä½œèˆ‡è¨˜éŒ„è¿½è¹¤ã€‚

#### æ ¸å¿ƒåŠŸèƒ½
1. **é€€æ¬¾æ“ä½œä»‹é¢**
   - æœå°‹äº¤æ˜“è¨˜éŒ„
   - é¸æ“‡é€€æ¬¾é …ç›®
   - è¼¸å…¥é€€æ¬¾åŸå› 
   - åŸ·è¡Œé€€æ¬¾æ“ä½œ
   - é€€æ¬¾ç¢ºèªæ©Ÿåˆ¶

2. **é€€æ¬¾ç‹€æ…‹ç®¡ç†**
   - ç”³è«‹ä¸­ (PENDING)
   - è™•ç†ä¸­ (PROCESSING)
   - æˆåŠŸ (SUCCESS)
   - å¤±æ•— (FAILED)
   - å·²å–æ¶ˆ (CANCELLED)

3. **è¨Šæ¯èˆ‡é€šçŸ¥**
   - é€€æ¬¾æˆåŠŸé€šçŸ¥ï¼ˆEmail + ç³»çµ±é€šçŸ¥ï¼‰
   - é€€æ¬¾å¤±æ•—é€šçŸ¥ï¼ˆé¡¯ç¤ºå¤±æ•—åŸå› ï¼‰
   - ç®¡ç†è€…æ“ä½œè¨˜éŒ„

#### æŠ€è¡“å¯¦ä½œ
- **API è·¯ç”±**: `POST /api/admin/refunds`
- **è³‡æ–™æ¨¡å‹**:
  ```typescript
  interface Refund {
    id: string;
    transaction_id: string;
    amount: number;
    reason: string;
    status: RefundStatus;
    processed_by: number; // admin user id
    processed_at?: Date;
    error_message?: string;
  }
  ```
- **TapPay æ•´åˆ**: å‘¼å« TapPay Refund API
- **è¨˜éŒ„ç¨½æ ¸**: å®Œæ•´è¨˜éŒ„é€€æ¬¾æ“ä½œæ­·å²

#### é©—æ”¶æ¨™æº–
- [ ] ç®¡ç†è€…å¯æœå°‹ä¸¦æŸ¥çœ‹æ‰€æœ‰äº¤æ˜“è¨˜éŒ„
- [ ] åŸ·è¡Œå…¨é¡é€€æ¬¾åŠŸèƒ½æ­£å¸¸
- [ ] é€€æ¬¾æˆåŠŸå¾Œæ›´æ–°è¨‚é–±ç‹€æ…‹
- [ ] é€€æ¬¾å¤±æ•—é¡¯ç¤ºæ˜ç¢ºéŒ¯èª¤è¨Šæ¯
- [ ] æ‰€æœ‰é€€æ¬¾æ“ä½œå®Œæ•´è¨˜éŒ„
- [ ] Email é€šçŸ¥æ­£ç¢ºç™¼é€

---

### 2.3 é»æ•¸èˆ‡è¨‚é–±é‚è¼¯å„ªåŒ–

#### åŠŸèƒ½æè¿°
å®Œå–„é»æ•¸é…é¡ç³»çµ±ï¼Œå¯¦ä½œè©¦ç”¨åŒ…èˆ‡è¨‚é–±æ–¹æ¡ˆçš„ä¸åŒé»æ•¸è¨ˆç®—é‚è¼¯ã€‚

#### é»æ•¸è¦å‰‡

##### è©¦ç”¨åŒ…é»æ•¸ï¼ˆTrial Creditsï¼‰
- **åˆå§‹é…é¡**: 1,000 é»ï¼ˆè©¦ç”¨æœŸå°ˆç”¨ï¼‰
- **ä½¿ç”¨è¦å‰‡**:
  - è©¦ç”¨æœŸå…§å¯ä½¿ç”¨
  - å‰©é¤˜é»æ•¸å¯ç´¯è¨ˆåˆ°ä»˜è²»è¨‚é–±
  - å‡ç´šè¨‚é–±å¾Œï¼Œè©¦ç”¨é»æ•¸èˆ‡è¨‚é–±é»æ•¸åˆ†é–‹è¨ˆç®—
- **ç´¯è¨ˆæ©Ÿåˆ¶**:
  ```
  ç¸½å¯ç”¨é»æ•¸ = è©¦ç”¨å‰©é¤˜é»æ•¸ + è¨‚é–±æ–¹æ¡ˆé»æ•¸
  æ‰£é™¤é †åº: å…ˆæ‰£è¨‚é–±é»æ•¸ â†’ å†æ‰£è©¦ç”¨é»æ•¸
  ```

##### è¨‚é–±æ–¹æ¡ˆé»æ•¸ï¼ˆSubscription Creditsï¼‰
- **Tutor**: 10,000 é»/æœˆ
- **School**: 25,000 é»/æœˆ
- **ä½¿ç”¨è¦å‰‡**:
  - æ¯æœˆæ­¸é›¶ï¼Œä¸ç´¯ç©åˆ°ä¸‹å€‹æœˆ
  - æœˆåº•æœªä½¿ç”¨çš„é»æ•¸è‡ªå‹•æ¸…ç©º
  - çºŒè¨‚å¾Œé‡æ–°è¨ˆç®—é…é¡

#### é»æ•¸æ‰£é™¤è¦å‰‡
| åŠŸèƒ½ | æ‰£é»è¦å‰‡ |
|------|---------|
| èªéŸ³éŒ„éŸ³ | 1 ç§’ = 1 é» |
| æ–‡å­—æ‰¹æ”¹ | 1 å­— = 0.1 é»ï¼ˆ500å­— = 50é»ï¼‰ |
| åœ–ç‰‡æ‰¹æ”¹ | 1 å¼µ = 10 é» |

#### æŠ€è¡“å¯¦ä½œ
- **è³‡æ–™æ¨¡å‹æ“´å……**:
  ```python
  class Teacher(Base):
      trial_credits_remaining: int = 1000
      subscription_credits_remaining: int = 0
      subscription_credits_total: int = 0
      credits_reset_at: DateTime
  ```
- **é»æ•¸è¨ˆç®—é‚è¼¯**: `quota_service.py`
- **æœˆåº•é‡ç½®æ’ç¨‹**: Cron Job (æ¯æœˆ1æ—¥ 00:00)

#### é©—æ”¶æ¨™æº–
- [ ] è©¦ç”¨ç”¨æˆ¶æ­£ç¢ºé¡¯ç¤º 1,000 è©¦ç”¨é»æ•¸
- [ ] å‡ç´šè¨‚é–±å¾Œè©¦ç”¨é»æ•¸ä¿ç•™
- [ ] æ‰£é»é †åºæ­£ç¢ºï¼ˆè¨‚é–±é»æ•¸å„ªå…ˆï¼‰
- [ ] è¨‚é–±é»æ•¸æ¯æœˆ1æ—¥æ­£ç¢ºæ­¸é›¶
- [ ] å„€è¡¨æ¿æ­£ç¢ºé¡¯ç¤ºå…©ç¨®é»æ•¸é¤˜é¡
- [ ] é»æ•¸ä½¿ç”¨è¨˜éŒ„å®Œæ•´è¿½è¹¤

---

### 2.4 å¾Œå°å¸³æ¬¾æ˜ç´°ä¸‹è¼‰

#### åŠŸèƒ½æè¿°
æä¾›ç®¡ç†ç«¯å®Œæ•´çš„å¸³æ¬¾æ˜ç´°åŒ¯å‡ºåŠŸèƒ½ï¼Œæ”¯æ´å¤šç¨®æ ¼å¼ä¸‹è¼‰ã€‚

#### æ ¸å¿ƒåŠŸèƒ½
1. **å¸³æ¬¾è³‡æ–™ç¯©é¸**
   - æ™‚é–“ç¯„åœé¸æ“‡ï¼ˆèµ·è¿„æ—¥æœŸï¼‰
   - è¨‚é–±æ–¹æ¡ˆç¯©é¸ï¼ˆTrial/Tutor/Schoolï¼‰
   - äº¤æ˜“ç‹€æ…‹ç¯©é¸ï¼ˆæˆåŠŸ/é€€æ¬¾/å¤±æ•—ï¼‰
   - ç”¨æˆ¶æœå°‹ï¼ˆå§“å/Emailï¼‰

2. **åŒ¯å‡ºæ ¼å¼**
   - **CSV**: ç›¸å®¹ Excelï¼Œé©åˆæ•¸æ“šåˆ†æ
   - **XLSX**: Excel åŸç”Ÿæ ¼å¼ï¼Œæ”¯æ´å¤šå·¥ä½œè¡¨
   - æœªä¾†æ“´å……: PDF å ±è¡¨

3. **åŒ¯å‡ºæ¬„ä½**
   | æ¬„ä½åç¨± | èªªæ˜ |
   |---------|------|
   | äº¤æ˜“ID | Transaction ID |
   | äº¤æ˜“æ—¥æœŸ | Transaction Date |
   | ç”¨æˆ¶å§“å | Teacher Name |
   | ç”¨æˆ¶Email | Teacher Email |
   | è¨‚é–±æ–¹æ¡ˆ | Subscription Tier |
   | äº¤æ˜“é‡‘é¡ | Amount (NT$) |
   | æ”¯ä»˜æ–¹å¼ | Payment Method |
   | äº¤æ˜“ç‹€æ…‹ | Status |
   | é…é¡é»æ•¸ | Credits Allocated |
   | å‚™è¨» | Notes |

#### æŠ€è¡“å¯¦ä½œ
- **API è·¯ç”±**: `GET /api/admin/transactions/export`
- **Query åƒæ•¸**:
  ```typescript
  interface ExportQuery {
    start_date: string;
    end_date: string;
    tier?: 'trial' | 'tutor' | 'school';
    status?: 'success' | 'refunded' | 'failed';
    format: 'csv' | 'xlsx';
  }
  ```
- **å¾Œç«¯è™•ç†**:
  - CSV: Python `csv` module
  - XLSX: `openpyxl` library
  - æª”æ¡ˆå‘½å: `transactions_YYYYMMDD_HHMMSS.{csv|xlsx}`

#### é©—æ”¶æ¨™æº–
- [ ] å¯é¸æ“‡æ—¥æœŸç¯„åœåŒ¯å‡º
- [ ] CSV æ ¼å¼æ­£ç¢ºï¼ˆUTF-8 BOMï¼ŒExcel å¯é–‹å•Ÿï¼‰
- [ ] XLSX æ ¼å¼æ­£ç¢ºï¼ˆå«æ¨™é¡Œåˆ—ï¼‰
- [ ] ç¯©é¸æ¢ä»¶æ­£ç¢ºå¥—ç”¨
- [ ] å¤§é‡è³‡æ–™åŒ¯å‡ºä¸è¶…æ™‚ï¼ˆæ¸¬è©¦ 10,000 ç­†ï¼‰
- [ ] ä¸‹è¼‰æª”ååŒ…å«æ™‚é–“æˆ³è¨˜
- [ ] ä¸­æ–‡æ¬„ä½åç¨±æ­£ç¢ºé¡¯ç¤º

---

### 2.5 å…¨ç«™åœ‹éš›åŒ– (i18n)

#### åŠŸèƒ½æè¿°
å»ºç«‹å®Œæ•´çš„å¤šèªè¨€æ”¯æ´æ¶æ§‹ï¼Œå¯¦ä½œä¸­è‹±æ–‡é›™èªä»‹é¢ã€‚

#### æ”¯æ´èªè¨€
- **ä¸­æ–‡ (zh)**: ç¹é«”ä¸­æ–‡ï¼ˆé è¨­ï¼‰
- **è‹±æ–‡ (en)**: è‹±æ–‡

#### i18n æ¶æ§‹

##### å‰ç«¯å¯¦ä½œ
- **æ¡†æ¶**: `react-i18next`
- **èªç³»æª”ä½ç½®**: `/frontend/src/locales/`
  - `zh.json` - ç¹é«”ä¸­æ–‡
  - `en.json` - è‹±æ–‡
- **èªç³»åˆ‡æ›**: Header å³ä¸Šè§’èªè¨€é¸å–®
- **æŒä¹…åŒ–**: LocalStorage å„²å­˜ä½¿ç”¨è€…åå¥½

##### å¾Œç«¯å¯¦ä½œ
- **æ¡†æ¶**: `babel` æˆ–è‡ªå®šç¾© i18n service
- **èªç³»æª”ä½ç½®**: `/backend/locales/`
  - `zh.json` - ç¹é«”ä¸­æ–‡
  - `en.json` - è‹±æ–‡
- **Email æ¨¡æ¿**: æ”¯æ´å¤šèªè¨€ä¿¡ä»¶å…§å®¹

#### ç¿»è­¯ç¯„åœ

##### å‰ç«¯å…¨é é¢æ–‡æ¡ˆ
- [ ] ç™»å…¥/è¨»å†Šé é¢
- [ ] æ•™å¸«å„€è¡¨æ¿
- [ ] ç­ç´šç®¡ç†é é¢
- [ ] å­¸ç”Ÿç®¡ç†é é¢
- [ ] èª²ç¨‹ç®¡ç†é é¢
- [ ] ä½œæ¥­ç®¡ç†é é¢
- [ ] æ‰¹æ”¹ä»‹é¢
- [ ] è¨‚é–±ç®¡ç†é é¢
- [ ] å€‹äººè¨­å®šé é¢
- [ ] éŒ¯èª¤è¨Šæ¯
- [ ] æŒ‰éˆ•æ–‡å­—
- [ ] è¡¨å–®æ¨™ç±¤

##### å¾Œå°å…¨æ¨¡çµ„æ–‡æ¡ˆ
- [ ] ç®¡ç†è€…å„€è¡¨æ¿
- [ ] ç”¨æˆ¶ç®¡ç†
- [ ] äº¤æ˜“ç®¡ç†
- [ ] é€€æ¬¾ç®¡ç†
- [ ] ç³»çµ±è¨­å®š
- [ ] API éŒ¯èª¤è¨Šæ¯
- [ ] Email é€šçŸ¥æ¨¡æ¿

#### èªç³»æª”çµæ§‹
```json
{
  "common": {
    "save": "å„²å­˜",
    "cancel": "å–æ¶ˆ",
    "delete": "åˆªé™¤",
    "edit": "ç·¨è¼¯"
  },
  "auth": {
    "login": "ç™»å…¥",
    "logout": "ç™»å‡º",
    "register": "è¨»å†Š"
  },
  "dashboard": {
    "title": "å„€è¡¨æ¿",
    "welcome": "æ­¡è¿å›ä¾†"
  },
  "subscription": {
    "trial": "è©¦ç”¨ä¸­",
    "tutor": "Tutor æ–¹æ¡ˆ",
    "school": "School æ–¹æ¡ˆ"
  }
}
```

#### Fallback æ©Ÿåˆ¶
- **é †åº**: ä½¿ç”¨è€…åå¥½èªè¨€ â†’ ç€è¦½å™¨èªè¨€ â†’ é è¨­ä¸­æ–‡
- **ç¼ºå¤±ç¿»è­¯**: é¡¯ç¤º key å€¼ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰æˆ–é è¨­ä¸­æ–‡ï¼ˆç”Ÿç”¢æ¨¡å¼ï¼‰
- **å‹•æ…‹è¼‰å…¥**: èªç³»æª”æŒ‰éœ€è¼‰å…¥ï¼Œæ¸›å°‘åˆå§‹è¼‰å…¥æ™‚é–“

#### æŠ€è¡“å¯¦ä½œ
- **èªè¨€æª¢æ¸¬**:
  ```typescript
  const detectLanguage = (): Language => {
    const stored = localStorage.getItem('language');
    if (stored) return stored as Language;

    const browser = navigator.language;
    return browser.startsWith('zh') ? 'zh' : 'en';
  };
  ```
- **Context Provider**:
  ```typescript
  <I18nextProvider i18n={i18n}>
    <App />
  </I18nextProvider>
  ```
- **ä½¿ç”¨ç¯„ä¾‹**:
  ```typescript
  const { t } = useTranslation();
  return <h1>{t('dashboard.welcome')}</h1>;
  ```

#### é©—æ”¶æ¨™æº–
- [ ] èªç³»åˆ‡æ›åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [ ] åˆ‡æ›èªç³»å¾Œé é¢å³æ™‚æ›´æ–°
- [ ] æ‰€æœ‰å‰å°é é¢æ–‡æ¡ˆå·²ç¿»è­¯
- [ ] æ‰€æœ‰å¾Œå°é é¢æ–‡æ¡ˆå·²ç¿»è­¯
- [ ] Email é€šçŸ¥æ”¯æ´å¤šèªè¨€
- [ ] API éŒ¯èª¤è¨Šæ¯æ”¯æ´å¤šèªè¨€
- [ ] èªç³»åå¥½æ­£ç¢ºå„²å­˜
- [ ] é‡æ–°æ•´ç†é é¢èªç³»ä¸è®Š
- [ ] ç„¡ç¿»è­¯ç¼ºå¤±ï¼ˆ100% è¦†è“‹ç‡ï¼‰
- [ ] RTL èªè¨€æ”¯æ´ï¼ˆé ç•™ï¼Œæš«ä¸å¯¦ä½œï¼‰

---

## ä¸‰ã€è³‡æ–™æ¨¡å‹è®Šæ›´

### 3.1 Teacher æ¨¡å‹æ“´å……
```python
class Teacher(Base):
    # åŸæœ‰æ¬„ä½...

    # æ–°å¢æ¬„ä½
    subscription_tier: str  # 'trial' | 'tutor' | 'school'
    trial_credits_remaining: int = 1000
    subscription_credits_remaining: int = 0
    subscription_credits_total: int = 0
    credits_reset_at: DateTime
    preferred_language: str = 'zh'  # 'zh' | 'en'
```

### 3.2 æ–°å¢ Refund æ¨¡å‹
```python
class Refund(Base):
    __tablename__ = "refunds"

    id: int (Primary Key)
    transaction_id: str (Foreign Key -> Transaction.id)
    amount: Decimal
    reason: str
    status: RefundStatus  # 'pending' | 'processing' | 'success' | 'failed'
    error_message: str (Nullable)
    processed_by: int (Foreign Key -> User.id)
    processed_at: DateTime (Nullable)
    created_at: DateTime
    updated_at: DateTime
```

### 3.3 Transaction æ¨¡å‹æ“´å……
```python
class Transaction(Base):
    # åŸæœ‰æ¬„ä½...

    # æ–°å¢æ¬„ä½
    is_refunded: bool = False
    refunded_at: DateTime (Nullable)
    refund_amount: Decimal (Nullable)
```

---

## å››ã€API è¦æ ¼

### 4.1 è§’è‰²ç®¡ç† API

#### å–å¾—ç•¶å‰ç”¨æˆ¶è§’è‰²
```
GET /api/teachers/me/role
Response: {
  "subscription_tier": "tutor",
  "trial_credits_remaining": 500,
  "subscription_credits_remaining": 8500,
  "subscription_credits_total": 10000
}
```

### 4.2 é€€æ¬¾ç®¡ç† API

#### ç”³è«‹é€€æ¬¾
```
POST /api/admin/refunds
Request: {
  "transaction_id": "txn_123456",
  "amount": 330,
  "reason": "ç”¨æˆ¶è¦æ±‚é€€æ¬¾"
}
Response: {
  "refund_id": "ref_789",
  "status": "processing"
}
```

#### æŸ¥è©¢é€€æ¬¾ç‹€æ…‹
```
GET /api/admin/refunds/{refund_id}
Response: {
  "id": "ref_789",
  "status": "success",
  "processed_at": "2025-11-15T10:30:00Z"
}
```

### 4.3 å¸³æ¬¾åŒ¯å‡º API

#### åŒ¯å‡ºäº¤æ˜“æ˜ç´°
```
GET /api/admin/transactions/export?start_date=2025-11-01&end_date=2025-11-30&format=xlsx
Response: File Download (transactions_20251130_143000.xlsx)
```

### 4.4 èªç³»ç®¡ç† API

#### æ›´æ–°èªç³»åå¥½
```
PUT /api/teachers/me/language
Request: {
  "language": "en"
}
Response: {
  "language": "en",
  "updated_at": "2025-11-17T09:00:00Z"
}
```

---

## äº”ã€æ¸¬è©¦è¨ˆç•«

### 5.1 å–®å…ƒæ¸¬è©¦
- [ ] è§’è‰²æ¬Šé™é©—è­‰æ¸¬è©¦
- [ ] é»æ•¸è¨ˆç®—é‚è¼¯æ¸¬è©¦
- [ ] é€€æ¬¾æµç¨‹æ¸¬è©¦
- [ ] èªç³»åˆ‡æ›æ¸¬è©¦
- [ ] å¸³æ¬¾åŒ¯å‡ºæ¸¬è©¦

### 5.2 æ•´åˆæ¸¬è©¦
- [ ] TapPay é€€æ¬¾ API æ•´åˆæ¸¬è©¦
- [ ] é»æ•¸æ‰£é™¤èˆ‡é‡ç½®æ¸¬è©¦
- [ ] å¤šèªè¨€ Email ç™¼é€æ¸¬è©¦
- [ ] CSV/XLSX åŒ¯å‡ºæ­£ç¢ºæ€§æ¸¬è©¦

### 5.3 E2E æ¸¬è©¦
- [ ] ç”¨æˆ¶å‡ç´šè¨‚é–±æµç¨‹
- [ ] ç®¡ç†è€…åŸ·è¡Œé€€æ¬¾æµç¨‹
- [ ] èªç³»åˆ‡æ›å®Œæ•´æµç¨‹
- [ ] å¸³æ¬¾æ˜ç´°åŒ¯å‡ºæµç¨‹

### 5.4 æ•ˆèƒ½æ¸¬è©¦
- [ ] å¤§é‡äº¤æ˜“è³‡æ–™åŒ¯å‡ºï¼ˆ10,000 ç­†ä»¥ä¸Šï¼‰
- [ ] èªç³»æª”è¼‰å…¥æ•ˆèƒ½
- [ ] é»æ•¸è¨ˆç®—æŸ¥è©¢æ•ˆèƒ½

---

## å…­ã€éƒ¨ç½²è¨ˆç•«

### 6.1 éƒ¨ç½²æ­¥é©Ÿ
1. **è³‡æ–™åº«é·ç§»**
   ```bash
   alembic revision --autogenerate -m "November 2025 features"
   alembic upgrade head
   ```

2. **ç’°å¢ƒè®Šæ•¸æ›´æ–°**
   ```bash
   # æ–°å¢é€€æ¬¾ç›¸é—œè¨­å®š
   TAPPAY_REFUND_API_URL=https://sandbox.tappaysdk.com/tpc/refund/refund

   # æ–°å¢èªç³»è¨­å®š
   DEFAULT_LANGUAGE=zh
   SUPPORTED_LANGUAGES=zh,en
   ```

3. **éœæ…‹è³‡æºæ›´æ–°**
   - èªç³»æª”éƒ¨ç½²åˆ° CDN
   - å‰ç«¯ build ä¸¦éƒ¨ç½²

4. **Cron Job è¨­å®š**
   ```bash
   # æ¯æœˆ1æ—¥ 00:00 é‡ç½®è¨‚é–±é»æ•¸
   0 0 1 * * python backend/scripts/reset_subscription_credits.py
   ```

### 6.2 éƒ¨ç½²æª¢æŸ¥æ¸…å–®
- [ ] è³‡æ–™åº«å‚™ä»½å®Œæˆ
- [ ] Staging ç’°å¢ƒæ¸¬è©¦é€šé
- [ ] ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š
- [ ] Cron Job æ­£ç¢ºè¨­å®š
- [ ] èªç³»æª”æ­£ç¢ºéƒ¨ç½²
- [ ] Email æ¨¡æ¿æ­£ç¢ºæ›´æ–°
- [ ] ç›£æ§å‘Šè­¦è¨­å®šå®Œæˆ

---

## ä¸ƒã€æ–‡ä»¶æ›´æ–°

### 7.1 éœ€è¦æ›´æ–°çš„æ–‡ä»¶
- [ ] `PRD.md` - æ›´æ–° Phase 1.5 å…§å®¹
- [ ] `CLAUDE.md` - æ–°å¢ i18n é–‹ç™¼è¦ç¯„
- [ ] `README.md` - æ›´æ–°åŠŸèƒ½æ¸…å–®
- [ ] `API_DOCS.md` - æ–°å¢ API æ–‡ä»¶
- [ ] `DEPLOYMENT.md` - æ›´æ–°éƒ¨ç½²æµç¨‹

### 7.2 æ–°å¢æ–‡ä»¶
- [ ] `i18n_GUIDE.md` - å¤šèªè¨€é–‹ç™¼æŒ‡å—
- [ ] `ADMIN_MANUAL.md` - ç®¡ç†è€…æ“ä½œæ‰‹å†Š
- [ ] `REFUND_POLICY.md` - é€€æ¬¾æ”¿ç­–èªªæ˜

---

## å…«ã€é¢¨éšªè©•ä¼°

### 8.1 æŠ€è¡“é¢¨éšª
| é¢¨éšªé …ç›® | å½±éŸ¿ç¨‹åº¦ | ç·©è§£æªæ–½ |
|---------|---------|---------|
| TapPay é€€æ¬¾ API æ•´åˆå¤±æ•— | é«˜ | å®Œæ•´çš„éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶ |
| å¤§é‡è³‡æ–™åŒ¯å‡ºè¶…æ™‚ | ä¸­ | éåŒæ­¥è™•ç† + é€²åº¦é€šçŸ¥ |
| èªç³»æª”ç¼ºå¤±ç¿»è­¯ | ä½ | Fallback æ©Ÿåˆ¶ + ç¿»è­¯å®Œæ•´æ€§æª¢æŸ¥ |
| é»æ•¸è¨ˆç®—é‚è¼¯éŒ¯èª¤ | é«˜ | å®Œæ•´å–®å…ƒæ¸¬è©¦ + äººå·¥é©—è­‰ |

### 8.2 æ¥­å‹™é¢¨éšª
| é¢¨éšªé …ç›® | å½±éŸ¿ç¨‹åº¦ | ç·©è§£æªæ–½ |
|---------|---------|---------|
| é€€æ¬¾æµç¨‹æ¿«ç”¨ | ä¸­ | é€€æ¬¾åŸå› è¨˜éŒ„ + ç•°å¸¸åµæ¸¬ |
| é»æ•¸ç´¯è¨ˆè¦å‰‡èª¤è§£ | ä¸­ | æ¸…æ¥šçš„ UI èªªæ˜ + FAQ |
| å¤šèªè¨€ç¿»è­¯å“è³ª | ä½ | å°ˆæ¥­ç¿»è­¯å¯©æ ¸ |

---

## ä¹ã€é©—æ”¶æ¨™æº–

### 9.1 åŠŸèƒ½é©—æ”¶
- [ ] æ‰€æœ‰åŠŸèƒ½ä¾ç…§è¦æ ¼å®Œæˆ
- [ ] æ‰€æœ‰ API æ­£å¸¸é‹ä½œ
- [ ] æ‰€æœ‰å–®å…ƒæ¸¬è©¦é€šé
- [ ] æ‰€æœ‰æ•´åˆæ¸¬è©¦é€šé
- [ ] E2E æ¸¬è©¦é€šé

### 9.2 å“è³ªé©—æ”¶
- [ ] ç¨‹å¼ç¢¼é€šé ESLint æª¢æŸ¥
- [ ] ç¨‹å¼ç¢¼é€šé flake8 æª¢æŸ¥
- [ ] æ¸¬è©¦è¦†è“‹ç‡ > 80%
- [ ] ç„¡é‡å¤§ bug
- [ ] æ•ˆèƒ½ç¬¦åˆæ¨™æº–

### 9.3 æ–‡ä»¶é©—æ”¶
- [ ] API æ–‡ä»¶å®Œæ•´
- [ ] ä½¿ç”¨è€…æ‰‹å†Šå®Œæ•´
- [ ] ç®¡ç†è€…æ‰‹å†Šå®Œæ•´
- [ ] éƒ¨ç½²æ–‡ä»¶æ›´æ–°

---

## åã€æ¯æœˆè‡ªå‹•çºŒè¨‚ Cron Job (2025-11-17 é–‹ç™¼ä¸­)

### 10.1 åŠŸèƒ½æè¿°
å¯¦ä½œè¨‚é–±è‡ªå‹•çºŒè¨‚çš„ Cron Jobï¼Œæ¯æœˆ 1 æ—¥å‡Œæ™¨ 2:00 è‡ªå‹•è™•ç†è¨‚é–±åˆ°æœŸèˆ‡çºŒè¨‚é‚è¼¯ã€‚

### 10.2 åŸ·è¡Œæ™‚é–“
- **è§¸ç™¼æ™‚é–“**: æ¯æœˆ 1 æ—¥ 02:00 (å°åŒ—æ™‚é–“)
- **Cron è¡¨é”å¼**: `0 2 1 * *`

### 10.3 Cron Job é‚è¼¯

#### Phase 1: æ¨™è¨˜éæœŸè¨‚é–±
```
ç›®æ¨™: å°‡æ‰€æœ‰åˆ°æœŸçš„ active è¨‚é–±æ¨™è¨˜ç‚º expired
æŸ¥è©¢æ¢ä»¶:
  - status = 'active'
  - end_date < ç•¶æœˆ 1 æ—¥
å‹•ä½œ:
  - æ›´æ–° status = 'expired'
  - è¨˜éŒ„æ•¸é‡: marked_expired
```

#### Phase 2: è‡ªå‹•çºŒè¨‚è™•ç†
```
ç›®æ¨™: è™•ç†æ‰€æœ‰ç¬¦åˆçºŒè¨‚æ¢ä»¶çš„æ•™å¸«
æŸ¥è©¢æ¢ä»¶:
  - subscription_auto_renew = True
  - is_active = True
  - æœ‰ç¶å®šä¿¡ç”¨å¡ (card_key + card_token)

è™•ç†æµç¨‹:
  1. æª¢æŸ¥ 1: é˜²é‡è¤‡æ‰£æ¬¾
     - æŸ¥è©¢æ˜¯å¦å·²æœ‰æœ¬æœˆè¨‚é–± (start_date >= ç•¶æœˆ 1 æ—¥)
     - å¦‚æœ‰ â†’ è·³é (skip_count++)

  2. æª¢æŸ¥ 2: é˜²éŒ¯èª¤æ‰£æ¬¾ + è‡ªå‹•é—œé–‰ auto_renew
     - æŸ¥è©¢æ˜¯å¦æœ‰ä¸Šå€‹æœˆè¨‚é–± (start_date = ä¸Šæœˆ 1 æ—¥, end_date = ä¸Šæœˆæœ€å¾Œä¸€å¤©)
     - å¦‚ç„¡ â†’ é—œé–‰ auto_renew + ç™¼é€šçŸ¥ (auto_renew_disabled++)

  3. åŸ·è¡ŒçºŒè¨‚
     - å‘¼å« TapPay API æ‰£æ¬¾
     - æˆåŠŸ â†’ å»ºç«‹æ–°è¨‚é–±æœŸ (auto_renewed++)
     - å¤±æ•— â†’ è¨˜éŒ„éŒ¯èª¤ (renewal_failed++)
```

### 10.4 è³‡æ–™æ¨¡å‹

#### SubscriptionPeriod æ¬„ä½
```python
class SubscriptionPeriod(Base):
    id: int
    teacher_id: int
    plan_name: str  # 'Tutor Teachers' | 'School Teachers'
    amount_paid: int  # 231 (Tutor) | 660 (School)
    quota_total: int  # 10000 (Tutor) | 25000 (School)
    start_date: date  # ç•¶æœˆ 1 æ—¥
    end_date: date  # ç•¶æœˆæœ€å¾Œä¸€å¤©
    payment_method: str  # 'auto_renew'
    status: str  # 'active' | 'expired' | 'cancelled'
    created_at: datetime
```

#### Teacher ç›¸é—œæ¬„ä½
```python
class Teacher(Base):
    subscription_auto_renew: bool  # æ˜¯å¦è‡ªå‹•çºŒè¨‚
    card_key: str  # TapPay card_key
    card_token: str  # TapPay card_token
    is_active: bool  # å¸³è™Ÿæ˜¯å¦å•Ÿç”¨
```

### 10.5 å›æ‡‰æ ¼å¼
```json
{
  "status": "completed",
  "date": "2025-12-01",
  "marked_expired": 15,
  "auto_renewed": 8,
  "renewal_failed": 2,
  "auto_renew_disabled": 1,
  "skipped": 3,
  "errors": [
    {
      "teacher_id": 123,
      "error": "TapPay API error: insufficient funds"
    }
  ]
}
```

### 10.6 æ¸¬è©¦ç­–ç•¥ (TDD)

#### æ¸¬è©¦æª”æ¡ˆ
`backend/tests/integration/api/test_monthly_renewal_cron.py`

#### æ¸¬è©¦å ´æ™¯ (16 å€‹)

**Phase 1: æ¨™è¨˜éæœŸè¨‚é–± (3 tests)**
1. âœ… æ¨™è¨˜ä¸Šæœˆåˆ°æœŸçš„ active è¨‚é–±
2. âœ… æ¨™è¨˜å¤šå€‹æœˆå‰åˆ°æœŸçš„ active è¨‚é–±
3. âœ… ä¸æ¨™è¨˜ç•¶æœˆçš„ active è¨‚é–±

**Phase 2: è‡ªå‹•çºŒè¨‚ (3 tests)**
4. âœ… æˆåŠŸçºŒè¨‚ï¼ˆæœ‰ä¸Šæœˆè¨‚é–± + auto_renew + ç¶å¡ï¼‰
5. âœ… çºŒè¨‚å¤±æ•—ï¼ˆTapPay API éŒ¯èª¤ï¼‰
6. âœ… çºŒè¨‚å¾Œæ­£ç¢ºæ›´æ–° quota

**æª¢æŸ¥ 1: é˜²é‡è¤‡æ‰£æ¬¾ (2 tests)**
7. âœ… è·³éå·²æœ‰æœ¬æœˆè¨‚é–±çš„æ•™å¸«
8. âœ… ä¸è·³éæ²’æœ‰æœ¬æœˆè¨‚é–±çš„æ•™å¸«

**æª¢æŸ¥ 2: é—œé–‰ auto_renew (2 tests)**
9. âœ… é—œé–‰ç„¡ä¸Šæœˆè¨‚é–±çš„ auto_renew
10. âœ… ä¸é—œé–‰æœ‰ä¸Šæœˆè¨‚é–±çš„ auto_renew

**è·³éå ´æ™¯ (3 tests)**
11. âœ… è·³é auto_renew = False çš„æ•™å¸«
12. âœ… è·³éæ²’ç¶å¡çš„æ•™å¸«
13. âœ… è·³é is_active = False çš„æ•™å¸«

**é‚Šç•Œæ¡ˆä¾‹ (3 tests)**
14. âœ… è™•ç†æ²’æœ‰ä»»ä½•è¨‚é–±çš„æ•™å¸«
15. âœ… è™•ç† trial è¨‚é–±ç”¨æˆ¶
16. âœ… è™•ç†å¤šå€‹æ•™å¸«åŒæ™‚çºŒè¨‚

### 10.7 é–‹ç™¼é€²åº¦

#### âœ… å·²å®Œæˆ
- [x] TDD æ¸¬è©¦å¥—ä»¶æ’°å¯« (16 tests)
- [x] æ¸¬è©¦è³‡æ–™ fixtures è¨­å®š
- [x] æ™‚é–“ mocking (freezegun)
- [x] TapPay service mocking
- [x] Git branch: `prd_nov` å»ºç«‹
- [x] åˆå§‹ commit å®Œæˆ

#### ğŸ”„ é€²è¡Œä¸­
- [ ] Phase 1: æ¨™è¨˜éæœŸè¨‚é–±é‚è¼¯å¯¦ä½œ
- [ ] Phase 2: è‡ªå‹•çºŒè¨‚æ ¸å¿ƒé‚è¼¯å¯¦ä½œ
- [ ] æª¢æŸ¥ 1: é˜²é‡è¤‡æ‰£æ¬¾é‚è¼¯å¯¦ä½œ
- [ ] æª¢æŸ¥ 2: é—œé–‰ auto_renew é‚è¼¯å¯¦ä½œ
- [ ] æ¸¬è©¦é©—è­‰ (TDD GREEN éšæ®µ)

#### â³ å¾…è™•ç†
- [ ] Email é€šçŸ¥ï¼ˆauto_renew é—œé–‰é€šçŸ¥ï¼‰
- [ ] éŒ¯èª¤ç›£æ§èˆ‡å‘Šè­¦
- [ ] Staging ç’°å¢ƒæ¸¬è©¦
- [ ] Production éƒ¨ç½²

### 10.8 é©—æ”¶æ¨™æº–
- [ ] æ‰€æœ‰ 16 å€‹æ¸¬è©¦é€šé
- [ ] Phase 1 æ­£ç¢ºæ¨™è¨˜æ‰€æœ‰éæœŸè¨‚é–±
- [ ] Phase 2 æ­£ç¢ºè™•ç†çºŒè¨‚é‚è¼¯
- [ ] é˜²é‡è¤‡æ‰£æ¬¾æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- [ ] è‡ªå‹•é—œé–‰ auto_renew æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- [ ] å›æ‡‰æ ¼å¼ç¬¦åˆè¦æ ¼
- [ ] éŒ¯èª¤è™•ç†å®Œå–„
- [ ] Email é€šçŸ¥æ­£å¸¸ç™¼é€

---

## åä¸€ã€å¾ŒçºŒå·¥ä½œ

### 11.1 12æœˆè¦åŠƒ
- çµ±è¨ˆåœ–è¡¨åŠŸèƒ½å¢å¼·
- æ‰¹é‡æ“ä½œå„ªåŒ–
- æ•ˆèƒ½ç›£æ§æ”¹å–„
- ä½¿ç”¨è€…å›é¥‹æ”¶é›†

### 11.2 Phase 2 æº–å‚™
- å­¸æ ¡ç®¡ç†åŠŸèƒ½è¨­è¨ˆ
- å¤šæ•™å¸«å”ä½œæ©Ÿåˆ¶
- é€²éšå ±è¡¨ç³»çµ±
- å®¶é•·åŠŸèƒ½è¦åŠƒ

---

## é™„éŒ„

### A. ç¿»è­¯å°ç…§è¡¨ï¼ˆå¸¸ç”¨è©å½™ï¼‰
| ä¸­æ–‡ | è‹±æ–‡ |
|-----|------|
| å„€è¡¨æ¿ | Dashboard |
| ç­ç´š | Classroom |
| å­¸ç”Ÿ | Student |
| èª²ç¨‹ | Program/Course |
| ä½œæ¥­ | Assignment |
| è¨‚é–± | Subscription |
| è©¦ç”¨ | Trial |
| é»æ•¸ | Credits |
| é€€æ¬¾ | Refund |
| å¸³æ¬¾ | Transaction |

### B. ç›¸é—œé€£çµ
- [TapPay Refund API æ–‡ä»¶](https://docs.tappaysdk.com/refund/zh/front.html)
- [react-i18next å®˜æ–¹æ–‡ä»¶](https://react.i18next.com/)
- [OpenPyXL æ–‡ä»¶](https://openpyxl.readthedocs.io/)

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0
**å»ºç«‹æ—¥æœŸ**: 2025-11-17
**æœ€å¾Œæ›´æ–°**: 2025-11-17
**è² è²¬äºº**: ç”¢å“åœ˜éšŠ
**ç‹€æ…‹**: âœ… Final ç‰ˆæœ¬
