# æ•™ææ¨¡çµ„åŒ–èˆ‡æ¬Šé™æ¶æ§‹æ–‡ä»¶

**ç‰ˆæœ¬**: 1.0
**æ›´æ–°æ—¥æœŸ**: 2026-01-15
**ç‹€æ…‹**: âœ… Production Ready

---

## ğŸ“š ç›®éŒ„

1. [ç³»çµ±æ•´é«”æ¶æ§‹](#ç³»çµ±æ•´é«”æ¶æ§‹)
2. [æ¨¡çµ„åŒ–è¨­è¨ˆ](#æ¨¡çµ„åŒ–è¨­è¨ˆ)
3. [Frontend æ¶æ§‹](#frontend-æ¶æ§‹)
4. [Backend æ¶æ§‹](#backend-æ¶æ§‹)
5. [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
6. [æ¬Šé™ç³»çµ±](#æ¬Šé™ç³»çµ±)
7. [ä½¿ç”¨ç¯„ä¾‹](#ä½¿ç”¨ç¯„ä¾‹)
8. [ä¿®å¾©è¨˜éŒ„](#ä¿®å¾©è¨˜éŒ„)

---

## ğŸ—ï¸ ç³»çµ±æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Teacher Pages     â”‚    â”‚ Organization Pages â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ â€¢ Programs        â”‚    â”‚ â€¢ Materials âœ¨NEW  â”‚                â”‚
â”‚  â”‚ â€¢ Classrooms      â”‚    â”‚ â€¢ Schools          â”‚                â”‚
â”‚  â”‚ â€¢ Assignments     â”‚    â”‚ â€¢ Teachers         â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â€¢ Settings         â”‚                â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Shared Hooks & Components (æ¨¡çµ„åŒ–æ ¸å¿ƒ)          â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ useProgramAPI âœ¨NEW - çµ±ä¸€çš„ CRUD API                   â”‚   â”‚
â”‚  â”‚ â€¢ useProgramTree âœ¨NEW - æ¨¹ç‹€è³‡æ–™ç®¡ç†                     â”‚   â”‚
â”‚  â”‚ â€¢ useContentEditor âœ¨NEW - å…§å®¹ç·¨è¼¯å™¨                     â”‚   â”‚
â”‚  â”‚ â€¢ ProgramTreeView âœ¨NEW - å¯é‡ç”¨çš„æ¨¹ç‹€çµ„ä»¶                â”‚   â”‚
â”‚  â”‚ â€¢ ContentTypeDialog - å…§å®¹é¡å‹é¸æ“‡                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Backend (FastAPI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Unified API Routers (çµ±ä¸€ API)               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ /api/programs          (GET, POST, PUT, DELETE)          â”‚   â”‚
â”‚  â”‚ /api/programs/{id}/lessons      (GET, POST, PUT, DELETE) â”‚   â”‚
â”‚  â”‚ /api/programs/lessons/{id}/contents  (GET, POST, ...)    â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ ğŸ”‘ Query Params:                                          â”‚   â”‚
â”‚  â”‚    ?scope=teacher (default) - è€å¸«å€‹äººæ•™æ                â”‚   â”‚
â”‚  â”‚    ?scope=organization&organization_id=XXX - çµ„ç¹”æ•™æ     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          Service Layer (æ¥­å‹™é‚è¼¯å±¤) âœ¨NEW                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ program_service.py                                        â”‚   â”‚
â”‚  â”‚ â”œâ”€ create_program()                                       â”‚   â”‚
â”‚  â”‚ â”œâ”€ create_lesson()                                        â”‚   â”‚
â”‚  â”‚ â”œâ”€ create_content() âœ… å‰›ä¿®å¾©                             â”‚   â”‚
â”‚  â”‚ â”œâ”€ check_program_permission() âœ¨NEW                       â”‚   â”‚
â”‚  â”‚ â”œâ”€ check_lesson_permission() âœ¨NEW                        â”‚   â”‚
â”‚  â”‚ â””â”€ check_manage_materials_permission() âœ¨NEW              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Permission System (æ¬Šé™ç³»çµ±) âœ¨NEW                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Casbin Integration                                        â”‚   â”‚
â”‚  â”‚ â”œâ”€ Domain-based: org-{org_id}                            â”‚   â”‚
â”‚  â”‚ â”œâ”€ Resources: manage_materials, manage_schools, ...      â”‚   â”‚
â”‚  â”‚ â””â”€ Actions: read, write                                  â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚ Hierarchy:                                                â”‚   â”‚
â”‚  â”‚   org_owner â†’ Full permissions (auto)                    â”‚   â”‚
â”‚  â”‚   org_admin â†’ Needs explicit Casbin rules                â”‚   â”‚
â”‚  â”‚   teacher   â†’ No permissions                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Database Models (è³‡æ–™æ¨¡å‹) âœ… ä¿®å¾©               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ContentType Enum: âœ… å·²æ›´æ–°                               â”‚   â”‚
â”‚  â”‚   â€¢ reading_assessment (legacy)                          â”‚   â”‚
â”‚  â”‚   â€¢ example_sentences âœ… æ–°å¢                             â”‚   â”‚
â”‚  â”‚   â€¢ vocabulary_set âœ… æ–°å¢                                â”‚   â”‚
â”‚  â”‚   â€¢ single_choice_quiz âœ… æ–°å¢                            â”‚   â”‚
â”‚  â”‚   â€¢ scenario_dialogue âœ… æ–°å¢                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Database (PostgreSQL + Supabase)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ä¸‰å±¤æ¶æ§‹ï¼šProgram â†’ Lesson â†’ Content                             â”‚
â”‚                                                                   â”‚
â”‚  programs (æ•™æ)                                                  â”‚
â”‚    â”œâ”€ teacher_id (nullable) - è€å¸«å€‹äººæ•™æ                        â”‚
â”‚    â””â”€ organization_id (nullable) - çµ„ç¹”å…¬ç‰ˆæ•™æ                   â”‚
â”‚                                                                   â”‚
â”‚  lessons (å–®å…ƒ)                                                   â”‚
â”‚    â””â”€ program_id (FK)                                            â”‚
â”‚                                                                   â”‚
â”‚  contents (å…§å®¹) âœ… ä¿®å¾©                                          â”‚
â”‚    â”œâ”€ lesson_id (FK)                                             â”‚
â”‚    â””â”€ type (enum) âœ… å·²æ›´æ–° 4 å€‹æ–°é¡å‹                            â”‚
â”‚                                                                   â”‚
â”‚  teacher_organizations (çµ„ç¹”æˆå“¡)                                 â”‚
â”‚    â”œâ”€ teacher_id                                                 â”‚
â”‚    â”œâ”€ organization_id                                            â”‚
â”‚    â””â”€ role (org_owner, org_admin, teacher)                      â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ¨¡çµ„åŒ–è¨­è¨ˆ

### è¨­è¨ˆç†å¿µ

**æ ¸å¿ƒåŸå‰‡**: ç¨‹å¼ç¢¼é‡ç”¨ (Code Reuse) + å–®ä¸€çœŸç›¸ä¾†æº (Single Source of Truth)

**ç›®æ¨™**:
- âœ… Teacher å’Œ Organization é é¢å…±ç”¨ 80% ç¨‹å¼ç¢¼
- âœ… ä¿®æ”¹ä¸€è™•ï¼Œå…©é‚ŠåŒæ­¥ç”Ÿæ•ˆ
- âœ… UI/UX è¡Œç‚ºå®Œå…¨ä¸€è‡´
- âœ… é™ä½ç¶­è­·æˆæœ¬

### æ¨¡çµ„åŒ–æˆæœçµ±è¨ˆ

| é …ç›® | Before | After | æ”¹å–„ |
|------|--------|-------|------|
| é‡è¤‡ä»£ç¢¼è¡Œæ•¸ | ~600 è¡Œ | ~50 è¡Œ | -90% |
| æª”æ¡ˆæ•¸é‡ | 2 å€‹ç¨ç«‹é é¢ | 1 çµ„å…±ç”¨æ¨¡çµ„ | 50% |
| CRUD API å‘¼å« | é‡è¤‡å¯¦ä½œ 2 æ¬¡ | çµ±ä¸€ Hook | 100% é‡ç”¨ |
| ç¶­è­·é» | 2 è™• | 1 è™• | -50% |

### æ•™æ Tree / Copy è¦†è“‹çŸ©é™£ï¼ˆå››å±¤ï¼‰

| å±¤ç´š | Tree View (ProgramTreeView) | Copy åŠŸèƒ½ | ç¾æ³ |
|------|-----------------------------|-----------|------|
| è€å¸«å…¬ç”¨èª²ç¨‹ | âœ… Teacher Programs ä½¿ç”¨ | âœ… `POST /api/programs/copy-from-template` â†’ ç­ç´š | Tree å·²å®Œæˆï¼ŒCopy å·²å®Œæˆ |
| ç­ç´šèª²ç¨‹ | âŒ æœªç´å…¥ ProgramTreeView | âœ… `POST /api/programs/copy-from-classroom` / `POST /api/teachers/classrooms/{id}/programs/copy` | Tree ç¼ºå£ï¼ŒCopy å·²å®Œæˆ |
| å­¸æ ¡ç®¡ç† | âŒ ç„¡æ•™æ Tree | âŒ ç„¡æ•™æ Copy | æœªè¦†è“‹ |
| æ©Ÿæ§‹ç®¡ç† | âœ… Organization Materials ä½¿ç”¨ | âœ… `POST /api/organizations/{org_id}/programs/{program_id}/copy-to-classroom` | Tree å·²å®Œæˆï¼ŒCopy å·²å®Œæˆ |

**è£œå¼·æ–¹å‘**:
- çµ±ä¸€ copy å…¥å£ï¼š`POST /api/programs/{program_id}/copy`ï¼ˆsource/target scope åƒæ•¸åŒ–ï¼‰
- æŠ½å‡º `copy_program_tree()` serviceï¼ˆProgramâ†’Lessonâ†’Contentâ†’Item æ·±åº¦è¤‡è£½ï¼‰
- è®“ç­ç´šã€å­¸æ ¡å±¤å…±ç”¨ ProgramTreeViewï¼ˆæŒ‰æ¬Šé™æ±ºå®š readOnly/å¯ç·¨è¼¯ï¼‰

---

## ğŸ¨ Frontend æ¶æ§‹

### 1. Shared Hooks (å…±ç”¨ Hooks)

#### ğŸ“¦ `useProgramAPI` - çµ±ä¸€ API Hook

**ä½ç½®**: `frontend/src/hooks/useProgramAPI.ts`

**åŠŸèƒ½**: æä¾›æ‰€æœ‰ Program CRUD æ“ä½œçš„çµ±ä¸€ä»‹é¢

**API æ–¹æ³•**:
```typescript
interface ProgramAPI {
  // Program CRUD
  getPrograms(options?: { scope, organization_id })
  createProgram(data)
  updateProgram(id, data)
  deleteProgram(id)

  // Lesson CRUD
  createLesson(programId, data)
  updateLesson(id, data)
  deleteLesson(id)

  // Content CRUD
  createContent(lessonId, data)
  updateContent(id, data)
  deleteContent(id)
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
// Teacher é é¢ä½¿ç”¨
const api = useProgramAPI();
const programs = await api.getPrograms();  // scope=teacher (é è¨­)

// Organization é é¢ä½¿ç”¨
const api = useProgramAPI();
const programs = await api.getPrograms({
  scope: 'organization',
  organization_id: 'xxx-xxx-xxx'
});
```

**å„ªé»**:
- âœ… å–®ä¸€çœŸç›¸ä¾†æº - æ‰€æœ‰ API é‚è¼¯é›†ä¸­ç®¡ç†
- âœ… è‡ªå‹•è™•ç† scope åƒæ•¸
- âœ… éŒ¯èª¤è™•ç†çµ±ä¸€
- âœ… TypeScript é¡å‹å®‰å…¨

---

#### ğŸ“¦ `useProgramTree` - æ¨¹ç‹€è³‡æ–™ç®¡ç†

**ä½ç½®**: `frontend/src/hooks/useProgramTree.ts`

**åŠŸèƒ½**: ç®¡ç† Program â†’ Lesson â†’ Content ä¸‰å±¤æ¨¹ç‹€çµæ§‹

**ç‹€æ…‹ç®¡ç†**:
```typescript
interface ProgramTreeState {
  data: Program[]              // æ¨¹ç‹€è³‡æ–™
  expandedIds: Set<string>     // å±•é–‹çš„ç¯€é» ID
  isLoading: boolean           // è¼‰å…¥ç‹€æ…‹
  error: string | null         // éŒ¯èª¤è¨Šæ¯
}
```

**æ“ä½œæ–¹æ³•**:
```typescript
interface ProgramTreeActions {
  toggleExpand(id: string)     // å±•é–‹/æ”¶åˆç¯€é»
  handleCreate(type, parentId, data)  // å»ºç«‹ç¯€é»
  handleUpdate(id, data)       // æ›´æ–°ç¯€é»
  handleDelete(id, type)       // åˆªé™¤ç¯€é»
  refresh()                    // é‡æ–°è¼‰å…¥è³‡æ–™
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
const {
  data,
  expandedIds,
  toggleExpand,
  handleCreate,
  handleUpdate,
  handleDelete
} = useProgramTree({
  scope: 'organization',
  organizationId: orgId
});

// å»ºç«‹æ–° Lesson
await handleCreate('lesson', programId, {
  name: 'Unit 1',
  description: 'åŸºç¤èª²ç¨‹'
});
```

**å„ªé»**:
- âœ… è¤‡é›œçš„æ¨¹ç‹€é‚è¼¯å°è£
- âœ… è‡ªå‹•ç®¡ç†å±•é–‹/æ”¶åˆç‹€æ…‹
- âœ… æ¨‚è§€æ›´æ–° (Optimistic Updates)
- âœ… éŒ¯èª¤å›æ»¾æ©Ÿåˆ¶

---

#### ğŸ“¦ `useContentEditor` - å…§å®¹ç·¨è¼¯å™¨

**ä½ç½®**: `frontend/src/hooks/useContentEditor.ts`

**åŠŸèƒ½**: ç®¡ç† Content ç·¨è¼¯çš„ç‹€æ…‹å’Œé‚è¼¯

**ä½¿ç”¨ç¯„ä¾‹**:
```typescript
const {
  isOpen,
  currentContent,
  openEditor,
  closeEditor,
  saveContent
} = useContentEditor();

// é–‹å•Ÿç·¨è¼¯å™¨
openEditor(content);

// å„²å­˜å…§å®¹
await saveContent(updatedData);
```

---

### 2. Shared Components (å…±ç”¨çµ„ä»¶)

#### ğŸ“¦ `ProgramTreeView` - å¯é‡ç”¨æ¨¹ç‹€çµ„ä»¶

**ä½ç½®**: `frontend/src/components/shared/ProgramTreeView.tsx`

**åŠŸèƒ½**: é¡¯ç¤º Program ä¸‰å±¤æ¨¹ç‹€çµæ§‹çš„é€šç”¨çµ„ä»¶

**Props**:
```typescript
interface ProgramTreeViewProps {
  scope: 'teacher' | 'organization'
  organizationId?: string
  onSelect?: (node) => void
  readOnly?: boolean
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```tsx
// Teacher é é¢
<ProgramTreeView
  scope="teacher"
  onSelect={(node) => console.log(node)}
/>

// Organization é é¢
<ProgramTreeView
  scope="organization"
  organizationId={orgId}
  onSelect={(node) => console.log(node)}
/>
```

**å„ªé»**:
- âœ… UI ä¸€è‡´æ€§ - å…©é‚Šé é¢å®Œå…¨ç›¸åŒçš„å¤–è§€å’Œè¡Œç‚º
- âœ… æ¸›å°‘é‡è¤‡ä»£ç¢¼ - ä¸éœ€è¦åœ¨å…©å€‹é é¢åˆ†åˆ¥å¯¦ä½œ
- âœ… é›†ä¸­ç¶­è­· - ä¿®æ”¹ä¸€è™•ï¼Œå…©é‚ŠåŒæ­¥æ›´æ–°

---

#### ğŸ“¦ `ContentTypeDialog` - å…§å®¹é¡å‹é¸æ“‡

**ä½ç½®**: `frontend/src/components/ContentTypeDialog.tsx`

**åŠŸèƒ½**: é¸æ“‡è¦å»ºç«‹çš„ Content é¡å‹

**Content Types**:
```typescript
const contentTypes = [
  {
    type: 'example_sentences',
    name: 'ä¾‹å¥é›†',
    icon: 'ğŸ“',
    recommended: true
  },
  {
    type: 'vocabulary_set',
    name: 'å–®å­—é›†',
    icon: 'ğŸ“š'
  },
  {
    type: 'single_choice_quiz',
    name: 'å–®é¸é¡Œåº«',
    icon: 'âœ…'
  },
  {
    type: 'scenario_dialogue',
    name: 'æƒ…å¢ƒå°è©±',
    icon: 'ğŸ’¬'
  }
]
```

---

## âš™ï¸ Backend æ¶æ§‹

### 1. Unified API Routers

**ä½ç½®**: `backend/routers/programs.py`

**è¨­è¨ˆç†å¿µ**: å–®ä¸€ API è·¯ç”±ï¼Œé€é `scope` åƒæ•¸å€åˆ†ä½¿ç”¨å ´æ™¯

#### API Endpoints

| Endpoint | Method | Scope | èªªæ˜ |
|----------|--------|-------|------|
| `/api/programs` | GET | `teacher` | å–å¾—è€å¸«å€‹äººæ•™æ |
| `/api/programs` | GET | `organization` | å–å¾—çµ„ç¹”å…¬ç‰ˆæ•™æ |
| `/api/programs` | POST | `teacher` / `organization` | å»ºç«‹æ•™æ |
| `/api/programs/{id}` | PUT | - | æ›´æ–°æ•™æ |
| `/api/programs/{id}` | DELETE | - | åˆªé™¤æ•™æ |
| `/api/programs/{id}/lessons` | GET | - | å–å¾—å–®å…ƒåˆ—è¡¨ |
| `/api/programs/{id}/lessons` | POST | - | å»ºç«‹å–®å…ƒ |
| `/api/programs/lessons/{id}/contents` | POST | - | å»ºç«‹å…§å®¹ âœ… ä¿®å¾© |

#### Query Parameters

```
?scope=teacher               # é è¨­å€¼ï¼Œå–å¾—è€å¸«å€‹äººæ•™æ
?scope=organization&organization_id=XXX  # å–å¾—çµ„ç¹”æ•™æ
```

**ç¯„ä¾‹**:
```bash
# å–å¾—è€å¸«å€‹äººæ•™æ
GET /api/programs?scope=teacher

# å–å¾—çµ„ç¹”æ•™æ
GET /api/programs?scope=organization&organization_id=21a8a0c7-xxx

# å»ºç«‹çµ„ç¹”æ•™æ
POST /api/programs?scope=organization&organization_id=21a8a0c7-xxx
{
  "name": "Business English Level 1",
  "level": "B1"
}
```

---

### 2. Service Layer (æ¥­å‹™é‚è¼¯å±¤)

**ä½ç½®**: `backend/services/program_service.py`

**è¨­è¨ˆç†å¿µ**: å°‡æ¥­å‹™é‚è¼¯å¾ Router æŠ½é›¢ï¼Œçµ±ä¸€æ¬Šé™æª¢æŸ¥

#### Service Methods

```python
# Program CRUD
def create_program(teacher_id, data, db, organization_id=None)
def get_programs(teacher_id, db, scope='teacher', organization_id=None)
def update_program(program_id, teacher_id, data, db)
def delete_program(program_id, teacher_id, db)

# Lesson CRUD
def create_lesson(program_id, teacher_id, data, db)
def update_lesson(lesson_id, teacher_id, data, db)
def delete_lesson(lesson_id, teacher_id, db)

# Content CRUD
def create_content(lesson_id, teacher_id, data, db)  # âœ… ä¿®å¾©
def update_content(content_id, teacher_id, data, db)
def delete_content(content_id, teacher_id, db)

# Permission Checks
def check_program_permission(program_id, user_id, db, action='write')
def check_lesson_permission(lesson_id, user_id, db, action='write')
def check_manage_materials_permission(teacher_id, org_id, db)
```

#### æ¬Šé™æª¢æŸ¥éˆ (Permission Chain)

```python
# Content æ¬Šé™æª¢æŸ¥
def create_content(lesson_id, teacher_id, data, db):
    # 1. æª¢æŸ¥ Lesson æ¬Šé™
    if not check_lesson_permission(lesson_id, teacher_id, db, "write"):
        raise PermissionError("No permission")

    # 2. å»ºç«‹ Content
    content = Content(...)
    db.add(content)
    db.commit()
    return content

# Lesson æ¬Šé™æª¢æŸ¥
def check_lesson_permission(lesson_id, user_id, db, action):
    lesson = db.query(Lesson).filter(Lesson.id == lesson_id).first()
    # å‘ä¸Šæª¢æŸ¥ Program æ¬Šé™
    return check_program_permission(lesson.program_id, user_id, db, action)

# Program æ¬Šé™æª¢æŸ¥
def check_program_permission(program_id, user_id, db, action):
    program = db.query(Program).filter(Program.id == program_id).first()

    # Teacher å€‹äººæ•™æ
    if program.teacher_id:
        return program.teacher_id == user_id

    # çµ„ç¹”æ•™æ
    if program.organization_id:
        return check_manage_materials_permission(
            user_id,
            program.organization_id,
            db
        )
```

**å„ªé»**:
- âœ… è‡ªå‹•åŒ–æ¬Šé™ç¹¼æ‰¿ - Content è‡ªå‹•ç¹¼æ‰¿ Lesson â†’ Program â†’ Organization æ¬Šé™
- âœ… é›†ä¸­åŒ–é‚è¼¯ - æ‰€æœ‰æ¥­å‹™é‚è¼¯åœ¨ Service Layer
- âœ… å¯æ¸¬è©¦æ€§ - Service æ–¹æ³•å¯ç¨ç«‹å–®å…ƒæ¸¬è©¦
- âœ… Router ä¿æŒç°¡æ½” - åªè² è²¬ HTTP å±¤é¢

---

### 3. Permission System (æ¬Šé™ç³»çµ±)

#### Casbin æ•´åˆ

**é…ç½®æª”**: `backend/casbin/model.conf`

```ini
[request_definition]
r = sub, dom, obj, act

[policy_definition]
p = sub, dom, obj, act

[role_definition]
g = _, _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub, r.dom) && r.dom == p.dom && r.obj == p.obj && r.act == p.act
```

#### æ¬Šé™å±¤ç´š

```python
# org_owner - è‡ªå‹•æ“æœ‰æ‰€æœ‰æ¬Šé™
if membership.role == "org_owner":
    return True

# org_admin - éœ€è¦æ˜ç¢º Casbin è¦å‰‡
casbin.check_permission(
    teacher_id=teacher_id,
    domain=f"org-{org_id}",
    resource="manage_materials",
    action="write"
)

# teacher - ç„¡çµ„ç¹”ç®¡ç†æ¬Šé™
return False
```

#### Resources

| Resource | èªªæ˜ |
|----------|------|
| `manage_materials` | ç®¡ç†çµ„ç¹”æ•™æ |
| `manage_schools` | ç®¡ç†å­¸æ ¡ |
| `manage_teachers` | ç®¡ç†æ•™å¸« |
| `view_analytics` | æŸ¥çœ‹åˆ†æå ±è¡¨ |

---

## ğŸ’¾ è³‡æ–™åº«è¨­è¨ˆ

### ä¸‰å±¤æ¶æ§‹

```
Program (æ•™æ)
  â†“
Lesson (å–®å…ƒ)
  â†“
Content (å…§å®¹)
  â†“
ContentItem (å…§å®¹é …ç›®)
```

### æ ¸å¿ƒè³‡æ–™è¡¨

#### `programs` - æ•™æ

```sql
CREATE TABLE programs (
  id SERIAL PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  level programlevel,  -- A1, A2, B1, B2, C1, C2
  total_hours INTEGER,

  -- æ“æœ‰è€…ï¼ˆäºŒé¸ä¸€ï¼‰
  teacher_id INTEGER REFERENCES teachers(id),         -- è€å¸«å€‹äººæ•™æ
  organization_id UUID REFERENCES organizations(id),  -- çµ„ç¹”å…¬ç‰ˆæ•™æ

  is_template BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `lessons` - å–®å…ƒ

```sql
CREATE TABLE lessons (
  id SERIAL PRIMARY KEY,
  program_id INTEGER NOT NULL REFERENCES programs(id) ON DELETE CASCADE,
  name VARCHAR(200) NOT NULL,
  description TEXT,
  order_index INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `contents` - å…§å®¹

```sql
CREATE TABLE contents (
  id SERIAL PRIMARY KEY,
  lesson_id INTEGER NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
  type contenttype NOT NULL,  -- âœ… ä¿®å¾©ï¼šæ”¯æ´ 5 ç¨®é¡å‹
  title VARCHAR(200) NOT NULL,
  order_index INTEGER DEFAULT 0,

  -- è¨­å®š
  target_wpm INTEGER,
  target_accuracy FLOAT,
  time_limit INTEGER,

  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### `teacher_organizations` - çµ„ç¹”æˆå“¡

```sql
CREATE TABLE teacher_organizations (
  teacher_id INTEGER NOT NULL REFERENCES teachers(id),
  organization_id UUID NOT NULL REFERENCES organizations(id),
  role organizationrole NOT NULL,  -- org_owner, org_admin, teacher
  is_active BOOLEAN DEFAULT TRUE,
  joined_at TIMESTAMP DEFAULT NOW(),

  PRIMARY KEY (teacher_id, organization_id)
);
```

---

### ContentType Enum âœ… ä¿®å¾©

**ä¿®å¾©å‰**:
```sql
CREATE TYPE contenttype AS ENUM ('reading_assessment');
```

**ä¿®å¾©å¾Œ** (2026-01-15):
```sql
CREATE TYPE contenttype AS ENUM (
  'reading_assessment',  -- Legacy
  'example_sentences',   -- âœ… æ–°å¢ï¼šä¾‹å¥é›†
  'vocabulary_set',      -- âœ… æ–°å¢ï¼šå–®å­—é›†
  'single_choice_quiz',  -- âœ… æ–°å¢ï¼šå–®é¸é¡Œåº«
  'scenario_dialogue'    -- âœ… æ–°å¢ï¼šæƒ…å¢ƒå°è©±
);
```

**Migration**: `alembic/versions/20260115_0826_090076973179_add_new_content_types_to_enum.py`

---

## ğŸ“ ä½¿ç”¨ç¯„ä¾‹

### Frontend ä½¿ç”¨ç¯„ä¾‹

#### ç¯„ä¾‹ 1: Teacher Programs é é¢

```tsx
import { useProgramAPI } from '@/hooks/useProgramAPI';
import { useProgramTree } from '@/hooks/useProgramTree';
import { ProgramTreeView } from '@/components/shared/ProgramTreeView';

function TeacherProgramsPage() {
  const api = useProgramAPI();
  const { data, handleCreate, handleUpdate, handleDelete } = useProgramTree({
    scope: 'teacher'
  });

  const handleCreateProgram = async () => {
    await handleCreate('program', null, {
      name: 'Business English A1',
      level: 'A1',
      total_hours: 20
    });
  };

  return (
    <div>
      <button onClick={handleCreateProgram}>æ–°å¢æ•™æ</button>
      <ProgramTreeView
        scope="teacher"
        onSelect={(node) => console.log('Selected:', node)}
      />
    </div>
  );
}
```

#### ç¯„ä¾‹ 2: Organization Materials é é¢

```tsx
import { useProgramAPI } from '@/hooks/useProgramAPI';
import { useProgramTree } from '@/hooks/useProgramTree';
import { ProgramTreeView } from '@/components/shared/ProgramTreeView';

function OrganizationMaterialsPage() {
  const { organizationId } = useParams();
  const api = useProgramAPI();
  const { data, handleCreate } = useProgramTree({
    scope: 'organization',
    organizationId
  });

  const handleCreateProgram = async () => {
    await handleCreate('program', null, {
      name: 'Organization Standard Program',
      level: 'B1',
      total_hours: 30
    });
  };

  return (
    <div>
      <button onClick={handleCreateProgram}>æ–°å¢æ•™æ</button>
      <ProgramTreeView
        scope="organization"
        organizationId={organizationId}
        onSelect={(node) => console.log('Selected:', node)}
      />
    </div>
  );
}
```

**å·®ç•°**: åªæœ‰ `scope` å’Œ `organizationId` åƒæ•¸ä¸åŒï¼Œå…¶ä»–å®Œå…¨ç›¸åŒï¼

---

### Backend ä½¿ç”¨ç¯„ä¾‹

#### ç¯„ä¾‹ 1: Router ä½¿ç”¨ Service

```python
from services import program_service

@router.post("/programs/lessons/{lesson_id}/contents", status_code=201)
async def create_content(
    lesson_id: int,
    payload: ContentCreate,
    db: Session = Depends(get_db),
    current_teacher: Teacher = Depends(get_current_teacher),
):
    try:
        # Service Layer è‡ªå‹•è™•ç†æ¬Šé™æª¢æŸ¥
        content = program_service.create_content(
            lesson_id=lesson_id,
            teacher_id=current_teacher.id,
            data=payload.dict(),
            db=db,
        )

        return {
            "id": content.id,
            "lesson_id": content.lesson_id,
            "type": content.type,
            "title": content.title,
        }

    except PermissionError as e:
        raise HTTPException(status_code=403, detail=str(e))
```

#### ç¯„ä¾‹ 2: æ¬Šé™æª¢æŸ¥ä½¿ç”¨

```python
from services.program_service import check_manage_materials_permission

def some_organization_operation(teacher_id: int, org_id: uuid.UUID, db: Session):
    # æª¢æŸ¥æ˜¯å¦æœ‰ç®¡ç†æ•™ææ¬Šé™
    if not check_manage_materials_permission(teacher_id, org_id, db):
        raise PermissionError("You don't have permission to manage materials")

    # åŸ·è¡Œæ“ä½œ
    ...
```

---

## ğŸ”§ ä¿®å¾©è¨˜éŒ„

### ContentType Enum ä¿®å¾© (2026-01-15)

#### å•é¡Œæè¿°

**ç—‡ç‹€**: Organization Materials é é¢çš„ Content CREATE åŠŸèƒ½å¤±æ•— (HTTP 500)

**æ ¹æœ¬åŸå› **: Frontend-Backend ContentType ä¸åŒæ­¥

```
Frontend é€å‡º: type="example_sentences"
Backend è³‡æ–™åº« enum åªæ¥å—: type="reading_assessment"
â†’ PostgreSQL éŒ¯èª¤: invalid input value for enum contenttype
```

#### ä¿®å¾©å…§å®¹

1. **æ›´æ–° Backend Python Enum** (`backend/models/base.py`)
   - æ–°å¢ `EXAMPLE_SENTENCES = "example_sentences"`
   - æ–°å¢ `VOCABULARY_SET = "vocabulary_set"`
   - æ–°å¢ `SINGLE_CHOICE_QUIZ = "single_choice_quiz"`
   - æ–°å¢ `SCENARIO_DIALOGUE = "scenario_dialogue"`

2. **æ›´æ–° PostgreSQL Database Enum** (Alembic Migration)
   ```bash
   alembic revision -m "add_new_content_types_to_enum"
   alembic upgrade head
   ```

3. **é©—è­‰ä¿®å¾©**
   - âœ… Organization Materials é é¢ Content CREATE æˆåŠŸ
   - âœ… æ–° Content "æ–°example_sentences" (ID: 45) å»ºç«‹æˆåŠŸ
   - âœ… Backend Log: `Content created successfully: id=45`

#### ç¶“é©—æ•™è¨“

1. **ç³»çµ±æ€§èª¿æŸ¥** - Debug logging ç¹é GCP Cloud Logging éŒ¯èª¤ï¼Œæš´éœ²çœŸæ­£çš„ SQLAlchemy éŒ¯èª¤
2. **ä¸è¦çŒœæ¸¬** - åŸæœ¬ä»¥ç‚ºæ˜¯ GCP èªè­‰å•é¡Œï¼Œå¯¦éš›æ˜¯ database schema å•é¡Œ
3. **Frontend-Backend åŒæ­¥** - Schema è®Šæ›´ï¼ˆç‰¹åˆ¥æ˜¯ enumï¼‰å¿…é ˆåŒæ™‚æ›´æ–°å…©ç«¯
4. **Alembic Migration** - PostgreSQL enum ç„¡æ³•è‡ªå‹•åŒæ­¥ï¼Œéœ€è¦æ˜ç¢ºçš„ migration

**è©³ç´°èª¿æŸ¥å ±å‘Š**: è¦‹ `CONTENT_CREATE_INVESTIGATION.md`

---

## ğŸ¯ ç¸½çµ

### æ¨¡çµ„åŒ–æ ¸å¿ƒåƒ¹å€¼

| åƒ¹å€¼ | èªªæ˜ | æŒ‡æ¨™ |
|------|------|------|
| **ç¨‹å¼ç¢¼é‡ç”¨** | Teacher å’Œ Organization é é¢å…±ç”¨çµ„ä»¶ | 80% ä»£ç¢¼å…±ç”¨ |
| **ç¶­è­·æ€§** | ä¿®æ”¹ä¸€è™•ï¼Œå…©é‚ŠåŒæ­¥ç”Ÿæ•ˆ | ç¶­è­·é»æ¸›å°‘ 50% |
| **ä¸€è‡´æ€§** | UI/UX è¡Œç‚ºå®Œå…¨ä¸€è‡´ | 100% ä¸€è‡´ |
| **å¯æ¸¬è©¦æ€§** | Service Layer å’Œ Hooks å¯ç¨ç«‹æ¸¬è©¦ | æ¸¬è©¦è¦†è“‹ç‡æå‡ |

### æŠ€è¡“æ£§

| Layer | Technology |
|-------|-----------|
| Frontend | React + TypeScript + Tailwind CSS |
| State Management | React Hooks (Custom) |
| Backend | FastAPI + Python 3.11+ |
| Database | PostgreSQL (Supabase) |
| Permission | Casbin |
| Migration | Alembic |

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2026-01-15
**ç¶­è­·è€…**: Duotopia Development Team
