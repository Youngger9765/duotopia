# Duotopia 11æœˆäº¤ä»˜åŠŸèƒ½ PRD (Product Requirements Document)

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2025-11-17
**ç‹€æ…‹**: âœ… Final ç‰ˆæœ¬

---

## ä¸€ã€äº¤ä»˜æ¦‚è¿°

### 1.1 äº¤ä»˜æ™‚ç¨‹
- **é–‹ç™¼æœˆä»½**: 2025å¹´11æœˆ
- **äº¤ä»˜æ—¥æœŸ**: 2025å¹´11æœˆ30æ—¥
- **éšæ®µ**: Phase 1.5 - è¨‚é–±èˆ‡ç®¡ç†åŠŸèƒ½å¢å¼·

### 1.2 äº¤ä»˜ç›®æ¨™
æœ¬æ¬¡äº¤ä»˜å°ˆæ³¨æ–¼å®Œå–„è¨‚é–±ç®¡ç†ç³»çµ±ã€å¾Œå°ç®¡ç†åŠŸèƒ½ã€ä»¥åŠå…¨ç«™åœ‹éš›åŒ–æ”¯æ´ï¼Œç‚ºå¹³å°å•†æ¥­åŒ–é‹ç‡Ÿå¥ å®šåŸºç¤ã€‚

---

## äºŒã€æ ¸å¿ƒåŠŸèƒ½äº¤ä»˜æ¸…å–®

### 2.1 Admin è¨‚é–±ç®¡ç† - Trial Plan é¡¯ç¤º

#### åŠŸèƒ½æè¿°
ç¢ºä¿ `/admin/subscription` é é¢æ­£ç¢ºé¡¯ç¤ºæ–°è¨»å†Šç”¨æˆ¶çš„ Trial è¨‚é–±è³‡è¨Šã€‚

#### éœ€æ±‚
1. **Plan æ¬„ä½é¡¯ç¤º**
   - æ–°è¨»å†Šç”¨æˆ¶æ‡‰é¡¯ç¤º "30-Day Trial"
   - å·²ä»˜è²»ç”¨æˆ¶é¡¯ç¤ºå°æ‡‰æ–¹æ¡ˆåç¨±ï¼ˆTutor Teachers / School Teachersï¼‰

2. **End Date æ¬„ä½é¡¯ç¤º**
   - Trial ç”¨æˆ¶ï¼šé¡¯ç¤ºè¨»å†Šæ—¥æœŸ + 30 å¤©
   - ä»˜è²»ç”¨æˆ¶ï¼šé¡¯ç¤ºè¨‚é–±åˆ°æœŸæ—¥
   - æ ¼å¼ï¼šYYYY-MM-DD

#### é©—æ”¶æ¨™æº–
- [x] æ–°è¨»å†Šç”¨æˆ¶åœ¨ admin/subscription é é¢ Plan æ¬„ä½é¡¯ç¤º "30-Day Trial"
- [x] Trial ç”¨æˆ¶çš„ End Date æ­£ç¢ºé¡¯ç¤ºï¼ˆè¨»å†Šæ—¥ + 30å¤©ï¼‰
- [x] ä»˜è²»ç”¨æˆ¶çš„ Plan å’Œ End Date æ­£ç¢ºé¡¯ç¤º

#### å¯¦ä½œè¨˜éŒ„
- **å®Œæˆæ—¥æœŸ**: 2025-11-18
- **ä¿®æ”¹æª”æ¡ˆ**:
  - `services/email_service.py:445` - ä¿®æ”¹ `plan_name="30-Day Trial"`
  - `models.py:299` - ä¿®æ”¹ `subscription_auto_renew` default=Falseï¼ˆæ–°ç”¨æˆ¶é è¨­ä¸å•Ÿç”¨è‡ªå‹•çºŒè¨‚ï¼‰
  - `tests/integration/api/test_trial_plan_display.py` - æ–°å¢ TDD æ¸¬è©¦
- **æ¸¬è©¦**: 2 passed (test_email_verification_creates_trial_plan, test_trial_plan_name_and_duration)
- **é¡å¤–ä¿®å¾©**: æ–°è¨»å†Šç”¨æˆ¶é è¨­ `subscription_auto_renew=False`ï¼ˆæ²’ç¶å¡ä¸æ‡‰å•Ÿç”¨çºŒè¨‚ï¼‰

---

### 2.2 é€€æ¬¾æ©Ÿåˆ¶ï¼ˆå…¬å¸ç®¡ç†è€…å¾Œå°ï¼‰

#### åŠŸèƒ½æè¿°
ç‚ºå…¬å¸ç®¡ç†è€…æä¾›å®Œæ•´çš„é€€æ¬¾ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æ´å…¨é¡é€€æ¬¾æ“ä½œèˆ‡è¨˜éŒ„è¿½è¹¤ã€‚

#### æ ¸å¿ƒåŠŸèƒ½
1. **é€€æ¬¾æ“ä½œä»‹é¢**
   - æœå°‹äº¤æ˜“è¨˜éŒ„
   - é¸æ“‡é€€æ¬¾é …ç›®
   - è¼¸å…¥é€€æ¬¾åŸå› 
   - åŸ·è¡Œé€€æ¬¾æ“ä½œ
   - é€€æ¬¾ç¢ºèªæ©Ÿåˆ¶

2. **é€€æ¬¾ç‹€æ…‹ç®¡ç†**
   - ç”³è«‹ä¸­ (PENDING)
   - è™•ç†ä¸­ (PROCESSING)
   - æˆåŠŸ (SUCCESS)
   - å¤±æ•— (FAILED)
   - å·²å–æ¶ˆ (CANCELLED)

3. **è¨Šæ¯èˆ‡é€šçŸ¥**
   - é€€æ¬¾æˆåŠŸé€šçŸ¥ï¼ˆEmail + ç³»çµ±é€šçŸ¥ï¼‰
   - é€€æ¬¾å¤±æ•—é€šçŸ¥ï¼ˆé¡¯ç¤ºå¤±æ•—åŸå› ï¼‰
   - ç®¡ç†è€…æ“ä½œè¨˜éŒ„

#### æŠ€è¡“å¯¦ä½œ
- **API è·¯ç”±**: `POST /api/admin/refunds`
- **è³‡æ–™æ¨¡å‹**:
  ```typescript
  interface Refund {
    id: string;
    transaction_id: string;
    amount: number;
    reason: string;
    status: RefundStatus;
    processed_by: number; // admin user id
    processed_at?: Date;
    error_message?: string;
  }
  ```
- **TapPay æ•´åˆ**: å‘¼å« TapPay Refund API
- **è¨˜éŒ„ç¨½æ ¸**: å®Œæ•´è¨˜éŒ„é€€æ¬¾æ“ä½œæ­·å²

#### é©—æ”¶æ¨™æº–
- [ ] ç®¡ç†è€…å¯æœå°‹ä¸¦æŸ¥çœ‹æ‰€æœ‰äº¤æ˜“è¨˜éŒ„
- [ ] åŸ·è¡Œå…¨é¡é€€æ¬¾åŠŸèƒ½æ­£å¸¸
- [ ] é€€æ¬¾æˆåŠŸå¾Œæ›´æ–°è¨‚é–±ç‹€æ…‹
- [ ] é€€æ¬¾å¤±æ•—é¡¯ç¤ºæ˜ç¢ºéŒ¯èª¤è¨Šæ¯
- [ ] æ‰€æœ‰é€€æ¬¾æ“ä½œå®Œæ•´è¨˜éŒ„
- [ ] Email é€šçŸ¥æ­£ç¢ºç™¼é€

---

### 2.3 é»æ•¸èˆ‡è¨‚é–±é‚è¼¯å„ªåŒ–

#### åŠŸèƒ½æè¿°
å®Œå–„é»æ•¸é…é¡ç³»çµ±ï¼Œå¯¦ä½œè©¦ç”¨åŒ…èˆ‡è¨‚é–±æ–¹æ¡ˆçš„ä¸åŒé»æ•¸è¨ˆç®—é‚è¼¯ã€‚

#### é»æ•¸è¦å‰‡

##### è©¦ç”¨åŒ…é»æ•¸ï¼ˆTrial Creditsï¼‰
- **åˆå§‹é…é¡**: 1,000 é»ï¼ˆè©¦ç”¨æœŸå°ˆç”¨ï¼‰
- **ä½¿ç”¨è¦å‰‡**:
  - è©¦ç”¨æœŸå…§å¯ä½¿ç”¨
  - å‰©é¤˜é»æ•¸å¯ç´¯è¨ˆåˆ°ä»˜è²»è¨‚é–±
  - å‡ç´šè¨‚é–±å¾Œï¼Œè©¦ç”¨é»æ•¸èˆ‡è¨‚é–±é»æ•¸åˆ†é–‹è¨ˆç®—
- **ç´¯è¨ˆæ©Ÿåˆ¶**:
  ```
  ç¸½å¯ç”¨é»æ•¸ = è©¦ç”¨å‰©é¤˜é»æ•¸ + è¨‚é–±æ–¹æ¡ˆé»æ•¸
  æ‰£é™¤é †åº: å…ˆæ‰£è¨‚é–±é»æ•¸ â†’ å†æ‰£è©¦ç”¨é»æ•¸
  ```

##### è¨‚é–±æ–¹æ¡ˆé»æ•¸ï¼ˆSubscription Creditsï¼‰
- **Tutor**: 10,000 é»/æœˆ
- **School**: 25,000 é»/æœˆ
- **ä½¿ç”¨è¦å‰‡**:
  - æ¯æœˆæ­¸é›¶ï¼Œä¸ç´¯ç©åˆ°ä¸‹å€‹æœˆ
  - æœˆåº•æœªä½¿ç”¨çš„é»æ•¸è‡ªå‹•æ¸…ç©º
  - çºŒè¨‚å¾Œé‡æ–°è¨ˆç®—é…é¡

#### é»æ•¸æ‰£é™¤è¦å‰‡
| åŠŸèƒ½ | æ‰£é»è¦å‰‡ |
|------|---------|
| èªéŸ³éŒ„éŸ³ | 1 ç§’ = 1 é» |
| æ–‡å­—æ‰¹æ”¹ | 1 å­— = 0.1 é»ï¼ˆ500å­— = 50é»ï¼‰ |
| åœ–ç‰‡æ‰¹æ”¹ | 1 å¼µ = 10 é» |

#### æŠ€è¡“å¯¦ä½œ
- **è³‡æ–™æ¨¡å‹æ“´å……**:
  ```python
  class Teacher(Base):
      trial_credits_remaining: int = 1000
      subscription_credits_remaining: int = 0
      subscription_credits_total: int = 0
      credits_reset_at: DateTime
  ```
- **é»æ•¸è¨ˆç®—é‚è¼¯**: `quota_service.py`
- **æœˆåº•é‡ç½®æ’ç¨‹**: Cron Job (æ¯æœˆ1æ—¥ 00:00)

#### é©—æ”¶æ¨™æº–
- [ ] è©¦ç”¨ç”¨æˆ¶æ­£ç¢ºé¡¯ç¤º 1,000 è©¦ç”¨é»æ•¸
- [ ] å‡ç´šè¨‚é–±å¾Œè©¦ç”¨é»æ•¸ä¿ç•™
- [ ] æ‰£é»é †åºæ­£ç¢ºï¼ˆè¨‚é–±é»æ•¸å„ªå…ˆï¼‰
- [ ] è¨‚é–±é»æ•¸æ¯æœˆ1æ—¥æ­£ç¢ºæ­¸é›¶
- [ ] å„€è¡¨æ¿æ­£ç¢ºé¡¯ç¤ºå…©ç¨®é»æ•¸é¤˜é¡
- [ ] é»æ•¸ä½¿ç”¨è¨˜éŒ„å®Œæ•´è¿½è¹¤

---

### 2.4 å¾Œå°å¸³æ¬¾æ˜ç´°ä¸‹è¼‰

#### åŠŸèƒ½æè¿°
æä¾›ç®¡ç†ç«¯å®Œæ•´çš„å¸³æ¬¾æ˜ç´°åŒ¯å‡ºåŠŸèƒ½ï¼Œæ”¯æ´å¤šç¨®æ ¼å¼ä¸‹è¼‰ã€‚

#### æ ¸å¿ƒåŠŸèƒ½
1. **å¸³æ¬¾è³‡æ–™ç¯©é¸**
   - æ™‚é–“ç¯„åœé¸æ“‡ï¼ˆèµ·è¿„æ—¥æœŸï¼‰
   - è¨‚é–±æ–¹æ¡ˆç¯©é¸ï¼ˆTrial/Tutor/Schoolï¼‰
   - äº¤æ˜“ç‹€æ…‹ç¯©é¸ï¼ˆæˆåŠŸ/é€€æ¬¾/å¤±æ•—ï¼‰
   - ç”¨æˆ¶æœå°‹ï¼ˆå§“å/Emailï¼‰

2. **åŒ¯å‡ºæ ¼å¼**
   - **CSV**: ç›¸å®¹ Excelï¼Œé©åˆæ•¸æ“šåˆ†æ
   - **XLSX**: Excel åŸç”Ÿæ ¼å¼ï¼Œæ”¯æ´å¤šå·¥ä½œè¡¨
   - æœªä¾†æ“´å……: PDF å ±è¡¨

3. **åŒ¯å‡ºæ¬„ä½**
   | æ¬„ä½åç¨± | èªªæ˜ |
   |---------|------|
   | äº¤æ˜“ID | Transaction ID |
   | äº¤æ˜“æ—¥æœŸ | Transaction Date |
   | ç”¨æˆ¶å§“å | Teacher Name |
   | ç”¨æˆ¶Email | Teacher Email |
   | è¨‚é–±æ–¹æ¡ˆ | Subscription Tier |
   | äº¤æ˜“é‡‘é¡ | Amount (NT$) |
   | æ”¯ä»˜æ–¹å¼ | Payment Method |
   | äº¤æ˜“ç‹€æ…‹ | Status |
   | é…é¡é»æ•¸ | Credits Allocated |
   | å‚™è¨» | Notes |

#### æŠ€è¡“å¯¦ä½œ
- **API è·¯ç”±**: `GET /api/admin/transactions/export`
- **Query åƒæ•¸**:
  ```typescript
  interface ExportQuery {
    start_date: string;
    end_date: string;
    tier?: 'trial' | 'tutor' | 'school';
    status?: 'success' | 'refunded' | 'failed';
    format: 'csv' | 'xlsx';
  }
  ```
- **å¾Œç«¯è™•ç†**:
  - CSV: Python `csv` module
  - XLSX: `openpyxl` library
  - æª”æ¡ˆå‘½å: `transactions_YYYYMMDD_HHMMSS.{csv|xlsx}`

#### é©—æ”¶æ¨™æº–
- [x] âœ… å¯é¸æ“‡æ—¥æœŸç¯„åœåŒ¯å‡º
- [x] âœ… CSV æ ¼å¼æ­£ç¢ºï¼ˆUTF-8 BOMï¼ŒExcel å¯é–‹å•Ÿï¼‰
- [x] âœ… XLSX æ ¼å¼æ­£ç¢ºï¼ˆå«æ¨™é¡Œåˆ—ï¼‰
- [x] âœ… ç¯©é¸æ¢ä»¶æ­£ç¢ºå¥—ç”¨
- [x] âœ… å¤§é‡è³‡æ–™åŒ¯å‡ºä¸è¶…æ™‚ï¼ˆæ¸¬è©¦ 10,000 ç­†ï¼‰
- [x] âœ… ä¸‹è¼‰æª”ååŒ…å«æ™‚é–“æˆ³è¨˜
- [x] âœ… ä¸­æ–‡æ¬„ä½åç¨±æ­£ç¢ºé¡¯ç¤º

#### âœ… å¯¦ä½œå®Œæˆ (2025-11-17)
- **Commit**: `4ef9dd2`
- **åŠŸèƒ½**:
  - âœ… Subscriptions Tab - ä¸‹è¼‰è¨‚é–±è³‡æ–™
  - âœ… Transactions Tab - ä¸‹è¼‰äº¤æ˜“è¨˜éŒ„
  - âœ… Learning Tab - ä¸‹è¼‰å­¸ç¿’åˆ†æ
  - âœ… UTF-8 BOM æ”¯æ´ Excel ä¸­æ–‡é¡¯ç¤º
  - âœ… æª”åè‡ªå‹•åŠ ä¸Šæ—¥æœŸ (å¦‚ `subscriptions_2025-11-17.csv`)

---

### 2.5 å…¨ç«™åœ‹éš›åŒ– (i18n)

#### åŠŸèƒ½æè¿°
å»ºç«‹å®Œæ•´çš„å¤šèªè¨€æ”¯æ´æ¶æ§‹ï¼Œå¯¦ä½œä¸­è‹±æ–‡é›™èªä»‹é¢ã€‚

#### æ”¯æ´èªè¨€
- **ä¸­æ–‡ (zh)**: ç¹é«”ä¸­æ–‡ï¼ˆé è¨­ï¼‰
- **è‹±æ–‡ (en)**: è‹±æ–‡

#### i18n æ¶æ§‹

##### å‰ç«¯å¯¦ä½œ
- **æ¡†æ¶**: `react-i18next`
- **èªç³»æª”ä½ç½®**: `/frontend/src/locales/`
  - `zh.json` - ç¹é«”ä¸­æ–‡
  - `en.json` - è‹±æ–‡
- **èªç³»åˆ‡æ›**: Header å³ä¸Šè§’èªè¨€é¸å–®
- **æŒä¹…åŒ–**: LocalStorage å„²å­˜ä½¿ç”¨è€…åå¥½

##### å¾Œç«¯å¯¦ä½œ
- **æ¡†æ¶**: `babel` æˆ–è‡ªå®šç¾© i18n service
- **èªç³»æª”ä½ç½®**: `/backend/locales/`
  - `zh.json` - ç¹é«”ä¸­æ–‡
  - `en.json` - è‹±æ–‡
- **Email æ¨¡æ¿**: æ”¯æ´å¤šèªè¨€ä¿¡ä»¶å…§å®¹

#### ç¿»è­¯ç¯„åœ

##### å‰ç«¯å…¨é é¢æ–‡æ¡ˆ
- [ ] ç™»å…¥/è¨»å†Šé é¢
- [ ] æ•™å¸«å„€è¡¨æ¿
- [ ] ç­ç´šç®¡ç†é é¢
- [ ] å­¸ç”Ÿç®¡ç†é é¢
- [ ] èª²ç¨‹ç®¡ç†é é¢
- [ ] ä½œæ¥­ç®¡ç†é é¢
- [ ] æ‰¹æ”¹ä»‹é¢
- [ ] è¨‚é–±ç®¡ç†é é¢
- [ ] å€‹äººè¨­å®šé é¢
- [ ] éŒ¯èª¤è¨Šæ¯
- [ ] æŒ‰éˆ•æ–‡å­—
- [ ] è¡¨å–®æ¨™ç±¤

##### å¾Œå°å…¨æ¨¡çµ„æ–‡æ¡ˆ
- [ ] ç®¡ç†è€…å„€è¡¨æ¿
- [ ] ç”¨æˆ¶ç®¡ç†
- [ ] äº¤æ˜“ç®¡ç†
- [ ] é€€æ¬¾ç®¡ç†
- [ ] ç³»çµ±è¨­å®š
- [ ] API éŒ¯èª¤è¨Šæ¯
- [ ] Email é€šçŸ¥æ¨¡æ¿

#### èªç³»æª”çµæ§‹
```json
{
  "common": {
    "save": "å„²å­˜",
    "cancel": "å–æ¶ˆ",
    "delete": "åˆªé™¤",
    "edit": "ç·¨è¼¯"
  },
  "auth": {
    "login": "ç™»å…¥",
    "logout": "ç™»å‡º",
    "register": "è¨»å†Š"
  },
  "dashboard": {
    "title": "å„€è¡¨æ¿",
    "welcome": "æ­¡è¿å›ä¾†"
  },
  "subscription": {
    "trial": "è©¦ç”¨ä¸­",
    "tutor": "Tutor æ–¹æ¡ˆ",
    "school": "School æ–¹æ¡ˆ"
  }
}
```

#### Fallback æ©Ÿåˆ¶
- **é †åº**: ä½¿ç”¨è€…åå¥½èªè¨€ â†’ ç€è¦½å™¨èªè¨€ â†’ é è¨­ä¸­æ–‡
- **ç¼ºå¤±ç¿»è­¯**: é¡¯ç¤º key å€¼ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰æˆ–é è¨­ä¸­æ–‡ï¼ˆç”Ÿç”¢æ¨¡å¼ï¼‰
- **å‹•æ…‹è¼‰å…¥**: èªç³»æª”æŒ‰éœ€è¼‰å…¥ï¼Œæ¸›å°‘åˆå§‹è¼‰å…¥æ™‚é–“

#### æŠ€è¡“å¯¦ä½œ
- **èªè¨€æª¢æ¸¬**:
  ```typescript
  const detectLanguage = (): Language => {
    const stored = localStorage.getItem('language');
    if (stored) return stored as Language;

    const browser = navigator.language;
    return browser.startsWith('zh') ? 'zh' : 'en';
  };
  ```
- **Context Provider**:
  ```typescript
  <I18nextProvider i18n={i18n}>
    <App />
  </I18nextProvider>
  ```
- **ä½¿ç”¨ç¯„ä¾‹**:
  ```typescript
  const { t } = useTranslation();
  return <h1>{t('dashboard.welcome')}</h1>;
  ```

#### é©—æ”¶æ¨™æº–
- [ ] èªç³»åˆ‡æ›åŠŸèƒ½æ­£å¸¸é‹ä½œ
- [ ] åˆ‡æ›èªç³»å¾Œé é¢å³æ™‚æ›´æ–°
- [ ] æ‰€æœ‰å‰å°é é¢æ–‡æ¡ˆå·²ç¿»è­¯
- [ ] æ‰€æœ‰å¾Œå°é é¢æ–‡æ¡ˆå·²ç¿»è­¯
- [ ] Email é€šçŸ¥æ”¯æ´å¤šèªè¨€
- [ ] API éŒ¯èª¤è¨Šæ¯æ”¯æ´å¤šèªè¨€
- [ ] èªç³»åå¥½æ­£ç¢ºå„²å­˜
- [ ] é‡æ–°æ•´ç†é é¢èªç³»ä¸è®Š
- [ ] ç„¡ç¿»è­¯ç¼ºå¤±ï¼ˆ100% è¦†è“‹ç‡ï¼‰
- [ ] RTL èªè¨€æ”¯æ´ï¼ˆé ç•™ï¼Œæš«ä¸å¯¦ä½œï¼‰

---

## ä¸‰ã€è³‡æ–™æ¨¡å‹è®Šæ›´

### 3.1 Teacher æ¨¡å‹æ“´å……
```python
class Teacher(Base):
    # åŸæœ‰æ¬„ä½...

    # æ–°å¢æ¬„ä½
    subscription_tier: str  # 'trial' | 'tutor' | 'school'
    trial_credits_remaining: int = 1000
    subscription_credits_remaining: int = 0
    subscription_credits_total: int = 0
    credits_reset_at: DateTime
    preferred_language: str = 'zh'  # 'zh' | 'en'
```

### 3.2 æ–°å¢ Refund æ¨¡å‹
```python
class Refund(Base):
    __tablename__ = "refunds"

    id: int (Primary Key)
    transaction_id: str (Foreign Key -> Transaction.id)
    amount: Decimal
    reason: str
    status: RefundStatus  # 'pending' | 'processing' | 'success' | 'failed'
    error_message: str (Nullable)
    processed_by: int (Foreign Key -> User.id)
    processed_at: DateTime (Nullable)
    created_at: DateTime
    updated_at: DateTime
```

### 3.3 Transaction æ¨¡å‹æ“´å……
```python
class Transaction(Base):
    # åŸæœ‰æ¬„ä½...

    # æ–°å¢æ¬„ä½
    is_refunded: bool = False
    refunded_at: DateTime (Nullable)
    refund_amount: Decimal (Nullable)
```

---

## å››ã€API è¦æ ¼

### 4.1 è§’è‰²ç®¡ç† API

#### å–å¾—ç•¶å‰ç”¨æˆ¶è§’è‰²
```
GET /api/teachers/me/role
Response: {
  "subscription_tier": "tutor",
  "trial_credits_remaining": 500,
  "subscription_credits_remaining": 8500,
  "subscription_credits_total": 10000
}
```

### 4.2 é€€æ¬¾ç®¡ç† API

#### ç”³è«‹é€€æ¬¾
```
POST /api/admin/refunds
Request: {
  "transaction_id": "txn_123456",
  "amount": 330,
  "reason": "ç”¨æˆ¶è¦æ±‚é€€æ¬¾"
}
Response: {
  "refund_id": "ref_789",
  "status": "processing"
}
```

#### æŸ¥è©¢é€€æ¬¾ç‹€æ…‹
```
GET /api/admin/refunds/{refund_id}
Response: {
  "id": "ref_789",
  "status": "success",
  "processed_at": "2025-11-15T10:30:00Z"
}
```

### 4.3 å¸³æ¬¾åŒ¯å‡º API

#### åŒ¯å‡ºäº¤æ˜“æ˜ç´°
```
GET /api/admin/transactions/export?start_date=2025-11-01&end_date=2025-11-30&format=xlsx
Response: File Download (transactions_20251130_143000.xlsx)
```

### 4.4 èªç³»ç®¡ç† API

#### æ›´æ–°èªç³»åå¥½
```
PUT /api/teachers/me/language
Request: {
  "language": "en"
}
Response: {
  "language": "en",
  "updated_at": "2025-11-17T09:00:00Z"
}
```

---

## äº”ã€æ¸¬è©¦è¨ˆç•«

### 5.1 å–®å…ƒæ¸¬è©¦
- [ ] è§’è‰²æ¬Šé™é©—è­‰æ¸¬è©¦
- [ ] é»æ•¸è¨ˆç®—é‚è¼¯æ¸¬è©¦
- [ ] é€€æ¬¾æµç¨‹æ¸¬è©¦
- [ ] èªç³»åˆ‡æ›æ¸¬è©¦
- [ ] å¸³æ¬¾åŒ¯å‡ºæ¸¬è©¦

### 5.2 æ•´åˆæ¸¬è©¦
- [ ] TapPay é€€æ¬¾ API æ•´åˆæ¸¬è©¦
- [ ] é»æ•¸æ‰£é™¤èˆ‡é‡ç½®æ¸¬è©¦
- [ ] å¤šèªè¨€ Email ç™¼é€æ¸¬è©¦
- [ ] CSV/XLSX åŒ¯å‡ºæ­£ç¢ºæ€§æ¸¬è©¦

### 5.3 E2E æ¸¬è©¦
- [ ] ç”¨æˆ¶å‡ç´šè¨‚é–±æµç¨‹
- [ ] ç®¡ç†è€…åŸ·è¡Œé€€æ¬¾æµç¨‹
- [ ] èªç³»åˆ‡æ›å®Œæ•´æµç¨‹
- [ ] å¸³æ¬¾æ˜ç´°åŒ¯å‡ºæµç¨‹

### 5.4 æ•ˆèƒ½æ¸¬è©¦
- [ ] å¤§é‡äº¤æ˜“è³‡æ–™åŒ¯å‡ºï¼ˆ10,000 ç­†ä»¥ä¸Šï¼‰
- [ ] èªç³»æª”è¼‰å…¥æ•ˆèƒ½
- [ ] é»æ•¸è¨ˆç®—æŸ¥è©¢æ•ˆèƒ½

---

## å…­ã€éƒ¨ç½²è¨ˆç•«

### 6.1 éƒ¨ç½²æ­¥é©Ÿ
1. **è³‡æ–™åº«é·ç§»**
   ```bash
   alembic revision --autogenerate -m "November 2025 features"
   alembic upgrade head
   ```

2. **ç’°å¢ƒè®Šæ•¸æ›´æ–°**
   ```bash
   # æ–°å¢é€€æ¬¾ç›¸é—œè¨­å®š
   TAPPAY_REFUND_API_URL=https://sandbox.tappaysdk.com/tpc/refund/refund

   # æ–°å¢èªç³»è¨­å®š
   DEFAULT_LANGUAGE=zh
   SUPPORTED_LANGUAGES=zh,en
   ```

3. **éœæ…‹è³‡æºæ›´æ–°**
   - èªç³»æª”éƒ¨ç½²åˆ° CDN
   - å‰ç«¯ build ä¸¦éƒ¨ç½²

4. **Cron Job è¨­å®š**
   ```bash
   # æ¯æœˆ1æ—¥ 00:00 é‡ç½®è¨‚é–±é»æ•¸
   0 0 1 * * python backend/scripts/reset_subscription_credits.py
   ```

### 6.2 éƒ¨ç½²æª¢æŸ¥æ¸…å–®
- [ ] è³‡æ–™åº«å‚™ä»½å®Œæˆ
- [ ] Staging ç’°å¢ƒæ¸¬è©¦é€šé
- [ ] ç’°å¢ƒè®Šæ•¸æ­£ç¢ºè¨­å®š
- [ ] Cron Job æ­£ç¢ºè¨­å®š
- [ ] èªç³»æª”æ­£ç¢ºéƒ¨ç½²
- [ ] Email æ¨¡æ¿æ­£ç¢ºæ›´æ–°
- [ ] ç›£æ§å‘Šè­¦è¨­å®šå®Œæˆ

---

## ä¸ƒã€æ–‡ä»¶æ›´æ–°

### 7.1 éœ€è¦æ›´æ–°çš„æ–‡ä»¶
- [ ] `PRD.md` - æ›´æ–° Phase 1.5 å…§å®¹
- [ ] `CLAUDE.md` - æ–°å¢ i18n é–‹ç™¼è¦ç¯„
- [ ] `README.md` - æ›´æ–°åŠŸèƒ½æ¸…å–®
- [ ] `API_DOCS.md` - æ–°å¢ API æ–‡ä»¶
- [ ] `DEPLOYMENT.md` - æ›´æ–°éƒ¨ç½²æµç¨‹

### 7.2 æ–°å¢æ–‡ä»¶
- [ ] `i18n_GUIDE.md` - å¤šèªè¨€é–‹ç™¼æŒ‡å—
- [ ] `ADMIN_MANUAL.md` - ç®¡ç†è€…æ“ä½œæ‰‹å†Š
- [ ] `REFUND_POLICY.md` - é€€æ¬¾æ”¿ç­–èªªæ˜

---

## å…«ã€é¢¨éšªè©•ä¼°

### 8.1 æŠ€è¡“é¢¨éšª
| é¢¨éšªé …ç›® | å½±éŸ¿ç¨‹åº¦ | ç·©è§£æªæ–½ |
|---------|---------|---------|
| TapPay é€€æ¬¾ API æ•´åˆå¤±æ•— | é«˜ | å®Œæ•´çš„éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶ |
| å¤§é‡è³‡æ–™åŒ¯å‡ºè¶…æ™‚ | ä¸­ | éåŒæ­¥è™•ç† + é€²åº¦é€šçŸ¥ |
| èªç³»æª”ç¼ºå¤±ç¿»è­¯ | ä½ | Fallback æ©Ÿåˆ¶ + ç¿»è­¯å®Œæ•´æ€§æª¢æŸ¥ |
| é»æ•¸è¨ˆç®—é‚è¼¯éŒ¯èª¤ | é«˜ | å®Œæ•´å–®å…ƒæ¸¬è©¦ + äººå·¥é©—è­‰ |

### 8.2 æ¥­å‹™é¢¨éšª
| é¢¨éšªé …ç›® | å½±éŸ¿ç¨‹åº¦ | ç·©è§£æªæ–½ |
|---------|---------|---------|
| é€€æ¬¾æµç¨‹æ¿«ç”¨ | ä¸­ | é€€æ¬¾åŸå› è¨˜éŒ„ + ç•°å¸¸åµæ¸¬ |
| é»æ•¸ç´¯è¨ˆè¦å‰‡èª¤è§£ | ä¸­ | æ¸…æ¥šçš„ UI èªªæ˜ + FAQ |
| å¤šèªè¨€ç¿»è­¯å“è³ª | ä½ | å°ˆæ¥­ç¿»è­¯å¯©æ ¸ |

---

## ä¹ã€é©—æ”¶æ¨™æº–

### 9.1 åŠŸèƒ½é©—æ”¶
- [ ] æ‰€æœ‰åŠŸèƒ½ä¾ç…§è¦æ ¼å®Œæˆ
- [ ] æ‰€æœ‰ API æ­£å¸¸é‹ä½œ
- [ ] æ‰€æœ‰å–®å…ƒæ¸¬è©¦é€šé
- [ ] æ‰€æœ‰æ•´åˆæ¸¬è©¦é€šé
- [ ] E2E æ¸¬è©¦é€šé

### 9.2 å“è³ªé©—æ”¶
- [ ] ç¨‹å¼ç¢¼é€šé ESLint æª¢æŸ¥
- [ ] ç¨‹å¼ç¢¼é€šé flake8 æª¢æŸ¥
- [ ] æ¸¬è©¦è¦†è“‹ç‡ > 80%
- [ ] ç„¡é‡å¤§ bug
- [ ] æ•ˆèƒ½ç¬¦åˆæ¨™æº–

### 9.3 æ–‡ä»¶é©—æ”¶
- [ ] API æ–‡ä»¶å®Œæ•´
- [ ] ä½¿ç”¨è€…æ‰‹å†Šå®Œæ•´
- [ ] ç®¡ç†è€…æ‰‹å†Šå®Œæ•´
- [ ] éƒ¨ç½²æ–‡ä»¶æ›´æ–°

---

## åã€æ¯æœˆè‡ªå‹•çºŒè¨‚ Cron Job (2025-11-17 é–‹ç™¼ä¸­)

### 10.1 åŠŸèƒ½æè¿°
å¯¦ä½œè¨‚é–±è‡ªå‹•çºŒè¨‚çš„ Cron Jobï¼Œæ¯æœˆ 1 æ—¥å‡Œæ™¨ 2:00 è‡ªå‹•è™•ç†è¨‚é–±åˆ°æœŸèˆ‡çºŒè¨‚é‚è¼¯ã€‚

### 10.2 åŸ·è¡Œæ™‚é–“
- **è§¸ç™¼æ™‚é–“**: æ¯æœˆ 1 æ—¥ 02:00 (å°åŒ—æ™‚é–“)
- **Cron è¡¨é”å¼**: `0 2 1 * *`

### 10.3 Cron Job é‚è¼¯

#### Phase 1: æ¨™è¨˜éæœŸè¨‚é–±
```
ç›®æ¨™: å°‡æ‰€æœ‰åˆ°æœŸçš„ active è¨‚é–±æ¨™è¨˜ç‚º expired
æŸ¥è©¢æ¢ä»¶:
  - status = 'active'
  - end_date < ç•¶æœˆ 1 æ—¥
å‹•ä½œ:
  - æ›´æ–° status = 'expired'
  - è¨˜éŒ„æ•¸é‡: marked_expired
```

#### Phase 2: è‡ªå‹•çºŒè¨‚è™•ç†
```
ç›®æ¨™: è™•ç†æ‰€æœ‰ç¬¦åˆçºŒè¨‚æ¢ä»¶çš„æ•™å¸«
æŸ¥è©¢æ¢ä»¶:
  - subscription_auto_renew = True
  - is_active = True
  - æœ‰ç¶å®šä¿¡ç”¨å¡ (card_key + card_token)

è™•ç†æµç¨‹:
  1. æª¢æŸ¥ 1: é˜²é‡è¤‡æ‰£æ¬¾
     - æŸ¥è©¢æ˜¯å¦å·²æœ‰æœ¬æœˆè¨‚é–± (start_date >= ç•¶æœˆ 1 æ—¥)
     - å¦‚æœ‰ â†’ è·³é (skip_count++)

  2. æª¢æŸ¥ 2: é˜²éŒ¯èª¤æ‰£æ¬¾ + è‡ªå‹•é—œé–‰ auto_renew
     - æŸ¥è©¢æ˜¯å¦æœ‰ä¸Šå€‹æœˆè¨‚é–± (start_date = ä¸Šæœˆ 1 æ—¥, end_date = ä¸Šæœˆæœ€å¾Œä¸€å¤©)
     - å¦‚ç„¡ â†’ é—œé–‰ auto_renew + ç™¼é€šçŸ¥ (auto_renew_disabled++)

  3. åŸ·è¡ŒçºŒè¨‚
     - å‘¼å« TapPay API æ‰£æ¬¾
     - æˆåŠŸ â†’ å»ºç«‹æ–°è¨‚é–±æœŸ (auto_renewed++)
     - å¤±æ•— â†’ è¨˜éŒ„éŒ¯èª¤ (renewal_failed++)
```

### 10.4 è³‡æ–™æ¨¡å‹

#### SubscriptionPeriod æ¬„ä½
```python
class SubscriptionPeriod(Base):
    id: int
    teacher_id: int
    plan_name: str  # 'Tutor Teachers' | 'School Teachers'
    amount_paid: int  # 231 (Tutor) | 660 (School)
    quota_total: int  # 10000 (Tutor) | 25000 (School)
    start_date: date  # ç•¶æœˆ 1 æ—¥
    end_date: date  # ç•¶æœˆæœ€å¾Œä¸€å¤©
    payment_method: str  # 'auto_renew'
    status: str  # 'active' | 'expired' | 'cancelled'
    created_at: datetime
```

#### Teacher ç›¸é—œæ¬„ä½
```python
class Teacher(Base):
    subscription_auto_renew: bool  # æ˜¯å¦è‡ªå‹•çºŒè¨‚
    card_key: str  # TapPay card_key
    card_token: str  # TapPay card_token
    is_active: bool  # å¸³è™Ÿæ˜¯å¦å•Ÿç”¨
```

### 10.5 å›æ‡‰æ ¼å¼
```json
{
  "status": "completed",
  "date": "2025-12-01",
  "marked_expired": 15,
  "auto_renewed": 8,
  "renewal_failed": 2,
  "auto_renew_disabled": 1,
  "skipped": 3,
  "errors": [
    {
      "teacher_id": 123,
      "error": "TapPay API error: insufficient funds"
    }
  ]
}
```

### 10.6 æ¸¬è©¦ç­–ç•¥ (TDD)

#### æ¸¬è©¦æª”æ¡ˆ
`backend/tests/integration/api/test_monthly_renewal_cron.py`

#### æ¸¬è©¦å ´æ™¯ (16 å€‹)

**Phase 1: æ¨™è¨˜éæœŸè¨‚é–± (3 tests)**
1. âœ… æ¨™è¨˜ä¸Šæœˆåˆ°æœŸçš„ active è¨‚é–±
2. âœ… æ¨™è¨˜å¤šå€‹æœˆå‰åˆ°æœŸçš„ active è¨‚é–±
3. âœ… ä¸æ¨™è¨˜ç•¶æœˆçš„ active è¨‚é–±

**Phase 2: è‡ªå‹•çºŒè¨‚ (3 tests)**
4. âœ… æˆåŠŸçºŒè¨‚ï¼ˆæœ‰ä¸Šæœˆè¨‚é–± + auto_renew + ç¶å¡ï¼‰
5. âœ… çºŒè¨‚å¤±æ•—ï¼ˆTapPay API éŒ¯èª¤ï¼‰
6. âœ… çºŒè¨‚å¾Œæ­£ç¢ºæ›´æ–° quota

**æª¢æŸ¥ 1: é˜²é‡è¤‡æ‰£æ¬¾ (2 tests)**
7. âœ… è·³éå·²æœ‰æœ¬æœˆè¨‚é–±çš„æ•™å¸«
8. âœ… ä¸è·³éæ²’æœ‰æœ¬æœˆè¨‚é–±çš„æ•™å¸«

**æª¢æŸ¥ 2: é—œé–‰ auto_renew (2 tests)**
9. âœ… é—œé–‰ç„¡ä¸Šæœˆè¨‚é–±çš„ auto_renew
10. âœ… ä¸é—œé–‰æœ‰ä¸Šæœˆè¨‚é–±çš„ auto_renew

**è·³éå ´æ™¯ (3 tests)**
11. âœ… è·³é auto_renew = False çš„æ•™å¸«
12. âœ… è·³éæ²’ç¶å¡çš„æ•™å¸«
13. âœ… è·³é is_active = False çš„æ•™å¸«

**é‚Šç•Œæ¡ˆä¾‹ (3 tests)**
14. âœ… è™•ç†æ²’æœ‰ä»»ä½•è¨‚é–±çš„æ•™å¸«
15. âœ… è™•ç† trial è¨‚é–±ç”¨æˆ¶
16. âœ… è™•ç†å¤šå€‹æ•™å¸«åŒæ™‚çºŒè¨‚

### 10.7 é–‹ç™¼é€²åº¦

#### âœ… å·²å®Œæˆ (2025-11-17)
- [x] TDD æ¸¬è©¦å¥—ä»¶æ’°å¯« (16 tests) - **100% PASSING**
- [x] æ¸¬è©¦è³‡æ–™ fixtures è¨­å®š
- [x] æ™‚é–“ mocking (freezegun)
- [x] TapPay service mocking
- [x] Git branch: `prd_nov` å»ºç«‹
- [x] åˆå§‹ commit å®Œæˆ
- [x] ä¿¡ç”¨å¡ç¶å®šæµç¨‹ + è‡ªå‹•çºŒè¨‚ç¢ºèªå°è©±æ¡† (å‰ç«¯)
- [x] PRD ç¬¬åç« ï¼šä¿¡ç”¨å¡ç¶å®šèˆ‡è‡ªå‹•çºŒè¨‚è¦ç¯„å®Œæˆ
- [x] **Cron API endpoint å®Œæ•´å¯¦ä½œ** (`POST /api/cron/monthly-renewal`)
- [x] Phase 1: æ¨™è¨˜éæœŸè¨‚é–±é‚è¼¯ âœ…
- [x] Phase 2: è‡ªå‹•çºŒè¨‚æ ¸å¿ƒé‚è¼¯ âœ…
- [x] æª¢æŸ¥ 1: é˜²é‡è¤‡æ‰£æ¬¾é‚è¼¯ âœ…
- [x] æª¢æŸ¥ 2: é—œé–‰ auto_renew é‚è¼¯ âœ…
- [x] æ¸¬è©¦é©—è­‰ (TDD GREEN) - 16/16 tests âœ…

#### ğŸ”„ é€²è¡Œä¸­
- [ ] ç„¡ï¼ˆé–‹ç™¼å·²å®Œæˆï¼Œç­‰å¾…éƒ¨ç½²ï¼‰

#### â³ å¾…è™•ç†
- [ ] Cloud Scheduler è¨­å®š (æ¯æœˆ 1 æ—¥ 02:00)
- [ ] Email é€šçŸ¥ï¼ˆauto_renew é—œé–‰é€šçŸ¥ï¼‰
- [ ] éŒ¯èª¤ç›£æ§èˆ‡å‘Šè­¦ (Cloud Logging)
- [ ] Staging ç’°å¢ƒæ¸¬è©¦
- [ ] Production éƒ¨ç½²

### 10.8 é©—æ”¶æ¨™æº–
- [x] æ‰€æœ‰ 16 å€‹æ¸¬è©¦é€šé âœ… (2025-11-17)
- [x] Phase 1 æ­£ç¢ºæ¨™è¨˜æ‰€æœ‰éæœŸè¨‚é–± âœ…
- [x] Phase 2 æ­£ç¢ºè™•ç†çºŒè¨‚é‚è¼¯ âœ…
- [x] é˜²é‡è¤‡æ‰£æ¬¾æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ âœ…
- [x] è‡ªå‹•é—œé–‰ auto_renew æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ âœ…
- [x] å›æ‡‰æ ¼å¼ç¬¦åˆè¦æ ¼ âœ…
- [x] éŒ¯èª¤è™•ç†å®Œå–„ âœ…
- [x] Email é€šçŸ¥å¯¦ä½œ (send_renewal_success) âœ…
- [x] âœ… **å·²éƒ¨ç½²åˆ° main** (2025-11-18)
- [ ] Cloud Scheduler æ­£ç¢ºè§¸ç™¼ Cron Job (å¾…éƒ¨ç½²)
- [ ] Production ç’°å¢ƒæˆåŠŸåŸ·è¡Œç¬¬ä¸€æ¬¡çºŒè¨‚ (å¾…é©—è­‰)

---

## åä¸€ã€å¾ŒçºŒå·¥ä½œ

### 11.1 12æœˆè¦åŠƒ
- çµ±è¨ˆåœ–è¡¨åŠŸèƒ½å¢å¼·
- æ‰¹é‡æ“ä½œå„ªåŒ–
- æ•ˆèƒ½ç›£æ§æ”¹å–„
- ä½¿ç”¨è€…å›é¥‹æ”¶é›†

### 11.2 Phase 2 æº–å‚™
- å­¸æ ¡ç®¡ç†åŠŸèƒ½è¨­è¨ˆ
- å¤šæ•™å¸«å”ä½œæ©Ÿåˆ¶
- é€²éšå ±è¡¨ç³»çµ±
- å®¶é•·åŠŸèƒ½è¦åŠƒ

---

## é™„éŒ„

### A. ç¿»è­¯å°ç…§è¡¨ï¼ˆå¸¸ç”¨è©å½™ï¼‰
| ä¸­æ–‡ | è‹±æ–‡ |
|-----|------|
| å„€è¡¨æ¿ | Dashboard |
| ç­ç´š | Classroom |
| å­¸ç”Ÿ | Student |
| èª²ç¨‹ | Program/Course |
| ä½œæ¥­ | Assignment |
| è¨‚é–± | Subscription |
| è©¦ç”¨ | Trial |
| é»æ•¸ | Credits |
| é€€æ¬¾ | Refund |
| å¸³æ¬¾ | Transaction |

### B. ç›¸é—œé€£çµ
- [TapPay Refund API æ–‡ä»¶](https://docs.tappaysdk.com/refund/zh/front.html)
- [react-i18next å®˜æ–¹æ–‡ä»¶](https://react.i18next.com/)
- [OpenPyXL æ–‡ä»¶](https://openpyxl.readthedocs.io/)

---

## åã€ä¿¡ç”¨å¡ç¶å®šèˆ‡è‡ªå‹•çºŒè¨‚æµç¨‹è¦ç¯„

### 10.1 åŠŸèƒ½æ¦‚è¿°
å®šç¾©å‰ç«¯ä¿¡ç”¨å¡ç¶å®šã€è§£ç¶èˆ‡è‡ªå‹•çºŒè¨‚ä¹‹é–“çš„äº’å‹•é‚è¼¯ï¼Œç¢ºä¿ä½¿ç”¨è€…é«”é©—ä¸€è‡´ä¸”ç¬¦åˆå•†æ¥­é‚è¼¯ã€‚

### 10.2 æ ¸å¿ƒè¦å‰‡

#### è¦å‰‡ 1: ç¶å¡æ™‚è©¢å•è‡ªå‹•çºŒè¨‚
**æƒ…å¢ƒ**: ä½¿ç”¨è€…é¦–æ¬¡ç¶å®šä¿¡ç”¨å¡æˆ–æ›´æ›ä¿¡ç”¨å¡

**æµç¨‹**:
```
1. ä½¿ç”¨è€…è¼¸å…¥ä¿¡ç”¨å¡è³‡è¨Š
2. TapPay é©—è­‰æˆåŠŸ
3. â“ é¡¯ç¤ºç¢ºèªå°è©±æ¡†: "æ˜¯å¦å•Ÿç”¨è‡ªå‹•çºŒè¨‚ï¼Ÿ"
   - é¸é … A: "æ˜¯ï¼Œè‡ªå‹•çºŒè¨‚" â†’ subscription_auto_renew = True
   - é¸é … B: "å¦ï¼Œæ‰‹å‹•çºŒè¨‚" â†’ subscription_auto_renew = False
4. å„²å­˜ç¶å¡è³‡è¨Š (card_key, card_token) + auto_renew è¨­å®š
5. å‰ç«¯æ›´æ–°é¡¯ç¤ºç‹€æ…‹
```

**UI è¦é»**:
- æ¸…æ¥šèªªæ˜è‡ªå‹•çºŒè¨‚çš„æ„ç¾©ï¼ˆæ¯æœˆ 1 è™Ÿè‡ªå‹•æ‰£æ¬¾ï¼‰
- æä¾›å…©å€‹é¸é …ï¼Œé è¨­ä¸å‹¾é¸ï¼ˆä½¿ç”¨è€…ä¸»å‹•é¸æ“‡ï¼‰
- èªªæ˜å¯éš¨æ™‚åœ¨è¨­å®šä¸­è®Šæ›´

**API å‘¼å«**:
```typescript
POST /api/teachers/bind-card
{
  "card_key": "...",
  "card_token": "...",
  "auto_renew": true  // æ ¹æ“šä½¿ç”¨è€…é¸æ“‡
}
```

**å¾Œç«¯é©—è­‰**:
```python
# routers/payment.py or routers/teachers.py
def bind_card(teacher: Teacher, card_key: str, card_token: str, auto_renew: bool):
    teacher.card_key = card_key
    teacher.card_token = card_token
    teacher.subscription_auto_renew = auto_renew
    db.commit()
```

---

#### è¦å‰‡ 2: åˆªé™¤ç¶å¡æ™‚è‡ªå‹•é—œé–‰çºŒè¨‚
**æƒ…å¢ƒ**: ä½¿ç”¨è€…è§£é™¤ä¿¡ç”¨å¡ç¶å®š

**æ¥­å‹™é‚è¼¯**:
- æ²’æœ‰ç¶å¡ â†’ ç„¡æ³•è‡ªå‹•æ‰£æ¬¾ â†’ auto_renew å¿…é ˆé—œé–‰
- é¿å…ä½¿ç”¨è€…èª¤ä»¥ç‚ºæœƒè‡ªå‹•çºŒè¨‚ï¼Œä½†å¯¦éš›ä¸Šç„¡æ³•æ‰£æ¬¾

**æµç¨‹**:
```
1. ä½¿ç”¨è€…é»æ“Šã€Œåˆªé™¤ä¿¡ç”¨å¡ã€
2. â“ é¡¯ç¤ºç¢ºèªå°è©±æ¡†:
   "åˆªé™¤ä¿¡ç”¨å¡å¾Œï¼Œè‡ªå‹•çºŒè¨‚å°‡æœƒé—œé–‰ã€‚ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ"
3. ä½¿ç”¨è€…ç¢ºèª
4. å¾Œç«¯åŸ·è¡Œ:
   - card_key = NULL
   - card_token = NULL
   - subscription_auto_renew = False  â† å¼·åˆ¶é—œé–‰
5. å‰ç«¯å³æ™‚æ›´æ–°:
   - éš±è—ä¿¡ç”¨å¡è³‡è¨Šé¡¯ç¤º
   - è‡ªå‹•çºŒè¨‚é–‹é—œè®Šç‚º OFFï¼ˆä¸” disabledï¼‰
   - é¡¯ç¤ºæç¤º: "è«‹å…ˆç¶å®šä¿¡ç”¨å¡æ‰èƒ½å•Ÿç”¨è‡ªå‹•çºŒè¨‚"
```

**API å‘¼å«**:
```typescript
DELETE /api/teachers/card
// æˆ–
POST /api/teachers/unbind-card
```

**å¾Œç«¯å¯¦ä½œ**:
```python
@router.delete("/card")
def unbind_card(
    teacher: Teacher = Depends(get_current_teacher),
    db: Session = Depends(get_db)
):
    # åˆªé™¤ç¶å¡è³‡è¨Š
    teacher.card_key = None
    teacher.card_token = None

    # ğŸ”´ å¼·åˆ¶é—œé–‰è‡ªå‹•çºŒè¨‚
    teacher.subscription_auto_renew = False

    db.commit()

    return {
        "message": "ä¿¡ç”¨å¡å·²è§£ç¶ï¼Œè‡ªå‹•çºŒè¨‚å·²é—œé–‰",
        "card_bound": False,
        "auto_renew": False
    }
```

**å‰ç«¯é€£å‹•**:
```typescript
// åˆªé™¤ç¶å¡å¾Œï¼ŒUI å¿…é ˆå³æ™‚æ›´æ–°
const handleUnbindCard = async () => {
  await api.unbindCard();

  // æ›´æ–° UI ç‹€æ…‹
  setCardBound(false);
  setAutoRenew(false);
  setAutoRenewDisabled(true);  // ç¦ç”¨è‡ªå‹•çºŒè¨‚é–‹é—œ

  // é¡¯ç¤ºæç¤º
  showToast("ä¿¡ç”¨å¡å·²è§£ç¶ï¼Œè‡ªå‹•çºŒè¨‚å·²é—œé–‰");
}
```

---

#### è¦å‰‡ 3: åªå–æ¶ˆçºŒè¨‚ï¼Œä¿ç•™ç¶å¡
**æƒ…å¢ƒ**: ä½¿ç”¨è€…åªæƒ³é—œé–‰è‡ªå‹•çºŒè¨‚ï¼Œä½†ä¿ç•™ä¿¡ç”¨å¡è³‡è¨Š

**æ¥­å‹™é‚è¼¯**:
- ä½¿ç”¨è€…å¯èƒ½å¸Œæœ›æ‰‹å‹•çºŒè¨‚ï¼Œè€Œéè‡ªå‹•æ‰£æ¬¾
- ä¿ç•™ç¶å¡è³‡è¨Šæ–¹ä¾¿æœªä¾†ä½¿ç”¨

**æµç¨‹**:
```
1. ä½¿ç”¨è€…åœ¨ã€Œè¨‚é–±è¨­å®šã€é é¢
2. é—œé–‰ã€Œè‡ªå‹•çºŒè¨‚ã€é–‹é—œ
3. â“ é¡¯ç¤ºç¢ºèªå°è©±æ¡†:
   "é—œé–‰è‡ªå‹•çºŒè¨‚å¾Œï¼Œå°‡ä¸æœƒåœ¨æ¯æœˆ 1 è™Ÿè‡ªå‹•æ‰£æ¬¾ã€‚
    ä¿¡ç”¨å¡è³‡è¨Šæœƒä¿ç•™ï¼Œæ‚¨ä»å¯æ‰‹å‹•çºŒè¨‚ã€‚ç¢ºå®šè¦é—œé–‰å—ï¼Ÿ"
4. ä½¿ç”¨è€…ç¢ºèª
5. å¾Œç«¯åŸ·è¡Œ:
   - subscription_auto_renew = False
   - card_key ä¿æŒä¸è®Š
   - card_token ä¿æŒä¸è®Š
6. å‰ç«¯æ›´æ–°:
   - è‡ªå‹•çºŒè¨‚é–‹é—œ OFF
   - ä¿¡ç”¨å¡è³‡è¨Šä»ç„¶é¡¯ç¤º
   - é¡¯ç¤ºæç¤º: "å·²é—œé–‰è‡ªå‹•çºŒè¨‚ï¼Œæ‚¨å¯éš¨æ™‚æ‰‹å‹•çºŒè¨‚"
```

**API å‘¼å«**:
```typescript
PATCH /api/teachers/subscription-settings
{
  "auto_renew": false
}
```

**å¾Œç«¯å¯¦ä½œ**:
```python
@router.patch("/subscription-settings")
def update_subscription_settings(
    settings: SubscriptionSettings,
    teacher: Teacher = Depends(get_current_teacher),
    db: Session = Depends(get_db)
):
    # åªæ›´æ–° auto_renewï¼Œä¸å‹• card_key/card_token
    teacher.subscription_auto_renew = settings.auto_renew
    db.commit()

    return {
        "message": "è¨‚é–±è¨­å®šå·²æ›´æ–°",
        "auto_renew": teacher.subscription_auto_renew,
        "card_bound": bool(teacher.card_key)  # ç¶å¡ç‹€æ…‹ä¸è®Š
    }
```

---

### 10.3 ç‹€æ…‹çŸ©é™£

| ç¶å¡ç‹€æ…‹ | auto_renew | å…è¨±ï¼Ÿ | èªªæ˜ |
|---------|-----------|-------|------|
| âŒ æœªç¶å¡ | False | âœ… å…è¨± | åˆå§‹ç‹€æ…‹ / è§£ç¶å¾Œç‹€æ…‹ |
| âŒ æœªç¶å¡ | True  | âŒ **ç¦æ­¢** | ä¸åˆç†ç‹€æ…‹ï¼Œå¾Œç«¯æ‡‰æ‹’çµ• |
| âœ… å·²ç¶å¡ | False | âœ… å…è¨± | æ‰‹å‹•çºŒè¨‚æ¨¡å¼ |
| âœ… å·²ç¶å¡ | True  | âœ… å…è¨± | è‡ªå‹•çºŒè¨‚æ¨¡å¼ |

**å¾Œç«¯é©—è­‰è¦å‰‡**:
```python
# åœ¨ä»»ä½•æ›´æ–° auto_renew çš„ API ä¸­
def validate_auto_renew(teacher: Teacher, auto_renew: bool):
    if auto_renew and not teacher.card_key:
        raise HTTPException(
            status_code=400,
            detail="ç„¡æ³•å•Ÿç”¨è‡ªå‹•çºŒè¨‚ï¼šå°šæœªç¶å®šä¿¡ç”¨å¡"
        )
```

---

### 10.4 å‰ç«¯ UI è¦ç¯„

#### UI å…ƒç´ äº’å‹•é‚è¼¯

**ä¿¡ç”¨å¡è¨­å®šé é¢**:
```tsx
<Card title="ä¿¡ç”¨å¡ç®¡ç†">
  {cardBound ? (
    <>
      <CardDisplay lastFour={cardInfo.lastFour} />
      <Button onClick={handleUnbindCard} variant="danger">
        åˆªé™¤ä¿¡ç”¨å¡
      </Button>
    </>
  ) : (
    <Button onClick={handleBindCard} variant="primary">
      ç¶å®šä¿¡ç”¨å¡
    </Button>
  )}
</Card>

<Card title="è‡ªå‹•çºŒè¨‚è¨­å®š">
  <Switch
    checked={autoRenew}
    disabled={!cardBound}  // â† æ²’ç¶å¡æ™‚ç¦ç”¨
    onChange={handleAutoRenewChange}
    label="æ¯æœˆè‡ªå‹•çºŒè¨‚"
  />

  {!cardBound && (
    <HelpText variant="warning">
      è«‹å…ˆç¶å®šä¿¡ç”¨å¡æ‰èƒ½å•Ÿç”¨è‡ªå‹•çºŒè¨‚
    </HelpText>
  )}
</Card>
```

**ç¶å¡å°è©±æ¡†**:
```tsx
<Modal title="ç¶å®šä¿¡ç”¨å¡" onClose={handleClose}>
  <TapPayCardForm onSuccess={handleCardSuccess} />

  <Divider />

  <Checkbox
    checked={enableAutoRenew}
    onChange={setEnableAutoRenew}
    label="å•Ÿç”¨è‡ªå‹•çºŒè¨‚"
  />
  <HelpText>
    å•Ÿç”¨å¾Œï¼Œç³»çµ±å°‡åœ¨æ¯æœˆ 1 è™Ÿè‡ªå‹•æ‰£æ¬¾ä¸¦çºŒè¨‚ã€‚
    æ‚¨å¯éš¨æ™‚åœ¨è¨­å®šä¸­é—œé–‰æ­¤åŠŸèƒ½ã€‚
  </HelpText>

  <ButtonGroup>
    <Button onClick={handleClose}>å–æ¶ˆ</Button>
    <Button onClick={handleConfirm} variant="primary">
      ç¢ºèªç¶å®š
    </Button>
  </ButtonGroup>
</Modal>
```

---

### 10.5 æ¸¬è©¦æ¡ˆä¾‹

#### Test Case 1: ç¶å¡æ™‚é¸æ“‡å•Ÿç”¨è‡ªå‹•çºŒè¨‚
```
Given: ä½¿ç”¨è€…æœªç¶å¡ï¼Œauto_renew = False
When: ä½¿ç”¨è€…ç¶å®šä¿¡ç”¨å¡ï¼Œé¸æ“‡ã€Œå•Ÿç”¨è‡ªå‹•çºŒè¨‚ã€
Then:
  - card_key å’Œ card_token å„²å­˜æˆåŠŸ
  - auto_renew = True
  - å‰ç«¯é¡¯ç¤ºç¶å¡è³‡è¨Š
  - è‡ªå‹•çºŒè¨‚é–‹é—œç‚º ON
```

#### Test Case 2: ç¶å¡æ™‚é¸æ“‡ä¸å•Ÿç”¨è‡ªå‹•çºŒè¨‚
```
Given: ä½¿ç”¨è€…æœªç¶å¡ï¼Œauto_renew = False
When: ä½¿ç”¨è€…ç¶å®šä¿¡ç”¨å¡ï¼Œé¸æ“‡ã€Œä¸å•Ÿç”¨è‡ªå‹•çºŒè¨‚ã€
Then:
  - card_key å’Œ card_token å„²å­˜æˆåŠŸ
  - auto_renew = False
  - å‰ç«¯é¡¯ç¤ºç¶å¡è³‡è¨Š
  - è‡ªå‹•çºŒè¨‚é–‹é—œç‚º OFFï¼ˆä½†å¯æ‰‹å‹•é–‹å•Ÿï¼‰
```

#### Test Case 3: åˆªé™¤ç¶å¡ï¼Œè‡ªå‹•é—œé–‰çºŒè¨‚
```
Given: ä½¿ç”¨è€…å·²ç¶å¡ï¼Œauto_renew = True
When: ä½¿ç”¨è€…åˆªé™¤ä¿¡ç”¨å¡ç¶å®š
Then:
  - card_key = NULL
  - card_token = NULL
  - auto_renew = Falseï¼ˆå¼·åˆ¶é—œé–‰ï¼‰
  - å‰ç«¯éš±è—ç¶å¡è³‡è¨Š
  - è‡ªå‹•çºŒè¨‚é–‹é—œç‚º OFF ä¸” disabled
```

#### Test Case 4: åªé—œé–‰è‡ªå‹•çºŒè¨‚
```
Given: ä½¿ç”¨è€…å·²ç¶å¡ï¼Œauto_renew = True
When: ä½¿ç”¨è€…é—œé–‰è‡ªå‹•çºŒè¨‚é–‹é—œ
Then:
  - card_key ä¿æŒä¸è®Š
  - card_token ä¿æŒä¸è®Š
  - auto_renew = False
  - å‰ç«¯ä»é¡¯ç¤ºç¶å¡è³‡è¨Š
  - è‡ªå‹•çºŒè¨‚é–‹é—œç‚º OFFï¼ˆå¯å†æ¬¡é–‹å•Ÿï¼‰
```

#### Test Case 5: æœªç¶å¡å˜—è©¦å•Ÿç”¨è‡ªå‹•çºŒè¨‚ï¼ˆå¾Œç«¯é˜²ç¦¦ï¼‰
```
Given: ä½¿ç”¨è€…æœªç¶å¡ï¼Œcard_key = NULL
When: å‰ç«¯ç™¼é€è«‹æ±‚è¨­å®š auto_renew = True
Then:
  - å¾Œç«¯å›å‚³ 400 éŒ¯èª¤
  - éŒ¯èª¤è¨Šæ¯: "ç„¡æ³•å•Ÿç”¨è‡ªå‹•çºŒè¨‚ï¼šå°šæœªç¶å®šä¿¡ç”¨å¡"
  - auto_renew ä¿æŒ False
```

---

### 10.6 API è¦æ ¼

#### API 1: ç¶å®šä¿¡ç”¨å¡
```
POST /api/teachers/bind-card

Request:
{
  "card_key": "string",
  "card_token": "string",
  "auto_renew": boolean
}

Response:
{
  "message": "ä¿¡ç”¨å¡ç¶å®šæˆåŠŸ",
  "card_bound": true,
  "auto_renew": true,
  "card_last_four": "1234"
}
```

#### API 2: è§£é™¤ç¶å¡
```
DELETE /api/teachers/card

Response:
{
  "message": "ä¿¡ç”¨å¡å·²è§£ç¶ï¼Œè‡ªå‹•çºŒè¨‚å·²é—œé–‰",
  "card_bound": false,
  "auto_renew": false
}
```

#### API 3: æ›´æ–°è‡ªå‹•çºŒè¨‚è¨­å®š
```
PATCH /api/teachers/subscription-settings

Request:
{
  "auto_renew": boolean
}

Response:
{
  "message": "è¨‚é–±è¨­å®šå·²æ›´æ–°",
  "auto_renew": false,
  "card_bound": true
}

Error (400):
{
  "detail": "ç„¡æ³•å•Ÿç”¨è‡ªå‹•çºŒè¨‚ï¼šå°šæœªç¶å®šä¿¡ç”¨å¡"
}
```

---

### 10.7 é©—æ”¶æ¨™æº–

#### å‰ç«¯é©—æ”¶
- [x] ç¶å¡æ™‚é¡¯ç¤ºã€Œæ˜¯å¦å•Ÿç”¨è‡ªå‹•çºŒè¨‚ã€é¸é … âœ… (ce701d5)
- [x] ç¶å¡å¾Œï¼ŒUI æ­£ç¢ºé¡¯ç¤ºç¶å¡ç‹€æ…‹èˆ‡è‡ªå‹•çºŒè¨‚ç‹€æ…‹ âœ…
- [x] åˆªé™¤ç¶å¡æ™‚é¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼ˆå«è‡ªå‹•é—œé–‰çºŒè¨‚èªªæ˜ï¼‰ âœ…
- [x] åˆªé™¤ç¶å¡å¾Œï¼Œè‡ªå‹•çºŒè¨‚é–‹é—œè‡ªå‹•é—œé–‰ä¸”ç¦ç”¨ âœ…
- [x] æœªç¶å¡æ™‚ï¼Œè‡ªå‹•çºŒè¨‚é–‹é—œç‚ºç¦ç”¨ç‹€æ…‹ âœ…
- [x] é—œé–‰è‡ªå‹•çºŒè¨‚æ™‚é¡¯ç¤ºç¢ºèªå°è©±æ¡† âœ…
- [x] æ‰€æœ‰æ“ä½œæˆåŠŸå¾Œé¡¯ç¤ºé©ç•¶çš„ toast è¨Šæ¯ âœ…

#### å¾Œç«¯é©—æ”¶
- [x] `POST /api/payment/update-card` æ­£ç¢ºå„²å­˜ card + auto_renew âœ… (ce701d5)
- [x] `DELETE /api/payment/saved-card` å¼·åˆ¶è¨­å®š auto_renew = False âœ…
- [x] å¾Œç«¯é©—è­‰ï¼šæœªç¶å¡æ™‚æ‹’çµ•è¨­å®š auto_renew = True âœ…
- [x] æ‰€æœ‰ API æ­£ç¢ºå›å‚³æ“ä½œå¾Œçš„ç‹€æ…‹ âœ…
- [x] è³‡æ–™åº«ç´„æŸï¼šä¸å…è¨± card_key=NULL ä¸” auto_renew=True âœ…

#### æ•´åˆæ¸¬è©¦
- [x] å®Œæ•´æµç¨‹ï¼šç¶å¡ â†’ å•Ÿç”¨çºŒè¨‚ â†’ é—œé–‰çºŒè¨‚ â†’ åˆªé™¤ç¶å¡ âœ… (å·²å¯¦ä½œ)
- [x] é‚Šç•Œæ¡ˆä¾‹ï¼šæœªç¶å¡å˜—è©¦å•Ÿç”¨çºŒè¨‚ï¼ˆæ‡‰è¢«æ‹’çµ•ï¼‰ âœ…
- [x] é‚Šç•Œæ¡ˆä¾‹ï¼šåˆªé™¤ç¶å¡æ™‚ï¼ŒçºŒè¨‚è‡ªå‹•é—œé–‰ âœ…
- [x] UI èˆ‡å¾Œç«¯ç‹€æ…‹å®Œå…¨åŒæ­¥ âœ…

---

### 10.8 å¯¦ä½œå„ªå…ˆé †åº

**Phase 1 (Must Have)**:
1. âœ… å¾Œç«¯ API: `DELETE /api/payment/saved-card` å¼·åˆ¶é—œé–‰ auto_renew
2. âœ… å¾Œç«¯é©—è­‰: æ‹’çµ•æœªç¶å¡æ™‚è¨­å®š auto_renew = True
3. âœ… å‰ç«¯: åˆªé™¤ç¶å¡æ™‚è‡ªå‹•é—œé–‰çºŒè¨‚ UI

**Phase 2 (Should Have)**:
4. âœ… ç¶å¡æ™‚è©¢å•è‡ªå‹•çºŒè¨‚å°è©±æ¡† (ce701d5)
5. âœ… æœªç¶å¡æ™‚ç¦ç”¨è‡ªå‹•çºŒè¨‚é–‹é—œ
6. âœ… æ‰€æœ‰ç¢ºèªå°è©±æ¡†èˆ‡è­¦å‘Šè¨Šæ¯

**Phase 3 (Nice to Have)**:
7. â³ å®Œæ•´çš„ E2E æ¸¬è©¦å¥—ä»¶ (å·²æœ‰åŸºç¤æ¸¬è©¦)
8. âœ… ä½¿ç”¨è€…å¼•å°ï¼ˆtooltips, help textï¼‰

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.1
**å»ºç«‹æ—¥æœŸ**: 2025-11-17
**æœ€å¾Œæ›´æ–°**: 2025-11-17 (æ–°å¢ç¬¬åç« ï¼šä¿¡ç”¨å¡ç¶å®šè¦ç¯„)
**è² è²¬äºº**: ç”¢å“åœ˜éšŠ
**ç‹€æ…‹**: âœ… Final ç‰ˆæœ¬
